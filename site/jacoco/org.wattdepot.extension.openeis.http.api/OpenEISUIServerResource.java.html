<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OpenEISUIServerResource.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.html" class="el_package">org.wattdepot.extension.openeis.http.api</a> &gt; <span class="el_source">OpenEISUIServerResource.java</span></div><h1>OpenEISUIServerResource.java</h1><pre class="source lang-java linenums">/*
 * This file is part of WattDepot.
 *
 *  Copyright (C) 2015  Cam Moore
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package org.wattdepot.extension.openeis.http.api;

import org.restlet.data.LocalReference;
import org.restlet.data.MediaType;
import org.restlet.data.Status;
import org.restlet.ext.freemarker.TemplateRepresentation;
import org.restlet.representation.Representation;
import org.restlet.resource.ClientResource;
import org.restlet.resource.Get;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.MisMatchedOwnerException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.http.api.API;
import org.wattdepot.extension.openeis.OpenEISLabels;
import org.wattdepot.server.http.api.WattDepotServerResource;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;

/**
 * OpenEISUIServerResource - User interface for the OpenEIS algorithms. Handles /wattdepot/{orgId}/openeis/ui requests.
 *
 * @author Cam Moore
 *         Created by carletonmoore on 4/10/15.
 */
<span class="nc" id="L52">public class OpenEISUIServerResource extends WattDepotServerResource {</span>

  /**
   * @return The Organization summary information as an HTML Representation.
   */
  @Get()
  public Representation toHtml() {
<span class="nc" id="L59">    getLogger().log(Level.INFO,</span>
        &quot;GET &quot; + API.BASE_URI + &quot;{&quot; + orgId + &quot;}/&quot; + OpenEISLabels.OPENEIS + &quot;/ui/&quot;);
<span class="nc bnc" id="L61" title="All 2 branches missed.">    if (isInRole(orgId)) {</span>
<span class="nc" id="L62">      Map&lt;String, Object&gt; dataModel = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L63">      dataModel.put(&quot;orgId&quot;, orgId);</span>
<span class="nc" id="L64">      Representation rep = null;</span>
<span class="nc" id="L65">      TemplateRepresentation template = null;</span>
      try {
<span class="nc" id="L67">        depot.getOrganization(orgId, true);</span>
        // get the depositories
<span class="nc" id="L69">        List&lt;Depository&gt; depos = depot.getDepositories(orgId, false);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        for (Depository d : depos) {</span>
<span class="nc" id="L71">          String typeName = d.getMeasurementType().getName();</span>
<span class="nc bnc" id="L72" title="All 8 branches missed.">          if (!typeName.startsWith(&quot;Power&quot;) &amp;&amp; !typeName.startsWith(&quot;Energy&quot;) &amp;&amp; !typeName.startsWith(&quot;Temperature&quot;) &amp;&amp; !typeName.startsWith(&quot;Area&quot;)) {</span>
<span class="nc" id="L73">            depos.remove(d); // remove the ones we aren't interested in.</span>
          }
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">        Map&lt;String, List&lt;Sensor&gt;&gt; depoSensors = new HashMap&lt;String, List&lt;Sensor&gt;&gt;();</span>
<span class="nc" id="L77">        List&lt;Sensor&gt; sensors = new ArrayList&lt;Sensor&gt;();</span>
<span class="nc" id="L78">        List&lt;Sensor&gt; powerSensors = new ArrayList&lt;Sensor&gt;();</span>
<span class="nc" id="L79">        List&lt;Depository&gt; powerDepositories = new ArrayList&lt;Depository&gt;();</span>
<span class="nc" id="L80">        List&lt;Sensor&gt; temperatureSensors = new ArrayList&lt;Sensor&gt;();</span>
<span class="nc" id="L81">        List&lt;Depository&gt; temperatureDepositories = new ArrayList&lt;Depository&gt;();</span>
<span class="nc" id="L82">        List&lt;Sensor&gt; energySensors = new ArrayList&lt;Sensor&gt;();</span>
<span class="nc" id="L83">        List&lt;Depository&gt; energyDepositories = new ArrayList&lt;Depository&gt;();</span>
<span class="nc" id="L84">        Map&lt;String, Map&lt;String, List&lt;Date&gt;&gt;&gt; depsitorySensorInfo = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        for (Depository d : depos) {</span>
<span class="nc" id="L86">          Map&lt;String, List&lt;Date&gt;&gt; sensorInfo = new HashMap&lt;String, List&lt;Date&gt;&gt;();</span>
<span class="nc" id="L87">          List&lt;Sensor&gt; sensorList = new ArrayList&lt;Sensor&gt;();</span>
<span class="nc" id="L88">          depoSensors.put(d.getId(), sensorList);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">          for (String sensorId : depot.listSensors(d.getId(), orgId, false)) {</span>
<span class="nc" id="L90">            Sensor s = depot.getSensor(sensorId, orgId, false);</span>
<span class="nc" id="L91">            sensorList.add(s);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (!sensors.contains(s)) {</span>
<span class="nc" id="L93">              sensors.add(s);</span>
            }
<span class="nc bnc" id="L95" title="All 4 branches missed.">            if (d.getMeasurementType().getName().startsWith(&quot;Power&quot;) &amp;&amp; !powerSensors.contains(s)) {</span>
<span class="nc" id="L96">              powerSensors.add(s);</span>
<span class="nc" id="L97">              powerDepositories.add(d);</span>
            }
<span class="nc bnc" id="L99" title="All 4 branches missed.">            else if (d.getMeasurementType().getName().startsWith(&quot;Energy&quot;) &amp;&amp; !energySensors.contains(s)) {</span>
<span class="nc" id="L100">              energySensors.add(s);</span>
<span class="nc" id="L101">              energyDepositories.add(d);</span>
            }
<span class="nc bnc" id="L103" title="All 4 branches missed.">            else if (d.getMeasurementType().getName().startsWith(&quot;Temperature&quot;) &amp;&amp; !temperatureSensors.contains(s)) {</span>
<span class="nc" id="L104">              temperatureSensors.add(s);</span>
<span class="nc" id="L105">              temperatureDepositories.add(d);</span>
            }
            try {
<span class="nc" id="L108">              InterpolatedValue earliest = depot.getEarliestMeasuredValue(</span>
                  d.getId(), orgId, sensorId, false);
<span class="nc" id="L110">              InterpolatedValue latest = depot.getLatestMeasuredValue(</span>
                  d.getId(), orgId, sensorId, false);
<span class="nc" id="L112">              List&lt;Date&gt; info = new ArrayList&lt;Date&gt;();</span>
<span class="nc" id="L113">              info.add(earliest.getStart());</span>
<span class="nc" id="L114">              info.add(latest.getEnd());</span>
<span class="nc" id="L115">              sensorInfo.put(sensorId, info);</span>
<span class="nc" id="L116">              depsitorySensorInfo.put(d.getId(), sensorInfo);</span>
            }
<span class="nc" id="L118">            catch (NoMeasurementException e) {</span>
              // TODO Auto-generated catch block
<span class="nc" id="L120">              e.printStackTrace();</span>
<span class="nc" id="L121">            }</span>
<span class="nc" id="L122">          }</span>
<span class="nc" id="L123">        }</span>
<span class="nc" id="L124">        dataModel.put(&quot;depositories&quot;, depos);</span>
<span class="nc" id="L125">        dataModel.put(&quot;depoSensors&quot;, depoSensors);</span>
<span class="nc" id="L126">        dataModel.put(&quot;sensors&quot;, sensors);</span>
<span class="nc" id="L127">        dataModel.put(&quot;power_sensors&quot;, powerSensors);</span>
<span class="nc" id="L128">        dataModel.put(&quot;power_depositories&quot;, powerDepositories);</span>
<span class="nc" id="L129">        dataModel.put(&quot;energy_sensors&quot;, energySensors);</span>
<span class="nc" id="L130">        dataModel.put(&quot;energy_depositories&quot;, energyDepositories);</span>
<span class="nc" id="L131">        dataModel.put(&quot;temperature_sensors&quot;, temperatureSensors);</span>
<span class="nc" id="L132">        dataModel.put(&quot;temperature_depositories&quot;, temperatureDepositories);</span>
<span class="nc" id="L133">        dataModel.put(&quot;depository_sensor_info&quot;, depsitorySensorInfo);</span>
      }
<span class="nc" id="L135">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L136">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L137">        return null;</span>
      }
<span class="nc" id="L139">      catch (MisMatchedOwnerException e) {</span>
<span class="nc" id="L140">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L141">        return null;</span>
<span class="nc" id="L142">      }</span>
<span class="nc" id="L143">      rep = new ClientResource(LocalReference.createClapReference(getClass()</span>
          .getPackage()) + &quot;/OpenEISUI.ftl&quot;).get();
<span class="nc" id="L145">      template = new TemplateRepresentation(rep, dataModel, MediaType.TEXT_HTML);</span>
<span class="nc" id="L146">      return template;</span>
    }
<span class="nc" id="L148">    return null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>