<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DepositoryLatestValueServerResource.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.html" class="el_package">org.wattdepot.server.http.api</a> &gt; <span class="el_source">DepositoryLatestValueServerResource.java</span></div><h1>DepositoryLatestValueServerResource.java</h1><pre class="source lang-java linenums">package org.wattdepot.server.http.api;

import org.restlet.data.Status;
import org.restlet.resource.ResourceException;
import org.wattdepot.common.domainmodel.CollectorProcessDefinition;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.Labels;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorGroup;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.MisMatchedOwnerException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.http.api.DepositoryLatestValueResource;

import java.util.Date;
import java.util.List;
import java.util.logging.Level;

/**
 * DepositoryLatestValueServerResource - Returns the latest value for the sensor or sensor group stored in the
 * depository as an InterpolatedValue with missing sensors.
 *
 * @author Cam Moore
 */
<span class="fc" id="L26">public class DepositoryLatestValueServerResource extends WattDepotServerResource implements DepositoryLatestValueResource {</span>
  private String depositoryId;
  private String sensorId;
  private String window;

  /*
 * (non-Javadoc)
 *
 * @see org.restlet.resource.Resource#doInit()
 */
  @Override
  protected void doInit() throws ResourceException {
<span class="fc" id="L38">    super.doInit();</span>
<span class="fc" id="L39">    this.sensorId = getQuery().getValues(Labels.SENSOR);</span>
<span class="fc" id="L40">    this.window = getQuery().getValues(Labels.WINDOW);</span>
<span class="fc" id="L41">    this.depositoryId = getAttribute(Labels.DEPOSITORY_ID);</span>
<span class="fc" id="L42">  }</span>


  @Override
  public InterpolatedValue retrieve() {
<span class="fc" id="L47">    getLogger().log(</span>
        Level.INFO,
        &quot;GET /wattdepot/{&quot; + orgId + &quot;}/&quot; + Labels.DEPOSITORY + &quot;/{&quot; + depositoryId + &quot;}/&quot;
            + Labels.LATEST + &quot;/&quot; + Labels.VALUE + &quot;/?&quot; + Labels.SENSOR + &quot;={&quot; + sensorId + &quot;}&amp;&quot;
            + Labels.WINDOW + &quot;={&quot; + window + &quot;}&quot;);
<span class="fc" id="L52">    int width = 5;</span>
<span class="pc bpc" id="L53" title="3 of 4 branches missed.">    if (window != null &amp;&amp; !window.equals(&quot;&quot;)) {</span>
      try {
<span class="nc" id="L55">        width = Integer.parseInt(window);</span>
      }
<span class="nc" id="L57">      catch (NumberFormatException nfe) {</span>
<span class="nc" id="L58">        width = 5;</span>
<span class="nc" id="L59">      }</span>
    }
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">    if (isInRole(orgId)) {</span>
      try {
<span class="fc" id="L63">        Depository depository = depot.getDepository(depositoryId, orgId, true);</span>
<span class="fc" id="L64">        Sensor sensor = depot.getSensor(sensorId, orgId, false);</span>
<span class="fc" id="L65">        InterpolatedValue value = new InterpolatedValue(sensorId, 0.0, depository.getMeasurementType(), new Date());</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (sensor != null) {</span>
<span class="nc" id="L67">          value.addDefinedSensor(sensorId);</span>
<span class="nc" id="L68">          CollectorProcessDefinition cpd = findCPD(depositoryId, sensorId, orgId);</span>
          try {
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (cpd != null) {</span>
<span class="nc" id="L71">              return depot.getLatestMeasuredValue(depositoryId, orgId, sensorId, width * cpd.getPollingInterval(), false);</span>
            }
            else {
<span class="nc" id="L74">              return depot.getLatestMeasuredValue(depositoryId, orgId, sensorId, false);</span>
            }
          }
<span class="nc" id="L77">          catch (NoMeasurementException e) {</span>
<span class="nc" id="L78">            return value;</span>
          }
        }
        else {
<span class="fc" id="L82">          SensorGroup group = depot.getSensorGroup(sensorId, orgId, false);</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">          if (group != null) {</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">            for (String s : group.getSensors()) {</span>
<span class="fc" id="L85">              sensor = depot.getSensor(s, orgId, false);</span>
<span class="fc" id="L86">              value.addDefinedSensor(s);</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">              if (sensor != null) {</span>
<span class="fc" id="L88">                CollectorProcessDefinition cpd = findCPD(depositoryId, s, orgId);</span>
                try {
                  InterpolatedValue latest;
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">                  if (cpd != null) {</span>
<span class="nc" id="L92">                    latest = depot.getLatestMeasuredValue(depositoryId, orgId, s, width * cpd.getPollingInterval(), false);</span>
                  }
                  else {
<span class="fc" id="L95">                    latest = depot.getLatestMeasuredValue(depositoryId, orgId, s, false);</span>
                  }
<span class="fc" id="L97">                  value.setValue(value.getValue() + latest.getValue());</span>
<span class="fc" id="L98">                  value.addReportingSensor(s);</span>
<span class="fc" id="L99">                  value.setStart(latest.getStart());</span>
<span class="fc" id="L100">                  value.setEnd(latest.getEnd());</span>
                }
<span class="nc" id="L102">                catch (NoMeasurementException e) { //NOPMD</span>

<span class="fc" id="L104">                }</span>
              }
<span class="fc" id="L106">            }</span>
<span class="fc" id="L107">            return value;</span>
          }
        }
      }
<span class="nc" id="L111">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L112">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, depositoryId + &quot; is not a Depository id.&quot;);</span>
<span class="nc" id="L113">        return null;</span>
      }
<span class="nc" id="L115">      catch (MisMatchedOwnerException e) {</span>
<span class="nc" id="L116">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, depositoryId + &quot; is not in organization &quot; + orgId + &quot;.&quot;);</span>
<span class="nc" id="L117">        return null;</span>
<span class="nc" id="L118">      }</span>
    }
<span class="nc" id="L120">    return null;</span>
  }

  /**
   * @param depositoryId The depository id.
   * @param sensorId     The sensor id.
   * @param orgId        The orgainzation id.
   * @return The CollectorProcessDefinition for the depository and sensor, or null if not defined.
   */
  private CollectorProcessDefinition findCPD(String depositoryId, String sensorId, String orgId) {
    try {
<span class="fc" id="L131">      List&lt;CollectorProcessDefinition&gt; cpds = depot.getCollectorProcessDefinitions(orgId, false);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">      for (CollectorProcessDefinition cpd : cpds) {</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (cpd.getDepositoryId().equals(depositoryId) &amp;&amp; cpd.getSensorId().equals(sensorId)) {</span>
<span class="nc" id="L134">          return cpd;</span>
        }
<span class="nc" id="L136">      }</span>
    }
<span class="nc" id="L138">    catch (IdNotFoundException e) {</span>
<span class="nc" id="L139">      e.printStackTrace();</span>
<span class="fc" id="L140">    }</span>
<span class="fc" id="L141">    return null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>