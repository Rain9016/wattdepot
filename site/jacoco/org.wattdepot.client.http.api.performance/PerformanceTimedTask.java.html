<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PerformanceTimedTask.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.html" class="el_package">org.wattdepot.client.http.api.performance</a> &gt; <span class="el_source">PerformanceTimedTask.java</span></div><h1>PerformanceTimedTask.java</h1><pre class="source lang-java linenums">/**
 * GetLatestValueTask.java This file is part of WattDepot.
 *
 * Copyright (C) 2014  Cam Moore
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.wattdepot.client.http.api.performance;

import java.util.HashSet;
import java.util.TimerTask;

import org.wattdepot.client.http.api.WattDepotClient;
import org.wattdepot.common.domainmodel.CollectorProcessDefinition;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.DepositoryList;
import org.wattdepot.common.domainmodel.MeasurementType;
import org.wattdepot.common.domainmodel.Property;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorList;
import org.wattdepot.common.domainmodel.SensorModel;
import org.wattdepot.common.exception.BadCredentialException;
import org.wattdepot.common.exception.BadSensorUriException;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.util.SensorModelHelper;

/**
 * PerformanceTimedTask times a query from the WattDepot Server.
 * 
 * @author Cam Moore
 * 
 */
public abstract class PerformanceTimedTask extends TimerTask {
  /** Flag for debugging messages. */
  protected boolean debug;
  /** The definition about the collector. */
  protected CollectorProcessDefinition definition;
  /** The client used to communicate with the WattDepot server. */
  protected WattDepotClient client;
  /** The Depository for storing measurements. */
  protected Depository depository;
  /** The sensor to get the latest value for. */
  protected Sensor sensor;

  private Long totalTime;
  private Long numberOfRuns;
  private Long minGetTime;
  private Long maxGetTime;
  private String collectorId;

  /**
   * Initializes the GetLatestValueTask.
   * 
   * @param serverUri The URI for the WattDepot server.
   * @param username The name of a user defined in the WattDepot server.
   * @param orgId the id of the organization the user is in.
   * @param password The password for the user.
   * @param debug flag for debugging messages.
   * @throws BadCredentialException if the user or password don't match the
   *         credentials in WattDepot.
   * @throws IdNotFoundException if the processId is not defined.
   * @throws BadSensorUriException if the Sensor's URI isn't valid.
   */
  public PerformanceTimedTask(String serverUri, String username, String orgId, String password,
      boolean debug) throws BadCredentialException, IdNotFoundException, BadSensorUriException {
<span class="nc" id="L77">    this(serverUri, username, orgId, password, debug, &quot;performance-evaluation-collector&quot;);</span>
<span class="nc" id="L78">  }</span>

  /**
   * Initializes the GetLatestValueTask.
   * 
   * @param serverUri The URI for the WattDepot server.
   * @param username The name of a user defined in the WattDepot server.
   * @param orgId the id of the organization the user is in.
   * @param password The password for the user.
   * @param debug flag for debugging messages.
   * @param collectorId the CollectorProcessDefinition id.
   * @throws BadCredentialException if the user or password don't match the
   *         credentials in WattDepot.
   * @throws IdNotFoundException if the processId is not defined.
   * @throws BadSensorUriException if the Sensor's URI isn't valid.
   */
  public PerformanceTimedTask(String serverUri, String username, String orgId, String password,
      boolean debug, String collectorId) throws BadCredentialException, IdNotFoundException,
<span class="nc" id="L96">      BadSensorUriException {</span>
<span class="nc" id="L97">    this.totalTime = 0l;</span>
<span class="nc" id="L98">    this.numberOfRuns = 0l;</span>
<span class="nc" id="L99">    this.maxGetTime = -1l;</span>
<span class="nc" id="L100">    this.minGetTime = Long.MAX_VALUE;</span>
<span class="nc" id="L101">    this.client = new WattDepotClient(serverUri, username, orgId, password);</span>
<span class="nc" id="L102">    this.debug = debug;</span>
<span class="nc" id="L103">    this.collectorId = collectorId;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">    if (!client.isDefinedCollectorProcessDefinition(this.collectorId)) {</span>
      // need to find a depository and sensor with data.
<span class="nc" id="L106">      DepositoryList depositories = client.getDepositories();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">      if (depositories != null) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (Depository d : depositories.getDepositories()) {</span>
<span class="nc" id="L109">          SensorList sensors = client.getDepositorySensors(d.getId());</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">          if (sensors != null &amp;&amp; sensors.getSensors().size() &gt; 0) {</span>
<span class="nc" id="L111">            this.depository = d;</span>
<span class="nc" id="L112">            this.sensor = sensors.getSensors().get(0);</span>
<span class="nc" id="L113">            break;</span>
          }
<span class="nc" id="L115">        }</span>
      }
<span class="nc" id="L117">    }</span>
    else {
<span class="nc bnc" id="L119" title="All 2 branches missed.">      if (!client.isDefinedCollectorProcessDefinition(this.collectorId)) {</span>
<span class="nc" id="L120">        initializePerformanceItems(this.collectorId);</span>
      }
<span class="nc" id="L122">      this.definition = client.getCollectorProcessDefinition(this.collectorId);</span>
<span class="nc" id="L123">      this.depository = client.getDepository(definition.getDepositoryId());</span>
<span class="nc" id="L124">      this.sensor = client.getSensor(definition.getSensorId());</span>
    }
<span class="nc" id="L126">  }</span>

  /**
   * @return average put time.
   */
  public Double getAverageTime() {
<span class="nc bnc" id="L132" title="All 2 branches missed.">    if (debug) {</span>
<span class="nc" id="L133">      System.out.println(totalTime + &quot; / &quot; + numberOfRuns);</span>
    }
<span class="nc" id="L135">    return 1.0 * (totalTime) / numberOfRuns;</span>
  }

  /**
   * @return the maxGetTime
   */
  public Long getMaxTime() {
<span class="nc" id="L142">    return maxGetTime;</span>
  }

  /**
   * @return the minGetTime
   */
  public Long getMinTime() {
<span class="nc" id="L149">    return minGetTime;</span>
  }

  /**
   * @return the numberOfRuns
   */
  public Long getNumberOfRuns() {
<span class="nc" id="L156">    return numberOfRuns;</span>
  }

  /**
   * @return the totalTime
   */
  public Long getTotalTime() {
<span class="nc" id="L163">    return totalTime;</span>
  }

  /**
   * Ensures that there is a Performance Evaluation sensor, depository, and
   * collector process definition.
   * 
   * @param collectorId the id of the collector to define.
   */
  private void initializePerformanceItems(String collectorId) {
<span class="nc" id="L173">    SensorModel model = SensorModelHelper.models.get(SensorModelHelper.STRESS);</span>
<span class="nc" id="L174">    Sensor stressSensor = new Sensor(&quot;Performance Evaluation Sensor&quot;,</span>
        &quot;http://performance.evaluation.sensor&quot;, model.getId(), client.getOrganizationId());
<span class="nc bnc" id="L176" title="All 2 branches missed.">    if (!client.isDefinedSensor(stressSensor.getId())) {</span>
<span class="nc" id="L177">      client.putSensor(stressSensor);</span>
    }
<span class="nc" id="L179">    MeasurementType measType = null;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">    if (client.isDefinedMeasurementType(&quot;energy-wh&quot;)) {</span>
      try {
<span class="nc" id="L182">        measType = client.getMeasurementType(&quot;energy-wh&quot;);</span>
<span class="nc" id="L183">        Depository depository = new Depository(&quot;Performance Evaluation Energy&quot;, measType,</span>
            client.getOrganizationId());
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!client.isDefinedDepository(depository.getId())) {</span>
<span class="nc" id="L186">          client.putDepository(depository);</span>
        }
<span class="nc" id="L188">        CollectorProcessDefinition cpd = new CollectorProcessDefinition(collectorId,</span>
            &quot;Performance Evaluation Collector&quot;, stressSensor.getId(), 1L, depository.getId(),
            new HashSet&lt;Property&gt;(), client.getOrganizationId());
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (!client.isDefinedCollectorProcessDefinition(cpd.getId())) {</span>
<span class="nc" id="L192">          client.putCollectorProcessDefinition(cpd);</span>
        }
      }
<span class="nc" id="L195">      catch (IdNotFoundException e) { // NOPMD</span>
        // can't happen
<span class="nc" id="L197">      }</span>
    }
<span class="nc" id="L199">  }</span>

  /**
   * The client task to time.
   */
  public abstract void clientTask();

  /*
   * (non-Javadoc)
   * 
   * @see java.util.TimerTask#run()
   */
  @Override
  public void run() {
<span class="nc" id="L213">    numberOfRuns++;</span>
<span class="nc" id="L214">    Long startTime = System.nanoTime();</span>
<span class="nc" id="L215">    clientTask();</span>
<span class="nc" id="L216">    Long endTime = System.nanoTime();</span>
<span class="nc" id="L217">    Long diff = endTime - startTime;</span>
<span class="nc" id="L218">    totalTime += diff;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (debug) {</span>
<span class="nc" id="L220">      System.out.println(&quot;time = &quot; + (diff / 1E9) + &quot; seconds.&quot;);</span>
    }
<span class="nc bnc" id="L222" title="All 2 branches missed.">    if (minGetTime &gt; diff) {</span>
<span class="nc" id="L223">      minGetTime = diff;</span>
    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (maxGetTime &lt; diff) {</span>
<span class="nc" id="L226">      maxGetTime = diff;</span>
    }
<span class="nc" id="L228">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>