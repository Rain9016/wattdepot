<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MultiThreadedCollector.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.html" class="el_package">org.wattdepot.client.http.api.collector</a> &gt; <span class="el_source">MultiThreadedCollector.java</span></div><h1>MultiThreadedCollector.java</h1><pre class="source lang-java linenums">/**
 * MultiThreadedCollector.java This file is part of WattDepot.
 *
 * Copyright (C) 2013  Cam Moore
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.wattdepot.client.http.api.collector;

import java.util.Timer;
import java.util.TimerTask;

import org.apache.commons.validator.UrlValidator;
import org.wattdepot.client.http.api.WattDepotClient;
import org.wattdepot.common.domainmodel.CollectorProcessDefinition;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorModel;
import org.wattdepot.common.exception.BadCredentialException;
import org.wattdepot.common.exception.BadSensorUriException;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.util.SensorModelHelper;
import org.wattdepot.common.util.Slug;
import org.wattdepot.common.util.tstamp.Tstamp;

/**
 * MultiThreadedCollector - Abstract base class for all Multi-Threaded
 * Collectors.
 * 
 * @author Cam Moore
 * 
 */
public abstract class MultiThreadedCollector extends TimerTask {

  /** Flag for debugging messages. */
  protected boolean debug;
  /** The definition about the collector. */
  protected CollectorProcessDefinition definition;

  /** The client used to communicate with the WattDepot server. */
  protected WattDepotClient client;
  /** The Depository for storing measurements. */
  protected Depository depository;

  /**
   * Initializes the MultiThreadedCollector.
   * 
   * @param serverUri The URI for the WattDepot server.
   * @param username The name of a user defined in the WattDepot server.
   * @param orgId the id of the organization the user is in.
   * @param password The password for the user.
   * @param collectorId The CollectorProcessDefinitionId used to initialize this
   *        collector.
   * @param debug flag for debugging messages.
   * @throws BadCredentialException if the user or password don't match the
   *         credentials in WattDepot.
   * @throws IdNotFoundException if the processId is not defined.
   * @throws BadSensorUriException if the Sensor's URI isn't valid.
   */
  public MultiThreadedCollector(String serverUri, String username, String orgId, String password,
      String collectorId, boolean debug) throws BadCredentialException, IdNotFoundException,
<span class="nc" id="L73">      BadSensorUriException {</span>
<span class="nc" id="L74">    this.client = new WattDepotClient(serverUri, username, orgId, password);</span>
<span class="nc" id="L75">    this.debug = debug;</span>
<span class="nc" id="L76">    this.definition = client.getCollectorProcessDefinition(collectorId);</span>
<span class="nc" id="L77">    this.depository = client.getDepository(definition.getDepositoryId());</span>
<span class="nc" id="L78">    validate();</span>
<span class="nc" id="L79">  }</span>

  /**
   * @param serverUri The URI for the WattDepot server.
   * @param username The name of a user defined in the WattDepot server.
   * @param orgId the id of the user's organization.
   * @param password The password for the user.
   * @param sensorId The id of the Sensor to poll.
   * @param pollingInterval The polling interval in seconds.
   * @param depository The Depository to store the measurements.
   * @param debug flag for debugging messages.
   * @throws BadCredentialException if the user or password don't match the
   *         credentials in WattDepot.
   * @throws BadSensorUriException if the Sensor's URI isn't valid.
   * @throws IdNotFoundException if there is a problem with the sensorId.
   */
  public MultiThreadedCollector(String serverUri, String username, String orgId, String password,
      String sensorId, Long pollingInterval, Depository depository, boolean debug)
<span class="nc" id="L97">      throws BadCredentialException, BadSensorUriException, IdNotFoundException {</span>
<span class="nc" id="L98">    this.client = new WattDepotClient(serverUri, username, orgId, password);</span>
<span class="nc" id="L99">    this.debug = debug;</span>
<span class="nc" id="L100">    this.definition = new CollectorProcessDefinition(Slug.slugify(sensorId + &quot; &quot; + pollingInterval</span>
        + &quot; &quot; + depository.getName()), sensorId, pollingInterval, depository.getName(), null);
<span class="nc" id="L102">    client.putCollectorProcessDefinition(definition);</span>
<span class="nc" id="L103">    this.depository = depository;</span>
<span class="nc" id="L104">    client.putDepository(depository);</span>
<span class="nc" id="L105">    validate();</span>
<span class="nc" id="L106">  }</span>

  /**
   * @return true if everything is good to go.
   */
  public boolean isValid() {
<span class="nc bnc" id="L112" title="All 4 branches missed.">    if (this.client != null &amp;&amp; this.definition != null) {</span>
<span class="nc" id="L113">      return true;</span>
    }
<span class="nc" id="L115">    return false;</span>
  }

  /**
   * @param serverUri The URI for the WattDepot server.
   * @param username The name of a user defined in the WattDepot server.
   * @param orgId the user's organization id.
   * @param password The password for the user.
   * @param collectorId The CollectorProcessDefinitionId used to initialize this
   *        collector.
   * @param debug flag for debugging messages.
   * @return true if sensor starts successfully.
   * @throws InterruptedException If sleep is interrupted for some reason.
   * @throws BadCredentialException if the username and password are invalid.
   */
  public static boolean start(String serverUri, String username, String orgId, String password,
      String collectorId, boolean debug) throws InterruptedException, BadCredentialException {

    // Before starting any sensors, confirm that we can connect to the WattDepot
    // server. We do
    // this here because if the server and sensors are running on the same
    // system, at boot time the
    // sensor might start before the server, causing client calls to fail. If
    // this happens, we
    // want to catch it at the top level, where it will result in the sensor
    // process terminating.
    // If we wait to catch it at the per-sensor level, it might cause a sensor
    // to abort for what
    // might be a short-lived problem. The sensor process should be managed by
    // some other process
    // (such as launchd), so it is OK to terminate because it should get
    // restarted if the server
    // isn't up quite yet.
<span class="nc" id="L148">    WattDepotClient staticClient = new WattDepotClient(serverUri, username, orgId, password);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">    if (!staticClient.isHealthy()) {</span>
<span class="nc" id="L150">      System.err.format(&quot;Could not connect to server %s. Aborting.%n&quot;, serverUri);</span>
      // Pause briefly to rate limit restarts if server doesn't come up for a
      // long time
<span class="nc" id="L153">      Thread.sleep(2000);</span>
<span class="nc" id="L154">      return false;</span>
    }
    // Get the collector process definition
<span class="nc" id="L157">    CollectorProcessDefinition definition = null;</span>
<span class="nc" id="L158">    Sensor sensor = null;</span>
<span class="nc" id="L159">    SensorModel model = null;</span>

    try {
<span class="nc" id="L162">      definition = staticClient.getCollectorProcessDefinition(collectorId);</span>
<span class="nc" id="L163">      staticClient.getDepository(definition.getDepositoryId());</span>
<span class="nc" id="L164">      sensor = staticClient.getSensor(definition.getSensorId());</span>
<span class="nc" id="L165">      model = staticClient.getSensorModel(sensor.getModelId());</span>
      // Get SensorModel to determine what type of collector to start.
<span class="nc bnc" id="L167" title="All 4 branches missed.">      if (model.getName().equals(SensorModelHelper.EGAUGE) &amp;&amp; model.getVersion().equals(&quot;1.0&quot;)) {</span>
<span class="nc" id="L168">        Timer t = new Timer();</span>
        try {
<span class="nc" id="L170">          EGaugeCollector collector = new EGaugeCollector(serverUri, username, sensor.getOrganizationId(),</span>
              password, collectorId, debug);
<span class="nc bnc" id="L172" title="All 2 branches missed.">          if (collector.isValid()) {</span>
<span class="nc" id="L173">            System.out.format(&quot;Started polling %s sensor at %s%n&quot;, sensor.getName(),</span>
                Tstamp.makeTimestamp());
<span class="nc" id="L175">            t.schedule(collector, 0, definition.getPollingInterval() * 1000);</span>
          }
          else {
<span class="nc" id="L178">            System.err.format(&quot;Cannot poll %s sensor%n&quot;, sensor.getName());</span>
<span class="nc" id="L179">            return false;</span>
          }
        }
<span class="nc" id="L182">        catch (BadSensorUriException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L184">          e.printStackTrace();</span>
        }
<span class="nc" id="L186">        catch (IdNotFoundException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L188">          e.printStackTrace();</span>
<span class="nc" id="L189">        }</span>
<span class="nc" id="L190">      }</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">      else if (model.getName().equals(SensorModelHelper.SHARK) &amp;&amp; model.getVersion().equals(&quot;1.03&quot;)) {</span>
<span class="nc" id="L192">        Timer t = new Timer();</span>
        try {
<span class="nc" id="L194">          SharkCollector collector = new SharkCollector(serverUri, username, orgId, password,</span>
              collectorId, debug);
<span class="nc bnc" id="L196" title="All 2 branches missed.">          if (collector.isValid()) {</span>
<span class="nc" id="L197">            System.out.format(&quot;Started polling %s sensor at %s%n&quot;, sensor.getName(),</span>
                Tstamp.makeTimestamp());
<span class="nc" id="L199">            t.schedule(collector, 0, definition.getPollingInterval() * 1000);</span>
          }
          else {
<span class="nc" id="L202">            System.err.format(&quot;Cannot poll %s sensor%n&quot;, sensor.getName());</span>
<span class="nc" id="L203">            return false;</span>
          }
        }
<span class="nc" id="L206">        catch (IdNotFoundException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L208">          e.printStackTrace();</span>
        }
<span class="nc" id="L210">        catch (BadSensorUriException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L212">          e.printStackTrace();</span>
<span class="nc" id="L213">        }</span>
<span class="nc" id="L214">      }</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">      else if (model.getName().equals(SensorModelHelper.STRESS)) {</span>
<span class="nc" id="L216">        Timer t = new Timer();</span>
        try {
<span class="nc" id="L218">          StressCollector collector = new StressCollector(serverUri, username, orgId, password, collectorId, debug);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">          if (collector.isValid()) {</span>
<span class="nc" id="L220">            System.out.format(&quot;Started polling %s sensor at %s%n&quot;, sensor.getName(),</span>
                Tstamp.makeTimestamp());
<span class="nc" id="L222">            t.schedule(collector, 0, definition.getPollingInterval() * 1000);</span>
          }
          else {
<span class="nc" id="L225">            System.err.format(&quot;Cannot poll %s sensor%n&quot;, sensor.getName());</span>
<span class="nc" id="L226">            return false;</span>
          }
        }
<span class="nc" id="L229">        catch (IdNotFoundException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L231">          e.printStackTrace();</span>
        }
<span class="nc" id="L233">        catch (BadSensorUriException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L235">          e.printStackTrace();</span>
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">      }</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">      else if (model.getName().equals(SensorModelHelper.WEATHER)) {</span>
<span class="nc" id="L239">        Timer t = new Timer();</span>
        try {
<span class="nc" id="L241">          NOAAWeatherCollector collector = new NOAAWeatherCollector(serverUri, username, orgId, password, collectorId, debug);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">          if (collector.isValid()) {</span>
<span class="nc" id="L243">            System.out.format(&quot;Started polling %s sensor at %s%n&quot;, sensor.getName(),</span>
                Tstamp.makeTimestamp());
<span class="nc" id="L245">            t.schedule(collector, 0, definition.getPollingInterval() * 1000);</span>
          }
          else {
<span class="nc" id="L248">            System.err.format(&quot;Cannot poll %s sensor%n&quot;, sensor.getName());</span>
<span class="nc" id="L249">            return false;</span>
          }
        }       
<span class="nc" id="L252">        catch (IdNotFoundException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L254">          e.printStackTrace();</span>
        }
<span class="nc" id="L256">        catch (BadSensorUriException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L258">          e.printStackTrace();</span>
<span class="nc" id="L259">        }</span>
      }
    }
<span class="nc" id="L262">    catch (IdNotFoundException e) {</span>
<span class="nc" id="L263">      System.err.println(e.getMessage());</span>
<span class="nc" id="L264">      return false;</span>
<span class="nc" id="L265">    }</span>
<span class="nc" id="L266">    return true;</span>
  }

  /**
   * @throws BadSensorUriException if the Sensor's URI isn't valid.
   * @throws IdNotFoundException if there is a problem with the Collector
   *         Process Definition.
   */
  private void validate() throws BadSensorUriException, IdNotFoundException {
<span class="nc" id="L275">    Sensor s = client.getSensor(definition.getSensorId());</span>
<span class="nc" id="L276">    String[] schemes = { &quot;http&quot;, &quot;https&quot; };</span>
<span class="nc" id="L277">    UrlValidator urlValidator = new UrlValidator(schemes);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">    if (!urlValidator.isValid(s.getUri())) {</span>
<span class="nc" id="L279">      throw new BadSensorUriException(s.getUri() + &quot; is not a valid URI.&quot;);</span>
    }
<span class="nc" id="L281">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>