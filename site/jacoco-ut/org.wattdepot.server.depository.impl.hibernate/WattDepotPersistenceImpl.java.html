<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WattDepotPersistenceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.html" class="el_package">org.wattdepot.server.depository.impl.hibernate</a> &gt; <span class="el_source">WattDepotPersistenceImpl.java</span></div><h1>WattDepotPersistenceImpl.java</h1><pre class="source lang-java linenums">/**
 * WattDepotImpl.java This file is part of WattDepot.
 *
 * Copyright (C) 2013  Cam Moore
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.wattdepot.server.depository.impl.hibernate;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.xml.datatype.XMLGregorianCalendar;

import org.hibernate.Session;
import org.hibernate.Transaction;
import org.wattdepot.common.domainmodel.CollectorProcessDefinition;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.MeasurementList;
import org.wattdepot.common.domainmodel.MeasurementPruningDefinition;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.Measurement;
import org.wattdepot.common.domainmodel.MeasurementRateSummary;
import org.wattdepot.common.domainmodel.MeasurementType;
import org.wattdepot.common.domainmodel.Organization;
import org.wattdepot.common.domainmodel.Property;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorGroup;
import org.wattdepot.common.domainmodel.SensorMeasurementSummary;
import org.wattdepot.common.domainmodel.SensorModel;
import org.wattdepot.common.domainmodel.UserInfo;
import org.wattdepot.common.domainmodel.UserPassword;
import org.wattdepot.common.exception.BadSlugException;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.MeasurementGapException;
import org.wattdepot.common.exception.MeasurementTypeException;
import org.wattdepot.common.exception.MisMatchedOwnerException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.exception.UniqueIdException;
import org.wattdepot.common.util.DateConvert;
import org.wattdepot.common.util.SensorModelHelper;
import org.wattdepot.common.util.Slug;
import org.wattdepot.common.util.tstamp.Tstamp;
import org.wattdepot.server.ServerProperties;
import org.wattdepot.server.StrongAES;
import org.wattdepot.server.WattDepotPersistence;

/**
 * WattDepotImpl - Hibernate implementation of the WattDepot abstract class.
 * 
 * @author Cam Moore
 * 
 */
public class WattDepotPersistenceImpl extends WattDepotPersistence {

  private boolean checkSession;
<span class="fc" id="L75">  private int sessionOpen = 0;</span>
<span class="fc" id="L76">  private int sessionClose = 0;</span>

  private boolean timingp;
  private Logger timingLogger;
<span class="fc" id="L80">  private String padding = &quot;&quot;;</span>
  private PersistenceCache cache;

  /**
   * Creates a new WattDepotImpl instance with the given ServerProperties.
   * 
   * @param properties The ServerProperties.
   */
  public WattDepotPersistenceImpl(ServerProperties properties) {
<span class="fc" id="L89">    super();</span>
<span class="fc" id="L90">    this.cache = new PersistenceCache();</span>
    // try {
    // Session validate = Manager.getValidateFactory(properties).openSession();
    // validate.close();
    // }
    // catch (HibernateException e) { // NOPMD
    // // e.printStackTrace();
    // // might be able to just use the 'update' sessionFactory.
    // // Session create = Manager.getCreateFactory(properties).openSession();
    // // create.close();
    // }
<span class="fc" id="L101">    setServerProperties(properties);</span>
<span class="fc" id="L102">    this.checkSession = properties.get(ServerProperties.CHECK_SESSIONS).equals(&quot;true&quot;);</span>
<span class="fc" id="L103">    timingp = properties.get(ServerProperties.SERVER_TIMING_KEY).equals(ServerProperties.TRUE);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L105">      this.timingLogger = Logger.getLogger(getClass().getName());</span>
    }
    // Start with the Organizations
<span class="fc" id="L108">    Organization pub = null;</span>
    try {
<span class="fc" id="L110">      pub = getOrganization(Organization.PUBLIC_GROUP.getId(), false);</span>
    }
<span class="nc" id="L112">    catch (IdNotFoundException e1) { // NOPMD</span>
      // this is ok. We may need to create the Organization.
<span class="fc" id="L114">    }</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">    if (pub == null) {</span>
      try {
<span class="nc" id="L117">        defineOrganization(Organization.PUBLIC_GROUP.getId(), Organization.PUBLIC_GROUP.getName(),</span>
            new HashSet&lt;String&gt;());
<span class="nc bnc" id="L119" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L120">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L123">      catch (UniqueIdException e) {</span>
        // what do we do here?
<span class="nc" id="L125">        e.printStackTrace();</span>
      }
<span class="nc" id="L127">      catch (BadSlugException e) {</span>
        // what do we do here?
<span class="nc" id="L129">        e.printStackTrace();</span>
      }
<span class="nc" id="L131">      catch (IdNotFoundException e) {</span>
        // What do we do here?
<span class="nc" id="L133">        e.printStackTrace();</span>
<span class="nc" id="L134">      }</span>
    }
    else {
      try {
<span class="fc" id="L138">        updateOrganization(pub);</span>
      }
<span class="nc" id="L140">      catch (IdNotFoundException e) {</span>
        // Should not happen.
<span class="nc" id="L142">        e.printStackTrace();</span>
<span class="fc" id="L143">      }</span>
<span class="pc bpc" id="L144" title="3 of 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L145">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="pc bpc" id="L148" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L149">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="fc" id="L151">    Organization admin = null;</span>
    try {
<span class="fc" id="L153">      admin = getOrganization(Organization.ADMIN_GROUP.getId(), false);</span>
    }
<span class="nc" id="L155">    catch (IdNotFoundException e1) { // NOPMD</span>
      // this is ok, we might need to create the organization.
<span class="fc" id="L157">    }</span>
<span class="pc bpc" id="L158" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L159">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">    if (admin == null) {</span>
      try {
<span class="nc" id="L163">        defineOrganization(Organization.ADMIN_GROUP.getId(), Organization.ADMIN_GROUP.getName(),</span>
            new HashSet&lt;String&gt;());
<span class="nc bnc" id="L165" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L166">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L169">      catch (UniqueIdException e) {</span>
        // what do we do here?
<span class="nc" id="L171">        e.printStackTrace();</span>
      }
<span class="nc" id="L173">      catch (BadSlugException e) {</span>
        // what do we do here?
<span class="nc" id="L175">        e.printStackTrace();</span>
      }
<span class="nc" id="L177">      catch (IdNotFoundException e) {</span>
        // what do we do here?
<span class="nc" id="L179">        e.printStackTrace();</span>
<span class="nc" id="L180">      }</span>
    }
    else {
      try {
<span class="fc" id="L184">        updateOrganization(admin);</span>
      }
<span class="nc" id="L186">      catch (IdNotFoundException e) {</span>
        // Should not happen.
<span class="nc" id="L188">        e.printStackTrace();</span>
<span class="fc" id="L189">      }</span>
<span class="pc bpc" id="L190" title="3 of 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L191">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="fc" id="L194">    UserInfo adminUser = null;</span>
    try {
<span class="fc" id="L196">      adminUser = getUser(UserInfo.ROOT.getUid(), Organization.ADMIN_GROUP.getId(), false);</span>
    }
<span class="nc" id="L198">    catch (IdNotFoundException e) {</span>
      try {
<span class="nc" id="L200">        defineUserInfo(UserInfo.ROOT.getUid(), UserInfo.ROOT.getFirstName(),</span>
            UserInfo.ROOT.getLastName(), UserInfo.ROOT.getEmail(),
            Organization.ADMIN_GROUP.getId(), UserInfo.ROOT.getProperties(), StrongAES
                .getInstance().decrypt(UserPassword.ROOT.getEncryptedPassword()));
<span class="nc bnc" id="L204" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L205">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L208">      catch (UniqueIdException e1) {</span>
        // what do we do here?
<span class="nc" id="L210">        e1.printStackTrace();</span>
      }
<span class="nc" id="L212">      catch (IdNotFoundException e1) {</span>
        // this shouldn't happen
<span class="nc" id="L214">        e1.printStackTrace();</span>
<span class="nc" id="L215">      }</span>
<span class="fc" id="L216">    }</span>
<span class="pc bpc" id="L217" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L218">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    if (adminUser != null) {</span>
      try {
<span class="nc" id="L222">        updateUserInfo(UserInfo.ROOT);</span>
      }
<span class="nc" id="L224">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L225">        e.printStackTrace();</span>
<span class="nc" id="L226">      }</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L228">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">    if (!Organization.ADMIN_GROUP.getUsers().contains(UserInfo.ROOT.getUid())) {</span>
<span class="nc" id="L232">      Organization.ADMIN_GROUP.add(UserInfo.ROOT.getUid());</span>
      try {
<span class="nc" id="L234">        updateOrganization(Organization.ADMIN_GROUP);</span>
      }
<span class="nc" id="L236">      catch (IdNotFoundException e) { // NOPMD</span>
        // There is a problem
<span class="nc" id="L238">      }</span>
    }

    UserPassword adminPassword;
    try {
<span class="nc" id="L243">      adminPassword = getUserPassword(UserInfo.ROOT.getUid(), UserInfo.ROOT.getOrganizationId(),</span>
          false);
<span class="nc" id="L245">      updateUserPassword(adminPassword);</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L247">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="fc" id="L250">    catch (IdNotFoundException e2) { // NOPMD</span>
      // adminPassword no defined.
      // we are in trouble.
<span class="nc" id="L253">    }</span>
<span class="pc bpc" id="L254" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L255">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }

<span class="fc" id="L258">  }</span>


  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#defineCollectorProcessDefinition(java.lang
   * .String, java.lang.String, java.lang.Long, java.lang.String,
   * java.lang.String)
   */
  @Override
  public CollectorProcessDefinition defineCollectorProcessDefinition(String id, String name,
      String sensorId, Long pollingInterval, String depositoryId, Set&lt;Property&gt; properties,
      String orgId) throws UniqueIdException, MisMatchedOwnerException, IdNotFoundException,
      BadSlugException {
<span class="fc" id="L274">    getOrganization(orgId, true);</span>
<span class="fc" id="L275">    getSensor(sensorId, orgId, true);</span>
<span class="fc" id="L276">    getDepository(depositoryId, orgId, true);</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L278">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
    try {
<span class="fc" id="L281">      CollectorProcessDefinition cpd = getCollectorProcessDefinition(id, orgId, true);</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">      if (cpd != null) {</span>
<span class="fc" id="L283">        throw new UniqueIdException(id + &quot; is already a CollectorProcessDefinition id.&quot;);</span>
      }
    }
<span class="fc" id="L286">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is expected.
<span class="nc" id="L288">    }</span>
<span class="fc" id="L289">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L290">    sessionOpen++;</span>
<span class="fc" id="L291">    session.beginTransaction();</span>
<span class="fc" id="L292">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L293">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="fc" id="L294">    DepositoryImpl depot = retrieveDepository(session, depositoryId, orgId);</span>
<span class="fc" id="L295">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">    for (Property p : properties) {</span>
<span class="nc" id="L297">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L298">    }</span>
<span class="fc" id="L299">    CollectorProcessDefinitionImpl impl = new CollectorProcessDefinitionImpl(id, name, sensor,</span>
        pollingInterval, depot, props, org);
<span class="fc" id="L301">    storeCollectorProcessDefinition(session, impl);</span>
<span class="fc" id="L302">    session.getTransaction().commit();</span>
<span class="fc" id="L303">    session.close();</span>
<span class="fc" id="L304">    sessionClose++;</span>
<span class="fc" id="L305">    return impl.toCPD();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineWattDepository(java.lang.String,
   * java.lang.String, java.lang.String, org.wattdepot.datamodel.Organization)
   */
  @Override
  public Depository defineDepository(String id, String name, MeasurementType measurementType,
      String orgId) throws UniqueIdException, IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L318">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L320">    getOrganization(orgId, true);</span>
<span class="fc" id="L321">    getMeasurementType(measurementType.getId(), true);</span>
<span class="fc" id="L322">    Depository d = null;</span>
    try {
<span class="fc" id="L324">      d = getDepository(id, orgId, true);</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">      if (d != null) {</span>
<span class="fc" id="L326">        throw new UniqueIdException(name + &quot; is already a Depository name.&quot;);</span>
      }
    }
<span class="fc" id="L329">    catch (IdNotFoundException e) { // NOPMD</span>
      // ok since we are defining it.
<span class="nc" id="L331">    }</span>
<span class="fc" id="L332">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L333">    sessionOpen++;</span>
<span class="fc" id="L334">    session.beginTransaction();</span>
<span class="fc" id="L335">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L336">    MeasurementTypeImpl type = retrieveMeasurementType(session, measurementType.getId());</span>
<span class="fc" id="L337">    DepositoryImpl impl = new DepositoryImpl(id, name, type, org);</span>
<span class="fc" id="L338">    d = impl.toDepository();</span>
<span class="fc" id="L339">    session.save(impl);</span>
<span class="fc" id="L340">    session.getTransaction().commit();</span>
<span class="fc" id="L341">    session.close();</span>
<span class="fc" id="L342">    sessionClose++;</span>
<span class="fc" id="L343">    cache.putDepository(d);</span>
<span class="fc" id="L344">    return d;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#defineMeasurementPruningDefinition
   * (java.lang.String, java.lang.String, java.lang.String, java.lang.String,
   * java.lang.String, java.lang.Integer, java.lang.Integer, java.lang.Integer)
   */
  @Override
  public MeasurementPruningDefinition defineMeasurementPruningDefinition(String id, String name,
      String depositoryId, String sensorId, String orgId, Integer ignore, Integer collect,
      Integer gap) throws UniqueIdException, BadSlugException, IdNotFoundException {
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L360">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L362">    getOrganization(orgId, true);</span>
<span class="fc" id="L363">    getDepository(depositoryId, orgId, true);</span>
    try {
<span class="fc" id="L365">      getSensor(sensorId, orgId, true);</span>
    }
<span class="nc" id="L367">    catch (IdNotFoundException e) {</span>
<span class="nc" id="L368">      getSensorGroup(sensorId, orgId, true);</span>
<span class="fc" id="L369">    }</span>
<span class="fc" id="L370">    MeasurementPruningDefinition gcd = null;</span>
    try {
<span class="fc" id="L372">      gcd = getMeasurementPruningDefinition(id, orgId, true);</span>
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">      if (gcd != null) {</span>
<span class="fc" id="L374">        throw new UniqueIdException(name + &quot; is already a MeasurementPruningDefinition name.&quot;);</span>
      }
    }
<span class="fc" id="L377">    catch (IdNotFoundException e) { // NOPMD</span>
      // ok since we are defining it.
<span class="nc" id="L379">    }</span>
<span class="fc" id="L380">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L381">    sessionOpen++;</span>
<span class="fc" id="L382">    session.beginTransaction();</span>
<span class="fc" id="L383">    DepositoryImpl dep = retrieveDepository(session, depositoryId, orgId);</span>
<span class="fc" id="L384">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L385">    MeasurementPruningDefinitionImpl impl = new MeasurementPruningDefinitionImpl(id, name, dep,</span>
        sensorId, org, ignore, collect, gap);
<span class="fc" id="L387">    gcd = impl.toMPD();</span>
<span class="fc" id="L388">    session.save(impl);</span>
<span class="fc" id="L389">    session.getTransaction().commit();</span>
<span class="fc" id="L390">    session.close();</span>
<span class="fc" id="L391">    sessionClose++;</span>
<span class="fc" id="L392">    return gcd;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineMeasurementType(java.lang.String,
   * java.lang.String)
   */
  @Override
  public MeasurementType defineMeasurementType(String id, String name, String units)
      throws UniqueIdException, BadSlugException {
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L405">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L407">    MeasurementType mt = null;</span>
    try {
<span class="nc" id="L409">      mt = getMeasurementType(id, true);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">      if (mt != null) {</span>
<span class="nc" id="L411">        throw new UniqueIdException(id + &quot; is already a MeasurementType id.&quot;);</span>
      }
    }
<span class="fc" id="L414">    catch (IdNotFoundException e) { // NOPMD</span>
      // expected.
<span class="nc" id="L416">    }</span>
<span class="fc" id="L417">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L418">    sessionOpen++;</span>
<span class="fc" id="L419">    session.beginTransaction();</span>
<span class="fc" id="L420">    MeasurementTypeImpl impl = new MeasurementTypeImpl(id, name, units);</span>
<span class="fc" id="L421">    session.save(impl);</span>
<span class="fc" id="L422">    session.getTransaction().commit();</span>
<span class="fc" id="L423">    session.close();</span>
<span class="fc" id="L424">    sessionClose++;</span>
<span class="fc" id="L425">    return mt;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineOrganization(java.lang.String,
   * java.util.Set&lt;String&gt;)
   */
  @Override
  public Organization defineOrganization(String id, String name, Set&lt;String&gt; users)
      throws UniqueIdException, BadSlugException, IdNotFoundException {
<span class="fc" id="L437">    Long startTime = 0l;</span>
<span class="fc" id="L438">    Long endTime = 0l;</span>
<span class="fc" id="L439">    Long diff = 0l;</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L441">      timingLogger.log(Level.SEVERE, padding + &quot;Start defineOrganizations()&quot;);</span>
<span class="nc" id="L442">      padding += &quot;  &quot;;</span>
<span class="nc" id="L443">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L445">    Organization ret = null;</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L447">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
    Organization g;
    try {
<span class="nc" id="L451">      g = getOrganization(id, true);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">      if (g != null) {</span>
<span class="nc" id="L453">        throw new UniqueIdException(id + &quot; is already a Organization id.&quot;);</span>
      }
    }
<span class="fc" id="L456">    catch (IdNotFoundException e) { // NOPMD</span>
      // is ok.
<span class="nc" id="L458">    }</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">    for (String uid : users) {</span>
<span class="nc" id="L460">      getUser(uid, id, true);</span>
<span class="nc" id="L461">    }</span>
<span class="fc" id="L462">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L463">    sessionOpen++;</span>
<span class="fc" id="L464">    session.beginTransaction();</span>
<span class="fc" id="L465">    Set&lt;UserInfoImpl&gt; u = new HashSet&lt;UserInfoImpl&gt;();</span>
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">    for (String uid : users) {</span>
<span class="nc" id="L467">      u.add(retrieveUser(session, uid, id));</span>
<span class="nc" id="L468">    }</span>
<span class="fc" id="L469">    OrganizationImpl impl = new OrganizationImpl(id, name, u);</span>
<span class="fc" id="L470">    ret = impl.toOrganization();</span>
<span class="fc" id="L471">    session.save(impl);</span>
<span class="fc" id="L472">    session.getTransaction().commit();</span>
<span class="fc" id="L473">    session.close();</span>
<span class="fc" id="L474">    sessionClose++;</span>
<span class="fc" id="L475">    cache.putOrganization(ret);</span>
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L477">      endTime = System.nanoTime();</span>
<span class="nc" id="L478">      diff = endTime - startTime;</span>
<span class="nc" id="L479">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L480">      timingLogger</span>
          .log(Level.SEVERE, padding + &quot;defineOrganization() took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L483">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensor(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String, java.lang.String)
   */
  @Override
  public Sensor defineSensor(String id, String name, String uri, String modelId,
      Set&lt;Property&gt; properties, String orgId) throws UniqueIdException, MisMatchedOwnerException,
      IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L497">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L499">    getOrganization(orgId, true);</span>
<span class="fc" id="L500">    getSensorModel(modelId, true);</span>
<span class="fc" id="L501">    Sensor s = null;</span>
    try {
<span class="fc" id="L503">      s = getSensor(id, orgId, true);</span>
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">      if (s != null) {</span>
<span class="fc" id="L505">        throw new UniqueIdException(id + &quot; is already a defined Sensor.&quot;);</span>
      }
    }
<span class="fc" id="L508">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is expected.
<span class="nc" id="L510">    }</span>
<span class="fc" id="L511">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L512">    sessionOpen++;</span>
<span class="fc" id="L513">    session.beginTransaction();</span>
<span class="fc" id="L514">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L515">    SensorModelImpl model = retrieveSensorModel(session, modelId);</span>
<span class="fc" id="L516">    Set&lt;PropertyImpl&gt; prop = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">    for (Property p : properties) {</span>
<span class="nc" id="L518">      prop.add(new PropertyImpl(p));</span>
<span class="nc" id="L519">    }</span>
<span class="fc" id="L520">    SensorImpl impl = new SensorImpl(id, name, uri, model, prop, org);</span>
<span class="fc" id="L521">    s = impl.toSensor();</span>
<span class="fc" id="L522">    storeSensor(session, impl);</span>
<span class="fc" id="L523">    session.getTransaction().commit();</span>
<span class="fc" id="L524">    session.close();</span>
<span class="fc" id="L525">    sessionClose++;</span>
<span class="fc" id="L526">    cache.putSensor(s);</span>
<span class="fc" id="L527">    return s;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensorGroup(java.lang.String,
   * java.util.List, org.wattdepot.datamodel.Organization)
   */
  @Override
  public SensorGroup defineSensorGroup(String id, String name, Set&lt;String&gt; sensorIds, String orgId)
      throws UniqueIdException, MisMatchedOwnerException, IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L540">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L542">    Organization owner = getOrganization(orgId, true);</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">    for (String sensorId : sensorIds) {</span>
<span class="fc" id="L544">      Sensor sensor = getSensor(sensorId, orgId, true);</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">      if (!orgId.equals(sensor.getOrganizationId())) {</span>
<span class="nc" id="L546">        throw new MisMatchedOwnerException(orgId + &quot; is not the owner of all the sensors.&quot;);</span>
      }
<span class="fc" id="L548">    }</span>
<span class="fc" id="L549">    SensorGroup sg = null;</span>
    try {
<span class="nc" id="L551">      sg = getSensorGroup(id, owner.getId(), true);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">      if (sg != null) {</span>
<span class="nc" id="L553">        throw new UniqueIdException(id + &quot; is already a SensorGroup id.&quot;);</span>
      }
    }
<span class="fc" id="L556">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is ok since we are defining it.
<span class="nc" id="L558">    }</span>
<span class="fc" id="L559">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L560">    sessionOpen++;</span>
<span class="fc" id="L561">    session.beginTransaction();</span>
<span class="fc" id="L562">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L563">    Set&lt;SensorImpl&gt; sensors = new HashSet&lt;SensorImpl&gt;();</span>
<span class="fc bfc" id="L564" title="All 2 branches covered.">    for (String sensorId : sensorIds) {</span>
<span class="fc" id="L565">      sensors.add(retrieveSensor(session, sensorId, orgId));</span>
<span class="fc" id="L566">    }</span>
<span class="fc" id="L567">    SensorGroupImpl impl = new SensorGroupImpl(id, name, sensors, org);</span>
<span class="fc" id="L568">    session.save(impl);</span>
<span class="fc" id="L569">    session.getTransaction().commit();</span>
<span class="fc" id="L570">    session.close();</span>
<span class="fc" id="L571">    sessionClose++;</span>
<span class="fc" id="L572">    return sg;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensorModel(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String,
   * org.wattdepot.datamodel.Organization)
   */
  @Override
  public SensorModel defineSensorModel(String id, String name, String protocol, String type,
      String version) throws UniqueIdException, BadSlugException {
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L586">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L588">    SensorModel sm = null;</span>
    try {
<span class="nc" id="L590">      sm = getSensorModel(id, true);</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">      if (sm != null) {</span>
<span class="nc" id="L592">        throw new UniqueIdException(id + &quot; is already a SensorModel id.&quot;);</span>
      }
    }
<span class="fc" id="L595">    catch (IdNotFoundException e) { // NOPMD</span>
      // expected.
<span class="nc" id="L597">    }</span>
<span class="fc" id="L598">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L599">    sessionOpen++;</span>
<span class="fc" id="L600">    session.beginTransaction();</span>
<span class="fc" id="L601">    SensorModelImpl impl = new SensorModelImpl(id, name, protocol, type, version);</span>
<span class="fc" id="L602">    session.save(impl);</span>
<span class="fc" id="L603">    session.getTransaction().commit();</span>
<span class="fc" id="L604">    session.close();</span>
<span class="fc" id="L605">    sessionClose++;</span>
<span class="fc" id="L606">    return sm;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineUserInfo(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String, java.lang.String,
   * java.lang.Boolean, java.util.Set)
   */
  @Override
  public UserInfo defineUserInfo(String id, String firstName, String lastName, String email,
      String orgId, Set&lt;Property&gt; properties, String password) throws UniqueIdException,
      IdNotFoundException {
<span class="fc" id="L620">    getOrganization(orgId, true);</span>
<span class="fc" id="L621">    UserInfo u = null;</span>
    try {
<span class="nc" id="L623">      u = getUser(id, orgId, true);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">      if (u != null) {</span>
<span class="nc" id="L625">        throw new UniqueIdException(id + &quot; is already a UserInfo id.&quot;);</span>
      }
    }
<span class="fc" id="L628">    catch (IdNotFoundException e) { // NOPMD</span>
      // excpected since we are defining a new user.
<span class="nc" id="L630">    }</span>
<span class="fc" id="L631">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L632">    sessionOpen++;</span>
<span class="fc" id="L633">    session.beginTransaction();</span>
<span class="fc" id="L634">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L635">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="fc bfc" id="L636" title="All 2 branches covered.">    for (Property p : properties) {</span>
<span class="fc" id="L637">      PropertyImpl pi = new PropertyImpl(p);</span>
<span class="fc" id="L638">      props.add(pi);</span>
<span class="fc" id="L639">      session.saveOrUpdate(pi);</span>
<span class="fc" id="L640">    }</span>
<span class="fc" id="L641">    UserInfoImpl impl = new UserInfoImpl(id, firstName, lastName, email, props, org);</span>
<span class="fc" id="L642">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L643">    u = impl.toUserInfo();</span>
<span class="fc" id="L644">    UserPasswordImpl up = new UserPasswordImpl(impl, password, org);</span>
<span class="fc" id="L645">    session.saveOrUpdate(up);</span>
<span class="fc" id="L646">    session.getTransaction().commit();</span>
<span class="fc" id="L647">    session.close();</span>
<span class="fc" id="L648">    sessionClose++;</span>
<span class="fc" id="L649">    return u;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#deleteCollectorProcessDefinition(java.lang
   * .String, java.lang.String)
   */
  @Override
  public void deleteCollectorProcessDefinition(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L662">    getCollectorProcessDefinition(id, orgId, true);</span>
<span class="fc" id="L663">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L664">    sessionOpen++;</span>
<span class="fc" id="L665">    session.beginTransaction();</span>
<span class="fc" id="L666">    CollectorProcessDefinitionImpl impl = retrieveCollectorProcessDefinition(session, id, orgId);</span>
<span class="fc" id="L667">    session.delete(impl);</span>
<span class="fc" id="L668">    session.getTransaction().commit();</span>
<span class="fc" id="L669">    session.close();</span>
<span class="fc" id="L670">    sessionClose++;</span>
<span class="fc" id="L671">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteWattDepository(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteDepository(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L682">    Depository d = getDepository(id, orgId, true);</span>
<span class="fc" id="L683">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L684">    sessionOpen++;</span>
<span class="fc" id="L685">    session.beginTransaction();</span>
<span class="fc" id="L686">    DepositoryImpl impl = retrieveDepository(session, id, orgId);</span>
<span class="fc bfc" id="L687" title="All 2 branches covered.">    for (DepositorySensorContribution dsc : retrieveContributions(session, impl)) {</span>
<span class="fc" id="L688">      session.delete(dsc);</span>
<span class="fc" id="L689">    }</span>
<span class="fc" id="L690">    session.delete(impl);</span>
<span class="fc" id="L691">    session.getTransaction().commit();</span>
<span class="fc" id="L692">    session.close();</span>
<span class="fc" id="L693">    sessionClose++;</span>
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">    if (d != null) {</span>
<span class="fc" id="L695">      cache.deleteDepository(d);</span>
    }
<span class="fc" id="L697">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#deleteMeasurementPruningDefinition
   * (java.lang.String)
   */
  @Override
  public void deleteMeasurementPruningDefinition(String id, String orgId) throws IdNotFoundException {
<span class="fc" id="L708">    getMeasurementPruningDefinition(id, orgId, true);</span>
<span class="fc" id="L709">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L710">    sessionOpen++;</span>
<span class="fc" id="L711">    session.beginTransaction();</span>
<span class="fc" id="L712">    MeasurementPruningDefinitionImpl impl = retrieveMeasurementPruningDefinition(session, id, orgId);</span>
<span class="fc" id="L713">    session.delete(impl);</span>
<span class="fc" id="L714">    session.getTransaction().commit();</span>
<span class="fc" id="L715">    session.close();</span>
<span class="fc" id="L716">    sessionClose++;</span>
<span class="fc" id="L717">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#deleteMeasurement(java.lang.String
   * , java.lang.String)
   */
  @Override
  public void deleteMeasurement(String depotId, String orgId, String measId)
      throws IdNotFoundException {
<span class="fc" id="L729">    Long startTime = 0l;</span>
<span class="fc" id="L730">    Long endTime = 0l;</span>
<span class="fc" id="L731">    Long diff = 0l;</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L733">      timingLogger.log(Level.SEVERE, padding + &quot;Start deleteMeasurement(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L735">      padding += &quot;  &quot;;</span>
<span class="nc" id="L736">      startTime = System.nanoTime();</span>
    }
//    getOrganization(orgId, true);
//    getDepository(depotId, orgId, true);
//    getMeasurement(depotId, orgId, measId, true);
<span class="fc" id="L741">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L742">    session.beginTransaction();</span>
<span class="fc" id="L743">    MeasurementImpl impl = retrieveMeasurement(session, depotId, orgId, measId);</span>
<span class="fc bfc" id="L744" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L745">      session.delete(impl);</span>
    }
    else {
<span class="fc" id="L748">      throw new IdNotFoundException(measId + &quot; is not a valid measurment id.&quot;);</span>
    }
<span class="fc" id="L750">    session.getTransaction().commit();</span>
<span class="fc" id="L751">    session.close();</span>
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L753">      endTime = System.nanoTime();</span>
<span class="nc" id="L754">      diff = endTime - startTime;</span>
<span class="nc" id="L755">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L756">      timingLogger.log(Level.SEVERE, padding + &quot;deleteMeasurement(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }    
<span class="fc" id="L759">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteMeasurementType(java.lang.String)
   */
  @Override
  public void deleteMeasurementType(String id) throws IdNotFoundException {
<span class="fc" id="L768">    getMeasurementType(id, true);</span>
<span class="fc" id="L769">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L770">    sessionOpen++;</span>
<span class="fc" id="L771">    session.beginTransaction();</span>
<span class="fc" id="L772">    MeasurementTypeImpl impl = retrieveMeasurementType(session, id);</span>
<span class="fc" id="L773">    List&lt;DepositoryImpl&gt; depositories = retrieveDepositories(session, impl);</span>
<span class="fc" id="L774">    session.getTransaction().commit();</span>
<span class="fc" id="L775">    session.close();</span>
<span class="fc" id="L776">    sessionClose++;</span>
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">    for (DepositoryImpl depository : depositories) {</span>
      try {
<span class="nc" id="L779">        deleteDepository(depository.getId(), depository.getOrg().getId());</span>
      }
<span class="nc" id="L781">      catch (MisMatchedOwnerException e) {</span>
        // Shouldn't happen
<span class="nc" id="L783">        e.printStackTrace();</span>
<span class="nc" id="L784">      }</span>
<span class="nc" id="L785">    }</span>
<span class="fc" id="L786">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L787">    sessionOpen++;</span>
<span class="fc" id="L788">    session.beginTransaction();</span>
<span class="fc" id="L789">    impl = retrieveMeasurementType(session, id);</span>
<span class="fc" id="L790">    session.delete(impl);</span>
<span class="fc" id="L791">    session.getTransaction().commit();</span>
<span class="fc" id="L792">    session.close();</span>
<span class="fc" id="L793">    sessionClose++;</span>
<span class="fc" id="L794">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteOrganization(java.lang.String)
   */
  @Override
  public void deleteOrganization(String id) throws IdNotFoundException {
<span class="fc" id="L803">    Organization o = getOrganization(id, true);</span>
    // Remove Organization owned CollectorProcessDefinitions
<span class="fc" id="L805">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L806">    sessionOpen++;</span>
<span class="fc" id="L807">    session.beginTransaction();</span>
<span class="pc bpc" id="L808" title="1 of 2 branches missed.">    for (CollectorProcessDefinitionImpl sp : retrieveCollectorProcessDefinitions(session, id)) {</span>
<span class="nc" id="L809">      session.delete(sp);</span>
<span class="nc" id="L810">    }</span>
<span class="fc" id="L811">    session.getTransaction().commit();</span>
<span class="fc" id="L812">    session.close();</span>
<span class="fc" id="L813">    sessionClose++;</span>
    // Remove Organization owned MeasurementPruningDefinitions
<span class="fc" id="L815">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L816">    sessionOpen++;</span>
<span class="fc" id="L817">    session.beginTransaction();</span>
<span class="pc bpc" id="L818" title="1 of 2 branches missed.">    for (MeasurementPruningDefinitionImpl sp : retrieveMeasurementPruningDefinitions(session, id)) {</span>
<span class="nc" id="L819">      session.delete(sp);</span>
<span class="nc" id="L820">    }</span>
<span class="fc" id="L821">    session.getTransaction().commit();</span>
<span class="fc" id="L822">    session.close();</span>
<span class="fc" id="L823">    sessionClose++;</span>
    // Remove Organization owned SensorGroups
<span class="fc" id="L825">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L826">    sessionOpen++;</span>
<span class="fc" id="L827">    session.beginTransaction();</span>
<span class="fc bfc" id="L828" title="All 2 branches covered.">    for (SensorGroupImpl sg : retrieveSensorGroups(session, id)) {</span>
<span class="fc" id="L829">      session.delete(sg);</span>
<span class="fc" id="L830">    }</span>
<span class="fc" id="L831">    session.getTransaction().commit();</span>
<span class="fc" id="L832">    session.close();</span>
<span class="fc" id="L833">    sessionClose++;</span>
    // Remove Organization owned Measurements
<span class="fc" id="L835">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L836">    sessionOpen++;</span>
<span class="fc" id="L837">    session.beginTransaction();</span>
<span class="fc bfc" id="L838" title="All 2 branches covered.">    for (DepositoryImpl d : retrieveDepositories(session, id)) {</span>
<span class="fc bfc" id="L839" title="All 2 branches covered.">      for (String sensorId : listSensors(d.getId(), id, true)) {</span>
<span class="fc bfc" id="L840" title="All 2 branches covered.">        for (Measurement m : getMeasurements(d.getId(), id, sensorId, true)) {</span>
<span class="fc" id="L841">          MeasurementImpl mi = retrieveMeasurement(session, d.getId(), id, m.getId());</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">          if (mi != null) {</span>
<span class="fc" id="L843">            session.delete(mi);</span>
          }
<span class="fc" id="L845">        }</span>
<span class="fc" id="L846">      }</span>
<span class="fc" id="L847">    }</span>
<span class="fc" id="L848">    session.getTransaction().commit();</span>
<span class="fc" id="L849">    session.close();</span>
<span class="fc" id="L850">    sessionClose++;</span>
    // Remove Organization owned Depositories and Sensors
<span class="fc" id="L852">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L853">    sessionOpen++;</span>
<span class="fc" id="L854">    session.beginTransaction();</span>
<span class="fc" id="L855">    List&lt;DepositoryImpl&gt; depositories = retrieveDepositories(session, id);</span>
<span class="fc bfc" id="L856" title="All 2 branches covered.">    for (DepositoryImpl d : depositories) {</span>
<span class="fc bfc" id="L857" title="All 2 branches covered.">      for (DepositorySensorContribution dsc : retrieveContributions(session, d)) {</span>
<span class="fc" id="L858">        session.delete(dsc);</span>
<span class="fc" id="L859">      }</span>
<span class="fc" id="L860">      session.delete(d);</span>
<span class="fc" id="L861">    }</span>
<span class="fc bfc" id="L862" title="All 2 branches covered.">    for (SensorImpl s : retrieveSensors(session, id)) {</span>
<span class="fc" id="L863">      session.delete(s);</span>
<span class="fc" id="L864">    }</span>
<span class="fc" id="L865">    session.getTransaction().commit();</span>
<span class="fc" id="L866">    session.close();</span>
<span class="fc" id="L867">    sessionClose++;</span>
    // Remove Organization owned SensorModels
<span class="fc" id="L869">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L870">    sessionOpen++;</span>
<span class="fc" id="L871">    session.beginTransaction();</span>
<span class="fc bfc" id="L872" title="All 2 branches covered.">    for (SensorModelImpl sm : retrieveSensorModels(session)) {</span>
<span class="fc bfc" id="L873" title="All 2 branches covered.">      if (!SensorModelHelper.models.containsKey(sm.getName())) {</span>
<span class="fc" id="L874">        session.delete(sm);</span>
      }
<span class="fc" id="L876">    }</span>
<span class="fc" id="L877">    session.getTransaction().commit();</span>
<span class="fc" id="L878">    session.close();</span>
<span class="fc" id="L879">    sessionClose++;</span>
    // Remove Users in the Organization
<span class="fc" id="L881">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L882">    sessionOpen++;</span>
<span class="fc" id="L883">    session.beginTransaction();</span>
<span class="fc" id="L884">    OrganizationImpl orgImpl = retrieveOrganization(session, id);</span>
<span class="fc bfc" id="L885" title="All 2 branches covered.">    for (UserInfoImpl u : retrieveUsers(session, id)) {</span>
<span class="fc" id="L886">      orgImpl.getUsers().remove(u);</span>
<span class="fc" id="L887">      session.delete(u);</span>
<span class="fc" id="L888">    }</span>
<span class="fc" id="L889">    session.update(orgImpl);</span>
<span class="fc bfc" id="L890" title="All 2 branches covered.">    for (UserPasswordImpl u : retrieveUserPasswords(session, id)) {</span>
<span class="fc" id="L891">      session.delete(u);</span>
<span class="fc" id="L892">    }</span>
<span class="fc" id="L893">    session.getTransaction().commit();</span>
<span class="fc" id="L894">    session.close();</span>
<span class="fc" id="L895">    sessionClose++;</span>
    // Remove the organization
<span class="fc" id="L897">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L898">    sessionOpen++;</span>
<span class="fc" id="L899">    session.beginTransaction();</span>
<span class="fc" id="L900">    orgImpl = retrieveOrganization(session, id);</span>
<span class="fc" id="L901">    session.delete(orgImpl);</span>
<span class="fc" id="L902">    session.getTransaction().commit();</span>
<span class="fc" id="L903">    session.close();</span>
<span class="fc" id="L904">    sessionClose++;</span>
<span class="pc bpc" id="L905" title="1 of 2 branches missed.">    if (o != null) {</span>
<span class="fc" id="L906">      cache.deleteOrganization(o);</span>
    }
<span class="fc" id="L908">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensor(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensor(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L919">    Sensor s = getSensor(id, orgId, true);</span>
<span class="fc" id="L920">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L921">    sessionOpen++;</span>
<span class="fc" id="L922">    session.beginTransaction();</span>
<span class="fc" id="L923">    SensorImpl impl = retrieveSensor(session, id, orgId);</span>
<span class="pc bpc" id="L924" title="1 of 2 branches missed.">    for (DepositorySensorContribution dsc : retrieveContributions(session, impl)) {</span>
<span class="nc" id="L925">      session.delete(dsc);</span>
<span class="nc" id="L926">    }</span>
<span class="fc" id="L927">    session.delete(impl);</span>
<span class="fc" id="L928">    session.getTransaction().commit();</span>
<span class="fc" id="L929">    session.close();</span>
<span class="fc" id="L930">    sessionClose++;</span>
<span class="pc bpc" id="L931" title="1 of 2 branches missed.">    if (s != null) {</span>
<span class="fc" id="L932">      cache.deleteSensor(s);</span>
    }
<span class="fc" id="L934">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensorGroup(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensorGroup(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L945">    getSensorGroup(id, orgId, true);</span>
<span class="fc" id="L946">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L947">    sessionOpen++;</span>
<span class="fc" id="L948">    session.beginTransaction();</span>
<span class="fc" id="L949">    SensorGroupImpl impl = retrieveSensorGroup(session, id, orgId);</span>
<span class="fc" id="L950">    session.delete(impl);</span>
<span class="fc" id="L951">    session.getTransaction().commit();</span>
<span class="fc" id="L952">    session.close();</span>
<span class="fc" id="L953">    sessionClose++;</span>
<span class="fc" id="L954">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensorModel(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensorModel(String id) throws IdNotFoundException {
<span class="fc" id="L964">    getSensorModel(id, true);</span>
<span class="fc" id="L965">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L966">    sessionOpen++;</span>
<span class="fc" id="L967">    session.beginTransaction();</span>
<span class="fc" id="L968">    SensorModelImpl impl = retrieveSensorModel(session, id);</span>
<span class="fc" id="L969">    session.delete(impl);</span>
<span class="fc" id="L970">    session.getTransaction().commit();</span>
<span class="fc" id="L971">    session.close();</span>
<span class="fc" id="L972">    sessionClose++;</span>
<span class="fc" id="L973">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteUser(java.lang.String)
   */
  @Override
  public void deleteUser(String id, String orgId) throws IdNotFoundException {
<span class="fc" id="L982">    getUser(id, orgId, true);</span>
<span class="fc" id="L983">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L984">    sessionOpen++;</span>
<span class="fc" id="L985">    session.beginTransaction();</span>
<span class="fc" id="L986">    OrganizationImpl orgImpl = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L987">    UserInfoImpl impl = retrieveUser(session, id, orgId);</span>
<span class="fc" id="L988">    UserPasswordImpl up = retrieveUserPassword(session, id, orgId);</span>
<span class="fc" id="L989">    orgImpl.removeUser(impl);</span>
<span class="fc" id="L990">    session.saveOrUpdate(orgImpl);</span>
<span class="fc" id="L991">    session.delete(up);</span>
<span class="fc" id="L992">    session.delete(impl);</span>
<span class="fc" id="L993">    session.getTransaction().commit();</span>
<span class="fc" id="L994">    session.close();</span>
<span class="fc" id="L995">    sessionClose++;</span>
<span class="fc" id="L996">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteUserPassword(java.lang.String)
   */
  @Override
  public void deleteUserPassword(String userId, String orgId) throws IdNotFoundException {
<span class="fc" id="L1005">    getUserPassword(userId, orgId, true);</span>
<span class="fc" id="L1006">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1007">    sessionOpen++;</span>
<span class="fc" id="L1008">    session.beginTransaction();</span>
<span class="fc" id="L1009">    UserPasswordImpl impl = retrieveUserPassword(session, userId, orgId);</span>
<span class="fc" id="L1010">    session.delete(impl);</span>
<span class="fc" id="L1011">    session.getTransaction().commit();</span>
<span class="fc" id="L1012">    session.close();</span>
<span class="fc" id="L1013">    sessionClose++;</span>
<span class="fc" id="L1014">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#getCollectorProcessDefinition(java.lang.
   * String, java.lang.String)
   */
  @Override
  public CollectorProcessDefinition getCollectorProcessDefinition(String id, String orgId,
      boolean check) throws IdNotFoundException {
<span class="pc bpc" id="L1026" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1027">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1029">    CollectorProcessDefinition ret = getCollectorProcessDefinitionNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1030" title="1 of 4 branches missed.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L1031">      throw new IdNotFoundException(id + &quot; is not a defined CollectorProcessDefinition's id.&quot;);</span>
    }
<span class="fc" id="L1033">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getCollectorProcessDefinitionIds()
   */
  @Override
  public List&lt;String&gt; getCollectorProcessDefinitionIds(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1044">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1045" title="All 2 branches covered.">    for (CollectorProcessDefinition s : getCollectorProcessDefinitions(orgId, check)) {</span>
<span class="fc" id="L1046">      ret.add(s.getId());</span>
<span class="fc" id="L1047">    }</span>
<span class="fc" id="L1048">    return ret;</span>
  }

  /**
   * @param id The CollectorProcessDefinition's id
   * @param orgId The Organization's id.
   * @return The defined CollectorProcessDefinition or null.
   */
  private CollectorProcessDefinition getCollectorProcessDefinitionNoCheck(String id, String orgId) {
<span class="fc" id="L1057">    CollectorProcessDefinition ret = null;</span>
<span class="fc" id="L1058">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1059">    sessionOpen++;</span>
<span class="fc" id="L1060">    session.beginTransaction();</span>
<span class="fc" id="L1061">    CollectorProcessDefinitionImpl cpd = retrieveCollectorProcessDefinition(session, id, orgId);</span>
<span class="fc bfc" id="L1062" title="All 2 branches covered.">    if (cpd != null) {</span>
<span class="fc" id="L1063">      ret = cpd.toCPD();</span>
    }
<span class="fc" id="L1065">    session.getTransaction().commit();</span>
<span class="fc" id="L1066">    session.close();</span>
<span class="fc" id="L1067">    sessionClose++;</span>
<span class="fc" id="L1068">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#getCollectorProcessDefinitions(java.lang
   * .String)
   */
  @Override
  public List&lt;CollectorProcessDefinition&gt; getCollectorProcessDefinitions(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc bfc" id="L1081" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1082">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1084">    return getCollectorProcessDefinitionsNoCheck(orgId);</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of the defined CollectorProcessDefinitions.
   */
  private List&lt;CollectorProcessDefinition&gt; getCollectorProcessDefinitionsNoCheck(String orgId) {
<span class="fc" id="L1092">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1093">    sessionOpen++;</span>
<span class="fc" id="L1094">    session.beginTransaction();</span>
<span class="fc" id="L1095">    List&lt;CollectorProcessDefinitionImpl&gt; r = retrieveCollectorProcessDefinitions(session, orgId);</span>
<span class="fc" id="L1096">    List&lt;CollectorProcessDefinition&gt; ret = new ArrayList&lt;CollectorProcessDefinition&gt;();</span>
<span class="fc bfc" id="L1097" title="All 2 branches covered.">    for (CollectorProcessDefinitionImpl cpd : r) {</span>
<span class="fc" id="L1098">      ret.add(cpd.toCPD());</span>
<span class="fc" id="L1099">    }</span>
<span class="fc" id="L1100">    session.getTransaction().commit();</span>
<span class="fc" id="L1101">    session.close();</span>
<span class="fc" id="L1102">    sessionClose++;</span>
<span class="fc" id="L1103">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDepositories(java.lang.String)
   */
  @Override
  public List&lt;Depository&gt; getDepositories(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L1113">    Long startTime = 0l;</span>
<span class="fc" id="L1114">    Long endTime = 0l;</span>
<span class="fc" id="L1115">    Long diff = 0l;</span>
<span class="pc bpc" id="L1116" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1117">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositories(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1118">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1119">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1121" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1122">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1124">    List&lt;Depository&gt; ret = getDepositoriesNoCheck(orgId);</span>
<span class="pc bpc" id="L1125" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1126">      endTime = System.nanoTime();</span>
<span class="nc" id="L1127">      diff = endTime - startTime;</span>
<span class="nc" id="L1128">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1129">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositories(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1132">    return ret;</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of the defined Depositories.
   */
  private List&lt;Depository&gt; getDepositoriesNoCheck(String orgId) {
<span class="fc" id="L1140">    Long startTime = 0l;</span>
<span class="fc" id="L1141">    Long endTime = 0l;</span>
<span class="fc" id="L1142">    Long diff = 0l;</span>
<span class="pc bpc" id="L1143" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1144">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoriesNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1145">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1146">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1148">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1149">    sessionOpen++;</span>
<span class="fc" id="L1150">    session.beginTransaction();</span>
<span class="fc" id="L1151">    List&lt;DepositoryImpl&gt; r = retrieveDepositories(session, orgId);</span>
<span class="fc" id="L1152">    List&lt;Depository&gt; ret = new ArrayList&lt;Depository&gt;();</span>
<span class="fc bfc" id="L1153" title="All 2 branches covered.">    for (DepositoryImpl d : r) {</span>
<span class="fc" id="L1154">      ret.add(d.toDepository());</span>
<span class="fc" id="L1155">    }</span>
<span class="fc" id="L1156">    session.getTransaction().commit();</span>
<span class="fc" id="L1157">    session.close();</span>
<span class="fc" id="L1158">    sessionClose++;</span>
<span class="pc bpc" id="L1159" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1160">      endTime = System.nanoTime();</span>
<span class="nc" id="L1161">      diff = endTime - startTime;</span>
<span class="nc" id="L1162">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1163">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoriesNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1166">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDeposiory(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Depository getDepository(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1178">    Long startTime = 0l;</span>
<span class="fc" id="L1179">    Long endTime = 0l;</span>
<span class="fc" id="L1180">    Long diff = 0l;</span>
<span class="pc bpc" id="L1181" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1182">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepository(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1183">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1184">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1186" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1187">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1189">    Depository ret = cache.getDepository(id, orgId);</span>
<span class="fc bfc" id="L1190" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L1191">      ret = getDepositoryNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1192" title="1 of 2 branches missed.">      if (ret != null) {</span>
<span class="nc" id="L1193">        cache.putDepository(ret);</span>
      }
    }
<span class="fc bfc" id="L1196" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L1197">      throw new IdNotFoundException(id + &quot; is not a defined Depository's id.&quot;);</span>
    }
<span class="pc bpc" id="L1199" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1200">      endTime = System.nanoTime();</span>
<span class="nc" id="L1201">      diff = endTime - startTime;</span>
<span class="nc" id="L1202">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1203">      timingLogger.log(Level.SEVERE, padding + &quot;getDepository(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1206">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDepositoryIds()
   */
  @Override
  public List&lt;String&gt; getDepositoryIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L1216">    Long startTime = 0l;</span>
<span class="fc" id="L1217">    Long endTime = 0l;</span>
<span class="fc" id="L1218">    Long diff = 0l;</span>
<span class="pc bpc" id="L1219" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1220">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoryIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1221">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1222">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1224" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1225">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1227">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1228" title="All 2 branches covered.">    for (Depository d : getDepositoriesNoCheck(orgId)) {</span>
<span class="fc" id="L1229">      ret.add(d.getId());</span>
<span class="fc" id="L1230">    }</span>
<span class="pc bpc" id="L1231" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1232">      endTime = System.nanoTime();</span>
<span class="nc" id="L1233">      diff = endTime - startTime;</span>
<span class="nc" id="L1234">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1235">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoryIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1238">    return ret;</span>
  }

  /**
   * @param id The Depository's id.
   * @param orgId The Organization's id.
   * @return The defined Depository or null.
   */
  private Depository getDepositoryNoCheck(String id, String orgId) {
<span class="fc" id="L1247">    Long startTime = 0l;</span>
<span class="fc" id="L1248">    Long endTime = 0l;</span>
<span class="fc" id="L1249">    Long diff = 0l;</span>
<span class="pc bpc" id="L1250" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1251">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoryNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;)&quot;);
<span class="nc" id="L1253">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1254">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1256">    Depository ret = null;</span>
<span class="fc" id="L1257">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1258">    sessionOpen++;</span>
<span class="fc" id="L1259">    session.beginTransaction();</span>
<span class="fc" id="L1260">    DepositoryImpl impl = retrieveDepository(session, id, orgId);</span>
<span class="pc bpc" id="L1261" title="1 of 2 branches missed.">    if (impl != null) {</span>
<span class="nc" id="L1262">      ret = impl.toDepository();</span>
    }
<span class="fc" id="L1264">    session.getTransaction().commit();</span>
<span class="fc" id="L1265">    session.close();</span>
<span class="fc" id="L1266">    sessionClose++;</span>
<span class="pc bpc" id="L1267" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1268">      endTime = System.nanoTime();</span>
<span class="nc" id="L1269">      diff = endTime - startTime;</span>
<span class="nc" id="L1270">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1271">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoryNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1274">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getEarliestMeasuredValue(java
   * .lang.String, java.lang.String)
   */
  @Override
  public InterpolatedValue getEarliestMeasuredValue(String depotId, String orgId, String sensorId,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L1287">    Long startTime = 0l;</span>
<span class="fc" id="L1288">    Long endTime = 0l;</span>
<span class="fc" id="L1289">    Long diff = 0l;</span>
<span class="pc bpc" id="L1290" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1291">      timingLogger.log(Level.SEVERE, padding + &quot;Start getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1293">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1294">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1296" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1297">      getOrganization(orgId, check);</span>
<span class="fc" id="L1298">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1299">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1301">    InterpolatedValue value = getEarliestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1302" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1303">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="pc bpc" id="L1305" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1306">      endTime = System.nanoTime();</span>
<span class="nc" id="L1307">      diff = endTime - startTime;</span>
<span class="nc" id="L1308">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1309">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1312">    return value;</span>
  }

  /**
   * @param depotId The Depository's id.
   * @param orgId The Organization's id.
   * @param sensorId The Sensor id.
   * @return The earliest MeasuredValue for the given depository, organization
   *         and sensor.
   */
  private InterpolatedValue getEarliestMeasuredValueNoCheck(String depotId, String orgId,
      String sensorId) {
<span class="fc" id="L1324">    Long startTime = 0l;</span>
<span class="fc" id="L1325">    Long endTime = 0l;</span>
<span class="fc" id="L1326">    Long diff = 0l;</span>
<span class="pc bpc" id="L1327" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1328">      timingLogger.log(Level.SEVERE, padding + &quot;Start getEarliestMeasuredValueNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1330">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1331">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1333">    InterpolatedValue value = null;</span>
<span class="fc" id="L1334">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1335">    session.beginTransaction();</span>
<span class="fc" id="L1336">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1337">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1339">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
    // List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session
    // .createQuery(
    // &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor &quot;
    // + &quot;AND timestamp IN (SELECT min(timestamp) FROM MeasurementImpl WHERE &quot;
    // + &quot;depository = :depot AND sensor = :sensor)&quot;).setParameter(&quot;depot&quot;,
    // depot)
    // .setParameter(&quot;sensor&quot;, sensor).list();
<span class="pc bpc" id="L1350" title="1 of 2 branches missed.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L1351">      MeasurementImpl meas = result.get(0);</span>
<span class="fc" id="L1352">      value = new InterpolatedValue(sensorId, meas.getValue(), depot.getType().toMeasurementType(),</span>
          meas.getTimestamp());
    }
<span class="fc" id="L1355">    session.getTransaction().commit();</span>
<span class="fc" id="L1356">    session.close();</span>
<span class="pc bpc" id="L1357" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1358">      endTime = System.nanoTime();</span>
<span class="nc" id="L1359">      diff = endTime - startTime;</span>
<span class="nc" id="L1360">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1361">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValueNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1364">    return value;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinition
   * (java.lang.String, java.lang.String, boolean)
   */
  @Override
  public MeasurementPruningDefinition getMeasurementPruningDefinition(String id, String orgId,
      boolean check) throws IdNotFoundException {
<span class="fc" id="L1377">    Long startTime = 0l;</span>
<span class="fc" id="L1378">    Long endTime = 0l;</span>
<span class="fc" id="L1379">    Long diff = 0l;</span>
<span class="pc bpc" id="L1380" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1381">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementPruningDefinition(&quot; + id + &quot;, &quot;</span>
          + orgId + &quot;)&quot;);
<span class="nc" id="L1383">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1384">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1386" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1387">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1389">    MeasurementPruningDefinition gcd = getMeasurementPruningDefinitionNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1390" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1391">      endTime = System.nanoTime();</span>
<span class="nc" id="L1392">      diff = endTime - startTime;</span>
<span class="nc" id="L1393">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1394">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementPruningDefinition(&quot; + id + &quot;, &quot;</span>
          + orgId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc bfc" id="L1397" title="All 2 branches covered.">    if (gcd == null) {</span>
<span class="fc" id="L1398">      throw new IdNotFoundException(id + &quot; is not a defined MeasurementPruningDefinition id.&quot;);</span>
    }
<span class="fc" id="L1400">    return gcd;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinitionIds
   * (java.lang.String, boolean)
   */
  @Override
  public List&lt;String&gt; getMeasurementPruningDefinitionIds(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1413">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1414" title="All 2 branches covered.">    for (MeasurementPruningDefinition gcd : getMeasurementPruningDefinitions(orgId, check)) {</span>
<span class="fc" id="L1415">      ret.add(gcd.getId());</span>
<span class="fc" id="L1416">    }</span>
<span class="fc" id="L1417">    return ret;</span>
  }

  /**
   * @param id The MeasurementPruningDefinition's id.
   * @param orgId The Organization's id.
   * @return The MeasurementPruningDefinition with the given id and orgId, or
   *         null if not defined.
   */
  private MeasurementPruningDefinition getMeasurementPruningDefinitionNoCheck(String id, String orgId) {
<span class="fc" id="L1427">    MeasurementPruningDefinition ret = null;</span>
<span class="fc" id="L1428">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1429">    sessionOpen++;</span>
<span class="fc" id="L1430">    session.beginTransaction();</span>
<span class="fc" id="L1431">    MeasurementPruningDefinitionImpl gcd = retrieveMeasurementPruningDefinition(session, id, orgId);</span>
<span class="fc bfc" id="L1432" title="All 2 branches covered.">    if (gcd != null) {</span>
<span class="fc" id="L1433">      ret = gcd.toMPD();</span>
    }
<span class="fc" id="L1435">    session.getTransaction().commit();</span>
<span class="fc" id="L1436">    session.close();</span>
<span class="fc" id="L1437">    sessionClose++;</span>
<span class="fc" id="L1438">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinitions
   * (java.lang.String, boolean)
   */
  @Override
  public List&lt;MeasurementPruningDefinition&gt; getMeasurementPruningDefinitions(String orgId,
      boolean check) throws IdNotFoundException {
<span class="fc bfc" id="L1451" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1452">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1454">    return getMeasurementPruningDefinitionsNoCheck(orgId);</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of defined MeasurementPruningDefinitions.
   */
  private List&lt;MeasurementPruningDefinition&gt; getMeasurementPruningDefinitionsNoCheck(String orgId) {
<span class="fc" id="L1462">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1463">    sessionOpen++;</span>
<span class="fc" id="L1464">    session.beginTransaction();</span>
<span class="fc" id="L1465">    List&lt;MeasurementPruningDefinitionImpl&gt; r = retrieveMeasurementPruningDefinitions(session, orgId);</span>
<span class="fc" id="L1466">    List&lt;MeasurementPruningDefinition&gt; ret = new ArrayList&lt;MeasurementPruningDefinition&gt;();</span>
<span class="fc bfc" id="L1467" title="All 2 branches covered.">    for (MeasurementPruningDefinitionImpl gcd : r) {</span>
<span class="fc" id="L1468">      ret.add(gcd.toMPD());</span>
<span class="fc" id="L1469">    }</span>
<span class="fc" id="L1470">    session.getTransaction().commit();</span>
<span class="fc" id="L1471">    session.close();</span>
<span class="fc" id="L1472">    sessionClose++;</span>
<span class="fc" id="L1473">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getLatestMeasuredValue(java.lang
   * .String, java.lang.String)
   */
  @Override
  public InterpolatedValue getLatestMeasuredValue(String depotId, String orgId, String sensorId,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L1486">    Long startTime = 0l;</span>
<span class="fc" id="L1487">    Long endTime = 0l;</span>
<span class="fc" id="L1488">    Long diff = 0l;</span>
<span class="pc bpc" id="L1489" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1490">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLaestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1492">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1493">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1495" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1496">      getOrganization(orgId, check);</span>
<span class="fc" id="L1497">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1498">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1500">    InterpolatedValue value = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1501" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1502">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="pc bpc" id="L1504" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1505">      endTime = System.nanoTime();</span>
<span class="nc" id="L1506">      diff = endTime - startTime;</span>
<span class="nc" id="L1507">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1508">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1511">    return value;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensors's id.
   * @return The latest measured value or null if no measurements.
   */
  private InterpolatedValue getLatestMeasuredValueNoCheck(String depotId, String orgId,
      String sensorId) {
<span class="fc" id="L1522">    Long startTime = 0l;</span>
<span class="fc" id="L1523">    Long endTime = 0l;</span>
<span class="fc" id="L1524">    Long diff = 0l;</span>
<span class="pc bpc" id="L1525" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1526">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLatestMeasuredValueNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1528">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1529">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1531">    InterpolatedValue value = null;</span>
<span class="fc" id="L1532">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1533">    session.beginTransaction();</span>
<span class="fc" id="L1534">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1535">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1537">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();

    // List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session
    // .createQuery(
    // &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor &quot;
    // + &quot;AND timestamp IN (SELECT max(timestamp) FROM MeasurementImpl WHERE &quot;
    // + &quot;depository = :depot AND sensor = :sensor)&quot;).setParameter(&quot;depot&quot;,
    // depot)
    // .setParameter(&quot;sensor&quot;, sensor).list();
<span class="pc bpc" id="L1549" title="1 of 2 branches missed.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L1550">      MeasurementImpl meas = result.get(0);</span>
<span class="fc" id="L1551">      value = new InterpolatedValue(sensorId, meas.getValue(), depot.getType().toMeasurementType(),</span>
          meas.getTimestamp());
    }
<span class="fc" id="L1554">    session.getTransaction().commit();</span>
<span class="fc" id="L1555">    session.close();</span>
<span class="pc bpc" id="L1556" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1557">      endTime = System.nanoTime();</span>
<span class="nc" id="L1558">      diff = endTime - startTime;</span>
<span class="nc" id="L1559">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1560">      timingLogger.log(Level.SEVERE, padding + &quot;getLatestMeasuredValueNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1563">    return value;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurement(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Measurement getMeasurement(String depotId, String orgId, String measId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1576">    Long startTime = 0l;</span>
<span class="fc" id="L1577">    Long endTime = 0l;</span>
<span class="fc" id="L1578">    Long diff = 0l;</span>
<span class="pc bpc" id="L1579" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1580">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurement(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L1582">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1583">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1585" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1586">      getOrganization(orgId, check);</span>
<span class="fc" id="L1587">      getDepository(depotId, orgId, check);</span>
    }
<span class="fc" id="L1589">    Measurement ret = getMeasurementNoCheck(depotId, orgId, measId);</span>
<span class="pc bpc" id="L1590" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1591">      endTime = System.nanoTime();</span>
<span class="nc" id="L1592">      diff = endTime - startTime;</span>
<span class="nc" id="L1593">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1594">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurement(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1597">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param measId The measurement's id.
   * @return The Measurement with the given ids or null.
   */
  private Measurement getMeasurementNoCheck(String depotId, String orgId, String measId) {
<span class="fc" id="L1607">    Long startTime = 0l;</span>
<span class="fc" id="L1608">    Long endTime = 0l;</span>
<span class="fc" id="L1609">    Long diff = 0l;</span>
<span class="pc bpc" id="L1610" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1611">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L1613">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1614">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1616">    Measurement ret = null;</span>
<span class="fc" id="L1617">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1618">    session.beginTransaction();</span>
<span class="fc" id="L1619">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1621">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depot AND id = :id&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;id&quot;, measId).list();
<span class="pc bpc" id="L1624" title="1 of 2 branches missed.">    if (result.size() == 1) {</span>
<span class="fc" id="L1625">      ret = result.get(0).toMeasurement();</span>
    }
<span class="fc" id="L1627">    session.getTransaction().commit();</span>
<span class="fc" id="L1628">    session.close();</span>
<span class="pc bpc" id="L1629" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1630">      endTime = System.nanoTime();</span>
<span class="nc" id="L1631">      diff = endTime - startTime;</span>
<span class="nc" id="L1632">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1633">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1636">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurements(java.lang.String,
   * java.lang.String)
   */
  @Override
  public List&lt;Measurement&gt; getMeasurements(String depotId, String orgId, String sensorId,
      boolean check) throws IdNotFoundException {
<span class="fc" id="L1649">    Long startTime = 0l;</span>
<span class="fc" id="L1650">    Long endTime = 0l;</span>
<span class="fc" id="L1651">    Long diff = 0l;</span>
<span class="pc bpc" id="L1652" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1653">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurements(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1655">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1656">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1658" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1659">      getOrganization(orgId, check);</span>
<span class="fc" id="L1660">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1661">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1663">    List&lt;Measurement&gt; ret = getMeasurementsNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1664" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1665">      endTime = System.nanoTime();</span>
<span class="nc" id="L1666">      diff = endTime - startTime;</span>
<span class="nc" id="L1667">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1668">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurements(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1671">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurements(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public List&lt;Measurement&gt; getMeasurements(String depotId, String orgId, String sensorId,
      Date start, Date end, boolean check) throws IdNotFoundException {
<span class="fc" id="L1684">    Long startTime = 0l;</span>
<span class="fc" id="L1685">    Long endTime = 0l;</span>
<span class="fc" id="L1686">    Long diff = 0l;</span>
<span class="pc bpc" id="L1687" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1688">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1690">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1691">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1693" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1694">      getOrganization(orgId, check);</span>
<span class="fc" id="L1695">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1696">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1698">    List&lt;Measurement&gt; ret = getMeasurementsNoCheck(depotId, orgId, sensorId, start, end);</span>
<span class="pc bpc" id="L1699" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1700">      endTime = System.nanoTime();</span>
<span class="nc" id="L1701">      diff = endTime - startTime;</span>
<span class="nc" id="L1702">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1703">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1706">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, boolean)
   */
  @Override
  public Long getMeasurementsCount(String orgId, boolean check) throws IdNotFoundException {
<span class="nc" id="L1718">    Long startTime = 0l;</span>
<span class="nc" id="L1719">    Long endTime = 0l;</span>
<span class="nc" id="L1720">    Long diff = 0l;</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1722">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCount(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1723">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1724">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1726" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1727">      getOrganization(orgId, check);</span>
    }
<span class="nc" id="L1729">    Long ret = 0l;</span>
<span class="nc" id="L1730">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1731">    session.beginTransaction();</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">    for (DepositoryImpl depot : retrieveDepositories(session, orgId)) {</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1734">      List&lt;Long&gt; result = (List&lt;Long&gt;) session</span>
          .createQuery(&quot;SELECT count(*) FROM MeasurementImpl WHERE depository = :depot&quot;)
          .setParameter(&quot;depot&quot;, depot).list();
<span class="nc" id="L1737">      ret += result.get(0);</span>
<span class="nc" id="L1738">    }</span>
<span class="nc" id="L1739">    session.getTransaction().commit();</span>
<span class="nc" id="L1740">    session.close();</span>

<span class="nc bnc" id="L1742" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1743">      endTime = System.nanoTime();</span>
<span class="nc" id="L1744">      diff = endTime - startTime;</span>
<span class="nc" id="L1745">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1746">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1749">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, java.lang.String, java.lang.String)
   */
  @Override
  public Long getMeasurementsCount(String depotId, String orgId, String sensorId, boolean check)
      throws IdNotFoundException {
<span class="nc" id="L1762">    Long startTime = 0l;</span>
<span class="nc" id="L1763">    Long endTime = 0l;</span>
<span class="nc" id="L1764">    Long diff = 0l;</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1766">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCount(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1768">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1769">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1771" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1772">      getOrganization(orgId, check);</span>
<span class="nc" id="L1773">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1774">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1776">    Long ret = getMeasurementsCountNoCheck(depotId, orgId, sensorId);</span>
<span class="nc bnc" id="L1777" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1778">      endTime = System.nanoTime();</span>
<span class="nc" id="L1779">      diff = endTime - startTime;</span>
<span class="nc" id="L1780">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1781">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1784">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, java.lang.String, java.lang.String, java.util.Date,
   * java.util.Date)
   */
  @Override
  public Long getMeasurementsCount(String depotId, String orgId, String sensorId, Date start,
      Date end, boolean check) throws IdNotFoundException {
<span class="nc" id="L1798">    Long startTime = 0l;</span>
<span class="nc" id="L1799">    Long endTime = 0l;</span>
<span class="nc" id="L1800">    Long diff = 0l;</span>
<span class="nc bnc" id="L1801" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1802">      startTime = System.nanoTime();</span>
<span class="nc" id="L1803">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getMeasurementsCount(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1805">      padding += &quot;  &quot;;</span>
    }
<span class="nc bnc" id="L1807" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1808">      getOrganization(orgId, check);</span>
<span class="nc" id="L1809">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1810">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1812">    Long ret = getMeasurementsCountNoCheck(depotId, orgId, sensorId, start, end);</span>
<span class="nc bnc" id="L1813" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1814">      endTime = System.nanoTime();</span>
<span class="nc" id="L1815">      diff = endTime - startTime;</span>
<span class="nc" id="L1816">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1817">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1820">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @return the number of measurements made by the given sensor stored in the
   *         given depository.
   */
  private Long getMeasurementsCountNoCheck(String depotId, String orgId, String sensorId) {
<span class="nc" id="L1831">    Long startTime = 0l;</span>
<span class="nc" id="L1832">    Long endTime = 0l;</span>
<span class="nc" id="L1833">    Long diff = 0l;</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1835">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCountNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1837">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1838">      startTime = System.nanoTime();</span>
    }
<span class="nc" id="L1840">    Long ret = null;</span>
<span class="nc" id="L1841">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1842">    session.beginTransaction();</span>
<span class="nc" id="L1843">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="nc" id="L1844">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1846">    List&lt;Long&gt; result = (List&lt;Long&gt;) session</span>
        .createQuery(
            &quot;SELECT count(*) FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).list();
<span class="nc" id="L1850">    ret = result.get(0);</span>
<span class="nc" id="L1851">    session.getTransaction().commit();</span>
<span class="nc" id="L1852">    session.close();</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1854">      endTime = System.nanoTime();</span>
<span class="nc" id="L1855">      diff = endTime - startTime;</span>
<span class="nc" id="L1856">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1857">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCountNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1860">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @param start The start of the interval.
   * @param end The end of the interval.
   * @return a list of the measurements made by the given sensor stored in the
   *         given depository during the interval.
   */
  private Long getMeasurementsCountNoCheck(String depotId, String orgId, String sensorId,
      Date start, Date end) {
<span class="nc" id="L1874">    Long startTime = 0l;</span>
<span class="nc" id="L1875">    Long endTime = 0l;</span>
<span class="nc" id="L1876">    Long diff = 0l;</span>
<span class="nc bnc" id="L1877" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1878">      startTime = System.nanoTime();</span>
<span class="nc" id="L1879">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getMeasurementsCountNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1881">      padding += &quot;  &quot;;</span>
    }
<span class="nc" id="L1883">    Long ret = null;</span>
<span class="nc" id="L1884">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1885">    session.beginTransaction();</span>
<span class="nc" id="L1886">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="nc" id="L1887">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="nc" id="L1888">    Long result = (Long) session</span>
        .createQuery(
            &quot;SELECT count(*) FROM MeasurementImpl WHERE timestamp &gt;= :start AND timestamp &lt;= :end AND depository = :depository AND sensor = :sensor&quot;)
        .setParameter(&quot;start&quot;, start).setParameter(&quot;end&quot;, end).setParameter(&quot;depository&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).iterate().next();
<span class="nc" id="L1893">    ret = result;</span>
<span class="nc" id="L1894">    session.getTransaction().commit();</span>
<span class="nc" id="L1895">    session.close();</span>
<span class="nc bnc" id="L1896" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1897">      endTime = System.nanoTime();</span>
<span class="nc" id="L1898">      diff = endTime - startTime;</span>
<span class="nc" id="L1899">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1900">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCountNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1903">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The Organization's id.
   * @param sensorId The sensor's id.
   * @return a List of all the Measurements.
   */
  private List&lt;Measurement&gt; getMeasurementsNoCheck(String depotId, String orgId, String sensorId) {
<span class="fc" id="L1913">    List&lt;Measurement&gt; ret = new ArrayList&lt;Measurement&gt;();</span>
<span class="fc" id="L1914">    Long startTime = 0l;</span>
<span class="fc" id="L1915">    Long endTime = 0l;</span>
<span class="fc" id="L1916">    Long diff = 0l;</span>
<span class="pc bpc" id="L1917" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1918">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1920">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1921">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1923">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1924">    session.beginTransaction();</span>
<span class="fc" id="L1925">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1926">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1928">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L1931" title="All 2 branches covered.">    for (MeasurementImpl mi : result) {</span>
<span class="fc" id="L1932">      ret.add(mi.toMeasurement());</span>
<span class="fc" id="L1933">    }</span>
<span class="fc" id="L1934">    session.getTransaction().commit();</span>
<span class="fc" id="L1935">    session.close();</span>
<span class="pc bpc" id="L1936" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1937">      endTime = System.nanoTime();</span>
<span class="nc" id="L1938">      diff = endTime - startTime;</span>
<span class="nc" id="L1939">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1940">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1943">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @param start The start of the interval.
   * @param end The end of the interval.
   * @return All the measurements during the interval for the given depository,
   *         organization and sensor.
   */
  private List&lt;Measurement&gt; getMeasurementsNoCheck(String depotId, String orgId, String sensorId,
      Date start, Date end) {
<span class="fc" id="L1957">    Long startTime = 0l;</span>
<span class="fc" id="L1958">    Long endTime = 0l;</span>
<span class="fc" id="L1959">    Long diff = 0l;</span>
<span class="pc bpc" id="L1960" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1961">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1963">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1964">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1966">    List&lt;Measurement&gt; ret = new ArrayList&lt;Measurement&gt;();</span>
<span class="fc" id="L1967">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1968">    session.beginTransaction();</span>
<span class="fc" id="L1969">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1970">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1972">    List&lt;MeasurementImpl&gt; measurements = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp &gt;= :start AND timestamp &lt;= :end AND depository = :depository AND sensor = :sensor&quot;)
        .setParameter(&quot;start&quot;, start).setParameter(&quot;end&quot;, end).setParameter(&quot;depository&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L1977" title="All 2 branches covered.">    for (MeasurementImpl mi : measurements) {</span>
<span class="fc" id="L1978">      ret.add(mi.toMeasurement());</span>
<span class="fc" id="L1979">    }</span>
<span class="fc" id="L1980">    session.getTransaction().commit();</span>
<span class="fc" id="L1981">    session.close();</span>
<span class="pc bpc" id="L1982" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1983">      endTime = System.nanoTime();</span>
<span class="nc" id="L1984">      diff = endTime - startTime;</span>
<span class="nc" id="L1985">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1986">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1989">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getMeasurementType(java.lang.String)
   */
  @Override
  public MeasurementType getMeasurementType(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L1999">    Long startTime = 0l;</span>
<span class="fc" id="L2000">    Long endTime = 0l;</span>
<span class="fc" id="L2001">    Long diff = 0l;</span>
<span class="pc bpc" id="L2002" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2003">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementType(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2004">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2005">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2007">    MeasurementType ret = null;</span>
<span class="fc" id="L2008">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2009">    sessionOpen++;</span>
<span class="fc" id="L2010">    session.beginTransaction();</span>
<span class="fc" id="L2011">    MeasurementTypeImpl impl = retrieveMeasurementType(session, id);</span>
<span class="fc bfc" id="L2012" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2013">      ret = impl.toMeasurementType();</span>
    }
<span class="fc" id="L2015">    session.getTransaction().commit();</span>
<span class="fc" id="L2016">    session.close();</span>
<span class="fc" id="L2017">    sessionClose++;</span>
<span class="fc bfc" id="L2018" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2019">      throw new IdNotFoundException(id + &quot; is not a defined MeasurementType.&quot;);</span>
    }
<span class="pc bpc" id="L2021" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2022">      endTime = System.nanoTime();</span>
<span class="nc" id="L2023">      diff = endTime - startTime;</span>
<span class="nc" id="L2024">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2025">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementType(&quot; + id + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2028">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getMeasurementTypes()
   */
  @Override
  public List&lt;MeasurementType&gt; getMeasurementTypes() {
<span class="fc" id="L2038">    Long startTime = 0l;</span>
<span class="fc" id="L2039">    Long endTime = 0l;</span>
<span class="fc" id="L2040">    Long diff = 0l;</span>
<span class="pc bpc" id="L2041" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2042">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementTypes()&quot;);</span>
<span class="nc" id="L2043">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2044">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2046">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2047">    sessionOpen++;</span>
<span class="fc" id="L2048">    session.beginTransaction();</span>
<span class="fc" id="L2049">    List&lt;MeasurementTypeImpl&gt; ret = retrieveMeasurementTypes(session);</span>
<span class="fc" id="L2050">    List&lt;MeasurementType&gt; types = new ArrayList&lt;MeasurementType&gt;();</span>
<span class="fc bfc" id="L2051" title="All 2 branches covered.">    for (MeasurementTypeImpl i : ret) {</span>
<span class="fc" id="L2052">      types.add(i.toMeasurementType());</span>
<span class="fc" id="L2053">    }</span>
<span class="fc" id="L2054">    session.getTransaction().commit();</span>
<span class="fc" id="L2055">    session.close();</span>
<span class="fc" id="L2056">    sessionClose++;</span>
<span class="pc bpc" id="L2057" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2058">      endTime = System.nanoTime();</span>
<span class="nc" id="L2059">      diff = endTime - startTime;</span>
<span class="nc" id="L2060">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2061">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementTypes() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2064">    return types;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getOrganization(java.lang.String)
   */
  @Override
  public Organization getOrganization(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2074">    Long startTime = 0l;</span>
<span class="fc" id="L2075">    Long endTime = 0l;</span>
<span class="fc" id="L2076">    Long diff = 0l;</span>
<span class="pc bpc" id="L2077" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2078">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganization(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2079">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2081">    Organization ret = cache.getOrganization(id);</span>
<span class="fc bfc" id="L2082" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2083">      Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2084">      sessionOpen++;</span>
<span class="fc" id="L2085">      session.beginTransaction();</span>
<span class="fc" id="L2086">      OrganizationImpl org = retrieveOrganization(session, id);</span>
<span class="fc bfc" id="L2087" title="All 2 branches covered.">      if (org != null) {</span>
<span class="fc" id="L2088">        ret = org.toOrganization();</span>
      }
<span class="fc" id="L2090">      session.getTransaction().commit();</span>
<span class="fc" id="L2091">      session.close();</span>
<span class="fc" id="L2092">      sessionClose++;</span>
<span class="fc bfc" id="L2093" title="All 2 branches covered.">      if (ret == null) {</span>
<span class="fc" id="L2094">        throw new IdNotFoundException(id + &quot; isn't a defined Organization's id.&quot;);</span>
      }
<span class="fc" id="L2096">      cache.putOrganization(ret);</span>
    }
<span class="pc bpc" id="L2098" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2099">      endTime = System.nanoTime();</span>
<span class="nc" id="L2100">      diff = endTime - startTime;</span>
<span class="nc" id="L2101">      timingLogger.log(Level.SEVERE, padding + &quot;getOrganization(&quot; + id + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2104">    return ret;</span>
  }

  /*
   * (non-Javadoc)m
   * 
   * @see org.wattdepot.server.WattDepot#getOrganizationIds()
   */
  @Override
  public List&lt;String&gt; getOrganizationIds() {
<span class="fc" id="L2114">    Long startTime = 0l;</span>
<span class="fc" id="L2115">    Long endTime = 0l;</span>
<span class="fc" id="L2116">    Long diff = 0l;</span>
<span class="pc bpc" id="L2117" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2118">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganizationIds()&quot;);</span>
<span class="nc" id="L2119">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2120">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2122">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2123" title="All 2 branches covered.">    for (Organization u : getOrganizations()) {</span>
<span class="fc" id="L2124">      ret.add(u.getId());</span>
<span class="fc" id="L2125">    }</span>
<span class="pc bpc" id="L2126" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2127">      endTime = System.nanoTime();</span>
<span class="nc" id="L2128">      diff = endTime - startTime;</span>
<span class="nc" id="L2129">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2130">      timingLogger.log(Level.SEVERE, padding + &quot;getOrganizationIds() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2133">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getOrganizations()
   */
  @Override
  public List&lt;Organization&gt; getOrganizations() {
<span class="fc" id="L2143">    Long startTime = 0l;</span>
<span class="fc" id="L2144">    Long endTime = 0l;</span>
<span class="fc" id="L2145">    Long diff = 0l;</span>
<span class="pc bpc" id="L2146" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2147">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganizations()&quot;);</span>
<span class="nc" id="L2148">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2149">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2151">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2152">    sessionOpen++;</span>
<span class="fc" id="L2153">    session.beginTransaction();</span>
<span class="fc" id="L2154">    List&lt;OrganizationImpl&gt; r = retrieveOrganizations(session);</span>
<span class="fc" id="L2155">    List&lt;Organization&gt; ret = new ArrayList&lt;Organization&gt;();</span>
<span class="fc bfc" id="L2156" title="All 2 branches covered.">    for (OrganizationImpl o : r) {</span>
<span class="fc" id="L2157">      ret.add(o.toOrganization());</span>
<span class="fc" id="L2158">    }</span>
<span class="fc" id="L2159">    session.getTransaction().commit();</span>
<span class="fc" id="L2160">    session.close();</span>
<span class="fc" id="L2161">    sessionClose++;</span>
<span class="pc bpc" id="L2162" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2163">      endTime = System.nanoTime();</span>
<span class="nc" id="L2164">      diff = endTime - startTime;</span>
<span class="nc" id="L2165">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2166">      timingLogger</span>
          .log(Level.SEVERE, padding + &quot;getOrganizations() took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2169">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getRateSummary(java.lang.String,
   * java.lang.String, java.lang.String)
   */
  @Override
  public MeasurementRateSummary getRateSummary(String depotId, String orgId, String sensorId,
      boolean check) throws IdNotFoundException, NoMeasurementException {
<span class="nc" id="L2182">    Long startTime = 0l;</span>
<span class="nc" id="L2183">    Long endTime = 0l;</span>
<span class="nc" id="L2184">    Long diff = 0l;</span>
<span class="nc bnc" id="L2185" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2186">      startTime = System.nanoTime();</span>
<span class="nc" id="L2187">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getRateSummary(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L2189">      padding += &quot;  &quot;;</span>
    }
<span class="nc bnc" id="L2191" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L2192">      getOrganization(orgId, check);</span>
<span class="nc" id="L2193">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L2194">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L2196">    XMLGregorianCalendar now = Tstamp.makeTimestamp();</span>
<span class="nc" id="L2197">    XMLGregorianCalendar minAgo = Tstamp.incrementMinutes(now, -1);</span>
<span class="nc" id="L2198">    MeasurementRateSummary ret = new MeasurementRateSummary();</span>
<span class="nc" id="L2199">    ret.setDepositoryId(depotId);</span>
<span class="nc" id="L2200">    ret.setSensorId(sensorId);</span>
<span class="nc" id="L2201">    ret.setTimestamp(DateConvert.convertXMLCal(now));</span>
<span class="nc" id="L2202">    Long count = getMeasurementsCountNoCheck(depotId, orgId, sensorId,</span>
        DateConvert.convertXMLCal(minAgo), DateConvert.convertXMLCal(now));
<span class="nc" id="L2204">    ret.setOneMinuteCount(count);</span>
<span class="nc" id="L2205">    ret.setOneMinuteRate(count / 60.0);</span>
<span class="nc" id="L2206">    InterpolatedValue val = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="nc" id="L2207">    ret.setLatestValue(val.getValue());</span>
<span class="nc" id="L2208">    ret.setType(val.getMeasurementType());</span>
<span class="nc" id="L2209">    count = getMeasurementsCountNoCheck(depotId, orgId, sensorId);</span>
<span class="nc" id="L2210">    ret.setTotalCount(count);</span>
<span class="nc bnc" id="L2211" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2212">      endTime = System.nanoTime();</span>
<span class="nc" id="L2213">      diff = endTime - startTime;</span>
<span class="nc" id="L2214">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2215">      timingLogger.log(Level.SEVERE, padding + &quot;getRateSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L2218">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensor(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Sensor getSensor(String id, String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2229">    Long startTime = 0l;</span>
<span class="fc" id="L2230">    Long endTime = 0l;</span>
<span class="fc" id="L2231">    Long diff = 0l;</span>
<span class="pc bpc" id="L2232" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2233">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensor(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2234">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2235">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2237" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2238">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2240">    Sensor ret = cache.getSensor(id, orgId);</span>
<span class="fc bfc" id="L2241" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2242">      ret = getSensorNoCheck(id, orgId);</span>
<span class="pc bpc" id="L2243" title="1 of 2 branches missed.">      if (ret != null) {</span>
<span class="nc" id="L2244">        cache.putSensor(ret);</span>
      }
    }
<span class="fc bfc" id="L2247" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2248">      throw new IdNotFoundException(id + &quot; is not a defined Sensor id.&quot;);</span>
    }
<span class="pc bpc" id="L2250" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2251">      endTime = System.nanoTime();</span>
<span class="nc" id="L2252">      diff = endTime - startTime;</span>
<span class="nc" id="L2253">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2254">      timingLogger.log(Level.SEVERE, padding + &quot;getSensor(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2257">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroup(java.lang.String,
   * java.lang.String)
   */
  @Override
  public SensorGroup getSensorGroup(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L2269">    Long startTime = 0l;</span>
<span class="fc" id="L2270">    Long endTime = 0l;</span>
<span class="fc" id="L2271">    Long diff = 0l;</span>
<span class="pc bpc" id="L2272" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2273">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroup(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2274">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2275">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L2277" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2278">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2280">    SensorGroup ret = getSensorGroupNoCheck(id, orgId);</span>
<span class="pc bpc" id="L2281" title="1 of 4 branches missed.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2282">      throw new IdNotFoundException(id + &quot; is not a defined SensorGroup id.&quot;);</span>
    }
<span class="pc bpc" id="L2284" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2285">      endTime = System.nanoTime();</span>
<span class="nc" id="L2286">      diff = endTime - startTime;</span>
<span class="nc" id="L2287">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2288">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroup(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2291">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroupIds()
   */
  @Override
  public List&lt;String&gt; getSensorGroupIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2301">    Long startTime = 0l;</span>
<span class="fc" id="L2302">    Long endTime = 0l;</span>
<span class="fc" id="L2303">    Long diff = 0l;</span>
<span class="pc bpc" id="L2304" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2305">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2306">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2307">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L2309" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2310">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2312">    List&lt;String&gt; ret = getSensorGroupIdsNoCheck(orgId);</span>
<span class="pc bpc" id="L2313" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2314">      endTime = System.nanoTime();</span>
<span class="nc" id="L2315">      diff = endTime - startTime;</span>
<span class="nc" id="L2316">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2317">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2320">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return A List of the SensorGroups' ids.
   */
  private List&lt;String&gt; getSensorGroupIdsNoCheck(String orgId) {
<span class="fc" id="L2328">    Long startTime = 0l;</span>
<span class="fc" id="L2329">    Long endTime = 0l;</span>
<span class="fc" id="L2330">    Long diff = 0l;</span>
<span class="pc bpc" id="L2331" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2332">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2333">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2334">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2336">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2337" title="All 2 branches covered.">    for (SensorGroup s : getSensorGroupsNoCheck(orgId)) {</span>
<span class="fc" id="L2338">      ret.add(s.getId());</span>
<span class="fc" id="L2339">    }</span>
<span class="pc bpc" id="L2340" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2341">      endTime = System.nanoTime();</span>
<span class="nc" id="L2342">      diff = endTime - startTime;</span>
<span class="nc" id="L2343">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2344">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2347">    return ret;</span>
  }

  /**
   * @param id The sensor group's id.
   * @param orgId The organization's id.
   * @return The defined SensorGroup or null.
   */
  private SensorGroup getSensorGroupNoCheck(String id, String orgId) {
<span class="fc" id="L2356">    Long startTime = 0l;</span>
<span class="fc" id="L2357">    Long endTime = 0l;</span>
<span class="fc" id="L2358">    Long diff = 0l;</span>
<span class="pc bpc" id="L2359" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2360">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;)&quot;);
<span class="nc" id="L2362">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2363">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2365">    SensorGroup ret = null;</span>
<span class="fc" id="L2366">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2367">    sessionOpen++;</span>
<span class="fc" id="L2368">    session.beginTransaction();</span>
<span class="fc" id="L2369">    SensorGroupImpl impl = retrieveSensorGroup(session, id, orgId);</span>
<span class="fc bfc" id="L2370" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2371">      ret = impl.toSensorGroup();</span>
    }
<span class="fc" id="L2373">    session.getTransaction().commit();</span>
<span class="fc" id="L2374">    session.close();</span>
<span class="fc" id="L2375">    sessionClose++;</span>
<span class="pc bpc" id="L2376" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2377">      endTime = System.nanoTime();</span>
<span class="nc" id="L2378">      diff = endTime - startTime;</span>
<span class="nc" id="L2379">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2380">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2383">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroups(java.lang.String)
   */
  @Override
  public List&lt;SensorGroup&gt; getSensorGroups(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2393">    Long startTime = 0l;</span>
<span class="fc" id="L2394">    Long endTime = 0l;</span>
<span class="fc" id="L2395">    Long diff = 0l;</span>
<span class="pc bpc" id="L2396" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2397">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroups(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2398">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2399">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2401" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2402">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2404">    List&lt;SensorGroup&gt; ret = getSensorGroupsNoCheck(orgId);</span>
<span class="pc bpc" id="L2405" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2406">      endTime = System.nanoTime();</span>
<span class="nc" id="L2407">      diff = endTime - startTime;</span>
<span class="nc" id="L2408">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2409">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroups(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2412">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return All the defined SensorGroups.
   */
  private List&lt;SensorGroup&gt; getSensorGroupsNoCheck(String orgId) {
<span class="fc" id="L2420">    Long startTime = 0l;</span>
<span class="fc" id="L2421">    Long endTime = 0l;</span>
<span class="fc" id="L2422">    Long diff = 0l;</span>
<span class="pc bpc" id="L2423" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2424">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2425">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2426">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2428">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2429">    sessionOpen++;</span>
<span class="fc" id="L2430">    session.beginTransaction();</span>
<span class="fc" id="L2431">    List&lt;SensorGroupImpl&gt; r = retrieveSensorGroups(session, orgId);</span>
<span class="fc" id="L2432">    List&lt;SensorGroup&gt; ret = new ArrayList&lt;SensorGroup&gt;();</span>
<span class="fc bfc" id="L2433" title="All 2 branches covered.">    for (SensorGroupImpl s : r) {</span>
<span class="fc" id="L2434">      ret.add(s.toSensorGroup());</span>
<span class="fc" id="L2435">    }</span>
<span class="fc" id="L2436">    session.getTransaction().commit();</span>
<span class="fc" id="L2437">    session.close();</span>
<span class="fc" id="L2438">    sessionClose++;</span>
<span class="pc bpc" id="L2439" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2440">      endTime = System.nanoTime();</span>
<span class="nc" id="L2441">      diff = endTime - startTime;</span>
<span class="nc" id="L2442">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2443">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2446">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorIds()
   */
  @Override
  public List&lt;String&gt; getSensorIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2456">    Long startTime = 0l;</span>
<span class="fc" id="L2457">    Long endTime = 0l;</span>
<span class="fc" id="L2458">    Long diff = 0l;</span>
<span class="pc bpc" id="L2459" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2460">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2461">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2462">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2464">    List&lt;String&gt; ret = getSensorIdsNoCheck(orgId);</span>
<span class="pc bpc" id="L2465" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2466">      endTime = System.nanoTime();</span>
<span class="nc" id="L2467">      diff = endTime - startTime;</span>
<span class="nc" id="L2468">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2469">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorIds(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2472">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return The defined Sensors' ids.
   */
  private List&lt;String&gt; getSensorIdsNoCheck(String orgId) {
<span class="fc" id="L2480">    Long startTime = 0l;</span>
<span class="fc" id="L2481">    Long endTime = 0l;</span>
<span class="fc" id="L2482">    Long diff = 0l;</span>
<span class="pc bpc" id="L2483" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2484">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorIdsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2485">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2486">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2488">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2489" title="All 2 branches covered.">    for (Sensor s : getSensorsNoCheck(orgId)) {</span>
<span class="fc" id="L2490">      ret.add(s.getId());</span>
<span class="fc" id="L2491">    }</span>
<span class="pc bpc" id="L2492" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2493">      endTime = System.nanoTime();</span>
<span class="nc" id="L2494">      diff = endTime - startTime;</span>
<span class="nc" id="L2495">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2496">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorIdsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2499">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModel(java.lang.String,
   * java.lang.String)
   */
  @Override
  public SensorModel getSensorModel(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2510">    Long startTime = 0l;</span>
<span class="fc" id="L2511">    Long endTime = 0l;</span>
<span class="fc" id="L2512">    Long diff = 0l;</span>
<span class="pc bpc" id="L2513" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2514">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModel(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2515">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2516">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2518">    SensorModel ret = null;</span>
<span class="fc" id="L2519">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2520">    sessionOpen++;</span>
<span class="fc" id="L2521">    session.beginTransaction();</span>
<span class="fc" id="L2522">    SensorModelImpl impl = retrieveSensorModel(session, id);</span>
<span class="fc bfc" id="L2523" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2524">      ret = impl.toSensorModel();</span>
    }
<span class="fc" id="L2526">    session.getTransaction().commit();</span>
<span class="fc" id="L2527">    session.close();</span>
<span class="fc" id="L2528">    sessionClose++;</span>
<span class="fc bfc" id="L2529" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2530">      throw new IdNotFoundException(id + &quot; is not a valid SensorModel id.&quot;);</span>
    }
<span class="pc bpc" id="L2532" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2533">      endTime = System.nanoTime();</span>
<span class="nc" id="L2534">      diff = endTime - startTime;</span>
<span class="nc" id="L2535">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2536">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModel(&quot; + id + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2539">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModelIds()
   */
  @Override
  public List&lt;String&gt; getSensorModelIds() {
<span class="fc" id="L2549">    Long startTime = 0l;</span>
<span class="fc" id="L2550">    Long endTime = 0l;</span>
<span class="fc" id="L2551">    Long diff = 0l;</span>
<span class="pc bpc" id="L2552" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2553">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModelIds()&quot;);</span>
<span class="nc" id="L2554">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2555">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2557">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2558" title="All 2 branches covered.">    for (SensorModel s : getSensorModels()) {</span>
<span class="fc" id="L2559">      ret.add(s.getId());</span>
<span class="fc" id="L2560">    }</span>
<span class="pc bpc" id="L2561" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2562">      endTime = System.nanoTime();</span>
<span class="nc" id="L2563">      diff = endTime - startTime;</span>
<span class="nc" id="L2564">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2565">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModelIds() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2568">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModels(java.lang.String)
   */
  @Override
  public List&lt;SensorModel&gt; getSensorModels() {
<span class="fc" id="L2578">    Long startTime = 0l;</span>
<span class="fc" id="L2579">    Long endTime = 0l;</span>
<span class="fc" id="L2580">    Long diff = 0l;</span>
<span class="pc bpc" id="L2581" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2582">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModels()&quot;);</span>
<span class="nc" id="L2583">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2584">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2586">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2587">    sessionOpen++;</span>
<span class="fc" id="L2588">    session.beginTransaction();</span>
<span class="fc" id="L2589">    List&lt;SensorModelImpl&gt; r = retrieveSensorModels(session);</span>
<span class="fc" id="L2590">    List&lt;SensorModel&gt; ret = new ArrayList&lt;SensorModel&gt;();</span>
<span class="fc bfc" id="L2591" title="All 2 branches covered.">    for (SensorModelImpl s : r) {</span>
<span class="fc" id="L2592">      ret.add(s.toSensorModel());</span>
<span class="fc" id="L2593">    }</span>
<span class="fc" id="L2594">    session.getTransaction().commit();</span>
<span class="fc" id="L2595">    session.close();</span>
<span class="fc" id="L2596">    sessionClose++;</span>
<span class="pc bpc" id="L2597" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2598">      endTime = System.nanoTime();</span>
<span class="nc" id="L2599">      diff = endTime - startTime;</span>
<span class="nc" id="L2600">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2601">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModels() took &quot; + (diff / 1E9) + &quot; secs.&quot;);</span>
    }
<span class="fc" id="L2603">    return ret;</span>
  }

  /**
   * @param id The sensor's id.
   * @param orgId The organization's id.
   * @return The defined Sensor or null.
   */
  private Sensor getSensorNoCheck(String id, String orgId) {
<span class="fc" id="L2612">    Long startTime = 0l;</span>
<span class="fc" id="L2613">    Long endTime = 0l;</span>
<span class="fc" id="L2614">    Long diff = 0l;</span>
<span class="pc bpc" id="L2615" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2616">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorNoCheck(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2617">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2619">    Sensor ret = null;</span>
<span class="fc" id="L2620">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2621">    sessionOpen++;</span>
<span class="fc" id="L2622">    session.beginTransaction();</span>
<span class="fc" id="L2623">    SensorImpl impl = retrieveSensor(session, id, orgId);</span>
<span class="pc bpc" id="L2624" title="1 of 2 branches missed.">    if (impl != null) {</span>
<span class="nc" id="L2625">      ret = impl.toSensor();</span>
    }
<span class="fc" id="L2627">    session.getTransaction().commit();</span>
<span class="fc" id="L2628">    session.close();</span>
<span class="fc" id="L2629">    sessionClose++;</span>
<span class="pc bpc" id="L2630" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2631">      endTime = System.nanoTime();</span>
<span class="nc" id="L2632">      diff = endTime - startTime;</span>
<span class="nc" id="L2633">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorNoCheck(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2636">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensors(java.lang.String)
   */
  @Override
  public List&lt;Sensor&gt; getSensors(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2646">    Long startTime = 0l;</span>
<span class="fc" id="L2647">    Long endTime = 0l;</span>
<span class="fc" id="L2648">    Long diff = 0l;</span>
<span class="pc bpc" id="L2649" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2650">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensors(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2651">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2652">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2654" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2655">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2657">    List&lt;Sensor&gt; ret = getSensorsNoCheck(orgId);</span>
<span class="pc bpc" id="L2658" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2659">      endTime = System.nanoTime();</span>
<span class="nc" id="L2660">      diff = endTime - startTime;</span>
<span class="nc" id="L2661">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2662">      timingLogger.log(Level.SEVERE, padding + &quot;getSensors(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2665">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return A list of the defined Sensors.
   */
  private List&lt;Sensor&gt; getSensorsNoCheck(String orgId) {
<span class="fc" id="L2673">    Long startTime = 0l;</span>
<span class="fc" id="L2674">    Long endTime = 0l;</span>
<span class="fc" id="L2675">    Long diff = 0l;</span>
<span class="pc bpc" id="L2676" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2677">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2678">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2679">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2681">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2682">    sessionOpen++;</span>
<span class="fc" id="L2683">    session.beginTransaction();</span>
<span class="fc" id="L2684">    List&lt;SensorImpl&gt; r = retrieveSensors(session, orgId);</span>
<span class="fc" id="L2685">    List&lt;Sensor&gt; ret = new ArrayList&lt;Sensor&gt;();</span>
<span class="fc bfc" id="L2686" title="All 2 branches covered.">    for (SensorImpl s : r) {</span>
<span class="fc" id="L2687">      ret.add(s.toSensor());</span>
<span class="fc" id="L2688">    }</span>
<span class="fc" id="L2689">    session.getTransaction().commit();</span>
<span class="fc" id="L2690">    session.close();</span>
<span class="fc" id="L2691">    sessionClose++;</span>
<span class="pc bpc" id="L2692" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2693">      endTime = System.nanoTime();</span>
<span class="nc" id="L2694">      diff = endTime - startTime;</span>
<span class="nc" id="L2695">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2696">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2699">    return ret;</span>
  }

  /**
   * @return the sessionClose
   */
  public int getSessionClose() {
<span class="fc" id="L2706">    return sessionClose;</span>
  }

  /**
   * @return the sessionOpen
   */
  public int getSessionOpen() {
<span class="fc" id="L2713">    return sessionOpen;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getSummary(java.lang.String,
   * java.lang.String, java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public SensorMeasurementSummary getSummary(String depotId, String orgId, String sensorId,
      Date start, Date end, boolean check) throws IdNotFoundException {
<span class="nc" id="L2725">    Long startTime = 0l;</span>
<span class="nc" id="L2726">    Long endTime = 0l;</span>
<span class="nc" id="L2727">    Long diff = 0l;</span>
<span class="nc bnc" id="L2728" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2729">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;)&quot;);
<span class="nc" id="L2731">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2732">      startTime = System.nanoTime();</span>
    }
<span class="nc" id="L2734">    List&lt;Measurement&gt; list = getMeasurements(depotId, orgId, sensorId, start, end, check);</span>
<span class="nc" id="L2735">    SensorMeasurementSummary ret = new SensorMeasurementSummary(sensorId, depotId, start, end,</span>
        list.size());
<span class="nc bnc" id="L2737" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2738">      endTime = System.nanoTime();</span>
<span class="nc" id="L2739">      diff = endTime - startTime;</span>
<span class="nc" id="L2740">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2741">      timingLogger.log(Level.SEVERE, padding + &quot;getSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L2744">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUser(java.lang.String)
   */
  @Override
  public UserInfo getUser(String id, String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2754">    Long startTime = 0l;</span>
<span class="fc" id="L2755">    Long endTime = 0l;</span>
<span class="fc" id="L2756">    Long diff = 0l;</span>
<span class="pc bpc" id="L2757" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2758">      timingLogger.log(Level.SEVERE, padding + &quot;Start getUser(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2759">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2760">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2762" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2763">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2765">    UserInfo ret = null;</span>
<span class="fc" id="L2766">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2767">    sessionOpen++;</span>
<span class="fc" id="L2768">    session.beginTransaction();</span>
<span class="fc" id="L2769">    UserInfoImpl impl = retrieveUser(session, id, orgId);</span>
<span class="fc bfc" id="L2770" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2771">      ret = impl.toUserInfo();</span>
    }
<span class="fc" id="L2773">    session.getTransaction().commit();</span>
<span class="fc" id="L2774">    session.close();</span>
<span class="fc" id="L2775">    sessionClose++;</span>
<span class="fc bfc" id="L2776" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2777">      throw new IdNotFoundException(id + &quot; is not a defined user id.&quot;);</span>
    }
<span class="pc bpc" id="L2779" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2780">      endTime = System.nanoTime();</span>
<span class="nc" id="L2781">      diff = endTime - startTime;</span>
<span class="nc" id="L2782">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2783">      timingLogger.log(Level.SEVERE, padding + &quot;getUser(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2786">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUserIds()
   */
  @Override
  public List&lt;String&gt; getUserIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2796">    Long startTime = 0l;</span>
<span class="fc" id="L2797">    Long endTime = 0l;</span>
<span class="fc" id="L2798">    Long diff = 0l;</span>
<span class="pc bpc" id="L2799" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2800">      timingLogger.log(Level.SEVERE, padding + &quot;Start getUserIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2801">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2802">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2804">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2805" title="All 2 branches covered.">    for (UserInfo u : getUsers(orgId, check)) {</span>
<span class="fc" id="L2806">      ret.add(u.getUid());</span>
<span class="fc" id="L2807">    }</span>
<span class="pc bpc" id="L2808" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2809">      endTime = System.nanoTime();</span>
<span class="nc" id="L2810">      diff = endTime - startTime;</span>
<span class="nc" id="L2811">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2812">      timingLogger.log(Level.SEVERE, padding + &quot;getUserIds(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2815">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUserPassword(java.lang.String)
   */
  @Override
  public UserPassword getUserPassword(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L2826">    UserPassword ret = null;</span>
<span class="fc" id="L2827">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2828">    sessionOpen++;</span>
<span class="fc" id="L2829">    session.beginTransaction();</span>
<span class="fc" id="L2830">    UserPasswordImpl impl = retrieveUserPassword(session, id, orgId);</span>
<span class="fc bfc" id="L2831" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2832">      ret = impl.toUserPassword();</span>
    }
<span class="fc" id="L2834">    session.getTransaction().commit();</span>
<span class="fc" id="L2835">    session.close();</span>
<span class="fc" id="L2836">    sessionClose++;</span>
<span class="fc bfc" id="L2837" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2838">      throw new IdNotFoundException(id + &quot; is not a valid UserPassword id.&quot;);</span>
    }
<span class="fc" id="L2840">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUsers()
   */
  @Override
  public List&lt;UserInfo&gt; getUsers() {
<span class="fc" id="L2850">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2851">    sessionOpen++;</span>
<span class="fc" id="L2852">    session.beginTransaction();</span>
<span class="fc" id="L2853">    List&lt;UserInfoImpl&gt; result = retrieveUsers(session);</span>
<span class="fc" id="L2854">    ArrayList&lt;UserInfo&gt; ret = new ArrayList&lt;UserInfo&gt;();</span>
<span class="fc bfc" id="L2855" title="All 2 branches covered.">    for (UserInfoImpl u : result) {</span>
<span class="fc" id="L2856">      ret.add(u.toUserInfo());</span>
<span class="fc" id="L2857">    }</span>
<span class="fc" id="L2858">    session.getTransaction().commit();</span>
<span class="fc" id="L2859">    session.close();</span>
<span class="fc" id="L2860">    sessionClose++;</span>
<span class="fc" id="L2861">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUsers()
   */
  @Override
  public List&lt;UserInfo&gt; getUsers(String orgId, boolean check) throws IdNotFoundException {
<span class="pc bpc" id="L2871" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2872">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2874">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2875">    sessionOpen++;</span>
<span class="fc" id="L2876">    session.beginTransaction();</span>
<span class="fc" id="L2877">    List&lt;UserInfoImpl&gt; result = retrieveUsers(session, orgId);</span>
<span class="fc" id="L2878">    ArrayList&lt;UserInfo&gt; ret = new ArrayList&lt;UserInfo&gt;();</span>
<span class="fc bfc" id="L2879" title="All 2 branches covered.">    for (UserInfoImpl u : result) {</span>
<span class="fc" id="L2880">      ret.add(u.toUserInfo());</span>
<span class="fc" id="L2881">    }</span>
<span class="fc" id="L2882">    session.getTransaction().commit();</span>
<span class="fc" id="L2883">    session.close();</span>
<span class="fc" id="L2884">    sessionClose++;</span>
<span class="fc" id="L2885">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date timestamp,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="pc bpc" id="L2897" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2898">      getOrganization(orgId, check);</span>
<span class="fc" id="L2899">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L2900">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L2902">    Double ret = null;</span>
<span class="fc" id="L2903">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2904">    session.beginTransaction();</span>
<span class="fc" id="L2905">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L2906">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2908">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp = :time AND depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
<span class="fc bfc" id="L2913" title="All 2 branches covered.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L2914">      ret = result.get(0).getValue();</span>
    }
    else {
      // need to get the stradle
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2919">      List&lt;MeasurementImpl&gt; before = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &lt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2925">      List&lt;MeasurementImpl&gt; after = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &gt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setMaxResults(1).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L2930">      MeasurementImpl justBefore = null;</span>
<span class="fc bfc" id="L2931" title="All 2 branches covered.">      for (MeasurementImpl b : before) {</span>
<span class="pc bpc" id="L2932" title="1 of 2 branches missed.">        if (b.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L2933" title="1 of 2 branches missed.">          if (justBefore == null) {</span>
<span class="fc" id="L2934">            justBefore = b;</span>
          }
<span class="nc bnc" id="L2936" title="All 2 branches missed.">          else if (b.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L2937">            justBefore = b;</span>
          }
        }
<span class="fc" id="L2940">      }</span>
<span class="fc bfc" id="L2941" title="All 2 branches covered.">      if (justBefore == null) {</span>
<span class="fc" id="L2942">        session.getTransaction().commit();</span>
<span class="fc" id="L2943">        session.close();</span>
<span class="fc" id="L2944">        throw new NoMeasurementException(&quot;Cannot find measurement before &quot; + timestamp);</span>
      }
<span class="fc" id="L2946">      MeasurementImpl justAfter = null;</span>
<span class="fc bfc" id="L2947" title="All 2 branches covered.">      for (MeasurementImpl a : after) {</span>
<span class="pc bpc" id="L2948" title="1 of 2 branches missed.">        if (a.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L2949" title="1 of 2 branches missed.">          if (justAfter == null) {</span>
<span class="fc" id="L2950">            justAfter = a;</span>
          }
<span class="nc bnc" id="L2952" title="All 2 branches missed.">          else if (a.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L2953">            justAfter = a;</span>
          }
        }
<span class="fc" id="L2956">      }</span>
<span class="fc bfc" id="L2957" title="All 2 branches covered.">      if (justAfter == null) {</span>
<span class="fc" id="L2958">        session.getTransaction().commit();</span>
<span class="fc" id="L2959">        session.close();</span>
<span class="fc" id="L2960">        throw new NoMeasurementException(&quot;Cannot find measurement after &quot; + timestamp);</span>
      }
<span class="fc" id="L2962">      Double val1 = justBefore.getValue();</span>
<span class="fc" id="L2963">      Double val2 = justAfter.getValue();</span>
<span class="fc" id="L2964">      Double deltaV = val2 - val1;</span>
<span class="fc" id="L2965">      Long t1 = justBefore.getTimestamp().getTime();</span>
<span class="fc" id="L2966">      Long t2 = justAfter.getTimestamp().getTime();</span>
<span class="fc" id="L2967">      Long deltaT = t2 - t1;</span>
<span class="fc" id="L2968">      Long t3 = timestamp.getTime();</span>
<span class="fc" id="L2969">      Long toDate = t3 - t1;</span>
<span class="fc" id="L2970">      Double slope = deltaV / deltaT;</span>
<span class="fc" id="L2971">      ret = val1 + slope * toDate;</span>
    }
<span class="fc" id="L2973">    session.getTransaction().commit();</span>
<span class="fc" id="L2974">    session.close();</span>
<span class="fc" id="L2975">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date start, Date end,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L2987">    Double endVal = getValue(depotId, orgId, sensorId, end, check);</span>
<span class="fc" id="L2988">    Double startVal = getValue(depotId, orgId, sensorId, start, check);</span>
<span class="pc bpc" id="L2989" title="2 of 4 branches missed.">    if (endVal != null &amp;&amp; startVal != null) {</span>
<span class="fc" id="L2990">      return endVal - startVal;</span>
    }
<span class="nc" id="L2992">    return null;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date, java.lang.Long)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date start, Date end,
      Long gapSeconds, boolean check) throws NoMeasurementException, MeasurementGapException,
      IdNotFoundException {
<span class="fc" id="L3005">    Double endVal = getValue(depotId, orgId, sensorId, end, gapSeconds, check);</span>
<span class="fc" id="L3006">    Double startVal = getValue(depotId, orgId, sensorId, start, gapSeconds, check);</span>
<span class="pc bpc" id="L3007" title="2 of 4 branches missed.">    if (endVal != null &amp;&amp; startVal != null) {</span>
<span class="fc" id="L3008">      return endVal - startVal;</span>
    }
<span class="nc" id="L3010">    return null;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.lang.Long)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date timestamp,
      Long gapSeconds, boolean check) throws NoMeasurementException, MeasurementGapException,
      IdNotFoundException {
<span class="pc bpc" id="L3023" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L3024">      getOrganization(orgId, check);</span>
<span class="fc" id="L3025">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L3026">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L3028">    Double ret = null;</span>
<span class="fc" id="L3029">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3030">    session.beginTransaction();</span>
<span class="fc" id="L3031">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L3032">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3034">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp = :time AND depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L3039" title="All 2 branches covered.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L3040">      ret = result.get(0).getValue();</span>
    }
    else {
      // need to get the stradle
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3045">      List&lt;MeasurementImpl&gt; before = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &lt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3051">      List&lt;MeasurementImpl&gt; after = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &gt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setMaxResults(1).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L3056">      MeasurementImpl justBefore = null;</span>
<span class="fc bfc" id="L3057" title="All 2 branches covered.">      for (MeasurementImpl b : before) {</span>
<span class="pc bpc" id="L3058" title="1 of 2 branches missed.">        if (b.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3059" title="1 of 2 branches missed.">          if (justBefore == null) {</span>
<span class="fc" id="L3060">            justBefore = b;</span>
          }
<span class="nc bnc" id="L3062" title="All 2 branches missed.">          else if (b.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3063">            justBefore = b;</span>
          }
        }
<span class="fc" id="L3066">      }</span>
<span class="fc bfc" id="L3067" title="All 2 branches covered.">      if (justBefore == null) {</span>
<span class="fc" id="L3068">        session.getTransaction().commit();</span>
<span class="fc" id="L3069">        session.close();</span>
<span class="fc" id="L3070">        throw new NoMeasurementException(&quot;Cannot find measurement before &quot; + timestamp + &quot; in &quot; + depot.getName() + &quot; for &quot; + sensor.getName());</span>
      }
<span class="fc" id="L3072">      MeasurementImpl justAfter = null;</span>
<span class="fc bfc" id="L3073" title="All 2 branches covered.">      for (MeasurementImpl a : after) {</span>
<span class="pc bpc" id="L3074" title="1 of 2 branches missed.">        if (a.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3075" title="1 of 2 branches missed.">          if (justAfter == null) {</span>
<span class="fc" id="L3076">            justAfter = a;</span>
          }
<span class="nc bnc" id="L3078" title="All 2 branches missed.">          else if (a.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3079">            justAfter = a;</span>
          }
        }
<span class="fc" id="L3082">      }</span>
<span class="fc bfc" id="L3083" title="All 2 branches covered.">      if (justAfter == null) {</span>
<span class="fc" id="L3084">        session.getTransaction().commit();</span>
<span class="fc" id="L3085">        session.close();</span>
<span class="fc" id="L3086">        throw new NoMeasurementException(&quot;Cannot find measurement after &quot; + timestamp + &quot; in &quot; + depot.getName() + &quot; for &quot; + sensor.getName());</span>
      }
<span class="fc" id="L3088">      Double val1 = justBefore.getValue();</span>
<span class="fc" id="L3089">      Double val2 = justAfter.getValue();</span>
<span class="fc" id="L3090">      Double deltaV = val2 - val1;</span>
<span class="fc" id="L3091">      Long t1 = justBefore.getTimestamp().getTime();</span>
<span class="fc" id="L3092">      Long t2 = justAfter.getTimestamp().getTime();</span>
<span class="fc" id="L3093">      Long deltaT = t2 - t1;</span>
<span class="fc bfc" id="L3094" title="All 2 branches covered.">      if ((deltaT / 1000) &gt; gapSeconds) {</span>
<span class="fc" id="L3095">        session.getTransaction().commit();</span>
<span class="fc" id="L3096">        session.close();</span>
<span class="fc" id="L3097">        throw new MeasurementGapException(&quot;Gap of &quot; + (deltaT / 1000) + &quot;s is longer than &quot;</span>
            + gapSeconds + &quot; for &quot; + sensor.getName() + &quot; in &quot; + depot.getName());
      }
<span class="fc" id="L3100">      Long t3 = timestamp.getTime();</span>
<span class="fc" id="L3101">      Long toDate = t3 - t1;</span>
<span class="fc" id="L3102">      Double slope = deltaV / deltaT;</span>
<span class="fc" id="L3103">      ret = val1 + slope * toDate;</span>
    }
<span class="fc" id="L3105">    session.getTransaction().commit();</span>
<span class="fc" id="L3106">    session.close();</span>
<span class="fc" id="L3107">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#listSensors(java.lang.String)
   */
  @Override
  public List&lt;String&gt; listSensors(String depotId, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L3119">    Long startTime = 0l;</span>
<span class="fc" id="L3120">    Long endTime = 0l;</span>
<span class="fc" id="L3121">    Long diff = 0l;</span>
<span class="pc bpc" id="L3122" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L3123">      timingLogger.log(Level.SEVERE, padding + &quot;Start listSensors(&quot; + depotId + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L3124">      padding += &quot;  &quot;;</span>
<span class="nc" id="L3125">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L3127" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L3128">      getOrganization(orgId, check);</span>
<span class="fc" id="L3129">      getDepository(depotId, orgId, check);</span>
    }
<span class="fc" id="L3131">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3132">    session.beginTransaction();</span>
<span class="fc" id="L3133">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
    // List&lt;SensorImpl&gt; result = (List&lt;SensorImpl&gt;) session
    // .createQuery(
    // &quot;select distinct meas.sensor FROM MeasurementImpl meas WHERE meas.depository = :depot&quot;)
    // .setParameter(&quot;depot&quot;, depot).list();
<span class="fc" id="L3139">    List&lt;DepositorySensorContribution&gt; result = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where depository = :depository&quot;)
        .setParameter(&quot;depository&quot;, depot).list();
<span class="fc" id="L3142">    ArrayList&lt;String&gt; sensorIds = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L3143" title="All 2 branches covered.">    for (DepositorySensorContribution contrib : result) {</span>
<span class="fc" id="L3144">      sensorIds.add(contrib.getSensor().getId());</span>
<span class="fc" id="L3145">    }</span>
    // for (SensorImpl sensor : result) {
    // if (!sensorIds.contains(sensor.getId())) {
    // sensorIds.add(sensor.getId());
    // }
    // }
<span class="fc" id="L3151">    session.getTransaction().commit();</span>
<span class="fc" id="L3152">    session.close();</span>
<span class="pc bpc" id="L3153" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L3154">      endTime = System.nanoTime();</span>
<span class="nc" id="L3155">      diff = endTime - startTime;</span>
<span class="nc" id="L3156">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L3157">      timingLogger.log(Level.SEVERE, padding + &quot;listSensors(&quot; + depotId + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L3160">    return sensorIds;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#putMeasurement(java.lang.String,
   * org.wattdepot.common.domainmodel.Measurement)
   */
  @Override
  public void putMeasurement(String depotId, String orgId, Measurement meas)
      throws MeasurementTypeException, IdNotFoundException {
<span class="fc" id="L3173">    getOrganization(orgId, true);</span>
<span class="fc" id="L3174">    Depository d = getDepository(depotId, orgId, true);</span>
<span class="pc bpc" id="L3175" title="1 of 2 branches missed.">    if (!meas.getMeasurementType().equals(d.getMeasurementType().getUnits())) {</span>
<span class="nc" id="L3176">      throw new MeasurementTypeException(&quot;Measurement's type &quot; + meas.getMeasurementType()</span>
          + &quot; does not match &quot; + d.getMeasurementType());
    }
<span class="fc" id="L3179">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3180">    session.beginTransaction();</span>
<span class="fc" id="L3181">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L3182">    SensorImpl sensor = retrieveSensor(session, meas.getSensorId(), orgId);</span>
<span class="fc" id="L3183">    DepositorySensorContribution contrib = retrieveContribution(session, depot, sensor);</span>
<span class="fc bfc" id="L3184" title="All 2 branches covered.">    if (contrib == null) {</span>
<span class="fc" id="L3185">      contrib = new DepositorySensorContribution();</span>
<span class="fc" id="L3186">      contrib.setDepository(depot);</span>
<span class="fc" id="L3187">      contrib.setSensor(sensor);</span>
<span class="fc" id="L3188">      session.saveOrUpdate(contrib);</span>
    }
<span class="fc" id="L3190">    MeasurementImpl impl = new MeasurementImpl();</span>
<span class="fc" id="L3191">    impl.setDepository(depot);</span>
<span class="fc" id="L3192">    impl.setSensor(sensor);</span>
<span class="fc" id="L3193">    impl.setId(meas.getId());</span>
<span class="fc" id="L3194">    impl.setTimestamp(meas.getDate());</span>
<span class="fc" id="L3195">    impl.setValue(meas.getValue());</span>
<span class="fc" id="L3196">    impl.setUnits(meas.getMeasurementType().toString());</span>
//    InterpolatedValue iv = new InterpolatedValue(sensor.getId(), meas.getValue(), d.getMeasurementType(), meas.getDate());
//    depotSensorInfo.update(orgId, depotId, meas.getSensorId(), iv);
<span class="fc" id="L3199">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3200">    session.getTransaction().commit();</span>
<span class="fc" id="L3201">    session.close();</span>
<span class="fc" id="L3202">  }</span>

  /*
 * (non-Javadoc)
 *
 * @see
 * org.wattdepot.server.WattDepotPersistence#putMeasurement(java.lang.String,
 * org.wattdepot.common.domainmodel.MeasurementList)
 */
  @Override
  public void putMeasurementList(String depotId, String orgId, MeasurementList measurementList)
      throws MeasurementTypeException, IdNotFoundException {
<span class="fc" id="L3214">    getOrganization(orgId, true);</span>
    //We just checked the organisation, no reason to do it again.

<span class="fc" id="L3217">    Depository d = getDepository(depotId, orgId, false);</span>

<span class="fc" id="L3219">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3220">    Transaction transaction = session.beginTransaction();</span>
<span class="fc" id="L3221">    OrganizationImpl organization = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3222">    DepositoryImpl depository = retrieveDepository(session, depotId, organization);</span>

    //Cache all sensors for organization in a map
<span class="fc" id="L3225">    List&lt;SensorImpl&gt; sensors = retrieveSensors(session, organization);</span>
<span class="fc" id="L3226">    Map&lt;String, SensorImpl&gt; sensorMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L3227" title="All 2 branches covered.">    for (SensorImpl sensor : sensors) {</span>
<span class="fc" id="L3228">      sensorMap.put(sensor.getId(), sensor);</span>
<span class="fc" id="L3229">    }</span>

    //Cache all depository sensor contributions for this depository
<span class="fc" id="L3232">    List&lt;DepositorySensorContribution&gt; depositorySensorContributions = retrieveContributions(</span>
        session, depository);
<span class="fc" id="L3234">    Map&lt;String, DepositorySensorContribution&gt; depositorySensorContributionsMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L3235" title="All 2 branches covered.">    for (DepositorySensorContribution depositorySensorContribution : depositorySensorContributions) {</span>
<span class="fc" id="L3236">      depositorySensorContributionsMap.put(depositorySensorContribution.getSensor().getId(), depositorySensorContribution);</span>
<span class="fc" id="L3237">    }</span>

<span class="fc bfc" id="L3239" title="All 2 branches covered.">    for (int i = 0; i &lt;  measurementList.getMeasurements().size(); i++) {</span>
    //for (Measurement measurement : measurementList.getMeasurements()) {
<span class="fc" id="L3241">      Measurement measurement = measurementList.getMeasurements().get(i);</span>
<span class="pc bpc" id="L3242" title="1 of 2 branches missed.">      if (!measurement.getMeasurementType().equals(d.getMeasurementType().getUnits())) {</span>
<span class="nc" id="L3243">        throw new MeasurementTypeException(&quot;Measurement's type &quot; + measurement.getMeasurementType()</span>
            + &quot; does not match &quot; + d.getMeasurementType());
      }
<span class="fc" id="L3246">      SensorImpl sensor = sensorMap.get(measurement.getSensorId());</span>
<span class="fc" id="L3247">      DepositorySensorContribution contrib = depositorySensorContributionsMap.get(sensor.getId());</span>
<span class="pc bpc" id="L3248" title="1 of 2 branches missed.">      if (contrib == null) {</span>
<span class="nc" id="L3249">        contrib = new DepositorySensorContribution();</span>
<span class="nc" id="L3250">        contrib.setDepository(depository);</span>
<span class="nc" id="L3251">        contrib.setSensor(sensor);</span>
<span class="nc" id="L3252">        session.saveOrUpdate(contrib);</span>
<span class="nc" id="L3253">        depositorySensorContributionsMap.put(sensor.getId(), contrib);</span>
      }
<span class="fc" id="L3255">      MeasurementImpl impl = new MeasurementImpl();</span>
<span class="fc" id="L3256">      impl.setDepository(depository);</span>
<span class="fc" id="L3257">      impl.setSensor(sensor);</span>
<span class="fc" id="L3258">      impl.setId(measurement.getId());</span>
<span class="fc" id="L3259">      impl.setTimestamp(measurement.getDate());</span>
<span class="fc" id="L3260">      impl.setValue(measurement.getValue());</span>
<span class="fc" id="L3261">      impl.setUnits(measurement.getMeasurementType().toString());</span>
<span class="fc" id="L3262">      session.saveOrUpdate(impl);</span>
<span class="fc bfc" id="L3263" title="All 2 branches covered.">      if ( i % 50 == 0 ) { //50, same as the JDBC batch size</span>
        //flush a batch of inserts and release memory:
<span class="fc" id="L3265">        session.flush();</span>
<span class="fc" id="L3266">        session.clear();</span>
      }
    }
<span class="fc" id="L3269">    transaction.commit();</span>
<span class="fc" id="L3270">    session.close();</span>
<span class="fc" id="L3271">  }</span>

  /**
   * @param session The session with an open transaction.
   * @param id The CollectorProcessDefinition's id.
   * @param orgId The owner Organization's id.
   * @return the CollectorProcessDefinition if defined.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private CollectorProcessDefinitionImpl retrieveCollectorProcessDefinition(Session session,
      String id, String orgId) {
<span class="fc" id="L3282">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3283">    List&lt;CollectorProcessDefinitionImpl&gt; cpds = (List&lt;CollectorProcessDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM CollectorProcessDefinitionImpl WHERE id = :id AND org = :org&quot;)
        .setParameter(&quot;id&quot;, id).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3286" title="All 2 branches covered.">    if (cpds.size() == 1) {</span>
<span class="fc" id="L3287">      return cpds.get(0);</span>
    }
    else {
<span class="fc" id="L3290">      return null;</span>
    }
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return a List of CollectorProcessDefinitions owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;CollectorProcessDefinitionImpl&gt; retrieveCollectorProcessDefinitions(Session session,
      String orgId) {
<span class="fc" id="L3302">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3303">    List&lt;CollectorProcessDefinitionImpl&gt; ret = (List&lt;CollectorProcessDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM CollectorProcessDefinitionImpl WHERE org = :org&quot;)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3306">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param depo The Depository.
   * @param sensor The Sensor.
   * @return The DepositorySensorContribution if the sensor has contributed
   *         measurements to the depository, or null.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositorySensorContribution retrieveContribution(Session session, DepositoryImpl depo,
      SensorImpl sensor) {
<span class="fc" id="L3319">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(
            &quot;from DepositorySensorContribution where sensor = :sensor and depository = :depository&quot;)
        .setParameter(&quot;sensor&quot;, sensor).setParameter(&quot;depository&quot;, depo).list();
<span class="fc bfc" id="L3323" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3324">      return ret.get(0);</span>
    }
<span class="fc" id="L3326">    return null;</span>
  }

  /**
   * @param session A session with an open transaction.
   * @param depository The depository to search for.
   * @return A List of DepositorySensorContributions for the given depository.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositorySensorContribution&gt; retrieveContributions(Session session,
      DepositoryImpl depository) {
<span class="fc" id="L3337">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where depository = :depository&quot;)
        .setParameter(&quot;depository&quot;, depository).list();
<span class="fc" id="L3340">    return ret;</span>
  }

  /**
   * @param session A session with an open transaction.
   * @param sensor The sensor to search for.
   * @return A List of DepositorySensorContributions for the given sensor.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositorySensorContribution&gt; retrieveContributions(Session session,
      SensorImpl sensor) {
<span class="fc" id="L3351">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where sensor = :sensor&quot;)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L3354">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param type The measurement type of the depository.
   * @return A List of all the depositories with the given measurment type.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositoryImpl&gt; retrieveDepositories(Session session, MeasurementTypeImpl type) {
<span class="fc" id="L3364">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE type = :type&quot;).setParameter(&quot;type&quot;, type).list();
<span class="fc" id="L3366">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositoryImpl&gt; retrieveDepositories(Session session, String orgId) {
<span class="fc" id="L3376">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3377">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3379">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Depository's id.
   * @param orgId The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositoryImpl retrieveDepository(Session session, String id, String orgId) {
<span class="fc" id="L3390">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3391">    return retrieveDepository(session, id, org);</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Depository's id.
   * @param org The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositoryImpl retrieveDepository(Session session, String id, OrganizationImpl org) {
<span class="fc" id="L3402">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3405" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3406">      return ret.get(0);</span>
    }
<span class="fc" id="L3408">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the MeasurementPruningDefinition's id.
   * @param orgId The Organization's id.
   * @return The MeasurementPruningDefinitionImpl or null if not defined.
   */
  private MeasurementPruningDefinitionImpl retrieveMeasurementPruningDefinition(Session session,
      String id, String orgId) {
<span class="fc" id="L3419">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3421">    List&lt;MeasurementPruningDefinitionImpl&gt; result = (List&lt;MeasurementPruningDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementPruningDefinitionImpl WHERE id = :id AND org = :org&quot;)
        .setParameter(&quot;id&quot;, id).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3424" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3425">      return result.get(0);</span>
    }
<span class="fc" id="L3427">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The Organization's id.
   * @return A list of the defined MeasurementPruningDefinitionImpls.
   */
  private List&lt;MeasurementPruningDefinitionImpl&gt; retrieveMeasurementPruningDefinitions(
      Session session, String orgId) {
<span class="fc" id="L3437">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3439">    List&lt;MeasurementPruningDefinitionImpl&gt; result = (List&lt;MeasurementPruningDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementPruningDefinitionImpl WHERE org = :org&quot;)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3442">    return result;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param depotId the id of the Depository.
   * @param orgId the organization's id.
   * @param measId the measurement's id.
   * @return the MeasurementImpl.
   */
  private MeasurementImpl retrieveMeasurement(Session session, String depotId, String orgId,
      String measId) {
<span class="fc" id="L3454">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3456">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depository AND id = :id&quot;)
        .setParameter(&quot;depository&quot;, depot).setParameter(&quot;id&quot;, measId).list();
<span class="fc bfc" id="L3459" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3460">      return result.get(0);</span>
    }
<span class="fc" id="L3462">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @param id The id of the MeasurementType.
   * @return The MeasurementType with the given id.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private MeasurementTypeImpl retrieveMeasurementType(Session session, String id) {
<span class="fc" id="L3472">    List&lt;MeasurementTypeImpl&gt; ret = (List&lt;MeasurementTypeImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementTypeImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3474" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3475">      return ret.get(0);</span>
    }
<span class="fc" id="L3477">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @return The list of defined MeasurementTypes.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;MeasurementTypeImpl&gt; retrieveMeasurementTypes(Session session) {
<span class="fc" id="L3486">    List&lt;MeasurementTypeImpl&gt; ret = (List&lt;MeasurementTypeImpl&gt;) session.createQuery(</span>
        &quot;FROM MeasurementTypeImpl&quot;).list();
<span class="fc" id="L3488">    return ret;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @param id The id of the Organization.
   * @return The Organization with the given id.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private OrganizationImpl retrieveOrganization(Session session, String id) {
<span class="fc" id="L3498">    List&lt;OrganizationImpl&gt; ret = (List&lt;OrganizationImpl&gt;) session</span>
        .createQuery(&quot;from OrganizationImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3500" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3501">      return ret.get(0);</span>
    }
<span class="fc" id="L3503">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @return The List of defined Organizations.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;OrganizationImpl&gt; retrieveOrganizations(Session session) {
<span class="fc" id="L3512">    List&lt;OrganizationImpl&gt; ret = (List&lt;OrganizationImpl&gt;) session.createQuery(</span>
        &quot;from OrganizationImpl&quot;).list();
<span class="fc" id="L3514">    return ret;</span>

  }

  /**
   * @param session The session with an open transaction.
   * @param id the Sensor's id.
   * @param orgId The owner's Organization id.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorImpl retrieveSensor(Session session, String id, String orgId) {
<span class="fc" id="L3526">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3527">    return retrieveSensor(session, id, org);</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Sensor's id.
   * @param org The owner's OrganizationImpl.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorImpl retrieveSensor(Session session, String id, OrganizationImpl org) {
<span class="fc" id="L3538">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3541" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3542">      return ret.get(0);</span>
    }
<span class="fc" id="L3544">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param org The owner's OrganizationImpl.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorImpl&gt; retrieveSensors(Session session, OrganizationImpl org) {
<span class="fc" id="L3554">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;,
            org).list();
<span class="fc" id="L3557">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the SensorGroup's id.
   * @param orgId The owner's Organization id.
   * @return The SensorGroup with the given id, owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorGroupImpl retrieveSensorGroup(Session session, String id, String orgId) {
<span class="fc" id="L3568">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3569">    List&lt;SensorGroupImpl&gt; result = (List&lt;SensorGroupImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorGroupImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3572" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3573">      return result.get(0);</span>
    }
<span class="fc" id="L3575">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return a List of the SensorGroups owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorGroupImpl&gt; retrieveSensorGroups(Session session, String orgId) {
<span class="fc" id="L3585">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3586">    List&lt;SensorGroupImpl&gt; result = (List&lt;SensorGroupImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorGroupImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3588">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param id the id of the SensorModel to retrieve.
   * @return A List of the SensorModels owned by the orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorModelImpl retrieveSensorModel(Session session, String id) {
<span class="fc" id="L3598">    List&lt;SensorModelImpl&gt; result = (List&lt;SensorModelImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorModelImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3600" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3601">      return result.get(0);</span>
    }
<span class="fc" id="L3603">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @return A List of the SensorModels owned by the orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorModelImpl&gt; retrieveSensorModels(Session session) {
<span class="fc" id="L3612">    List&lt;SensorModelImpl&gt; ret = (List&lt;SensorModelImpl&gt;) session.createQuery(&quot;FROM SensorModelImpl&quot;)</span>
        .list();
<span class="fc" id="L3614">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return A List of the Sensors owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorImpl&gt; retrieveSensors(Session session, String orgId) {
<span class="fc" id="L3624">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3625">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3627">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param uid the User's id.
   * @param orgId the Organziation's id.
   * @return the UserInfoImpl.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private UserInfoImpl retrieveUser(Session session, String uid, String orgId) {
<span class="fc" id="L3638">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3639">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session</span>
        .createQuery(&quot;FROM UserInfoImpl WHERE uid = :uid AND org = :org&quot;).setParameter(&quot;uid&quot;, uid)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3642" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3643">      return result.get(0);</span>
    }
<span class="fc" id="L3645">    return null;</span>

  }

  /**
   * @param session The Session with an open transaction.
   * @param id the user's id.
   * @param orgId the organization's id.
   * @return the UserPasswordImpl.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private UserPasswordImpl retrieveUserPassword(Session session, String id, String orgId) {
<span class="fc" id="L3657">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3658">    UserInfoImpl user = retrieveUser(session, id, orgId);</span>
<span class="fc" id="L3659">    List&lt;UserPasswordImpl&gt; result = (List&lt;UserPasswordImpl&gt;) session</span>
        .createQuery(&quot;FROM UserPasswordImpl WHERE user = :user AND org = :org&quot;)
        .setParameter(&quot;user&quot;, user).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3662" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3663">      return result.get(0);</span>
    }
<span class="fc" id="L3665">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The organization id.
   * @return a List of the user passwords in the given organization.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserPasswordImpl&gt; retrieveUserPasswords(Session session, String orgId) {
<span class="fc" id="L3675">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3676">    List&lt;UserPasswordImpl&gt; result = (List&lt;UserPasswordImpl&gt;) session</span>
        .createQuery(&quot;FROM UserPasswordImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3678">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @return A List of all the defined users.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserInfoImpl&gt; retrieveUsers(Session session) {
<span class="fc" id="L3687">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session.createQuery(&quot;FROM UserInfoImpl&quot;)</span>
        .list();
<span class="fc" id="L3689">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The organization id.
   * @return a List of the users in the given organization.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserInfoImpl&gt; retrieveUsers(Session session, String orgId) {
<span class="fc" id="L3699">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3700">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session</span>
        .createQuery(&quot;FROM UserInfoImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3702">    return result;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#stop()
   */
  @Override
  public void stop() {
<span class="fc" id="L3712">    Manager.closeSession();</span>
<span class="fc" id="L3713">  }</span>

  /**
   * Use this method after beginning a transaction.
   * 
   * @param session The Session, a transaction must be in progress.
   * @param cpd The CollectorProcessDefinitionImpl to save.
   */
  private void storeCollectorProcessDefinition(Session session, CollectorProcessDefinitionImpl cpd) {
<span class="pc bpc" id="L3722" title="1 of 2 branches missed.">    for (PropertyImpl p : cpd.getProperties()) {</span>
<span class="nc" id="L3723">      session.saveOrUpdate(p);</span>
<span class="nc" id="L3724">    }</span>
<span class="fc" id="L3725">    session.saveOrUpdate(cpd);</span>

<span class="fc" id="L3727">  }</span>

  /**
   * Use this method after beginning a transaction.
   * 
   * @param session The Session, a transaction must be in progress.
   * @param sensor The SensorImpl to save.
   */
  private void storeSensor(Session session, SensorImpl sensor) {
<span class="pc bpc" id="L3736" title="1 of 2 branches missed.">    for (PropertyImpl p : sensor.getProperties()) {</span>
<span class="nc" id="L3737">      session.saveOrUpdate(p);</span>
<span class="nc" id="L3738">    }</span>
<span class="fc" id="L3739">    session.saveOrUpdate(sensor);</span>
<span class="fc" id="L3740">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateCollectorProcessDefinition(org.wattdepot
   * . datamodel .CollectorProcessDefinition)
   */
  @Override
  public CollectorProcessDefinition updateCollectorProcessDefinition(
      CollectorProcessDefinition process) throws IdNotFoundException {
<span class="fc" id="L3752">    getCollectorProcessDefinition(process.getId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3753">    getDepository(process.getDepositoryId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3754">    getSensor(process.getSensorId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3755">    CollectorProcessDefinition ret = null;</span>
<span class="fc" id="L3756">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3757">    sessionOpen++;</span>
<span class="fc" id="L3758">    session.beginTransaction();</span>
<span class="fc" id="L3759">    CollectorProcessDefinitionImpl impl = retrieveCollectorProcessDefinition(session,</span>
        process.getId(), process.getOrganizationId());
<span class="fc" id="L3761">    impl.setId(process.getId());</span>
<span class="fc" id="L3762">    impl.setName(process.getName());</span>
<span class="fc" id="L3763">    impl.setPollingInterval(process.getPollingInterval());</span>
<span class="fc" id="L3764">    impl.setDepository(retrieveDepository(session, process.getDepositoryId(),</span>
        process.getOrganizationId()));
<span class="fc" id="L3766">    impl.setSensor(retrieveSensor(session, process.getSensorId(), process.getOrganizationId()));</span>
<span class="fc" id="L3767">    impl.setOrg(retrieveOrganization(session, process.getOrganizationId()));</span>
<span class="fc" id="L3768">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L3769" title="1 of 2 branches missed.">    for (Property p : process.getProperties()) {</span>
<span class="nc" id="L3770">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L3771">    }</span>
<span class="fc" id="L3772">    impl.setProperties(props);</span>
<span class="fc" id="L3773">    storeCollectorProcessDefinition(session, impl);</span>
<span class="fc" id="L3774">    ret = impl.toCPD();</span>
<span class="fc" id="L3775">    session.getTransaction().commit();</span>
<span class="fc" id="L3776">    session.close();</span>
<span class="fc" id="L3777">    sessionClose++;</span>
<span class="fc" id="L3778">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#updateMeasurementPruningDefinition
   * (org.wattdepot.common.domainmodel.MeasurementPruningDefinition)
   */
  @Override
  public MeasurementPruningDefinition updateMeasurementPruningDefinition(
      MeasurementPruningDefinition gcd) throws IdNotFoundException {
<span class="fc" id="L3791">    getMeasurementPruningDefinition(gcd.getId(), gcd.getOrganizationId(), true);</span>
<span class="fc" id="L3792">    getDepository(gcd.getDepositoryId(), gcd.getOrganizationId(), true);</span>
<span class="fc" id="L3793">    MeasurementPruningDefinition ret = null;</span>
<span class="fc" id="L3794">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3795">    sessionOpen++;</span>
<span class="fc" id="L3796">    session.beginTransaction();</span>
<span class="fc" id="L3797">    MeasurementPruningDefinitionImpl impl = retrieveMeasurementPruningDefinition(session,</span>
        gcd.getId(), gcd.getOrganizationId());
<span class="fc" id="L3799">    impl.setName(gcd.getName());</span>
<span class="fc" id="L3800">    impl.setDepository(retrieveDepository(session, gcd.getDepositoryId(), gcd.getOrganizationId()));</span>
<span class="fc" id="L3801">    impl.setSensor(gcd.getSensorId());</span>
<span class="fc" id="L3802">    impl.setIgnoreWindowDays(gcd.getIgnoreWindowDays());</span>
<span class="fc" id="L3803">    impl.setCollectWindowDays(gcd.getCollectWindowDays());</span>
<span class="fc" id="L3804">    impl.setMinGapSeconds(gcd.getMinGapSeconds());</span>
<span class="fc" id="L3805">    impl.setLastStarted(gcd.getLastStarted());</span>
<span class="fc" id="L3806">    impl.setLastCompleted(gcd.getLastCompleted());</span>
<span class="fc" id="L3807">    impl.setNumMeasurementsCollected(gcd.getNumMeasurementsCollected());</span>
<span class="fc" id="L3808">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3809">    ret = impl.toMPD();</span>
<span class="fc" id="L3810">    session.getTransaction().commit();</span>
<span class="fc" id="L3811">    session.close();</span>
<span class="fc" id="L3812">    sessionClose++;</span>
<span class="fc" id="L3813">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateMeasurementType(org.wattdepot.datamodel
   * .MeasurementType)
   */
  @Override
  public MeasurementType updateMeasurementType(MeasurementType type) {
<span class="fc" id="L3825">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3826">    sessionOpen++;</span>
<span class="fc" id="L3827">    session.beginTransaction();</span>
<span class="fc" id="L3828">    MeasurementTypeImpl impl = retrieveMeasurementType(session, type.getId());</span>
<span class="fc" id="L3829">    impl.setName(type.getName());</span>
<span class="fc" id="L3830">    impl.setUnits(type.getUnits());</span>
<span class="fc" id="L3831">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3832">    session.getTransaction().commit();</span>
<span class="fc" id="L3833">    session.close();</span>
<span class="fc" id="L3834">    sessionClose++;</span>

<span class="fc" id="L3836">    return type;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateOrganization(org.wattdepot.datamodel
   * .Organization)
   */
  @Override
  public Organization updateOrganization(Organization org) throws IdNotFoundException {
<span class="fc" id="L3848">    getOrganization(org.getId(), true);</span>
<span class="fc bfc" id="L3849" title="All 2 branches covered.">    for (String s : org.getUsers()) {</span>
<span class="fc" id="L3850">      getUser(s, org.getId(), true);</span>
<span class="fc" id="L3851">    }</span>
<span class="fc" id="L3852">    Organization ret = null;</span>
<span class="fc" id="L3853">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3854">    sessionOpen++;</span>
<span class="fc" id="L3855">    session.beginTransaction();</span>
<span class="fc" id="L3856">    OrganizationImpl impl = retrieveOrganization(session, org.getId());</span>
<span class="fc" id="L3857">    impl.setId(org.getId());</span>
<span class="fc" id="L3858">    impl.setName(org.getName());</span>
<span class="fc bfc" id="L3859" title="All 2 branches covered.">    for (String s : org.getUsers()) {</span>
<span class="fc" id="L3860">      UserInfoImpl u = retrieveUser(session, s, org.getId());</span>
<span class="pc bpc" id="L3861" title="1 of 2 branches missed.">      if (u != null) {</span>
<span class="fc" id="L3862">        impl.getUsers().add(u);</span>
      }
<span class="fc" id="L3864">    }</span>
<span class="fc" id="L3865">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3866">    ret = impl.toOrganization();</span>
<span class="fc" id="L3867">    session.getTransaction().commit();</span>
<span class="fc" id="L3868">    session.close();</span>
<span class="fc" id="L3869">    sessionClose++;</span>
<span class="fc" id="L3870">    cache.putOrganization(ret);</span>
<span class="fc" id="L3871">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensor(org.wattdepot.datamodel.Sensor
   * )
   */
  @Override
  public Sensor updateSensor(Sensor sensor) throws IdNotFoundException {
<span class="fc" id="L3883">    getOrganization(sensor.getOrganizationId(), true);</span>
<span class="fc" id="L3884">    getSensorModel(sensor.getModelId(), true);</span>
<span class="fc" id="L3885">    Sensor ret = null;</span>
<span class="fc" id="L3886">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3887">    sessionOpen++;</span>
<span class="fc" id="L3888">    session.beginTransaction();</span>
<span class="fc" id="L3889">    SensorImpl impl = retrieveSensor(session, sensor.getId(), sensor.getOrganizationId());</span>
<span class="fc" id="L3890">    impl.setId(sensor.getId());</span>
<span class="fc" id="L3891">    impl.setName(sensor.getName());</span>
<span class="fc" id="L3892">    impl.setOrg(retrieveOrganization(session, sensor.getOrganizationId()));</span>
<span class="fc" id="L3893">    impl.setModel(retrieveSensorModel(session, sensor.getModelId()));</span>
<span class="fc" id="L3894">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L3895" title="1 of 2 branches missed.">    for (Property p : sensor.getProperties()) {</span>
<span class="nc" id="L3896">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L3897">    }</span>
<span class="fc" id="L3898">    impl.setProperties(props);</span>
<span class="fc" id="L3899">    storeSensor(session, impl);</span>
<span class="fc" id="L3900">    ret = impl.toSensor();</span>
<span class="fc" id="L3901">    session.getTransaction().commit();</span>
<span class="fc" id="L3902">    session.close();</span>
<span class="fc" id="L3903">    sessionClose++;</span>
<span class="fc" id="L3904">    cache.putSensor(ret);</span>
<span class="fc" id="L3905">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensorGroup(org.wattdepot.datamodel
   * .SensorGroup)
   */
  @Override
  public SensorGroup updateSensorGroup(SensorGroup group) throws IdNotFoundException {
<span class="fc" id="L3917">    getOrganization(group.getOrganizationId(), true);</span>
<span class="fc" id="L3918">    getSensorGroup(group.getId(), group.getOrganizationId(), true);</span>
    // validate the list of sensor ids.
<span class="fc bfc" id="L3920" title="All 2 branches covered.">    for (String id : group.getSensors()) {</span>
<span class="fc" id="L3921">      getSensor(id, group.getOrganizationId(), true);</span>
<span class="fc" id="L3922">    }</span>
<span class="fc" id="L3923">    SensorGroup ret = null;</span>
<span class="fc" id="L3924">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3925">    sessionOpen++;</span>
<span class="fc" id="L3926">    session.beginTransaction();</span>
<span class="fc" id="L3927">    OrganizationImpl org = retrieveOrganization(session, group.getOrganizationId());</span>
<span class="fc" id="L3928">    SensorGroupImpl impl = retrieveSensorGroup(session, group.getId(), group.getOrganizationId());</span>
<span class="fc" id="L3929">    impl.setId(group.getId());</span>
<span class="fc" id="L3930">    impl.setName(group.getName());</span>
<span class="fc" id="L3931">    impl.setOrg(org);</span>
<span class="fc" id="L3932">    Set&lt;SensorImpl&gt; sensors = new HashSet&lt;SensorImpl&gt;();</span>
<span class="fc bfc" id="L3933" title="All 2 branches covered.">    for (String s : group.getSensors()) {</span>
<span class="fc" id="L3934">      sensors.add(retrieveSensor(session, s, group.getOrganizationId()));</span>
<span class="fc" id="L3935">    }</span>
<span class="fc" id="L3936">    impl.setSensors(sensors);</span>
<span class="fc" id="L3937">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3938">    ret = impl.toSensorGroup();</span>
<span class="fc" id="L3939">    session.getTransaction().commit();</span>
<span class="fc" id="L3940">    session.close();</span>
<span class="fc" id="L3941">    sessionClose++;</span>
<span class="fc" id="L3942">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensorModel(org.wattdepot.datamodel
   * .SensorModel)
   */
  @Override
  public SensorModel updateSensorModel(SensorModel model) throws IdNotFoundException {
<span class="fc" id="L3954">    getSensorModel(model.getId(), true);</span>
<span class="fc" id="L3955">    SensorModel ret = null;</span>
<span class="fc" id="L3956">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3957">    sessionOpen++;</span>
<span class="fc" id="L3958">    session.beginTransaction();</span>
<span class="fc" id="L3959">    SensorModelImpl impl = retrieveSensorModel(session, model.getId());</span>
<span class="fc" id="L3960">    impl.setName(model.getName());</span>
<span class="fc" id="L3961">    impl.setProtocol(model.getProtocol());</span>
<span class="fc" id="L3962">    impl.setId(model.getId());</span>
<span class="fc" id="L3963">    impl.setType(model.getType());</span>
<span class="fc" id="L3964">    impl.setVersion(model.getVersion());</span>
<span class="fc" id="L3965">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3966">    ret = impl.toSensorModel();</span>
<span class="fc" id="L3967">    session.getTransaction().commit();</span>
<span class="fc" id="L3968">    session.close();</span>
<span class="fc" id="L3969">    sessionClose++;</span>
<span class="fc" id="L3970">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#updateUserInfo(org.wattdepot.datamodel
   * .UserInfo)
   */
  @Override
  public UserInfo updateUserInfo(UserInfo user) throws IdNotFoundException {
<span class="fc" id="L3981">    getUser(user.getUid(), user.getOrganizationId(), true);</span>
<span class="fc" id="L3982">    UserInfo ret = null;</span>
<span class="fc" id="L3983">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3984">    sessionOpen++;</span>
<span class="fc" id="L3985">    session.beginTransaction();</span>
<span class="fc" id="L3986">    OrganizationImpl orgImpl = retrieveOrganization(session, user.getOrganizationId());</span>
<span class="fc" id="L3987">    UserInfoImpl impl = retrieveUser(session, user.getUid(), user.getOrganizationId());</span>
<span class="fc" id="L3988">    impl.setUid(user.getUid());</span>
<span class="fc" id="L3989">    impl.setFirstName(user.getFirstName());</span>
<span class="fc" id="L3990">    impl.setLastName(user.getLastName());</span>
<span class="fc" id="L3991">    impl.setEmail(user.getEmail());</span>
<span class="fc" id="L3992">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="fc bfc" id="L3993" title="All 2 branches covered.">    for (Property p : user.getProperties()) {</span>
<span class="fc" id="L3994">      PropertyImpl pi = new PropertyImpl(p);</span>
<span class="fc" id="L3995">      props.add(pi);</span>
<span class="fc" id="L3996">      session.saveOrUpdate(pi);</span>
<span class="fc" id="L3997">    }</span>
<span class="fc" id="L3998">    impl.setProperties(props);</span>
<span class="fc" id="L3999">    impl.setOrg(orgImpl);</span>
<span class="fc" id="L4000">    session.saveOrUpdate(orgImpl);</span>
<span class="fc" id="L4001">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L4002">    ret = impl.toUserInfo();</span>
<span class="fc" id="L4003">    session.getTransaction().commit();</span>
<span class="fc" id="L4004">    session.close();</span>
<span class="fc" id="L4005">    sessionClose++;</span>
<span class="fc" id="L4006">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateUserPassword(org.wattdepot.datamodel
   * .UserPassword)
   */
  @Override
  public UserPassword updateUserPassword(UserPassword password) throws IdNotFoundException {
<span class="fc" id="L4018">    UserPassword ret = null;</span>
<span class="fc" id="L4019">    getUserPassword(password.getUid(), password.getOrganizationId(), true);</span>
<span class="fc" id="L4020">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L4021">    sessionOpen++;</span>
<span class="fc" id="L4022">    session.beginTransaction();</span>
<span class="fc" id="L4023">    UserPasswordImpl impl = retrieveUserPassword(session, password.getUid(),</span>
        password.getOrganizationId());
<span class="fc" id="L4025">    impl.setEncryptedPassword(password.getEncryptedPassword());</span>
<span class="fc" id="L4026">    impl.setOrg(retrieveOrganization(session, password.getOrganizationId()));</span>
<span class="fc" id="L4027">    impl.setUser(retrieveUser(session, password.getUid(), password.getOrganizationId()));</span>
<span class="fc" id="L4028">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L4029">    ret = impl.toUserPassword();</span>
<span class="fc" id="L4030">    session.getTransaction().commit();</span>
<span class="fc" id="L4031">    session.close();</span>
<span class="fc" id="L4032">    sessionClose++;</span>
<span class="fc" id="L4033">    return ret;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>