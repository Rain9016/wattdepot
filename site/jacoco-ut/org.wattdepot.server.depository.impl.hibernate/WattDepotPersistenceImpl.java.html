<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WattDepotPersistenceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.source.html" class="el_package">org.wattdepot.server.depository.impl.hibernate</a> &gt; <span class="el_source">WattDepotPersistenceImpl.java</span></div><h1>WattDepotPersistenceImpl.java</h1><pre class="source lang-java linenums">/**
 * WattDepotImpl.java This file is part of WattDepot.
 *
 * Copyright (C) 2013  Cam Moore
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.wattdepot.server.depository.impl.hibernate;

import java.security.InvalidKeyException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.crypto.BadPaddingException;
import javax.crypto.IllegalBlockSizeException;
import javax.xml.datatype.XMLGregorianCalendar;

import org.hibernate.Session;
import org.hibernate.Transaction;
import org.wattdepot.common.domainmodel.CollectorProcessDefinition;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.Labels;
import org.wattdepot.common.domainmodel.MeasurementList;
import org.wattdepot.common.domainmodel.MeasurementPruningDefinition;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.Measurement;
import org.wattdepot.common.domainmodel.MeasurementRateSummary;
import org.wattdepot.common.domainmodel.MeasurementType;
import org.wattdepot.common.domainmodel.Organization;
import org.wattdepot.common.domainmodel.Property;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorGroup;
import org.wattdepot.common.domainmodel.SensorMeasurementSummary;
import org.wattdepot.common.domainmodel.SensorModel;
import org.wattdepot.common.domainmodel.UserInfo;
import org.wattdepot.common.domainmodel.UserPassword;
import org.wattdepot.common.exception.BadSlugException;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.MeasurementGapException;
import org.wattdepot.common.exception.MeasurementTypeException;
import org.wattdepot.common.exception.MisMatchedOwnerException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.exception.UniqueIdException;
import org.wattdepot.common.util.DateConvert;
import org.wattdepot.common.util.SensorModelHelper;
import org.wattdepot.common.util.Slug;
import org.wattdepot.common.util.tstamp.Tstamp;
import org.wattdepot.server.ServerProperties;
import org.wattdepot.server.StrongAES;
import org.wattdepot.server.WattDepotPersistence;

/**
 * WattDepotImpl - Hibernate implementation of the WattDepot abstract class.
 * 
 * @author Cam Moore
 * 
 */
public class WattDepotPersistenceImpl extends WattDepotPersistence {

  private boolean checkSession;
<span class="fc" id="L79">  private int sessionOpen = 0;</span>
<span class="fc" id="L80">  private int sessionClose = 0;</span>

  private boolean timingp;
  private Logger timingLogger;
<span class="fc" id="L84">  private String padding = &quot;&quot;;</span>
  private PersistenceCache cache;

  /**
   * Creates a new WattDepotImpl instance with the given ServerProperties.
   * 
   * @param properties The ServerProperties.
   */
  public WattDepotPersistenceImpl(ServerProperties properties) {
<span class="fc" id="L93">    super();</span>
<span class="fc" id="L94">    this.cache = new PersistenceCache();</span>
    // try {
    // Session validate = Manager.getValidateFactory(properties).openSession();
    // validate.close();
    // }
    // catch (HibernateException e) { // NOPMD
    // // e.printStackTrace();
    // // might be able to just use the 'update' sessionFactory.
    // // Session create = Manager.getCreateFactory(properties).openSession();
    // // create.close();
    // }
<span class="fc" id="L105">    setServerProperties(properties);</span>
<span class="fc" id="L106">    this.checkSession = properties.get(ServerProperties.CHECK_SESSIONS).equals(&quot;true&quot;);</span>
<span class="fc" id="L107">    timingp = properties.get(ServerProperties.SERVER_TIMING_KEY).equals(ServerProperties.TRUE);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L109">      this.timingLogger = Logger.getLogger(getClass().getName());</span>
    }
    // Start with the Organizations
<span class="fc" id="L112">    Organization pub = null;</span>
    try {
<span class="fc" id="L114">      pub = getOrganization(Organization.PUBLIC_GROUP.getId(), false);</span>
    }
<span class="nc" id="L116">    catch (IdNotFoundException e1) { // NOPMD</span>
      // this is ok. We may need to create the Organization.
<span class="fc" id="L118">    }</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">    if (pub == null) {</span>
      try {
<span class="nc" id="L121">        defineOrganization(Organization.PUBLIC_GROUP.getId(), Organization.PUBLIC_GROUP.getName(),</span>
            new HashSet&lt;String&gt;());
<span class="nc bnc" id="L123" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L124">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L127">      catch (UniqueIdException e) {</span>
        // what do we do here?
<span class="nc" id="L129">        e.printStackTrace();</span>
      }
<span class="nc" id="L131">      catch (BadSlugException e) {</span>
        // what do we do here?
<span class="nc" id="L133">        e.printStackTrace();</span>
      }
<span class="nc" id="L135">      catch (IdNotFoundException e) {</span>
        // What do we do here?
<span class="nc" id="L137">        e.printStackTrace();</span>
<span class="nc" id="L138">      }</span>
    }
    else {
      try {
<span class="fc" id="L142">        updateOrganization(pub);</span>
      }
<span class="nc" id="L144">      catch (IdNotFoundException e) {</span>
        // Should not happen.
<span class="nc" id="L146">        e.printStackTrace();</span>
<span class="fc" id="L147">      }</span>
<span class="pc bpc" id="L148" title="3 of 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L149">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="pc bpc" id="L152" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L153">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="fc" id="L155">    Organization admin = null;</span>
    try {
<span class="fc" id="L157">      admin = getOrganization(Organization.ADMIN_GROUP.getId(), false);</span>
    }
<span class="nc" id="L159">    catch (IdNotFoundException e1) { // NOPMD</span>
      // this is ok, we might need to create the organization.
<span class="fc" id="L161">    }</span>
<span class="pc bpc" id="L162" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L163">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    if (admin == null) {</span>
      try {
<span class="nc" id="L167">        defineOrganization(Organization.ADMIN_GROUP.getId(), Organization.ADMIN_GROUP.getName(),</span>
            new HashSet&lt;String&gt;());
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L170">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L173">      catch (UniqueIdException e) {</span>
        // what do we do here?
<span class="nc" id="L175">        e.printStackTrace();</span>
      }
<span class="nc" id="L177">      catch (BadSlugException e) {</span>
        // what do we do here?
<span class="nc" id="L179">        e.printStackTrace();</span>
      }
<span class="nc" id="L181">      catch (IdNotFoundException e) {</span>
        // what do we do here?
<span class="nc" id="L183">        e.printStackTrace();</span>
<span class="nc" id="L184">      }</span>
    }
    else {
      try {
<span class="fc" id="L188">        updateOrganization(admin);</span>
      }
<span class="nc" id="L190">      catch (IdNotFoundException e) {</span>
        // Should not happen.
<span class="nc" id="L192">        e.printStackTrace();</span>
<span class="fc" id="L193">      }</span>
<span class="pc bpc" id="L194" title="3 of 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L195">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="fc" id="L198">    UserInfo adminUser = null;</span>
    try {
<span class="fc" id="L200">      adminUser = getUser(UserInfo.ROOT.getUid(), Organization.ADMIN_GROUP.getId(), false);</span>
    }
<span class="nc" id="L202">    catch (IdNotFoundException e) {</span>
      try {
<span class="nc" id="L204">        defineUserInfo(UserInfo.ROOT.getUid(), UserInfo.ROOT.getFirstName(),</span>
            UserInfo.ROOT.getLastName(), UserInfo.ROOT.getEmail(),
            Organization.ADMIN_GROUP.getId(), UserInfo.ROOT.getProperties(), StrongAES
                .getInstance().decrypt(UserPassword.ROOT.getEncryptedPassword()));
<span class="nc bnc" id="L208" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L209">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L212">      catch (UniqueIdException e1) {</span>
        // what do we do here?
<span class="nc" id="L214">        e1.printStackTrace();</span>
      }
<span class="nc" id="L216">      catch (IdNotFoundException e1) {</span>
        // this shouldn't happen
<span class="nc" id="L218">        e1.printStackTrace();</span>
      }
<span class="nc" id="L220">      catch (IllegalBlockSizeException e1) {</span>
<span class="nc" id="L221">        e1.printStackTrace();</span>
      }
<span class="nc" id="L223">      catch (BadPaddingException e1) {</span>
<span class="nc" id="L224">        e1.printStackTrace();</span>
      }
<span class="nc" id="L226">      catch (InvalidKeyException e1) {</span>
<span class="nc" id="L227">        e1.printStackTrace();</span>
<span class="nc" id="L228">      }</span>
<span class="fc" id="L229">    }</span>
<span class="pc bpc" id="L230" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L231">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">    if (adminUser != null) {</span>
      try {
<span class="nc" id="L235">        updateUserInfo(UserInfo.ROOT);</span>
      }
<span class="nc" id="L237">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L238">        e.printStackTrace();</span>
<span class="nc" id="L239">      }</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L241">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">    if (!Organization.ADMIN_GROUP.getUsers().contains(UserInfo.ROOT.getUid())) {</span>
<span class="nc" id="L245">      Organization.ADMIN_GROUP.add(UserInfo.ROOT.getUid());</span>
      try {
<span class="nc" id="L247">        updateOrganization(Organization.ADMIN_GROUP);</span>
      }
<span class="nc" id="L249">      catch (IdNotFoundException e) { // NOPMD</span>
        // There is a problem
<span class="nc" id="L251">      }</span>
    }

    UserPassword adminPassword;
    try {
<span class="nc" id="L256">      adminPassword = getUserPassword(UserInfo.ROOT.getUid(), UserInfo.ROOT.getOrganizationId(),</span>
          false);
<span class="nc" id="L258">      updateUserPassword(adminPassword);</span>
<span class="nc bnc" id="L259" title="All 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L260">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="fc" id="L263">    catch (IdNotFoundException e2) { // NOPMD</span>
      // adminPassword no defined.
      // we are in trouble.
<span class="nc" id="L266">    }</span>
<span class="pc bpc" id="L267" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L268">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }

<span class="fc" id="L271">  }</span>


  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#defineCollectorProcessDefinition(java.lang
   * .String, java.lang.String, java.lang.Long, java.lang.String,
   * java.lang.String)
   */
  @Override
  public CollectorProcessDefinition defineCollectorProcessDefinition(String id, String name,
      String sensorId, Long pollingInterval, String depositoryId, Set&lt;Property&gt; properties,
      String orgId) throws UniqueIdException, MisMatchedOwnerException, IdNotFoundException,
      BadSlugException {
<span class="fc" id="L287">    getOrganization(orgId, true);</span>
<span class="fc" id="L288">    getSensor(sensorId, orgId, true);</span>
<span class="fc" id="L289">    getDepository(depositoryId, orgId, true);</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L291">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
    try {
<span class="fc" id="L294">      CollectorProcessDefinition cpd = getCollectorProcessDefinition(id, orgId, true);</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">      if (cpd != null) {</span>
<span class="fc" id="L296">        throw new UniqueIdException(id + &quot; is already a CollectorProcessDefinition id.&quot;);</span>
      }
    }
<span class="fc" id="L299">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is expected.
<span class="nc" id="L301">    }</span>
<span class="fc" id="L302">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L303">    sessionOpen++;</span>
<span class="fc" id="L304">    session.beginTransaction();</span>
<span class="fc" id="L305">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L306">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="fc" id="L307">    DepositoryImpl depot = retrieveDepository(session, depositoryId, orgId);</span>
<span class="fc" id="L308">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">    for (Property p : properties) {</span>
<span class="nc" id="L310">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L311">    }</span>
<span class="fc" id="L312">    CollectorProcessDefinitionImpl impl = new CollectorProcessDefinitionImpl(id, name, sensor,</span>
        pollingInterval, depot, props, org);
<span class="fc" id="L314">    storeCollectorProcessDefinition(session, impl);</span>
<span class="fc" id="L315">    session.getTransaction().commit();</span>
<span class="fc" id="L316">    session.close();</span>
<span class="fc" id="L317">    sessionClose++;</span>
<span class="fc" id="L318">    return impl.toCPD();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineWattDepository(java.lang.String,
   * java.lang.String, java.lang.String, org.wattdepot.datamodel.Organization)
   */
  @Override
  public Depository defineDepository(String id, String name, MeasurementType measurementType,
      String orgId) throws UniqueIdException, IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L331">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L333">    getOrganization(orgId, true);</span>
<span class="fc" id="L334">    getMeasurementType(measurementType.getId(), true);</span>
<span class="fc" id="L335">    Depository d = null;</span>
    try {
<span class="fc" id="L337">      d = getDepository(id, orgId, true);</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">      if (d != null) {</span>
<span class="fc" id="L339">        throw new UniqueIdException(name + &quot; is already a Depository name.&quot;);</span>
      }
    }
<span class="fc" id="L342">    catch (IdNotFoundException e) { // NOPMD</span>
      // ok since we are defining it.
<span class="nc" id="L344">    }</span>
<span class="fc" id="L345">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L346">    sessionOpen++;</span>
<span class="fc" id="L347">    session.beginTransaction();</span>
<span class="fc" id="L348">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L349">    MeasurementTypeImpl type = retrieveMeasurementType(session, measurementType.getId());</span>
<span class="fc" id="L350">    DepositoryImpl impl = new DepositoryImpl(id, name, type, org);</span>
<span class="fc" id="L351">    d = impl.toDepository();</span>
<span class="fc" id="L352">    session.save(impl);</span>
<span class="fc" id="L353">    session.getTransaction().commit();</span>
<span class="fc" id="L354">    session.close();</span>
<span class="fc" id="L355">    sessionClose++;</span>
<span class="fc" id="L356">    cache.putDepository(d);</span>
<span class="fc" id="L357">    return d;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#defineMeasurementPruningDefinition
   * (java.lang.String, java.lang.String, java.lang.String, java.lang.String,
   * java.lang.String, java.lang.Integer, java.lang.Integer, java.lang.Integer)
   */
  @Override
  public MeasurementPruningDefinition defineMeasurementPruningDefinition(String id, String name,
      String depositoryId, String sensorId, String orgId, Integer ignore, Integer collect,
      Integer gap) throws UniqueIdException, BadSlugException, IdNotFoundException {
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L373">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L375">    getOrganization(orgId, true);</span>
<span class="fc" id="L376">    getDepository(depositoryId, orgId, true);</span>
    try {
<span class="fc" id="L378">      getSensor(sensorId, orgId, true);</span>
    }
<span class="nc" id="L380">    catch (IdNotFoundException e) {</span>
<span class="nc" id="L381">      getSensorGroup(sensorId, orgId, true);</span>
<span class="fc" id="L382">    }</span>
<span class="fc" id="L383">    MeasurementPruningDefinition gcd = null;</span>
    try {
<span class="fc" id="L385">      gcd = getMeasurementPruningDefinition(id, orgId, true);</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">      if (gcd != null) {</span>
<span class="fc" id="L387">        throw new UniqueIdException(name + &quot; is already a MeasurementPruningDefinition name.&quot;);</span>
      }
    }
<span class="fc" id="L390">    catch (IdNotFoundException e) { // NOPMD</span>
      // ok since we are defining it.
<span class="nc" id="L392">    }</span>
<span class="fc" id="L393">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L394">    sessionOpen++;</span>
<span class="fc" id="L395">    session.beginTransaction();</span>
<span class="fc" id="L396">    DepositoryImpl dep = retrieveDepository(session, depositoryId, orgId);</span>
<span class="fc" id="L397">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L398">    MeasurementPruningDefinitionImpl impl = new MeasurementPruningDefinitionImpl(id, name, dep,</span>
        sensorId, org, ignore, collect, gap);
<span class="fc" id="L400">    gcd = impl.toMPD();</span>
<span class="fc" id="L401">    session.save(impl);</span>
<span class="fc" id="L402">    session.getTransaction().commit();</span>
<span class="fc" id="L403">    session.close();</span>
<span class="fc" id="L404">    sessionClose++;</span>
<span class="fc" id="L405">    return gcd;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineMeasurementType(java.lang.String,
   * java.lang.String)
   */
  @Override
  public MeasurementType defineMeasurementType(String id, String name, String units)
      throws UniqueIdException, BadSlugException {
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L418">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L420">    MeasurementType mt = null;</span>
    try {
<span class="nc" id="L422">      mt = getMeasurementType(id, true);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">      if (mt != null) {</span>
<span class="nc" id="L424">        throw new UniqueIdException(id + &quot; is already a MeasurementType id.&quot;);</span>
      }
    }
<span class="fc" id="L427">    catch (IdNotFoundException e) { // NOPMD</span>
      // expected.
<span class="nc" id="L429">    }</span>
<span class="fc" id="L430">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L431">    sessionOpen++;</span>
<span class="fc" id="L432">    session.beginTransaction();</span>
<span class="fc" id="L433">    MeasurementTypeImpl impl = new MeasurementTypeImpl(id, name, units);</span>
<span class="fc" id="L434">    session.save(impl);</span>
<span class="fc" id="L435">    session.getTransaction().commit();</span>
<span class="fc" id="L436">    session.close();</span>
<span class="fc" id="L437">    sessionClose++;</span>
<span class="fc" id="L438">    return mt;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineOrganization(java.lang.String,
   * java.util.Set&lt;String&gt;)
   */
  @Override
  public Organization defineOrganization(String id, String name, Set&lt;String&gt; users)
      throws UniqueIdException, BadSlugException, IdNotFoundException {
<span class="fc" id="L450">    Long startTime = 0l;</span>
<span class="fc" id="L451">    Long endTime = 0l;</span>
<span class="fc" id="L452">    Long diff = 0l;</span>
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L454">      timingLogger.log(Level.SEVERE, padding + &quot;Start defineOrganizations()&quot;);</span>
<span class="nc" id="L455">      padding += &quot;  &quot;;</span>
<span class="nc" id="L456">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L458">    Organization ret = null;</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L460">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
    Organization g;
    try {
<span class="nc" id="L464">      g = getOrganization(id, true);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">      if (g != null) {</span>
<span class="nc" id="L466">        throw new UniqueIdException(id + &quot; is already a Organization id.&quot;);</span>
      }
    }
<span class="fc" id="L469">    catch (IdNotFoundException e) { // NOPMD</span>
      // is ok.
<span class="nc" id="L471">    }</span>
<span class="pc bpc" id="L472" title="1 of 2 branches missed.">    for (String uid : users) {</span>
<span class="nc" id="L473">      getUser(uid, id, true);</span>
<span class="nc" id="L474">    }</span>
<span class="fc" id="L475">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L476">    sessionOpen++;</span>
<span class="fc" id="L477">    session.beginTransaction();</span>
<span class="fc" id="L478">    Set&lt;UserInfoImpl&gt; u = new HashSet&lt;UserInfoImpl&gt;();</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">    for (String uid : users) {</span>
<span class="nc" id="L480">      u.add(retrieveUser(session, uid, id));</span>
<span class="nc" id="L481">    }</span>
<span class="fc" id="L482">    OrganizationImpl impl = new OrganizationImpl(id, name, u);</span>
<span class="fc" id="L483">    ret = impl.toOrganization();</span>
<span class="fc" id="L484">    session.save(impl);</span>
<span class="fc" id="L485">    session.getTransaction().commit();</span>
<span class="fc" id="L486">    session.close();</span>
<span class="fc" id="L487">    sessionClose++;</span>
<span class="fc" id="L488">    cache.putOrganization(ret);</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L490">      endTime = System.nanoTime();</span>
<span class="nc" id="L491">      diff = endTime - startTime;</span>
<span class="nc" id="L492">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L493">      timingLogger</span>
          .log(Level.SEVERE, padding + &quot;defineOrganization() took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L496">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensor(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String, java.lang.String)
   */
  @Override
  public Sensor defineSensor(String id, String name, String uri, String modelId,
      Set&lt;Property&gt; properties, String orgId) throws UniqueIdException, MisMatchedOwnerException,
      IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L510">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L512">    getOrganization(orgId, true);</span>
<span class="fc" id="L513">    getSensorModel(modelId, true);</span>
<span class="fc" id="L514">    Sensor s = null;</span>
    try {
<span class="fc" id="L516">      s = getSensor(id, orgId, true);</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">      if (s != null) {</span>
<span class="fc" id="L518">        throw new UniqueIdException(id + &quot; is already a defined Sensor.&quot;);</span>
      }
    }
<span class="fc" id="L521">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is expected.
<span class="nc" id="L523">    }</span>
<span class="fc" id="L524">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L525">    sessionOpen++;</span>
<span class="fc" id="L526">    session.beginTransaction();</span>
<span class="fc" id="L527">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L528">    SensorModelImpl model = retrieveSensorModel(session, modelId);</span>
<span class="fc" id="L529">    Set&lt;PropertyImpl&gt; prop = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">    for (Property p : properties) {</span>
<span class="nc" id="L531">      prop.add(new PropertyImpl(p));</span>
<span class="nc" id="L532">    }</span>
<span class="fc" id="L533">    SensorImpl impl = new SensorImpl(id, name, uri, model, prop, org);</span>
<span class="fc" id="L534">    s = impl.toSensor();</span>
<span class="fc" id="L535">    storeSensor(session, impl);</span>
<span class="fc" id="L536">    session.getTransaction().commit();</span>
<span class="fc" id="L537">    session.close();</span>
<span class="fc" id="L538">    sessionClose++;</span>
<span class="fc" id="L539">    cache.putSensor(s);</span>
<span class="fc" id="L540">    return s;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensorGroup(java.lang.String,
   * java.util.List, org.wattdepot.datamodel.Organization)
   */
  @Override
  public SensorGroup defineSensorGroup(String id, String name, Set&lt;String&gt; sensorIds, String orgId)
      throws UniqueIdException, MisMatchedOwnerException, IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L553">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L555">    Organization owner = getOrganization(orgId, true);</span>
<span class="fc bfc" id="L556" title="All 2 branches covered.">    for (String sensorId : sensorIds) {</span>
<span class="fc" id="L557">      Sensor sensor = getSensor(sensorId, orgId, true);</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">      if (!orgId.equals(sensor.getOrganizationId())) {</span>
<span class="nc" id="L559">        throw new MisMatchedOwnerException(orgId + &quot; is not the owner of all the sensors.&quot;);</span>
      }
<span class="fc" id="L561">    }</span>
<span class="fc" id="L562">    SensorGroup sg = null;</span>
    try {
<span class="nc" id="L564">      sg = getSensorGroup(id, owner.getId(), true);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">      if (sg != null) {</span>
<span class="nc" id="L566">        throw new UniqueIdException(id + &quot; is already a SensorGroup id.&quot;);</span>
      }
    }
<span class="fc" id="L569">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is ok since we are defining it.
<span class="nc" id="L571">    }</span>
<span class="fc" id="L572">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L573">    sessionOpen++;</span>
<span class="fc" id="L574">    session.beginTransaction();</span>
<span class="fc" id="L575">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L576">    Set&lt;SensorImpl&gt; sensors = new HashSet&lt;SensorImpl&gt;();</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">    for (String sensorId : sensorIds) {</span>
<span class="fc" id="L578">      sensors.add(retrieveSensor(session, sensorId, orgId));</span>
<span class="fc" id="L579">    }</span>
<span class="fc" id="L580">    SensorGroupImpl impl = new SensorGroupImpl(id, name, sensors, org);</span>
<span class="fc" id="L581">    session.save(impl);</span>
<span class="fc" id="L582">    session.getTransaction().commit();</span>
<span class="fc" id="L583">    session.close();</span>
<span class="fc" id="L584">    sessionClose++;</span>
<span class="fc" id="L585">    return sg;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensorModel(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String,
   * org.wattdepot.datamodel.Organization)
   */
  @Override
  public SensorModel defineSensorModel(String id, String name, String protocol, String type,
      String version) throws UniqueIdException, BadSlugException {
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L599">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L601">    SensorModel sm = null;</span>
    try {
<span class="nc" id="L603">      sm = getSensorModel(id, true);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">      if (sm != null) {</span>
<span class="nc" id="L605">        throw new UniqueIdException(id + &quot; is already a SensorModel id.&quot;);</span>
      }
    }
<span class="fc" id="L608">    catch (IdNotFoundException e) { // NOPMD</span>
      // expected.
<span class="nc" id="L610">    }</span>
<span class="fc" id="L611">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L612">    sessionOpen++;</span>
<span class="fc" id="L613">    session.beginTransaction();</span>
<span class="fc" id="L614">    SensorModelImpl impl = new SensorModelImpl(id, name, protocol, type, version);</span>
<span class="fc" id="L615">    session.save(impl);</span>
<span class="fc" id="L616">    session.getTransaction().commit();</span>
<span class="fc" id="L617">    session.close();</span>
<span class="fc" id="L618">    sessionClose++;</span>
<span class="fc" id="L619">    return sm;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineUserInfo(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String, java.lang.String,
   * java.lang.Boolean, java.util.Set)
   */
  @Override
  public UserInfo defineUserInfo(String id, String firstName, String lastName, String email,
      String orgId, Set&lt;Property&gt; properties, String password) throws UniqueIdException,
      IdNotFoundException {
<span class="fc" id="L633">    getOrganization(orgId, true);</span>
<span class="fc" id="L634">    UserInfo u = null;</span>
    try {
<span class="nc" id="L636">      u = getUser(id, orgId, true);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">      if (u != null) {</span>
<span class="nc" id="L638">        throw new UniqueIdException(id + &quot; is already a UserInfo id.&quot;);</span>
      }
    }
<span class="fc" id="L641">    catch (IdNotFoundException e) { // NOPMD</span>
      // excpected since we are defining a new user.
<span class="nc" id="L643">    }</span>
<span class="fc" id="L644">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L645">    sessionOpen++;</span>
<span class="fc" id="L646">    session.beginTransaction();</span>
<span class="fc" id="L647">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L648">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="fc bfc" id="L649" title="All 2 branches covered.">    for (Property p : properties) {</span>
<span class="fc" id="L650">      PropertyImpl pi = new PropertyImpl(p);</span>
<span class="fc" id="L651">      props.add(pi);</span>
<span class="fc" id="L652">      session.saveOrUpdate(pi);</span>
<span class="fc" id="L653">    }</span>
<span class="fc" id="L654">    UserInfoImpl impl = new UserInfoImpl(id, firstName, lastName, email, props, org);</span>
<span class="fc" id="L655">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L656">    u = impl.toUserInfo();</span>
<span class="fc" id="L657">    UserPasswordImpl up = new UserPasswordImpl(impl, password, org);</span>
<span class="fc" id="L658">    session.saveOrUpdate(up);</span>
<span class="fc" id="L659">    session.getTransaction().commit();</span>
<span class="fc" id="L660">    session.close();</span>
<span class="fc" id="L661">    sessionClose++;</span>
<span class="fc" id="L662">    return u;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#deleteCollectorProcessDefinition(java.lang
   * .String, java.lang.String)
   */
  @Override
  public void deleteCollectorProcessDefinition(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L675">    getCollectorProcessDefinition(id, orgId, true);</span>
<span class="fc" id="L676">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L677">    sessionOpen++;</span>
<span class="fc" id="L678">    session.beginTransaction();</span>
<span class="fc" id="L679">    CollectorProcessDefinitionImpl impl = retrieveCollectorProcessDefinition(session, id, orgId);</span>
<span class="fc" id="L680">    session.delete(impl);</span>
<span class="fc" id="L681">    session.getTransaction().commit();</span>
<span class="fc" id="L682">    session.close();</span>
<span class="fc" id="L683">    sessionClose++;</span>
<span class="fc" id="L684">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteWattDepository(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteDepository(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L695">    Depository d = getDepository(id, orgId, true);</span>
<span class="fc" id="L696">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L697">    sessionOpen++;</span>
<span class="fc" id="L698">    session.beginTransaction();</span>
<span class="fc" id="L699">    DepositoryImpl impl = retrieveDepository(session, id, orgId);</span>
<span class="fc bfc" id="L700" title="All 2 branches covered.">    for (DepositorySensorContribution dsc : retrieveContributions(session, impl)) {</span>
<span class="fc" id="L701">      session.delete(dsc);</span>
<span class="fc" id="L702">    }</span>
<span class="fc" id="L703">    session.delete(impl);</span>
<span class="fc" id="L704">    session.getTransaction().commit();</span>
<span class="fc" id="L705">    session.close();</span>
<span class="fc" id="L706">    sessionClose++;</span>
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">    if (d != null) {</span>
<span class="fc" id="L708">      cache.deleteDepository(d);</span>
    }
<span class="fc" id="L710">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#deleteMeasurementPruningDefinition
   * (java.lang.String)
   */
  @Override
  public void deleteMeasurementPruningDefinition(String id, String orgId) throws IdNotFoundException {
<span class="fc" id="L721">    getMeasurementPruningDefinition(id, orgId, true);</span>
<span class="fc" id="L722">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L723">    sessionOpen++;</span>
<span class="fc" id="L724">    session.beginTransaction();</span>
<span class="fc" id="L725">    MeasurementPruningDefinitionImpl impl = retrieveMeasurementPruningDefinition(session, id, orgId);</span>
<span class="fc" id="L726">    session.delete(impl);</span>
<span class="fc" id="L727">    session.getTransaction().commit();</span>
<span class="fc" id="L728">    session.close();</span>
<span class="fc" id="L729">    sessionClose++;</span>
<span class="fc" id="L730">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#deleteMeasurement(java.lang.String
   * , java.lang.String)
   */
  @Override
  public void deleteMeasurement(String depotId, String orgId, String measId)
      throws IdNotFoundException {
<span class="fc" id="L742">    Long startTime = 0l;</span>
<span class="fc" id="L743">    Long endTime = 0l;</span>
<span class="fc" id="L744">    Long diff = 0l;</span>
<span class="pc bpc" id="L745" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L746">      timingLogger.log(Level.SEVERE, padding + &quot;Start deleteMeasurement(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L748">      padding += &quot;  &quot;;</span>
<span class="nc" id="L749">      startTime = System.nanoTime();</span>
    }
//    getOrganization(orgId, true);
//    getDepository(depotId, orgId, true);
//    getMeasurement(depotId, orgId, measId, true);
<span class="fc" id="L754">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L755">    session.beginTransaction();</span>
<span class="fc" id="L756">    MeasurementImpl impl = retrieveMeasurement(session, depotId, orgId, measId);</span>
<span class="fc bfc" id="L757" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L758">      session.delete(impl);</span>
    }
    else {
<span class="fc" id="L761">      throw new IdNotFoundException(measId + &quot; is not a valid measurment id.&quot;);</span>
    }
<span class="fc" id="L763">    session.getTransaction().commit();</span>
<span class="fc" id="L764">    session.close();</span>
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L766">      endTime = System.nanoTime();</span>
<span class="nc" id="L767">      diff = endTime - startTime;</span>
<span class="nc" id="L768">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L769">      timingLogger.log(Level.SEVERE, padding + &quot;deleteMeasurement(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }    
<span class="fc" id="L772">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteMeasurementType(java.lang.String)
   */
  @Override
  public void deleteMeasurementType(String id) throws IdNotFoundException {
<span class="fc" id="L781">    getMeasurementType(id, true);</span>
<span class="fc" id="L782">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L783">    sessionOpen++;</span>
<span class="fc" id="L784">    session.beginTransaction();</span>
<span class="fc" id="L785">    MeasurementTypeImpl impl = retrieveMeasurementType(session, id);</span>
<span class="fc" id="L786">    List&lt;DepositoryImpl&gt; depositories = retrieveDepositories(session, impl);</span>
<span class="fc" id="L787">    session.getTransaction().commit();</span>
<span class="fc" id="L788">    session.close();</span>
<span class="fc" id="L789">    sessionClose++;</span>
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">    for (DepositoryImpl depository : depositories) {</span>
      try {
<span class="nc" id="L792">        deleteDepository(depository.getId(), depository.getOrg().getId());</span>
      }
<span class="nc" id="L794">      catch (MisMatchedOwnerException e) {</span>
        // Shouldn't happen
<span class="nc" id="L796">        e.printStackTrace();</span>
<span class="nc" id="L797">      }</span>
<span class="nc" id="L798">    }</span>
<span class="fc" id="L799">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L800">    sessionOpen++;</span>
<span class="fc" id="L801">    session.beginTransaction();</span>
<span class="fc" id="L802">    impl = retrieveMeasurementType(session, id);</span>
<span class="fc" id="L803">    session.delete(impl);</span>
<span class="fc" id="L804">    session.getTransaction().commit();</span>
<span class="fc" id="L805">    session.close();</span>
<span class="fc" id="L806">    sessionClose++;</span>
<span class="fc" id="L807">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteOrganization(java.lang.String)
   */
  @Override
  public void deleteOrganization(String id) throws IdNotFoundException {
<span class="fc" id="L816">    Organization o = getOrganization(id, true);</span>
    // Remove Organization owned CollectorProcessDefinitions
<span class="fc" id="L818">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L819">    sessionOpen++;</span>
<span class="fc" id="L820">    session.beginTransaction();</span>
<span class="pc bpc" id="L821" title="1 of 2 branches missed.">    for (CollectorProcessDefinitionImpl sp : retrieveCollectorProcessDefinitions(session, id)) {</span>
<span class="nc" id="L822">      session.delete(sp);</span>
<span class="nc" id="L823">    }</span>
<span class="fc" id="L824">    session.getTransaction().commit();</span>
<span class="fc" id="L825">    session.close();</span>
<span class="fc" id="L826">    sessionClose++;</span>
    // Remove Organization owned MeasurementPruningDefinitions
<span class="fc" id="L828">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L829">    sessionOpen++;</span>
<span class="fc" id="L830">    session.beginTransaction();</span>
<span class="pc bpc" id="L831" title="1 of 2 branches missed.">    for (MeasurementPruningDefinitionImpl sp : retrieveMeasurementPruningDefinitions(session, id)) {</span>
<span class="nc" id="L832">      session.delete(sp);</span>
<span class="nc" id="L833">    }</span>
<span class="fc" id="L834">    session.getTransaction().commit();</span>
<span class="fc" id="L835">    session.close();</span>
<span class="fc" id="L836">    sessionClose++;</span>
    // Remove Organization owned SensorGroups
<span class="fc" id="L838">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L839">    sessionOpen++;</span>
<span class="fc" id="L840">    session.beginTransaction();</span>
<span class="fc bfc" id="L841" title="All 2 branches covered.">    for (SensorGroupImpl sg : retrieveSensorGroups(session, id)) {</span>
<span class="fc" id="L842">      session.delete(sg);</span>
<span class="fc" id="L843">    }</span>
<span class="fc" id="L844">    session.getTransaction().commit();</span>
<span class="fc" id="L845">    session.close();</span>
<span class="fc" id="L846">    sessionClose++;</span>
    // Remove Organization owned Measurements
<span class="fc" id="L848">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L849">    sessionOpen++;</span>
<span class="fc" id="L850">    session.beginTransaction();</span>
<span class="fc bfc" id="L851" title="All 2 branches covered.">    for (DepositoryImpl d : retrieveDepositories(session, id)) {</span>
<span class="fc bfc" id="L852" title="All 2 branches covered.">      for (String sensorId : listSensors(d.getId(), id, true)) {</span>
<span class="fc bfc" id="L853" title="All 2 branches covered.">        for (Measurement m : getMeasurements(d.getId(), id, sensorId, true)) {</span>
<span class="fc" id="L854">          MeasurementImpl mi = retrieveMeasurement(session, d.getId(), id, m.getId());</span>
<span class="pc bpc" id="L855" title="1 of 2 branches missed.">          if (mi != null) {</span>
<span class="fc" id="L856">            session.delete(mi);</span>
          }
<span class="fc" id="L858">        }</span>
<span class="fc" id="L859">      }</span>
<span class="fc" id="L860">    }</span>
<span class="fc" id="L861">    session.getTransaction().commit();</span>
<span class="fc" id="L862">    session.close();</span>
<span class="fc" id="L863">    sessionClose++;</span>
    // Remove Organization owned Depositories and Sensors
<span class="fc" id="L865">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L866">    sessionOpen++;</span>
<span class="fc" id="L867">    session.beginTransaction();</span>
<span class="fc" id="L868">    List&lt;DepositoryImpl&gt; depositories = retrieveDepositories(session, id);</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">    for (DepositoryImpl d : depositories) {</span>
<span class="fc bfc" id="L870" title="All 2 branches covered.">      for (DepositorySensorContribution dsc : retrieveContributions(session, d)) {</span>
<span class="fc" id="L871">        session.delete(dsc);</span>
<span class="fc" id="L872">      }</span>
<span class="fc" id="L873">      session.delete(d);</span>
<span class="fc" id="L874">    }</span>
<span class="fc bfc" id="L875" title="All 2 branches covered.">    for (SensorImpl s : retrieveSensors(session, id)) {</span>
<span class="fc" id="L876">      session.delete(s);</span>
<span class="fc" id="L877">    }</span>
<span class="fc" id="L878">    session.getTransaction().commit();</span>
<span class="fc" id="L879">    session.close();</span>
<span class="fc" id="L880">    sessionClose++;</span>
    // Remove Organization owned SensorModels
<span class="fc" id="L882">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L883">    sessionOpen++;</span>
<span class="fc" id="L884">    session.beginTransaction();</span>
<span class="fc bfc" id="L885" title="All 2 branches covered.">    for (SensorModelImpl sm : retrieveSensorModels(session)) {</span>
<span class="fc bfc" id="L886" title="All 2 branches covered.">      if (!SensorModelHelper.models.containsKey(sm.getName())) {</span>
<span class="fc" id="L887">        session.delete(sm);</span>
      }
<span class="fc" id="L889">    }</span>
<span class="fc" id="L890">    session.getTransaction().commit();</span>
<span class="fc" id="L891">    session.close();</span>
<span class="fc" id="L892">    sessionClose++;</span>
    // Remove Users in the Organization
<span class="fc" id="L894">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L895">    sessionOpen++;</span>
<span class="fc" id="L896">    session.beginTransaction();</span>
<span class="fc" id="L897">    OrganizationImpl orgImpl = retrieveOrganization(session, id);</span>
<span class="fc bfc" id="L898" title="All 2 branches covered.">    for (UserInfoImpl u : retrieveUsers(session, id)) {</span>
<span class="fc" id="L899">      orgImpl.getUsers().remove(u);</span>
<span class="fc" id="L900">      session.delete(u);</span>
<span class="fc" id="L901">    }</span>
<span class="fc" id="L902">    session.update(orgImpl);</span>
<span class="fc bfc" id="L903" title="All 2 branches covered.">    for (UserPasswordImpl u : retrieveUserPasswords(session, id)) {</span>
<span class="fc" id="L904">      session.delete(u);</span>
<span class="fc" id="L905">    }</span>
<span class="fc" id="L906">    session.getTransaction().commit();</span>
<span class="fc" id="L907">    session.close();</span>
<span class="fc" id="L908">    sessionClose++;</span>
    // Remove the organization
<span class="fc" id="L910">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L911">    sessionOpen++;</span>
<span class="fc" id="L912">    session.beginTransaction();</span>
<span class="fc" id="L913">    orgImpl = retrieveOrganization(session, id);</span>
<span class="fc" id="L914">    session.delete(orgImpl);</span>
<span class="fc" id="L915">    session.getTransaction().commit();</span>
<span class="fc" id="L916">    session.close();</span>
<span class="fc" id="L917">    sessionClose++;</span>
<span class="pc bpc" id="L918" title="1 of 2 branches missed.">    if (o != null) {</span>
<span class="fc" id="L919">      cache.deleteOrganization(o);</span>
    }
<span class="fc" id="L921">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensor(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensor(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L932">    Sensor s = getSensor(id, orgId, true);</span>
<span class="fc" id="L933">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L934">    sessionOpen++;</span>
<span class="fc" id="L935">    session.beginTransaction();</span>
<span class="fc" id="L936">    SensorImpl impl = retrieveSensor(session, id, orgId);</span>
<span class="pc bpc" id="L937" title="1 of 2 branches missed.">    for (DepositorySensorContribution dsc : retrieveContributions(session, impl)) {</span>
<span class="nc" id="L938">      session.delete(dsc);</span>
<span class="nc" id="L939">    }</span>
<span class="fc" id="L940">    session.delete(impl);</span>
<span class="fc" id="L941">    session.getTransaction().commit();</span>
<span class="fc" id="L942">    session.close();</span>
<span class="fc" id="L943">    sessionClose++;</span>
<span class="pc bpc" id="L944" title="1 of 2 branches missed.">    if (s != null) {</span>
<span class="fc" id="L945">      cache.deleteSensor(s);</span>
    }
<span class="fc" id="L947">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensorGroup(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensorGroup(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L958">    getSensorGroup(id, orgId, true);</span>
<span class="fc" id="L959">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L960">    sessionOpen++;</span>
<span class="fc" id="L961">    session.beginTransaction();</span>
<span class="fc" id="L962">    SensorGroupImpl impl = retrieveSensorGroup(session, id, orgId);</span>
<span class="fc" id="L963">    session.delete(impl);</span>
<span class="fc" id="L964">    session.getTransaction().commit();</span>
<span class="fc" id="L965">    session.close();</span>
<span class="fc" id="L966">    sessionClose++;</span>
<span class="fc" id="L967">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensorModel(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensorModel(String id) throws IdNotFoundException {
<span class="fc" id="L977">    getSensorModel(id, true);</span>
<span class="fc" id="L978">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L979">    sessionOpen++;</span>
<span class="fc" id="L980">    session.beginTransaction();</span>
<span class="fc" id="L981">    SensorModelImpl impl = retrieveSensorModel(session, id);</span>
<span class="fc" id="L982">    session.delete(impl);</span>
<span class="fc" id="L983">    session.getTransaction().commit();</span>
<span class="fc" id="L984">    session.close();</span>
<span class="fc" id="L985">    sessionClose++;</span>
<span class="fc" id="L986">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteUser(java.lang.String)
   */
  @Override
  public void deleteUser(String id, String orgId) throws IdNotFoundException {
<span class="fc" id="L995">    getUser(id, orgId, true);</span>
<span class="fc" id="L996">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L997">    sessionOpen++;</span>
<span class="fc" id="L998">    session.beginTransaction();</span>
<span class="fc" id="L999">    OrganizationImpl orgImpl = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L1000">    UserInfoImpl impl = retrieveUser(session, id, orgId);</span>
<span class="fc" id="L1001">    UserPasswordImpl up = retrieveUserPassword(session, id, orgId);</span>
<span class="fc" id="L1002">    orgImpl.removeUser(impl);</span>
<span class="fc" id="L1003">    session.saveOrUpdate(orgImpl);</span>
<span class="fc" id="L1004">    session.delete(up);</span>
<span class="fc" id="L1005">    session.delete(impl);</span>
<span class="fc" id="L1006">    session.getTransaction().commit();</span>
<span class="fc" id="L1007">    session.close();</span>
<span class="fc" id="L1008">    sessionClose++;</span>
<span class="fc" id="L1009">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteUserPassword(java.lang.String)
   */
  @Override
  public void deleteUserPassword(String userId, String orgId) throws IdNotFoundException {
<span class="fc" id="L1018">    getUserPassword(userId, orgId, true);</span>
<span class="fc" id="L1019">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1020">    sessionOpen++;</span>
<span class="fc" id="L1021">    session.beginTransaction();</span>
<span class="fc" id="L1022">    UserPasswordImpl impl = retrieveUserPassword(session, userId, orgId);</span>
<span class="fc" id="L1023">    session.delete(impl);</span>
<span class="fc" id="L1024">    session.getTransaction().commit();</span>
<span class="fc" id="L1025">    session.close();</span>
<span class="fc" id="L1026">    sessionClose++;</span>
<span class="fc" id="L1027">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#getCollectorProcessDefinition(java.lang.
   * String, java.lang.String)
   */
  @Override
  public CollectorProcessDefinition getCollectorProcessDefinition(String id, String orgId,
      boolean check) throws IdNotFoundException {
<span class="pc bpc" id="L1039" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1040">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1042">    CollectorProcessDefinition ret = getCollectorProcessDefinitionNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1043" title="1 of 4 branches missed.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L1044">      throw new IdNotFoundException(id + &quot; is not a defined CollectorProcessDefinition's id.&quot;);</span>
    }
<span class="fc" id="L1046">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getCollectorProcessDefinitionIds()
   */
  @Override
  public List&lt;String&gt; getCollectorProcessDefinitionIds(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1057">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1058" title="All 2 branches covered.">    for (CollectorProcessDefinition s : getCollectorProcessDefinitions(orgId, check)) {</span>
<span class="fc" id="L1059">      ret.add(s.getId());</span>
<span class="fc" id="L1060">    }</span>
<span class="fc" id="L1061">    return ret;</span>
  }

  /**
   * @param id The CollectorProcessDefinition's id
   * @param orgId The Organization's id.
   * @return The defined CollectorProcessDefinition or null.
   */
  private CollectorProcessDefinition getCollectorProcessDefinitionNoCheck(String id, String orgId) {
<span class="fc" id="L1070">    CollectorProcessDefinition ret = null;</span>
<span class="fc" id="L1071">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1072">    sessionOpen++;</span>
<span class="fc" id="L1073">    session.beginTransaction();</span>
<span class="fc" id="L1074">    CollectorProcessDefinitionImpl cpd = retrieveCollectorProcessDefinition(session, id, orgId);</span>
<span class="fc bfc" id="L1075" title="All 2 branches covered.">    if (cpd != null) {</span>
<span class="fc" id="L1076">      ret = cpd.toCPD();</span>
    }
<span class="fc" id="L1078">    session.getTransaction().commit();</span>
<span class="fc" id="L1079">    session.close();</span>
<span class="fc" id="L1080">    sessionClose++;</span>
<span class="fc" id="L1081">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#getCollectorProcessDefinitions(java.lang
   * .String)
   */
  @Override
  public List&lt;CollectorProcessDefinition&gt; getCollectorProcessDefinitions(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc bfc" id="L1094" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1095">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1097">    return getCollectorProcessDefinitionsNoCheck(orgId);</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of the defined CollectorProcessDefinitions.
   */
  private List&lt;CollectorProcessDefinition&gt; getCollectorProcessDefinitionsNoCheck(String orgId) {
<span class="fc" id="L1105">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1106">    sessionOpen++;</span>
<span class="fc" id="L1107">    session.beginTransaction();</span>
<span class="fc" id="L1108">    List&lt;CollectorProcessDefinitionImpl&gt; r = retrieveCollectorProcessDefinitions(session, orgId);</span>
<span class="fc" id="L1109">    List&lt;CollectorProcessDefinition&gt; ret = new ArrayList&lt;CollectorProcessDefinition&gt;();</span>
<span class="fc bfc" id="L1110" title="All 2 branches covered.">    for (CollectorProcessDefinitionImpl cpd : r) {</span>
<span class="fc" id="L1111">      ret.add(cpd.toCPD());</span>
<span class="fc" id="L1112">    }</span>
<span class="fc" id="L1113">    session.getTransaction().commit();</span>
<span class="fc" id="L1114">    session.close();</span>
<span class="fc" id="L1115">    sessionClose++;</span>
<span class="fc" id="L1116">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDepositories(java.lang.String)
   */
  @Override
  public List&lt;Depository&gt; getDepositories(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L1126">    Long startTime = 0l;</span>
<span class="fc" id="L1127">    Long endTime = 0l;</span>
<span class="fc" id="L1128">    Long diff = 0l;</span>
<span class="pc bpc" id="L1129" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1130">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositories(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1131">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1132">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1134" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1135">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1137">    List&lt;Depository&gt; ret = getDepositoriesNoCheck(orgId);</span>
<span class="pc bpc" id="L1138" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1139">      endTime = System.nanoTime();</span>
<span class="nc" id="L1140">      diff = endTime - startTime;</span>
<span class="nc" id="L1141">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1142">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositories(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1145">    return ret;</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of the defined Depositories.
   */
  private List&lt;Depository&gt; getDepositoriesNoCheck(String orgId) {
<span class="fc" id="L1153">    Long startTime = 0l;</span>
<span class="fc" id="L1154">    Long endTime = 0l;</span>
<span class="fc" id="L1155">    Long diff = 0l;</span>
<span class="pc bpc" id="L1156" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1157">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoriesNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1158">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1159">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1161">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1162">    sessionOpen++;</span>
<span class="fc" id="L1163">    session.beginTransaction();</span>
<span class="fc" id="L1164">    List&lt;DepositoryImpl&gt; r = retrieveDepositories(session, orgId);</span>
<span class="fc" id="L1165">    List&lt;Depository&gt; ret = new ArrayList&lt;Depository&gt;();</span>
<span class="fc bfc" id="L1166" title="All 2 branches covered.">    for (DepositoryImpl d : r) {</span>
<span class="fc" id="L1167">      ret.add(d.toDepository());</span>
<span class="fc" id="L1168">    }</span>
<span class="fc" id="L1169">    session.getTransaction().commit();</span>
<span class="fc" id="L1170">    session.close();</span>
<span class="fc" id="L1171">    sessionClose++;</span>
<span class="pc bpc" id="L1172" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1173">      endTime = System.nanoTime();</span>
<span class="nc" id="L1174">      diff = endTime - startTime;</span>
<span class="nc" id="L1175">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1176">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoriesNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1179">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDeposiory(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Depository getDepository(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1191">    Long startTime = 0l;</span>
<span class="fc" id="L1192">    Long endTime = 0l;</span>
<span class="fc" id="L1193">    Long diff = 0l;</span>
<span class="pc bpc" id="L1194" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1195">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepository(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1196">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1197">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1199" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1200">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1202">    Depository ret = cache.getDepository(id, orgId);</span>
<span class="fc bfc" id="L1203" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L1204">      ret = getDepositoryNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1205" title="1 of 2 branches missed.">      if (ret != null) {</span>
<span class="nc" id="L1206">        cache.putDepository(ret);</span>
      }
    }
<span class="fc bfc" id="L1209" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L1210">      throw new IdNotFoundException(id + &quot; is not a defined Depository's id.&quot;);</span>
    }
<span class="pc bpc" id="L1212" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1213">      endTime = System.nanoTime();</span>
<span class="nc" id="L1214">      diff = endTime - startTime;</span>
<span class="nc" id="L1215">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1216">      timingLogger.log(Level.SEVERE, padding + &quot;getDepository(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1219">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDepositoryIds()
   */
  @Override
  public List&lt;String&gt; getDepositoryIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L1229">    Long startTime = 0l;</span>
<span class="fc" id="L1230">    Long endTime = 0l;</span>
<span class="fc" id="L1231">    Long diff = 0l;</span>
<span class="pc bpc" id="L1232" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1233">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoryIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1234">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1235">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1237" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1238">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1240">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1241" title="All 2 branches covered.">    for (Depository d : getDepositoriesNoCheck(orgId)) {</span>
<span class="fc" id="L1242">      ret.add(d.getId());</span>
<span class="fc" id="L1243">    }</span>
<span class="pc bpc" id="L1244" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1245">      endTime = System.nanoTime();</span>
<span class="nc" id="L1246">      diff = endTime - startTime;</span>
<span class="nc" id="L1247">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1248">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoryIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1251">    return ret;</span>
  }

  /**
   * @param id The Depository's id.
   * @param orgId The Organization's id.
   * @return The defined Depository or null.
   */
  private Depository getDepositoryNoCheck(String id, String orgId) {
<span class="fc" id="L1260">    Long startTime = 0l;</span>
<span class="fc" id="L1261">    Long endTime = 0l;</span>
<span class="fc" id="L1262">    Long diff = 0l;</span>
<span class="pc bpc" id="L1263" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1264">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoryNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;)&quot;);
<span class="nc" id="L1266">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1267">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1269">    Depository ret = null;</span>
<span class="fc" id="L1270">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1271">    sessionOpen++;</span>
<span class="fc" id="L1272">    session.beginTransaction();</span>
<span class="fc" id="L1273">    DepositoryImpl impl = retrieveDepository(session, id, orgId);</span>
<span class="pc bpc" id="L1274" title="1 of 2 branches missed.">    if (impl != null) {</span>
<span class="nc" id="L1275">      ret = impl.toDepository();</span>
    }
<span class="fc" id="L1277">    session.getTransaction().commit();</span>
<span class="fc" id="L1278">    session.close();</span>
<span class="fc" id="L1279">    sessionClose++;</span>
<span class="pc bpc" id="L1280" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1281">      endTime = System.nanoTime();</span>
<span class="nc" id="L1282">      diff = endTime - startTime;</span>
<span class="nc" id="L1283">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1284">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoryNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1287">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getEarliestMeasuredValue(java
   * .lang.String, java.lang.String)
   */
  @Override
  public InterpolatedValue getEarliestMeasuredValue(String depotId, String orgId, String sensorId,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L1300">    Long startTime = 0l;</span>
<span class="fc" id="L1301">    Long endTime = 0l;</span>
<span class="fc" id="L1302">    Long diff = 0l;</span>
<span class="pc bpc" id="L1303" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1304">      timingLogger.log(Level.SEVERE, padding + &quot;Start getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1306">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1307">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1309" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1310">      getOrganization(orgId, check);</span>
<span class="fc" id="L1311">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1312">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1314">    InterpolatedValue value = getEarliestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1315" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1316">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="pc bpc" id="L1318" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1319">      endTime = System.nanoTime();</span>
<span class="nc" id="L1320">      diff = endTime - startTime;</span>
<span class="nc" id="L1321">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1322">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1325">    return value;</span>
  }

  /**
   * @param depotId The Depository's id.
   * @param orgId The Organization's id.
   * @param sensorId The Sensor id.
   * @return The earliest MeasuredValue for the given depository, organization
   *         and sensor.
   */
  private InterpolatedValue getEarliestMeasuredValueNoCheck(String depotId, String orgId,
      String sensorId) {
<span class="fc" id="L1337">    Long startTime = 0l;</span>
<span class="fc" id="L1338">    Long endTime = 0l;</span>
<span class="fc" id="L1339">    Long diff = 0l;</span>
<span class="pc bpc" id="L1340" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1341">      timingLogger.log(Level.SEVERE, padding + &quot;Start getEarliestMeasuredValueNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1343">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1344">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1346">    InterpolatedValue value = null;</span>
<span class="fc" id="L1347">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1348">    session.beginTransaction();</span>
<span class="fc" id="L1349">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1350">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1352">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
    // List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session
    // .createQuery(
    // &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor &quot;
    // + &quot;AND timestamp IN (SELECT min(timestamp) FROM MeasurementImpl WHERE &quot;
    // + &quot;depository = :depot AND sensor = :sensor)&quot;).setParameter(&quot;depot&quot;,
    // depot)
    // .setParameter(&quot;sensor&quot;, sensor).list();
<span class="pc bpc" id="L1363" title="1 of 2 branches missed.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L1364">      MeasurementImpl meas = result.get(0);</span>
<span class="fc" id="L1365">      value = new InterpolatedValue(sensorId, meas.getValue(), depot.getType().toMeasurementType(),</span>
          meas.getTimestamp());
    }
<span class="fc" id="L1368">    session.getTransaction().commit();</span>
<span class="fc" id="L1369">    session.close();</span>
<span class="pc bpc" id="L1370" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1371">      endTime = System.nanoTime();</span>
<span class="nc" id="L1372">      diff = endTime - startTime;</span>
<span class="nc" id="L1373">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1374">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValueNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1377">    return value;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinition
   * (java.lang.String, java.lang.String, boolean)
   */
  @Override
  public MeasurementPruningDefinition getMeasurementPruningDefinition(String id, String orgId,
      boolean check) throws IdNotFoundException {
<span class="fc" id="L1390">    Long startTime = 0l;</span>
<span class="fc" id="L1391">    Long endTime = 0l;</span>
<span class="fc" id="L1392">    Long diff = 0l;</span>
<span class="pc bpc" id="L1393" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1394">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementPruningDefinition(&quot; + id + &quot;, &quot;</span>
          + orgId + &quot;)&quot;);
<span class="nc" id="L1396">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1397">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1399" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1400">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1402">    MeasurementPruningDefinition gcd = getMeasurementPruningDefinitionNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1403" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1404">      endTime = System.nanoTime();</span>
<span class="nc" id="L1405">      diff = endTime - startTime;</span>
<span class="nc" id="L1406">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1407">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementPruningDefinition(&quot; + id + &quot;, &quot;</span>
          + orgId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc bfc" id="L1410" title="All 2 branches covered.">    if (gcd == null) {</span>
<span class="fc" id="L1411">      throw new IdNotFoundException(id + &quot; is not a defined MeasurementPruningDefinition id.&quot;);</span>
    }
<span class="fc" id="L1413">    return gcd;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinitionIds
   * (java.lang.String, boolean)
   */
  @Override
  public List&lt;String&gt; getMeasurementPruningDefinitionIds(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1426">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1427" title="All 2 branches covered.">    for (MeasurementPruningDefinition gcd : getMeasurementPruningDefinitions(orgId, check)) {</span>
<span class="fc" id="L1428">      ret.add(gcd.getId());</span>
<span class="fc" id="L1429">    }</span>
<span class="fc" id="L1430">    return ret;</span>
  }

  /**
   * @param orgId The Organization's id.
   * @param id The MeasurementPruningDefinition's id.
   * @return The MeasurementPruningDefinition with the given id and orgId, or
   *         null if not defined.
   */
  private MeasurementPruningDefinition getMeasurementPruningDefinitionNoCheck(String id, String orgId) {
<span class="fc" id="L1440">    MeasurementPruningDefinition ret = null;</span>
<span class="fc" id="L1441">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1442">    sessionOpen++;</span>
<span class="fc" id="L1443">    session.beginTransaction();</span>
<span class="fc" id="L1444">    MeasurementPruningDefinitionImpl gcd = retrieveMeasurementPruningDefinition(session, id, orgId);</span>
<span class="fc bfc" id="L1445" title="All 2 branches covered.">    if (gcd != null) {</span>
<span class="fc" id="L1446">      ret = gcd.toMPD();</span>
    }
<span class="fc" id="L1448">    session.getTransaction().commit();</span>
<span class="fc" id="L1449">    session.close();</span>
<span class="fc" id="L1450">    sessionClose++;</span>
<span class="fc" id="L1451">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinitions
   * (java.lang.String, boolean)
   */
  @Override
  public List&lt;MeasurementPruningDefinition&gt; getMeasurementPruningDefinitions(String orgId,
      boolean check) throws IdNotFoundException {
<span class="fc bfc" id="L1464" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1465">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1467">    return getMeasurementPruningDefinitionsNoCheck(orgId);</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of defined MeasurementPruningDefinitions.
   */
  private List&lt;MeasurementPruningDefinition&gt; getMeasurementPruningDefinitionsNoCheck(String orgId) {
<span class="fc" id="L1475">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1476">    sessionOpen++;</span>
<span class="fc" id="L1477">    session.beginTransaction();</span>
<span class="fc" id="L1478">    List&lt;MeasurementPruningDefinitionImpl&gt; r = retrieveMeasurementPruningDefinitions(session, orgId);</span>
<span class="fc" id="L1479">    List&lt;MeasurementPruningDefinition&gt; ret = new ArrayList&lt;MeasurementPruningDefinition&gt;();</span>
<span class="fc bfc" id="L1480" title="All 2 branches covered.">    for (MeasurementPruningDefinitionImpl gcd : r) {</span>
<span class="fc" id="L1481">      ret.add(gcd.toMPD());</span>
<span class="fc" id="L1482">    }</span>
<span class="fc" id="L1483">    session.getTransaction().commit();</span>
<span class="fc" id="L1484">    session.close();</span>
<span class="fc" id="L1485">    sessionClose++;</span>
<span class="fc" id="L1486">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getLatestMeasuredValue(java.lang
   * .String, java.lang.String)
   */
  @Override
  public InterpolatedValue getLatestMeasuredValue(String depotId, String orgId, String sensorId,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L1499">    Long startTime = 0l;</span>
<span class="fc" id="L1500">    Long endTime = 0l;</span>
<span class="fc" id="L1501">    Long diff = 0l;</span>
<span class="pc bpc" id="L1502" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1503">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLaestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1505">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1506">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1508" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1509">      getOrganization(orgId, check);</span>
<span class="fc" id="L1510">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1511">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1513">    InterpolatedValue value = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1514" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1515">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="pc bpc" id="L1517" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1518">      endTime = System.nanoTime();</span>
<span class="nc" id="L1519">      diff = endTime - startTime;</span>
<span class="nc" id="L1520">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1521">      timingLogger.log(Level.SEVERE, padding + &quot;getLatestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1524">    value.addReportingSensor(sensorId);</span>
<span class="fc" id="L1525">    value.addDefinedSensor(sensorId);</span>
<span class="fc" id="L1526">    return value;</span>
  }

  /*
   * (non-Javadoc)
   *
   * @see
   * org.wattdepot.server.WattDepotPersistence#getLatestMeasuredValue(java.lang
   * .String, java.lang.String)
   */
  @Override
  public InterpolatedValue getLatestMeasuredValue(String depotId, String orgId, String sensorId, Long window,
                                                  boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="nc" id="L1539">    Long startTime = 0l;</span>
<span class="nc" id="L1540">    Long endTime = 0l;</span>
<span class="nc" id="L1541">    Long diff = 0l;</span>
<span class="nc bnc" id="L1542" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1543">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLatestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1545">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1546">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1548" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1549">      getOrganization(orgId, check);</span>
<span class="nc" id="L1550">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1551">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1553">    InterpolatedValue value = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1555">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="nc" id="L1557">    Date now = new Date();</span>
<span class="nc" id="L1558">    Long deltaT = now.getTime() - value.getEnd().getTime();</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">    if (Math.abs(deltaT) &gt; window * 1000) {</span>
<span class="nc" id="L1560">      throw new NoMeasurementException(&quot;No recent &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="nc bnc" id="L1562" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1563">      endTime = System.nanoTime();</span>
<span class="nc" id="L1564">      diff = endTime - startTime;</span>
<span class="nc" id="L1565">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1566">      timingLogger.log(Level.SEVERE, padding + &quot;getLatestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1569">    value.addDefinedSensor(sensorId);</span>
<span class="nc" id="L1570">    value.addReportingSensor(sensorId);</span>
<span class="nc" id="L1571">    return value;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensors's id.
   * @return The latest measured value or null if no measurements.
   */
  private InterpolatedValue getLatestMeasuredValueNoCheck(String depotId, String orgId,
      String sensorId) {
<span class="fc" id="L1582">    Long startTime = 0l;</span>
<span class="fc" id="L1583">    Long endTime = 0l;</span>
<span class="fc" id="L1584">    Long diff = 0l;</span>
<span class="pc bpc" id="L1585" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1586">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLatestMeasuredValueNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1588">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1589">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1591">    InterpolatedValue value = null;</span>
<span class="fc" id="L1592">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1593">    session.beginTransaction();</span>
<span class="fc" id="L1594">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1595">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1597">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();

    // List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session
    // .createQuery(
    // &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor &quot;
    // + &quot;AND timestamp IN (SELECT max(timestamp) FROM MeasurementImpl WHERE &quot;
    // + &quot;depository = :depot AND sensor = :sensor)&quot;).setParameter(&quot;depot&quot;,
    // depot)
    // .setParameter(&quot;sensor&quot;, sensor).list();
<span class="pc bpc" id="L1609" title="1 of 2 branches missed.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L1610">      MeasurementImpl meas = result.get(0);</span>
<span class="fc" id="L1611">      value = new InterpolatedValue(sensorId, meas.getValue(), depot.getType().toMeasurementType(),</span>
          meas.getTimestamp());
    }
<span class="fc" id="L1614">    session.getTransaction().commit();</span>
<span class="fc" id="L1615">    session.close();</span>
<span class="pc bpc" id="L1616" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1617">      endTime = System.nanoTime();</span>
<span class="nc" id="L1618">      diff = endTime - startTime;</span>
<span class="nc" id="L1619">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1620">      timingLogger.log(Level.SEVERE, padding + &quot;getLatestMeasuredValueNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1623">    return value;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurement(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Measurement getMeasurement(String depotId, String orgId, String measId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1636">    Long startTime = 0l;</span>
<span class="fc" id="L1637">    Long endTime = 0l;</span>
<span class="fc" id="L1638">    Long diff = 0l;</span>
<span class="pc bpc" id="L1639" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1640">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurement(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L1642">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1643">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1645" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1646">      getOrganization(orgId, check);</span>
<span class="fc" id="L1647">      getDepository(depotId, orgId, check);</span>
    }
<span class="fc" id="L1649">    Measurement ret = getMeasurementNoCheck(depotId, orgId, measId);</span>
<span class="pc bpc" id="L1650" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1651">      endTime = System.nanoTime();</span>
<span class="nc" id="L1652">      diff = endTime - startTime;</span>
<span class="nc" id="L1653">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1654">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurement(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1657">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param measId The measurement's id.
   * @return The Measurement with the given ids or null.
   */
  private Measurement getMeasurementNoCheck(String depotId, String orgId, String measId) {
<span class="fc" id="L1667">    Long startTime = 0l;</span>
<span class="fc" id="L1668">    Long endTime = 0l;</span>
<span class="fc" id="L1669">    Long diff = 0l;</span>
<span class="pc bpc" id="L1670" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1671">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L1673">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1674">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1676">    Measurement ret = null;</span>
<span class="fc" id="L1677">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1678">    session.beginTransaction();</span>
<span class="fc" id="L1679">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1681">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depot AND id = :id&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;id&quot;, measId).list();
<span class="pc bpc" id="L1684" title="1 of 2 branches missed.">    if (result.size() == 1) {</span>
<span class="fc" id="L1685">      ret = result.get(0).toMeasurement();</span>
    }
<span class="fc" id="L1687">    session.getTransaction().commit();</span>
<span class="fc" id="L1688">    session.close();</span>
<span class="pc bpc" id="L1689" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1690">      endTime = System.nanoTime();</span>
<span class="nc" id="L1691">      diff = endTime - startTime;</span>
<span class="nc" id="L1692">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1693">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1696">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurements(java.lang.String,
   * java.lang.String)
   */
  @Override
  public List&lt;Measurement&gt; getMeasurements(String depotId, String orgId, String sensorId,
      boolean check) throws IdNotFoundException {
<span class="fc" id="L1709">    Long startTime = 0l;</span>
<span class="fc" id="L1710">    Long endTime = 0l;</span>
<span class="fc" id="L1711">    Long diff = 0l;</span>
<span class="pc bpc" id="L1712" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1713">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurements(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1715">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1716">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1718" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1719">      getOrganization(orgId, check);</span>
<span class="fc" id="L1720">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1721">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1723">    List&lt;Measurement&gt; ret = getMeasurementsNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1724" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1725">      endTime = System.nanoTime();</span>
<span class="nc" id="L1726">      diff = endTime - startTime;</span>
<span class="nc" id="L1727">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1728">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurements(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1731">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurements(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public List&lt;Measurement&gt; getMeasurements(String depotId, String orgId, String sensorId,
      Date start, Date end, boolean check) throws IdNotFoundException {
<span class="fc" id="L1744">    Long startTime = 0l;</span>
<span class="fc" id="L1745">    Long endTime = 0l;</span>
<span class="fc" id="L1746">    Long diff = 0l;</span>
<span class="pc bpc" id="L1747" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1748">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1750">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1751">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1753" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1754">      getOrganization(orgId, check);</span>
<span class="fc" id="L1755">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1756">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1758">    List&lt;Measurement&gt; ret = getMeasurementsNoCheck(depotId, orgId, sensorId, start, end);</span>
<span class="pc bpc" id="L1759" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1760">      endTime = System.nanoTime();</span>
<span class="nc" id="L1761">      diff = endTime - startTime;</span>
<span class="nc" id="L1762">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1763">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1766">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, boolean)
   */
  @Override
  public Long getMeasurementsCount(String orgId, boolean check) throws IdNotFoundException {
<span class="nc" id="L1778">    Long startTime = 0l;</span>
<span class="nc" id="L1779">    Long endTime = 0l;</span>
<span class="nc" id="L1780">    Long diff = 0l;</span>
<span class="nc bnc" id="L1781" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1782">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCount(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1783">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1784">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1786" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1787">      getOrganization(orgId, check);</span>
    }
<span class="nc" id="L1789">    Long ret = 0l;</span>
<span class="nc" id="L1790">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1791">    session.beginTransaction();</span>
<span class="nc bnc" id="L1792" title="All 2 branches missed.">    for (DepositoryImpl depot : retrieveDepositories(session, orgId)) {</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1794">      List&lt;Long&gt; result = (List&lt;Long&gt;) session</span>
          .createQuery(&quot;SELECT count(*) FROM MeasurementImpl WHERE depository = :depot&quot;)
          .setParameter(&quot;depot&quot;, depot).list();
<span class="nc" id="L1797">      ret += result.get(0);</span>
<span class="nc" id="L1798">    }</span>
<span class="nc" id="L1799">    session.getTransaction().commit();</span>
<span class="nc" id="L1800">    session.close();</span>

<span class="nc bnc" id="L1802" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1803">      endTime = System.nanoTime();</span>
<span class="nc" id="L1804">      diff = endTime - startTime;</span>
<span class="nc" id="L1805">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1806">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1809">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, java.lang.String, java.lang.String)
   */
  @Override
  public Long getMeasurementsCount(String depotId, String orgId, String sensorId, boolean check)
      throws IdNotFoundException {
<span class="nc" id="L1822">    Long startTime = 0l;</span>
<span class="nc" id="L1823">    Long endTime = 0l;</span>
<span class="nc" id="L1824">    Long diff = 0l;</span>
<span class="nc bnc" id="L1825" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1826">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCount(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1828">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1829">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1831" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1832">      getOrganization(orgId, check);</span>
<span class="nc" id="L1833">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1834">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1836">    Long ret = getMeasurementsCountNoCheck(depotId, orgId, sensorId);</span>
<span class="nc bnc" id="L1837" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1838">      endTime = System.nanoTime();</span>
<span class="nc" id="L1839">      diff = endTime - startTime;</span>
<span class="nc" id="L1840">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1841">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1844">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, java.lang.String, java.lang.String, java.util.Date,
   * java.util.Date)
   */
  @Override
  public Long getMeasurementsCount(String depotId, String orgId, String sensorId, Date start,
      Date end, boolean check) throws IdNotFoundException {
<span class="nc" id="L1858">    Long startTime = 0l;</span>
<span class="nc" id="L1859">    Long endTime = 0l;</span>
<span class="nc" id="L1860">    Long diff = 0l;</span>
<span class="nc bnc" id="L1861" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1862">      startTime = System.nanoTime();</span>
<span class="nc" id="L1863">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getMeasurementsCount(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1865">      padding += &quot;  &quot;;</span>
    }
<span class="nc bnc" id="L1867" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1868">      getOrganization(orgId, check);</span>
<span class="nc" id="L1869">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1870">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1872">    Long ret = getMeasurementsCountNoCheck(depotId, orgId, sensorId, start, end);</span>
<span class="nc bnc" id="L1873" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1874">      endTime = System.nanoTime();</span>
<span class="nc" id="L1875">      diff = endTime - startTime;</span>
<span class="nc" id="L1876">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1877">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1880">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @return the number of measurements made by the given sensor stored in the
   *         given depository.
   */
  private Long getMeasurementsCountNoCheck(String depotId, String orgId, String sensorId) {
<span class="nc" id="L1891">    Long startTime = 0l;</span>
<span class="nc" id="L1892">    Long endTime = 0l;</span>
<span class="nc" id="L1893">    Long diff = 0l;</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1895">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCountNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1897">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1898">      startTime = System.nanoTime();</span>
    }
<span class="nc" id="L1900">    Long ret = null;</span>
<span class="nc" id="L1901">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1902">    session.beginTransaction();</span>
<span class="nc" id="L1903">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="nc" id="L1904">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1906">    List&lt;Long&gt; result = (List&lt;Long&gt;) session</span>
        .createQuery(
            &quot;SELECT count(*) FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).list();
<span class="nc" id="L1910">    ret = result.get(0);</span>
<span class="nc" id="L1911">    session.getTransaction().commit();</span>
<span class="nc" id="L1912">    session.close();</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1914">      endTime = System.nanoTime();</span>
<span class="nc" id="L1915">      diff = endTime - startTime;</span>
<span class="nc" id="L1916">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1917">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCountNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1920">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @param start The start of the interval.
   * @param end The end of the interval.
   * @return a list of the measurements made by the given sensor stored in the
   *         given depository during the interval.
   */
  private Long getMeasurementsCountNoCheck(String depotId, String orgId, String sensorId,
      Date start, Date end) {
<span class="nc" id="L1934">    Long startTime = 0l;</span>
<span class="nc" id="L1935">    Long endTime = 0l;</span>
<span class="nc" id="L1936">    Long diff = 0l;</span>
<span class="nc bnc" id="L1937" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1938">      startTime = System.nanoTime();</span>
<span class="nc" id="L1939">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getMeasurementsCountNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1941">      padding += &quot;  &quot;;</span>
    }
<span class="nc" id="L1943">    Long ret = null;</span>
<span class="nc" id="L1944">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1945">    session.beginTransaction();</span>
<span class="nc" id="L1946">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="nc" id="L1947">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="nc" id="L1948">    Long result = (Long) session</span>
        .createQuery(
            &quot;SELECT count(*) FROM MeasurementImpl WHERE timestamp &gt;= :start AND timestamp &lt;= :end AND depository = :depository AND sensor = :sensor&quot;)
        .setParameter(&quot;start&quot;, start).setParameter(&quot;end&quot;, end).setParameter(&quot;depository&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).iterate().next();
<span class="nc" id="L1953">    ret = result;</span>
<span class="nc" id="L1954">    session.getTransaction().commit();</span>
<span class="nc" id="L1955">    session.close();</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1957">      endTime = System.nanoTime();</span>
<span class="nc" id="L1958">      diff = endTime - startTime;</span>
<span class="nc" id="L1959">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1960">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCountNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1963">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The Organization's id.
   * @param sensorId The sensor's id.
   * @return a List of all the Measurements.
   */
  private List&lt;Measurement&gt; getMeasurementsNoCheck(String depotId, String orgId, String sensorId) {
<span class="fc" id="L1973">    List&lt;Measurement&gt; ret = new ArrayList&lt;Measurement&gt;();</span>
<span class="fc" id="L1974">    Long startTime = 0l;</span>
<span class="fc" id="L1975">    Long endTime = 0l;</span>
<span class="fc" id="L1976">    Long diff = 0l;</span>
<span class="pc bpc" id="L1977" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1978">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1980">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1981">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1983">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1984">    session.beginTransaction();</span>
<span class="fc" id="L1985">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1986">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1988">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L1991" title="All 2 branches covered.">    for (MeasurementImpl mi : result) {</span>
<span class="fc" id="L1992">      ret.add(mi.toMeasurement());</span>
<span class="fc" id="L1993">    }</span>
<span class="fc" id="L1994">    session.getTransaction().commit();</span>
<span class="fc" id="L1995">    session.close();</span>
<span class="pc bpc" id="L1996" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1997">      endTime = System.nanoTime();</span>
<span class="nc" id="L1998">      diff = endTime - startTime;</span>
<span class="nc" id="L1999">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2000">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2003">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @param start The start of the interval.
   * @param end The end of the interval.
   * @return All the measurements during the interval for the given depository,
   *         organization and sensor.
   */
  private List&lt;Measurement&gt; getMeasurementsNoCheck(String depotId, String orgId, String sensorId,
      Date start, Date end) {
<span class="fc" id="L2017">    Long startTime = 0l;</span>
<span class="fc" id="L2018">    Long endTime = 0l;</span>
<span class="fc" id="L2019">    Long diff = 0l;</span>
<span class="pc bpc" id="L2020" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2021">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L2023">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2024">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2026">    List&lt;Measurement&gt; ret = new ArrayList&lt;Measurement&gt;();</span>
<span class="fc" id="L2027">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2028">    session.beginTransaction();</span>
<span class="fc" id="L2029">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L2030">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2032">    List&lt;MeasurementImpl&gt; measurements = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp &gt;= :start AND timestamp &lt;= :end AND depository = :depository AND sensor = :sensor&quot;)
        .setParameter(&quot;start&quot;, start).setParameter(&quot;end&quot;, end).setParameter(&quot;depository&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L2037" title="All 2 branches covered.">    for (MeasurementImpl mi : measurements) {</span>
<span class="fc" id="L2038">      ret.add(mi.toMeasurement());</span>
<span class="fc" id="L2039">    }</span>
<span class="fc" id="L2040">    session.getTransaction().commit();</span>
<span class="fc" id="L2041">    session.close();</span>
<span class="pc bpc" id="L2042" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2043">      endTime = System.nanoTime();</span>
<span class="nc" id="L2044">      diff = endTime - startTime;</span>
<span class="nc" id="L2045">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2046">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2049">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getMeasurementType(java.lang.String)
   */
  @Override
  public MeasurementType getMeasurementType(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2059">    Long startTime = 0l;</span>
<span class="fc" id="L2060">    Long endTime = 0l;</span>
<span class="fc" id="L2061">    Long diff = 0l;</span>
<span class="pc bpc" id="L2062" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2063">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementType(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2064">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2065">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2067">    MeasurementType ret = null;</span>
<span class="fc" id="L2068">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2069">    sessionOpen++;</span>
<span class="fc" id="L2070">    session.beginTransaction();</span>
<span class="fc" id="L2071">    MeasurementTypeImpl impl = retrieveMeasurementType(session, id);</span>
<span class="fc bfc" id="L2072" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2073">      ret = impl.toMeasurementType();</span>
    }
<span class="fc" id="L2075">    session.getTransaction().commit();</span>
<span class="fc" id="L2076">    session.close();</span>
<span class="fc" id="L2077">    sessionClose++;</span>
<span class="fc bfc" id="L2078" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2079">      throw new IdNotFoundException(id + &quot; is not a defined MeasurementType.&quot;);</span>
    }
<span class="pc bpc" id="L2081" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2082">      endTime = System.nanoTime();</span>
<span class="nc" id="L2083">      diff = endTime - startTime;</span>
<span class="nc" id="L2084">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2085">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementType(&quot; + id + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2088">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getMeasurementTypes()
   */
  @Override
  public List&lt;MeasurementType&gt; getMeasurementTypes() {
<span class="fc" id="L2098">    Long startTime = 0l;</span>
<span class="fc" id="L2099">    Long endTime = 0l;</span>
<span class="fc" id="L2100">    Long diff = 0l;</span>
<span class="pc bpc" id="L2101" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2102">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementTypes()&quot;);</span>
<span class="nc" id="L2103">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2104">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2106">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2107">    sessionOpen++;</span>
<span class="fc" id="L2108">    session.beginTransaction();</span>
<span class="fc" id="L2109">    List&lt;MeasurementTypeImpl&gt; ret = retrieveMeasurementTypes(session);</span>
<span class="fc" id="L2110">    List&lt;MeasurementType&gt; types = new ArrayList&lt;MeasurementType&gt;();</span>
<span class="fc bfc" id="L2111" title="All 2 branches covered.">    for (MeasurementTypeImpl i : ret) {</span>
<span class="fc" id="L2112">      types.add(i.toMeasurementType());</span>
<span class="fc" id="L2113">    }</span>
<span class="fc" id="L2114">    session.getTransaction().commit();</span>
<span class="fc" id="L2115">    session.close();</span>
<span class="fc" id="L2116">    sessionClose++;</span>
<span class="pc bpc" id="L2117" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2118">      endTime = System.nanoTime();</span>
<span class="nc" id="L2119">      diff = endTime - startTime;</span>
<span class="nc" id="L2120">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2121">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementTypes() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2124">    return types;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getOrganization(java.lang.String)
   */
  @Override
  public Organization getOrganization(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2134">    Long startTime = 0l;</span>
<span class="fc" id="L2135">    Long endTime = 0l;</span>
<span class="fc" id="L2136">    Long diff = 0l;</span>
<span class="pc bpc" id="L2137" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2138">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganization(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2139">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2141">    Organization ret = cache.getOrganization(id);</span>
<span class="fc bfc" id="L2142" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2143">      Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2144">      sessionOpen++;</span>
<span class="fc" id="L2145">      session.beginTransaction();</span>
<span class="fc" id="L2146">      OrganizationImpl org = retrieveOrganization(session, id);</span>
<span class="fc bfc" id="L2147" title="All 2 branches covered.">      if (org != null) {</span>
<span class="fc" id="L2148">        ret = org.toOrganization();</span>
      }
<span class="fc" id="L2150">      session.getTransaction().commit();</span>
<span class="fc" id="L2151">      session.close();</span>
<span class="fc" id="L2152">      sessionClose++;</span>
<span class="fc bfc" id="L2153" title="All 2 branches covered.">      if (ret == null) {</span>
<span class="fc" id="L2154">        throw new IdNotFoundException(id + &quot; isn't a defined Organization's id.&quot;);</span>
      }
<span class="fc" id="L2156">      cache.putOrganization(ret);</span>
    }
<span class="pc bpc" id="L2158" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2159">      endTime = System.nanoTime();</span>
<span class="nc" id="L2160">      diff = endTime - startTime;</span>
<span class="nc" id="L2161">      timingLogger.log(Level.SEVERE, padding + &quot;getOrganization(&quot; + id + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2164">    return ret;</span>
  }

  /*
   * (non-Javadoc)m
   * 
   * @see org.wattdepot.server.WattDepot#getOrganizationIds()
   */
  @Override
  public List&lt;String&gt; getOrganizationIds() {
<span class="fc" id="L2174">    Long startTime = 0l;</span>
<span class="fc" id="L2175">    Long endTime = 0l;</span>
<span class="fc" id="L2176">    Long diff = 0l;</span>
<span class="pc bpc" id="L2177" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2178">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganizationIds()&quot;);</span>
<span class="nc" id="L2179">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2180">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2182">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2183" title="All 2 branches covered.">    for (Organization u : getOrganizations()) {</span>
<span class="fc" id="L2184">      ret.add(u.getId());</span>
<span class="fc" id="L2185">    }</span>
<span class="pc bpc" id="L2186" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2187">      endTime = System.nanoTime();</span>
<span class="nc" id="L2188">      diff = endTime - startTime;</span>
<span class="nc" id="L2189">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2190">      timingLogger.log(Level.SEVERE, padding + &quot;getOrganizationIds() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2193">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getOrganizations()
   */
  @Override
  public List&lt;Organization&gt; getOrganizations() {
<span class="fc" id="L2203">    Long startTime = 0l;</span>
<span class="fc" id="L2204">    Long endTime = 0l;</span>
<span class="fc" id="L2205">    Long diff = 0l;</span>
<span class="pc bpc" id="L2206" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2207">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganizations()&quot;);</span>
<span class="nc" id="L2208">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2209">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2211">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2212">    sessionOpen++;</span>
<span class="fc" id="L2213">    session.beginTransaction();</span>
<span class="fc" id="L2214">    List&lt;OrganizationImpl&gt; r = retrieveOrganizations(session);</span>
<span class="fc" id="L2215">    List&lt;Organization&gt; ret = new ArrayList&lt;Organization&gt;();</span>
<span class="fc bfc" id="L2216" title="All 2 branches covered.">    for (OrganizationImpl o : r) {</span>
<span class="fc" id="L2217">      ret.add(o.toOrganization());</span>
<span class="fc" id="L2218">    }</span>
<span class="fc" id="L2219">    session.getTransaction().commit();</span>
<span class="fc" id="L2220">    session.close();</span>
<span class="fc" id="L2221">    sessionClose++;</span>
<span class="pc bpc" id="L2222" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2223">      endTime = System.nanoTime();</span>
<span class="nc" id="L2224">      diff = endTime - startTime;</span>
<span class="nc" id="L2225">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2226">      timingLogger</span>
          .log(Level.SEVERE, padding + &quot;getOrganizations() took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2229">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getRateSummary(java.lang.String,
   * java.lang.String, java.lang.String)
   */
  @Override
  public MeasurementRateSummary getRateSummary(String depotId, String orgId, String sensorId,
      boolean check) throws IdNotFoundException, NoMeasurementException {
<span class="nc" id="L2242">    Long startTime = 0l;</span>
<span class="nc" id="L2243">    Long endTime = 0l;</span>
<span class="nc" id="L2244">    Long diff = 0l;</span>
<span class="nc bnc" id="L2245" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2246">      startTime = System.nanoTime();</span>
<span class="nc" id="L2247">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getRateSummary(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L2249">      padding += &quot;  &quot;;</span>
    }
<span class="nc bnc" id="L2251" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L2252">      getOrganization(orgId, check);</span>
<span class="nc" id="L2253">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L2254">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L2256">    XMLGregorianCalendar now = Tstamp.makeTimestamp();</span>
<span class="nc" id="L2257">    XMLGregorianCalendar minAgo = Tstamp.incrementMinutes(now, -1);</span>
<span class="nc" id="L2258">    MeasurementRateSummary ret = new MeasurementRateSummary();</span>
<span class="nc" id="L2259">    ret.setDepositoryId(depotId);</span>
<span class="nc" id="L2260">    ret.setSensorId(sensorId);</span>
<span class="nc" id="L2261">    ret.setTimestamp(DateConvert.convertXMLCal(now));</span>
<span class="nc" id="L2262">    Long count = getMeasurementsCountNoCheck(depotId, orgId, sensorId,</span>
        DateConvert.convertXMLCal(minAgo), DateConvert.convertXMLCal(now));
<span class="nc" id="L2264">    ret.setOneMinuteCount(count);</span>
<span class="nc" id="L2265">    ret.setOneMinuteRate(count / 60.0);</span>
<span class="nc" id="L2266">    InterpolatedValue val = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="nc" id="L2267">    ret.setLatestValue(val.getValue());</span>
<span class="nc" id="L2268">    ret.setType(val.getMeasurementType());</span>
<span class="nc" id="L2269">    count = getMeasurementsCountNoCheck(depotId, orgId, sensorId);</span>
<span class="nc" id="L2270">    ret.setTotalCount(count);</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2272">      endTime = System.nanoTime();</span>
<span class="nc" id="L2273">      diff = endTime - startTime;</span>
<span class="nc" id="L2274">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2275">      timingLogger.log(Level.SEVERE, padding + &quot;getRateSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L2278">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensor(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Sensor getSensor(String id, String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2289">    Long startTime = 0l;</span>
<span class="fc" id="L2290">    Long endTime = 0l;</span>
<span class="fc" id="L2291">    Long diff = 0l;</span>
<span class="pc bpc" id="L2292" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2293">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensor(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2294">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2295">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2297" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2298">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2300">    Sensor ret = cache.getSensor(id, orgId);</span>
<span class="fc bfc" id="L2301" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2302">      ret = getSensorNoCheck(id, orgId);</span>
<span class="pc bpc" id="L2303" title="1 of 2 branches missed.">      if (ret != null) {</span>
<span class="nc" id="L2304">        cache.putSensor(ret);</span>
      }
    }
<span class="fc bfc" id="L2307" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2308">      throw new IdNotFoundException(id + &quot; is not a defined Sensor id.&quot;);</span>
    }
<span class="pc bpc" id="L2310" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2311">      endTime = System.nanoTime();</span>
<span class="nc" id="L2312">      diff = endTime - startTime;</span>
<span class="nc" id="L2313">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2314">      timingLogger.log(Level.SEVERE, padding + &quot;getSensor(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2317">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroup(java.lang.String,
   * java.lang.String)
   */
  @Override
  public SensorGroup getSensorGroup(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L2329">    Long startTime = 0l;</span>
<span class="fc" id="L2330">    Long endTime = 0l;</span>
<span class="fc" id="L2331">    Long diff = 0l;</span>
<span class="pc bpc" id="L2332" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2333">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroup(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2334">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2335">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2337" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2338">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2340">    SensorGroup ret = getSensorGroupNoCheck(id, orgId);</span>
<span class="fc bfc" id="L2341" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2342">      throw new IdNotFoundException(id + &quot; is not a defined SensorGroup id.&quot;);</span>
    }
<span class="pc bpc" id="L2344" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2345">      endTime = System.nanoTime();</span>
<span class="nc" id="L2346">      diff = endTime - startTime;</span>
<span class="nc" id="L2347">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2348">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroup(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2351">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroupIds()
   */
  @Override
  public List&lt;String&gt; getSensorGroupIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2361">    Long startTime = 0l;</span>
<span class="fc" id="L2362">    Long endTime = 0l;</span>
<span class="fc" id="L2363">    Long diff = 0l;</span>
<span class="pc bpc" id="L2364" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2365">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2366">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2367">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L2369" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2370">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2372">    List&lt;String&gt; ret = getSensorGroupIdsNoCheck(orgId);</span>
<span class="pc bpc" id="L2373" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2374">      endTime = System.nanoTime();</span>
<span class="nc" id="L2375">      diff = endTime - startTime;</span>
<span class="nc" id="L2376">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2377">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2380">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return A List of the SensorGroups' ids.
   */
  private List&lt;String&gt; getSensorGroupIdsNoCheck(String orgId) {
<span class="fc" id="L2388">    Long startTime = 0l;</span>
<span class="fc" id="L2389">    Long endTime = 0l;</span>
<span class="fc" id="L2390">    Long diff = 0l;</span>
<span class="pc bpc" id="L2391" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2392">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2393">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2394">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2396">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2397" title="All 2 branches covered.">    for (SensorGroup s : getSensorGroupsNoCheck(orgId)) {</span>
<span class="fc" id="L2398">      ret.add(s.getId());</span>
<span class="fc" id="L2399">    }</span>
<span class="pc bpc" id="L2400" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2401">      endTime = System.nanoTime();</span>
<span class="nc" id="L2402">      diff = endTime - startTime;</span>
<span class="nc" id="L2403">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2404">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2407">    return ret;</span>
  }

  /**
   * @param id The sensor group's id.
   * @param orgId The organization's id.
   * @return The defined SensorGroup or null.
   */
  private SensorGroup getSensorGroupNoCheck(String id, String orgId) {
<span class="fc" id="L2416">    Long startTime = 0l;</span>
<span class="fc" id="L2417">    Long endTime = 0l;</span>
<span class="fc" id="L2418">    Long diff = 0l;</span>
<span class="pc bpc" id="L2419" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2420">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;)&quot;);
<span class="nc" id="L2422">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2423">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2425">    SensorGroup ret = null;</span>
<span class="fc" id="L2426">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2427">    sessionOpen++;</span>
<span class="fc" id="L2428">    session.beginTransaction();</span>
<span class="fc" id="L2429">    SensorGroupImpl impl = retrieveSensorGroup(session, id, orgId);</span>
<span class="fc bfc" id="L2430" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2431">      ret = impl.toSensorGroup();</span>
    }
<span class="fc" id="L2433">    session.getTransaction().commit();</span>
<span class="fc" id="L2434">    session.close();</span>
<span class="fc" id="L2435">    sessionClose++;</span>
<span class="pc bpc" id="L2436" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2437">      endTime = System.nanoTime();</span>
<span class="nc" id="L2438">      diff = endTime - startTime;</span>
<span class="nc" id="L2439">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2440">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2443">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroups(java.lang.String)
   */
  @Override
  public List&lt;SensorGroup&gt; getSensorGroups(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2453">    Long startTime = 0l;</span>
<span class="fc" id="L2454">    Long endTime = 0l;</span>
<span class="fc" id="L2455">    Long diff = 0l;</span>
<span class="pc bpc" id="L2456" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2457">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroups(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2458">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2459">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2461" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2462">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2464">    List&lt;SensorGroup&gt; ret = getSensorGroupsNoCheck(orgId);</span>
<span class="pc bpc" id="L2465" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2466">      endTime = System.nanoTime();</span>
<span class="nc" id="L2467">      diff = endTime - startTime;</span>
<span class="nc" id="L2468">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2469">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroups(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2472">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return All the defined SensorGroups.
   */
  private List&lt;SensorGroup&gt; getSensorGroupsNoCheck(String orgId) {
<span class="fc" id="L2480">    Long startTime = 0l;</span>
<span class="fc" id="L2481">    Long endTime = 0l;</span>
<span class="fc" id="L2482">    Long diff = 0l;</span>
<span class="pc bpc" id="L2483" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2484">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2485">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2486">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2488">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2489">    sessionOpen++;</span>
<span class="fc" id="L2490">    session.beginTransaction();</span>
<span class="fc" id="L2491">    List&lt;SensorGroupImpl&gt; r = retrieveSensorGroups(session, orgId);</span>
<span class="fc" id="L2492">    List&lt;SensorGroup&gt; ret = new ArrayList&lt;SensorGroup&gt;();</span>
<span class="fc bfc" id="L2493" title="All 2 branches covered.">    for (SensorGroupImpl s : r) {</span>
<span class="fc" id="L2494">      ret.add(s.toSensorGroup());</span>
<span class="fc" id="L2495">    }</span>
<span class="fc" id="L2496">    session.getTransaction().commit();</span>
<span class="fc" id="L2497">    session.close();</span>
<span class="fc" id="L2498">    sessionClose++;</span>
<span class="pc bpc" id="L2499" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2500">      endTime = System.nanoTime();</span>
<span class="nc" id="L2501">      diff = endTime - startTime;</span>
<span class="nc" id="L2502">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2503">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2506">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorIds()
   */
  @Override
  public List&lt;String&gt; getSensorIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2516">    Long startTime = 0l;</span>
<span class="fc" id="L2517">    Long endTime = 0l;</span>
<span class="fc" id="L2518">    Long diff = 0l;</span>
<span class="pc bpc" id="L2519" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2520">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2521">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2522">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2524">    List&lt;String&gt; ret = getSensorIdsNoCheck(orgId);</span>
<span class="pc bpc" id="L2525" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2526">      endTime = System.nanoTime();</span>
<span class="nc" id="L2527">      diff = endTime - startTime;</span>
<span class="nc" id="L2528">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2529">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorIds(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2532">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return The defined Sensors' ids.
   */
  private List&lt;String&gt; getSensorIdsNoCheck(String orgId) {
<span class="fc" id="L2540">    Long startTime = 0l;</span>
<span class="fc" id="L2541">    Long endTime = 0l;</span>
<span class="fc" id="L2542">    Long diff = 0l;</span>
<span class="pc bpc" id="L2543" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2544">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorIdsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2545">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2546">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2548">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2549" title="All 2 branches covered.">    for (Sensor s : getSensorsNoCheck(orgId)) {</span>
<span class="fc" id="L2550">      ret.add(s.getId());</span>
<span class="fc" id="L2551">    }</span>
<span class="pc bpc" id="L2552" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2553">      endTime = System.nanoTime();</span>
<span class="nc" id="L2554">      diff = endTime - startTime;</span>
<span class="nc" id="L2555">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2556">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorIdsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2559">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModel(java.lang.String,
   * java.lang.String)
   */
  @Override
  public SensorModel getSensorModel(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2570">    Long startTime = 0l;</span>
<span class="fc" id="L2571">    Long endTime = 0l;</span>
<span class="fc" id="L2572">    Long diff = 0l;</span>
<span class="pc bpc" id="L2573" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2574">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModel(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2575">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2576">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2578">    SensorModel ret = null;</span>
<span class="fc" id="L2579">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2580">    sessionOpen++;</span>
<span class="fc" id="L2581">    session.beginTransaction();</span>
<span class="fc" id="L2582">    SensorModelImpl impl = retrieveSensorModel(session, id);</span>
<span class="fc bfc" id="L2583" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2584">      ret = impl.toSensorModel();</span>
    }
<span class="fc" id="L2586">    session.getTransaction().commit();</span>
<span class="fc" id="L2587">    session.close();</span>
<span class="fc" id="L2588">    sessionClose++;</span>
<span class="fc bfc" id="L2589" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2590">      throw new IdNotFoundException(id + &quot; is not a valid SensorModel id.&quot;);</span>
    }
<span class="pc bpc" id="L2592" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2593">      endTime = System.nanoTime();</span>
<span class="nc" id="L2594">      diff = endTime - startTime;</span>
<span class="nc" id="L2595">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2596">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModel(&quot; + id + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2599">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModelIds()
   */
  @Override
  public List&lt;String&gt; getSensorModelIds() {
<span class="fc" id="L2609">    Long startTime = 0l;</span>
<span class="fc" id="L2610">    Long endTime = 0l;</span>
<span class="fc" id="L2611">    Long diff = 0l;</span>
<span class="pc bpc" id="L2612" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2613">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModelIds()&quot;);</span>
<span class="nc" id="L2614">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2615">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2617">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2618" title="All 2 branches covered.">    for (SensorModel s : getSensorModels()) {</span>
<span class="fc" id="L2619">      ret.add(s.getId());</span>
<span class="fc" id="L2620">    }</span>
<span class="pc bpc" id="L2621" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2622">      endTime = System.nanoTime();</span>
<span class="nc" id="L2623">      diff = endTime - startTime;</span>
<span class="nc" id="L2624">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2625">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModelIds() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2628">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModels(java.lang.String)
   */
  @Override
  public List&lt;SensorModel&gt; getSensorModels() {
<span class="fc" id="L2638">    Long startTime = 0l;</span>
<span class="fc" id="L2639">    Long endTime = 0l;</span>
<span class="fc" id="L2640">    Long diff = 0l;</span>
<span class="pc bpc" id="L2641" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2642">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModels()&quot;);</span>
<span class="nc" id="L2643">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2644">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2646">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2647">    sessionOpen++;</span>
<span class="fc" id="L2648">    session.beginTransaction();</span>
<span class="fc" id="L2649">    List&lt;SensorModelImpl&gt; r = retrieveSensorModels(session);</span>
<span class="fc" id="L2650">    List&lt;SensorModel&gt; ret = new ArrayList&lt;SensorModel&gt;();</span>
<span class="fc bfc" id="L2651" title="All 2 branches covered.">    for (SensorModelImpl s : r) {</span>
<span class="fc" id="L2652">      ret.add(s.toSensorModel());</span>
<span class="fc" id="L2653">    }</span>
<span class="fc" id="L2654">    session.getTransaction().commit();</span>
<span class="fc" id="L2655">    session.close();</span>
<span class="fc" id="L2656">    sessionClose++;</span>
<span class="pc bpc" id="L2657" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2658">      endTime = System.nanoTime();</span>
<span class="nc" id="L2659">      diff = endTime - startTime;</span>
<span class="nc" id="L2660">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2661">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModels() took &quot; + (diff / 1E9) + &quot; secs.&quot;);</span>
    }
<span class="fc" id="L2663">    return ret;</span>
  }

  /**
   * @param id The sensor's id.
   * @param orgId The organization's id.
   * @return The defined Sensor or null.
   */
  private Sensor getSensorNoCheck(String id, String orgId) {
<span class="fc" id="L2672">    Long startTime = 0l;</span>
<span class="fc" id="L2673">    Long endTime = 0l;</span>
<span class="fc" id="L2674">    Long diff = 0l;</span>
<span class="pc bpc" id="L2675" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2676">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorNoCheck(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2677">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2679">    Sensor ret = null;</span>
<span class="fc" id="L2680">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2681">    sessionOpen++;</span>
<span class="fc" id="L2682">    session.beginTransaction();</span>
<span class="fc" id="L2683">    SensorImpl impl = retrieveSensor(session, id, orgId);</span>
<span class="pc bpc" id="L2684" title="1 of 2 branches missed.">    if (impl != null) {</span>
<span class="nc" id="L2685">      ret = impl.toSensor();</span>
    }
<span class="fc" id="L2687">    session.getTransaction().commit();</span>
<span class="fc" id="L2688">    session.close();</span>
<span class="fc" id="L2689">    sessionClose++;</span>
<span class="pc bpc" id="L2690" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2691">      endTime = System.nanoTime();</span>
<span class="nc" id="L2692">      diff = endTime - startTime;</span>
<span class="nc" id="L2693">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorNoCheck(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2696">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensors(java.lang.String)
   */
  @Override
  public List&lt;Sensor&gt; getSensors(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2706">    Long startTime = 0l;</span>
<span class="fc" id="L2707">    Long endTime = 0l;</span>
<span class="fc" id="L2708">    Long diff = 0l;</span>
<span class="pc bpc" id="L2709" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2710">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensors(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2711">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2712">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2714" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2715">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2717">    List&lt;Sensor&gt; ret = getSensorsNoCheck(orgId);</span>
<span class="pc bpc" id="L2718" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2719">      endTime = System.nanoTime();</span>
<span class="nc" id="L2720">      diff = endTime - startTime;</span>
<span class="nc" id="L2721">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2722">      timingLogger.log(Level.SEVERE, padding + &quot;getSensors(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2725">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return A list of the defined Sensors.
   */
  private List&lt;Sensor&gt; getSensorsNoCheck(String orgId) {
<span class="fc" id="L2733">    Long startTime = 0l;</span>
<span class="fc" id="L2734">    Long endTime = 0l;</span>
<span class="fc" id="L2735">    Long diff = 0l;</span>
<span class="pc bpc" id="L2736" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2737">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2738">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2739">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2741">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2742">    sessionOpen++;</span>
<span class="fc" id="L2743">    session.beginTransaction();</span>
<span class="fc" id="L2744">    List&lt;SensorImpl&gt; r = retrieveSensors(session, orgId);</span>
<span class="fc" id="L2745">    List&lt;Sensor&gt; ret = new ArrayList&lt;Sensor&gt;();</span>
<span class="fc bfc" id="L2746" title="All 2 branches covered.">    for (SensorImpl s : r) {</span>
<span class="fc" id="L2747">      ret.add(s.toSensor());</span>
<span class="fc" id="L2748">    }</span>
<span class="fc" id="L2749">    session.getTransaction().commit();</span>
<span class="fc" id="L2750">    session.close();</span>
<span class="fc" id="L2751">    sessionClose++;</span>
<span class="pc bpc" id="L2752" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2753">      endTime = System.nanoTime();</span>
<span class="nc" id="L2754">      diff = endTime - startTime;</span>
<span class="nc" id="L2755">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2756">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2759">    return ret;</span>
  }

  /**
   * @return the sessionClose
   */
  public int getSessionClose() {
<span class="fc" id="L2766">    return sessionClose;</span>
  }

  /**
   * @return the sessionOpen
   */
  public int getSessionOpen() {
<span class="fc" id="L2773">    return sessionOpen;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getSummary(java.lang.String,
   * java.lang.String, java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public SensorMeasurementSummary getSummary(String depotId, String orgId, String sensorId,
      Date start, Date end, boolean check) throws IdNotFoundException {
<span class="nc" id="L2785">    Long startTime = 0l;</span>
<span class="nc" id="L2786">    Long endTime = 0l;</span>
<span class="nc" id="L2787">    Long diff = 0l;</span>
<span class="nc bnc" id="L2788" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2789">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;)&quot;);
<span class="nc" id="L2791">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2792">      startTime = System.nanoTime();</span>
    }
<span class="nc" id="L2794">    List&lt;Measurement&gt; list = getMeasurements(depotId, orgId, sensorId, start, end, check);</span>
<span class="nc" id="L2795">    SensorMeasurementSummary ret = new SensorMeasurementSummary(sensorId, depotId, start, end,</span>
        list.size());
<span class="nc bnc" id="L2797" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2798">      endTime = System.nanoTime();</span>
<span class="nc" id="L2799">      diff = endTime - startTime;</span>
<span class="nc" id="L2800">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2801">      timingLogger.log(Level.SEVERE, padding + &quot;getSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L2804">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUser(java.lang.String)
   */
  @Override
  public UserInfo getUser(String id, String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2814">    Long startTime = 0l;</span>
<span class="fc" id="L2815">    Long endTime = 0l;</span>
<span class="fc" id="L2816">    Long diff = 0l;</span>
<span class="pc bpc" id="L2817" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2818">      timingLogger.log(Level.SEVERE, padding + &quot;Start getUser(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2819">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2820">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2822" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2823">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2825">    UserInfo ret = null;</span>
<span class="fc" id="L2826">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2827">    sessionOpen++;</span>
<span class="fc" id="L2828">    session.beginTransaction();</span>
<span class="fc" id="L2829">    UserInfoImpl impl = retrieveUser(session, id, orgId);</span>
<span class="fc bfc" id="L2830" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2831">      ret = impl.toUserInfo();</span>
    }
<span class="fc" id="L2833">    session.getTransaction().commit();</span>
<span class="fc" id="L2834">    session.close();</span>
<span class="fc" id="L2835">    sessionClose++;</span>
<span class="fc bfc" id="L2836" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2837">      throw new IdNotFoundException(id + &quot; is not a defined user id.&quot;);</span>
    }
<span class="pc bpc" id="L2839" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2840">      endTime = System.nanoTime();</span>
<span class="nc" id="L2841">      diff = endTime - startTime;</span>
<span class="nc" id="L2842">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2843">      timingLogger.log(Level.SEVERE, padding + &quot;getUser(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2846">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUserIds()
   */
  @Override
  public List&lt;String&gt; getUserIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2856">    Long startTime = 0l;</span>
<span class="fc" id="L2857">    Long endTime = 0l;</span>
<span class="fc" id="L2858">    Long diff = 0l;</span>
<span class="pc bpc" id="L2859" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2860">      timingLogger.log(Level.SEVERE, padding + &quot;Start getUserIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2861">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2862">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2864">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2865" title="All 2 branches covered.">    for (UserInfo u : getUsers(orgId, check)) {</span>
<span class="fc" id="L2866">      ret.add(u.getUid());</span>
<span class="fc" id="L2867">    }</span>
<span class="pc bpc" id="L2868" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2869">      endTime = System.nanoTime();</span>
<span class="nc" id="L2870">      diff = endTime - startTime;</span>
<span class="nc" id="L2871">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2872">      timingLogger.log(Level.SEVERE, padding + &quot;getUserIds(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2875">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUserPassword(java.lang.String)
   */
  @Override
  public UserPassword getUserPassword(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L2886">    UserPassword ret = null;</span>
<span class="fc" id="L2887">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2888">    sessionOpen++;</span>
<span class="fc" id="L2889">    session.beginTransaction();</span>
<span class="fc" id="L2890">    UserPasswordImpl impl = retrieveUserPassword(session, id, orgId);</span>
<span class="fc bfc" id="L2891" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2892">      ret = impl.toUserPassword();</span>
    }
<span class="fc" id="L2894">    session.getTransaction().commit();</span>
<span class="fc" id="L2895">    session.close();</span>
<span class="fc" id="L2896">    sessionClose++;</span>
<span class="fc bfc" id="L2897" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2898">      throw new IdNotFoundException(id + &quot; is not a valid UserPassword id.&quot;);</span>
    }
<span class="fc" id="L2900">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUsers()
   */
  @Override
  public List&lt;UserInfo&gt; getUsers() {
<span class="fc" id="L2910">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2911">    sessionOpen++;</span>
<span class="fc" id="L2912">    session.beginTransaction();</span>
<span class="fc" id="L2913">    List&lt;UserInfoImpl&gt; result = retrieveUsers(session);</span>
<span class="fc" id="L2914">    ArrayList&lt;UserInfo&gt; ret = new ArrayList&lt;UserInfo&gt;();</span>
<span class="fc bfc" id="L2915" title="All 2 branches covered.">    for (UserInfoImpl u : result) {</span>
<span class="fc" id="L2916">      ret.add(u.toUserInfo());</span>
<span class="fc" id="L2917">    }</span>
<span class="fc" id="L2918">    session.getTransaction().commit();</span>
<span class="fc" id="L2919">    session.close();</span>
<span class="fc" id="L2920">    sessionClose++;</span>
<span class="fc" id="L2921">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUsers()
   */
  @Override
  public List&lt;UserInfo&gt; getUsers(String orgId, boolean check) throws IdNotFoundException {
<span class="pc bpc" id="L2931" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2932">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2934">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2935">    sessionOpen++;</span>
<span class="fc" id="L2936">    session.beginTransaction();</span>
<span class="fc" id="L2937">    List&lt;UserInfoImpl&gt; result = retrieveUsers(session, orgId);</span>
<span class="fc" id="L2938">    ArrayList&lt;UserInfo&gt; ret = new ArrayList&lt;UserInfo&gt;();</span>
<span class="fc bfc" id="L2939" title="All 2 branches covered.">    for (UserInfoImpl u : result) {</span>
<span class="fc" id="L2940">      ret.add(u.toUserInfo());</span>
<span class="fc" id="L2941">    }</span>
<span class="fc" id="L2942">    session.getTransaction().commit();</span>
<span class="fc" id="L2943">    session.close();</span>
<span class="fc" id="L2944">    sessionClose++;</span>
<span class="fc" id="L2945">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date timestamp,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="pc bpc" id="L2957" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2958">      getOrganization(orgId, check);</span>
<span class="fc" id="L2959">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L2960">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L2962">    Double ret = null;</span>
<span class="fc" id="L2963">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2964">    session.beginTransaction();</span>
<span class="fc" id="L2965">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L2966">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2968">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp = :time AND depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
<span class="fc bfc" id="L2973" title="All 2 branches covered.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L2974">      ret = result.get(0).getValue();</span>
    }
    else {
      // need to get the stradle
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2979">      List&lt;MeasurementImpl&gt; before = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &lt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2985">      List&lt;MeasurementImpl&gt; after = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &gt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setMaxResults(1).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L2990">      MeasurementImpl justBefore = null;</span>
<span class="fc bfc" id="L2991" title="All 2 branches covered.">      for (MeasurementImpl b : before) {</span>
<span class="pc bpc" id="L2992" title="1 of 2 branches missed.">        if (b.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L2993" title="1 of 2 branches missed.">          if (justBefore == null) {</span>
<span class="fc" id="L2994">            justBefore = b;</span>
          }
<span class="nc bnc" id="L2996" title="All 2 branches missed.">          else if (b.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L2997">            justBefore = b;</span>
          }
        }
<span class="fc" id="L3000">      }</span>
<span class="fc bfc" id="L3001" title="All 2 branches covered.">      if (justBefore == null) {</span>
<span class="fc" id="L3002">        session.getTransaction().commit();</span>
<span class="fc" id="L3003">        session.close();</span>
<span class="fc" id="L3004">        throw new NoMeasurementException(&quot;Cannot find measurement before &quot; + timestamp);</span>
      }
<span class="fc" id="L3006">      MeasurementImpl justAfter = null;</span>
<span class="fc bfc" id="L3007" title="All 2 branches covered.">      for (MeasurementImpl a : after) {</span>
<span class="pc bpc" id="L3008" title="1 of 2 branches missed.">        if (a.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3009" title="1 of 2 branches missed.">          if (justAfter == null) {</span>
<span class="fc" id="L3010">            justAfter = a;</span>
          }
<span class="nc bnc" id="L3012" title="All 2 branches missed.">          else if (a.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3013">            justAfter = a;</span>
          }
        }
<span class="fc" id="L3016">      }</span>
<span class="fc bfc" id="L3017" title="All 2 branches covered.">      if (justAfter == null) {</span>
<span class="fc" id="L3018">        session.getTransaction().commit();</span>
<span class="fc" id="L3019">        session.close();</span>
<span class="fc" id="L3020">        throw new NoMeasurementException(&quot;Cannot find measurement after &quot; + timestamp);</span>
      }
<span class="fc" id="L3022">      Double val1 = justBefore.getValue();</span>
<span class="fc" id="L3023">      Double val2 = justAfter.getValue();</span>
<span class="fc" id="L3024">      Double deltaV = val2 - val1;</span>
<span class="fc" id="L3025">      Long t1 = justBefore.getTimestamp().getTime();</span>
<span class="fc" id="L3026">      Long t2 = justAfter.getTimestamp().getTime();</span>
<span class="fc" id="L3027">      Long deltaT = t2 - t1;</span>
<span class="fc" id="L3028">      Long t3 = timestamp.getTime();</span>
<span class="fc" id="L3029">      Long toDate = t3 - t1;</span>
<span class="fc" id="L3030">      Double slope = deltaV / deltaT;</span>
<span class="fc" id="L3031">      ret = val1 + slope * toDate;</span>
    }
<span class="fc" id="L3033">    session.getTransaction().commit();</span>
<span class="fc" id="L3034">    session.close();</span>
<span class="fc" id="L3035">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date start, Date end,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L3047">    Boolean generatePower = false;</span>
<span class="fc" id="L3048">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3049">    session.beginTransaction();</span>
<span class="fc" id="L3050">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="pc bpc" id="L3051" title="1 of 2 branches missed.">    for (PropertyImpl p : sensor.getProperties()) {</span>
<span class="nc bnc" id="L3052" title="All 2 branches missed.">      if (p.getKey().equals(Labels.GENERATE_POWER)) {</span>
<span class="nc" id="L3053">        generatePower = Boolean.parseBoolean(p.getValue());</span>
      }
<span class="nc" id="L3055">    }</span>
<span class="fc" id="L3056">    session.getTransaction().commit();</span>
<span class="fc" id="L3057">    session.close();</span>
<span class="fc" id="L3058">    Double endVal = getValue(depotId, orgId, sensorId, end, check);</span>
<span class="fc" id="L3059">    Double startVal = getValue(depotId, orgId, sensorId, start, check);</span>
<span class="pc bpc" id="L3060" title="2 of 4 branches missed.">    if (endVal != null &amp;&amp; startVal != null) {</span>
<span class="fc" id="L3061">      Double returnVal = endVal - startVal;</span>
<span class="pc bpc" id="L3062" title="1 of 4 branches missed.">      if (returnVal &lt; 0 &amp;&amp; !generatePower) {</span>
<span class="fc" id="L3063">        Double max = Double.MIN_NORMAL;</span>
<span class="fc" id="L3064">        Double min = Double.MAX_VALUE;</span>
<span class="fc" id="L3065">        List&lt;Measurement&gt; measurements = getMeasurements(depotId, orgId, sensorId, start, end, false);</span>
<span class="fc bfc" id="L3066" title="All 2 branches covered.">        for (Measurement m : measurements) {</span>
<span class="fc" id="L3067">          Double value = m.getValue();</span>
<span class="fc bfc" id="L3068" title="All 2 branches covered.">          if (max &lt; value) {</span>
<span class="fc" id="L3069">            max = value;</span>
          }
<span class="pc bpc" id="L3071" title="1 of 2 branches missed.">          if (min &gt; value) {</span>
<span class="fc" id="L3072">            min = value;</span>
          }
<span class="fc" id="L3074">          returnVal = endVal - startVal + max - min;</span>
<span class="fc" id="L3075">        }</span>
      }
<span class="fc" id="L3077">      return returnVal;</span>
    }
<span class="nc" id="L3079">    return null;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date, java.lang.Long)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date start, Date end,
      Long gapSeconds, boolean check) throws NoMeasurementException, MeasurementGapException,
      IdNotFoundException {
<span class="fc" id="L3092">    Boolean generatePower = false;</span>
<span class="fc" id="L3093">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3094">    session.beginTransaction();</span>
<span class="fc" id="L3095">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="pc bpc" id="L3096" title="1 of 2 branches missed.">    for (PropertyImpl p : sensor.getProperties()) {</span>
<span class="nc bnc" id="L3097" title="All 2 branches missed.">      if (p.getKey().equals(Labels.GENERATE_POWER)) {</span>
<span class="nc" id="L3098">        generatePower = Boolean.parseBoolean(p.getValue());</span>
      }
<span class="nc" id="L3100">    }</span>
<span class="fc" id="L3101">    session.getTransaction().commit();</span>
<span class="fc" id="L3102">    session.close();</span>
<span class="fc" id="L3103">    Double endVal = getValue(depotId, orgId, sensorId, end, gapSeconds, check);</span>
<span class="fc" id="L3104">    Double startVal = getValue(depotId, orgId, sensorId, start, gapSeconds, check);</span>
<span class="pc bpc" id="L3105" title="2 of 4 branches missed.">    if (endVal != null &amp;&amp; startVal != null) {</span>
<span class="fc" id="L3106">      Double returnVal = endVal - startVal;</span>
<span class="pc bpc" id="L3107" title="3 of 4 branches missed.">      if (returnVal &lt; 0 &amp;&amp; !generatePower) {</span>
<span class="nc" id="L3108">        Double max = Double.MIN_NORMAL;</span>
<span class="nc" id="L3109">        Double min = Double.MAX_VALUE;</span>
<span class="nc" id="L3110">        List&lt;Measurement&gt; measurements = getMeasurements(depotId, orgId, sensorId, start, end, false);</span>
<span class="nc bnc" id="L3111" title="All 2 branches missed.">        for (Measurement m : measurements) {</span>
<span class="nc" id="L3112">          Double value = m.getValue();</span>
<span class="nc bnc" id="L3113" title="All 2 branches missed.">          if (max &lt; value) {</span>
<span class="nc" id="L3114">            max = value;</span>
          }
<span class="nc bnc" id="L3116" title="All 2 branches missed.">          if (min &gt; value) {</span>
<span class="nc" id="L3117">            min = value;</span>
          }
<span class="nc" id="L3119">          returnVal = endVal - startVal + max - min;</span>
<span class="nc" id="L3120">        }</span>
      }
<span class="fc" id="L3122">      return returnVal;</span>
    }
<span class="nc" id="L3124">    return null;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.lang.Long)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date timestamp,
      Long gapSeconds, boolean check) throws NoMeasurementException, MeasurementGapException,
      IdNotFoundException {
<span class="pc bpc" id="L3137" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L3138">      getOrganization(orgId, check);</span>
<span class="fc" id="L3139">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L3140">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L3142">    Double ret = null;</span>
<span class="fc" id="L3143">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3144">    session.beginTransaction();</span>
<span class="fc" id="L3145">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L3146">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3148">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp = :time AND depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L3153" title="All 2 branches covered.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L3154">      ret = result.get(0).getValue();</span>
    }
    else {
      // need to get the stradle
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3159">      List&lt;MeasurementImpl&gt; before = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &lt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3165">      List&lt;MeasurementImpl&gt; after = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &gt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setMaxResults(1).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L3170">      MeasurementImpl justBefore = null;</span>
<span class="fc bfc" id="L3171" title="All 2 branches covered.">      for (MeasurementImpl b : before) {</span>
<span class="pc bpc" id="L3172" title="1 of 2 branches missed.">        if (b.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3173" title="1 of 2 branches missed.">          if (justBefore == null) {</span>
<span class="fc" id="L3174">            justBefore = b;</span>
          }
<span class="nc bnc" id="L3176" title="All 2 branches missed.">          else if (b.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3177">            justBefore = b;</span>
          }
        }
<span class="fc" id="L3180">      }</span>
<span class="fc bfc" id="L3181" title="All 2 branches covered.">      if (justBefore == null) {</span>
<span class="fc" id="L3182">        session.getTransaction().commit();</span>
<span class="fc" id="L3183">        session.close();</span>
<span class="fc" id="L3184">        throw new NoMeasurementException(&quot;Cannot find measurement before &quot; + timestamp + &quot; in &quot; + depot.getName() + &quot; for &quot; + sensor.getName());</span>
      }
<span class="fc" id="L3186">      MeasurementImpl justAfter = null;</span>
<span class="fc bfc" id="L3187" title="All 2 branches covered.">      for (MeasurementImpl a : after) {</span>
<span class="pc bpc" id="L3188" title="1 of 2 branches missed.">        if (a.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3189" title="1 of 2 branches missed.">          if (justAfter == null) {</span>
<span class="fc" id="L3190">            justAfter = a;</span>
          }
<span class="nc bnc" id="L3192" title="All 2 branches missed.">          else if (a.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3193">            justAfter = a;</span>
          }
        }
<span class="fc" id="L3196">      }</span>
<span class="fc bfc" id="L3197" title="All 2 branches covered.">      if (justAfter == null) {</span>
<span class="fc" id="L3198">        session.getTransaction().commit();</span>
<span class="fc" id="L3199">        session.close();</span>
<span class="fc" id="L3200">        throw new NoMeasurementException(&quot;Cannot find measurement after &quot; + timestamp + &quot; in &quot; + depot.getName() + &quot; for &quot; + sensor.getName());</span>
      }
<span class="fc" id="L3202">      Double val1 = justBefore.getValue();</span>
<span class="fc" id="L3203">      Double val2 = justAfter.getValue();</span>
<span class="fc" id="L3204">      Double deltaV = val2 - val1;</span>
<span class="fc" id="L3205">      Long t1 = justBefore.getTimestamp().getTime();</span>
<span class="fc" id="L3206">      Long t2 = justAfter.getTimestamp().getTime();</span>
<span class="fc" id="L3207">      Long deltaT = t2 - t1;</span>
<span class="fc bfc" id="L3208" title="All 2 branches covered.">      if ((deltaT / 1000) &gt; gapSeconds) {</span>
<span class="fc" id="L3209">        session.getTransaction().commit();</span>
<span class="fc" id="L3210">        session.close();</span>
<span class="fc" id="L3211">        throw new MeasurementGapException(&quot;Gap of &quot; + (deltaT / 1000) + &quot;s is longer than &quot;</span>
            + gapSeconds + &quot; for &quot; + sensor.getName() + &quot; in &quot; + depot.getName());
      }
<span class="fc" id="L3214">      Long t3 = timestamp.getTime();</span>
<span class="fc" id="L3215">      Long toDate = t3 - t1;</span>
<span class="fc" id="L3216">      Double slope = deltaV / deltaT;</span>
<span class="fc" id="L3217">      ret = val1 + slope * toDate;</span>
    }
<span class="fc" id="L3219">    session.getTransaction().commit();</span>
<span class="fc" id="L3220">    session.close();</span>
<span class="fc" id="L3221">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#listSensors(java.lang.String)
   */
  @Override
  public List&lt;String&gt; listSensors(String depotId, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L3233">    Long startTime = 0l;</span>
<span class="fc" id="L3234">    Long endTime = 0l;</span>
<span class="fc" id="L3235">    Long diff = 0l;</span>
<span class="pc bpc" id="L3236" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L3237">      timingLogger.log(Level.SEVERE, padding + &quot;Start listSensors(&quot; + depotId + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L3238">      padding += &quot;  &quot;;</span>
<span class="nc" id="L3239">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L3241" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L3242">      getOrganization(orgId, check);</span>
<span class="fc" id="L3243">      getDepository(depotId, orgId, check);</span>
    }
<span class="fc" id="L3245">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3246">    session.beginTransaction();</span>
<span class="fc" id="L3247">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
    // List&lt;SensorImpl&gt; result = (List&lt;SensorImpl&gt;) session
    // .createQuery(
    // &quot;select distinct meas.sensor FROM MeasurementImpl meas WHERE meas.depository = :depot&quot;)
    // .setParameter(&quot;depot&quot;, depot).list();
<span class="fc" id="L3253">    List&lt;DepositorySensorContribution&gt; result = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where depository = :depository&quot;)
        .setParameter(&quot;depository&quot;, depot).list();
<span class="fc" id="L3256">    ArrayList&lt;String&gt; sensorIds = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L3257" title="All 2 branches covered.">    for (DepositorySensorContribution contrib : result) {</span>
<span class="fc" id="L3258">      sensorIds.add(contrib.getSensor().getId());</span>
<span class="fc" id="L3259">    }</span>
    // for (SensorImpl sensor : result) {
    // if (!sensorIds.contains(sensor.getId())) {
    // sensorIds.add(sensor.getId());
    // }
    // }
<span class="fc" id="L3265">    session.getTransaction().commit();</span>
<span class="fc" id="L3266">    session.close();</span>
<span class="pc bpc" id="L3267" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L3268">      endTime = System.nanoTime();</span>
<span class="nc" id="L3269">      diff = endTime - startTime;</span>
<span class="nc" id="L3270">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L3271">      timingLogger.log(Level.SEVERE, padding + &quot;listSensors(&quot; + depotId + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L3274">    return sensorIds;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#putMeasurement(java.lang.String,
   * org.wattdepot.common.domainmodel.Measurement)
   */
  @Override
  public void putMeasurement(String depotId, String orgId, Measurement meas)
      throws MeasurementTypeException, IdNotFoundException {
<span class="fc" id="L3287">    getOrganization(orgId, true);</span>
<span class="fc" id="L3288">    Depository d = getDepository(depotId, orgId, true);</span>
<span class="pc bpc" id="L3289" title="1 of 2 branches missed.">    if (!meas.getMeasurementType().equals(d.getMeasurementType().getUnits())) {</span>
<span class="nc" id="L3290">      throw new MeasurementTypeException(&quot;Measurement's type &quot; + meas.getMeasurementType()</span>
          + &quot; does not match &quot; + d.getMeasurementType());
    }
<span class="fc" id="L3293">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3294">    session.beginTransaction();</span>
<span class="fc" id="L3295">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L3296">    SensorImpl sensor = retrieveSensor(session, meas.getSensorId(), orgId);</span>
<span class="fc" id="L3297">    DepositorySensorContribution contrib = retrieveContribution(session, depot, sensor);</span>
<span class="fc bfc" id="L3298" title="All 2 branches covered.">    if (contrib == null) {</span>
<span class="fc" id="L3299">      contrib = new DepositorySensorContribution();</span>
<span class="fc" id="L3300">      contrib.setDepository(depot);</span>
<span class="fc" id="L3301">      contrib.setSensor(sensor);</span>
<span class="fc" id="L3302">      session.saveOrUpdate(contrib);</span>
    }
<span class="fc" id="L3304">    MeasurementImpl impl = new MeasurementImpl();</span>
<span class="fc" id="L3305">    impl.setDepository(depot);</span>
<span class="fc" id="L3306">    impl.setSensor(sensor);</span>
<span class="fc" id="L3307">    impl.setId(meas.getId());</span>
<span class="fc" id="L3308">    impl.setTimestamp(meas.getDate());</span>
<span class="fc" id="L3309">    impl.setValue(meas.getValue());</span>
<span class="fc" id="L3310">    impl.setUnits(meas.getMeasurementType().toString());</span>
//    InterpolatedValue iv = new InterpolatedValue(sensor.getId(), meas.getValue(), d.getMeasurementType(), meas.getDate());
//    depotSensorInfo.update(orgId, depotId, meas.getSensorId(), iv);
<span class="fc" id="L3313">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3314">    session.getTransaction().commit();</span>
<span class="fc" id="L3315">    session.close();</span>
<span class="fc" id="L3316">  }</span>

  /*
 * (non-Javadoc)
 *
 * @see
 * org.wattdepot.server.WattDepotPersistence#putMeasurement(java.lang.String,
 * org.wattdepot.common.domainmodel.MeasurementList)
 */
  @Override
  public void putMeasurementList(String depotId, String orgId, MeasurementList measurementList)
      throws MeasurementTypeException, IdNotFoundException {
<span class="fc" id="L3328">    getOrganization(orgId, true);</span>
    //We just checked the organisation, no reason to do it again.

<span class="fc" id="L3331">    Depository d = getDepository(depotId, orgId, false);</span>

<span class="fc" id="L3333">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3334">    Transaction transaction = session.beginTransaction();</span>
<span class="fc" id="L3335">    OrganizationImpl organization = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3336">    DepositoryImpl depository = retrieveDepository(session, depotId, organization);</span>

    //Cache all sensors for organization in a map
<span class="fc" id="L3339">    List&lt;SensorImpl&gt; sensors = retrieveSensors(session, organization);</span>
<span class="fc" id="L3340">    Map&lt;String, SensorImpl&gt; sensorMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L3341" title="All 2 branches covered.">    for (SensorImpl sensor : sensors) {</span>
<span class="fc" id="L3342">      sensorMap.put(sensor.getId(), sensor);</span>
<span class="fc" id="L3343">    }</span>

    //Cache all depository sensor contributions for this depository
<span class="fc" id="L3346">    List&lt;DepositorySensorContribution&gt; depositorySensorContributions = retrieveContributions(</span>
        session, depository);
<span class="fc" id="L3348">    Map&lt;String, DepositorySensorContribution&gt; depositorySensorContributionsMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L3349" title="All 2 branches covered.">    for (DepositorySensorContribution depositorySensorContribution : depositorySensorContributions) {</span>
<span class="fc" id="L3350">      depositorySensorContributionsMap.put(depositorySensorContribution.getSensor().getId(), depositorySensorContribution);</span>
<span class="fc" id="L3351">    }</span>

<span class="fc bfc" id="L3353" title="All 2 branches covered.">    for (int i = 0; i &lt;  measurementList.getMeasurements().size(); i++) {</span>
    //for (Measurement measurement : measurementList.getMeasurements()) {
<span class="fc" id="L3355">      Measurement measurement = measurementList.getMeasurements().get(i);</span>
<span class="pc bpc" id="L3356" title="1 of 2 branches missed.">      if (!measurement.getMeasurementType().equals(d.getMeasurementType().getUnits())) {</span>
<span class="nc" id="L3357">        throw new MeasurementTypeException(&quot;Measurement's type &quot; + measurement.getMeasurementType()</span>
            + &quot; does not match &quot; + d.getMeasurementType());
      }
<span class="fc" id="L3360">      SensorImpl sensor = sensorMap.get(measurement.getSensorId());</span>
<span class="fc" id="L3361">      DepositorySensorContribution contrib = depositorySensorContributionsMap.get(sensor.getId());</span>
<span class="pc bpc" id="L3362" title="1 of 2 branches missed.">      if (contrib == null) {</span>
<span class="nc" id="L3363">        contrib = new DepositorySensorContribution();</span>
<span class="nc" id="L3364">        contrib.setDepository(depository);</span>
<span class="nc" id="L3365">        contrib.setSensor(sensor);</span>
<span class="nc" id="L3366">        session.saveOrUpdate(contrib);</span>
<span class="nc" id="L3367">        depositorySensorContributionsMap.put(sensor.getId(), contrib);</span>
      }
<span class="fc" id="L3369">      MeasurementImpl impl = new MeasurementImpl();</span>
<span class="fc" id="L3370">      impl.setDepository(depository);</span>
<span class="fc" id="L3371">      impl.setSensor(sensor);</span>
<span class="fc" id="L3372">      impl.setId(measurement.getId());</span>
<span class="fc" id="L3373">      impl.setTimestamp(measurement.getDate());</span>
<span class="fc" id="L3374">      impl.setValue(measurement.getValue());</span>
<span class="fc" id="L3375">      impl.setUnits(measurement.getMeasurementType().toString());</span>
<span class="fc" id="L3376">      session.saveOrUpdate(impl);</span>
<span class="fc bfc" id="L3377" title="All 2 branches covered.">      if ( i % 50 == 0 ) { //50, same as the JDBC batch size</span>
        //flush a batch of inserts and release memory:
<span class="fc" id="L3379">        session.flush();</span>
<span class="fc" id="L3380">        session.clear();</span>
      }
    }
<span class="fc" id="L3383">    transaction.commit();</span>
<span class="fc" id="L3384">    session.close();</span>
<span class="fc" id="L3385">  }</span>

  /**
   * @param session The session with an open transaction.
   * @param id The CollectorProcessDefinition's id.
   * @param orgId The owner Organization's id.
   * @return the CollectorProcessDefinition if defined.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private CollectorProcessDefinitionImpl retrieveCollectorProcessDefinition(Session session,
      String id, String orgId) {
<span class="fc" id="L3396">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3397">    List&lt;CollectorProcessDefinitionImpl&gt; cpds = (List&lt;CollectorProcessDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM CollectorProcessDefinitionImpl WHERE id = :id AND org = :org&quot;)
        .setParameter(&quot;id&quot;, id).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3400" title="All 2 branches covered.">    if (cpds.size() == 1) {</span>
<span class="fc" id="L3401">      return cpds.get(0);</span>
    }
    else {
<span class="fc" id="L3404">      return null;</span>
    }
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return a List of CollectorProcessDefinitions owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;CollectorProcessDefinitionImpl&gt; retrieveCollectorProcessDefinitions(Session session,
      String orgId) {
<span class="fc" id="L3416">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3417">    List&lt;CollectorProcessDefinitionImpl&gt; ret = (List&lt;CollectorProcessDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM CollectorProcessDefinitionImpl WHERE org = :org&quot;)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3420">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param depo The Depository.
   * @param sensor The Sensor.
   * @return The DepositorySensorContribution if the sensor has contributed
   *         measurements to the depository, or null.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositorySensorContribution retrieveContribution(Session session, DepositoryImpl depo,
      SensorImpl sensor) {
<span class="fc" id="L3433">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(
            &quot;from DepositorySensorContribution where sensor = :sensor and depository = :depository&quot;)
        .setParameter(&quot;sensor&quot;, sensor).setParameter(&quot;depository&quot;, depo).list();
<span class="fc bfc" id="L3437" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3438">      return ret.get(0);</span>
    }
<span class="fc" id="L3440">    return null;</span>
  }

  /**
   * @param session A session with an open transaction.
   * @param depository The depository to search for.
   * @return A List of DepositorySensorContributions for the given depository.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositorySensorContribution&gt; retrieveContributions(Session session,
      DepositoryImpl depository) {
<span class="fc" id="L3451">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where depository = :depository&quot;)
        .setParameter(&quot;depository&quot;, depository).list();
<span class="fc" id="L3454">    return ret;</span>
  }

  /**
   * @param session A session with an open transaction.
   * @param sensor The sensor to search for.
   * @return A List of DepositorySensorContributions for the given sensor.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositorySensorContribution&gt; retrieveContributions(Session session,
      SensorImpl sensor) {
<span class="fc" id="L3465">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where sensor = :sensor&quot;)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L3468">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param type The measurement type of the depository.
   * @return A List of all the depositories with the given measurment type.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositoryImpl&gt; retrieveDepositories(Session session, MeasurementTypeImpl type) {
<span class="fc" id="L3478">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE type = :type&quot;).setParameter(&quot;type&quot;, type).list();
<span class="fc" id="L3480">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositoryImpl&gt; retrieveDepositories(Session session, String orgId) {
<span class="fc" id="L3490">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3491">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3493">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Depository's id.
   * @param orgId The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositoryImpl retrieveDepository(Session session, String id, String orgId) {
<span class="fc" id="L3504">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3505">    return retrieveDepository(session, id, org);</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Depository's id.
   * @param org The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositoryImpl retrieveDepository(Session session, String id, OrganizationImpl org) {
<span class="fc" id="L3516">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3519" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3520">      return ret.get(0);</span>
    }
<span class="fc" id="L3522">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the MeasurementPruningDefinition's id.
   * @param orgId The Organization's id.
   * @return The MeasurementPruningDefinitionImpl or null if not defined.
   */
  private MeasurementPruningDefinitionImpl retrieveMeasurementPruningDefinition(Session session,
      String id, String orgId) {
<span class="fc" id="L3533">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3535">    List&lt;MeasurementPruningDefinitionImpl&gt; result = (List&lt;MeasurementPruningDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementPruningDefinitionImpl WHERE id = :id AND org = :org&quot;)
        .setParameter(&quot;id&quot;, id).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3538" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3539">      return result.get(0);</span>
    }
<span class="fc" id="L3541">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The Organization's id.
   * @return A list of the defined MeasurementPruningDefinitionImpls.
   */
  private List&lt;MeasurementPruningDefinitionImpl&gt; retrieveMeasurementPruningDefinitions(
      Session session, String orgId) {
<span class="fc" id="L3551">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3553">    List&lt;MeasurementPruningDefinitionImpl&gt; result = (List&lt;MeasurementPruningDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementPruningDefinitionImpl WHERE org = :org&quot;)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3556">    return result;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param depotId the id of the Depository.
   * @param orgId the organization's id.
   * @param measId the measurement's id.
   * @return the MeasurementImpl.
   */
  private MeasurementImpl retrieveMeasurement(Session session, String depotId, String orgId,
      String measId) {
<span class="fc" id="L3568">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3570">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depository AND id = :id&quot;)
        .setParameter(&quot;depository&quot;, depot).setParameter(&quot;id&quot;, measId).list();
<span class="fc bfc" id="L3573" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3574">      return result.get(0);</span>
    }
<span class="fc" id="L3576">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @param id The id of the MeasurementType.
   * @return The MeasurementType with the given id.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private MeasurementTypeImpl retrieveMeasurementType(Session session, String id) {
<span class="fc" id="L3586">    List&lt;MeasurementTypeImpl&gt; ret = (List&lt;MeasurementTypeImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementTypeImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3588" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3589">      return ret.get(0);</span>
    }
<span class="fc" id="L3591">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @return The list of defined MeasurementTypes.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;MeasurementTypeImpl&gt; retrieveMeasurementTypes(Session session) {
<span class="fc" id="L3600">    List&lt;MeasurementTypeImpl&gt; ret = (List&lt;MeasurementTypeImpl&gt;) session.createQuery(</span>
        &quot;FROM MeasurementTypeImpl&quot;).list();
<span class="fc" id="L3602">    return ret;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @param id The id of the Organization.
   * @return The Organization with the given id.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private OrganizationImpl retrieveOrganization(Session session, String id) {
<span class="fc" id="L3612">    List&lt;OrganizationImpl&gt; ret = (List&lt;OrganizationImpl&gt;) session</span>
        .createQuery(&quot;from OrganizationImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3614" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3615">      return ret.get(0);</span>
    }
<span class="fc" id="L3617">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @return The List of defined Organizations.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;OrganizationImpl&gt; retrieveOrganizations(Session session) {
<span class="fc" id="L3626">    List&lt;OrganizationImpl&gt; ret = (List&lt;OrganizationImpl&gt;) session.createQuery(</span>
        &quot;from OrganizationImpl&quot;).list();
<span class="fc" id="L3628">    return ret;</span>

  }

  /**
   * @param session The session with an open transaction.
   * @param id the Sensor's id.
   * @param orgId The owner's Organization id.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorImpl retrieveSensor(Session session, String id, String orgId) {
<span class="fc" id="L3640">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3641">    return retrieveSensor(session, id, org);</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Sensor's id.
   * @param org The owner's OrganizationImpl.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorImpl retrieveSensor(Session session, String id, OrganizationImpl org) {
<span class="fc" id="L3652">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3655" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3656">      return ret.get(0);</span>
    }
<span class="fc" id="L3658">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param org The owner's OrganizationImpl.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorImpl&gt; retrieveSensors(Session session, OrganizationImpl org) {
<span class="fc" id="L3668">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;,
            org).list();
<span class="fc" id="L3671">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the SensorGroup's id.
   * @param orgId The owner's Organization id.
   * @return The SensorGroup with the given id, owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorGroupImpl retrieveSensorGroup(Session session, String id, String orgId) {
<span class="fc" id="L3682">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3683">    List&lt;SensorGroupImpl&gt; result = (List&lt;SensorGroupImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorGroupImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3686" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3687">      return result.get(0);</span>
    }
<span class="fc" id="L3689">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return a List of the SensorGroups owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorGroupImpl&gt; retrieveSensorGroups(Session session, String orgId) {
<span class="fc" id="L3699">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3700">    List&lt;SensorGroupImpl&gt; result = (List&lt;SensorGroupImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorGroupImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3702">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param id the id of the SensorModel to retrieve.
   * @return A List of the SensorModels owned by the orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorModelImpl retrieveSensorModel(Session session, String id) {
<span class="fc" id="L3712">    List&lt;SensorModelImpl&gt; result = (List&lt;SensorModelImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorModelImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3714" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3715">      return result.get(0);</span>
    }
<span class="fc" id="L3717">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @return A List of the SensorModels owned by the orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorModelImpl&gt; retrieveSensorModels(Session session) {
<span class="fc" id="L3726">    List&lt;SensorModelImpl&gt; ret = (List&lt;SensorModelImpl&gt;) session.createQuery(&quot;FROM SensorModelImpl&quot;)</span>
        .list();
<span class="fc" id="L3728">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return A List of the Sensors owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorImpl&gt; retrieveSensors(Session session, String orgId) {
<span class="fc" id="L3738">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3739">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3741">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param uid the User's id.
   * @param orgId the Organziation's id.
   * @return the UserInfoImpl.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private UserInfoImpl retrieveUser(Session session, String uid, String orgId) {
<span class="fc" id="L3752">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3753">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session</span>
        .createQuery(&quot;FROM UserInfoImpl WHERE uid = :uid AND org = :org&quot;).setParameter(&quot;uid&quot;, uid)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3756" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3757">      return result.get(0);</span>
    }
<span class="fc" id="L3759">    return null;</span>

  }

  /**
   * @param session The Session with an open transaction.
   * @param id the user's id.
   * @param orgId the organization's id.
   * @return the UserPasswordImpl.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private UserPasswordImpl retrieveUserPassword(Session session, String id, String orgId) {
<span class="fc" id="L3771">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3772">    UserInfoImpl user = retrieveUser(session, id, orgId);</span>
<span class="fc" id="L3773">    List&lt;UserPasswordImpl&gt; result = (List&lt;UserPasswordImpl&gt;) session</span>
        .createQuery(&quot;FROM UserPasswordImpl WHERE user = :user AND org = :org&quot;)
        .setParameter(&quot;user&quot;, user).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3776" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3777">      return result.get(0);</span>
    }
<span class="fc" id="L3779">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The organization id.
   * @return a List of the user passwords in the given organization.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserPasswordImpl&gt; retrieveUserPasswords(Session session, String orgId) {
<span class="fc" id="L3789">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3790">    List&lt;UserPasswordImpl&gt; result = (List&lt;UserPasswordImpl&gt;) session</span>
        .createQuery(&quot;FROM UserPasswordImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3792">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @return A List of all the defined users.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserInfoImpl&gt; retrieveUsers(Session session) {
<span class="fc" id="L3801">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session.createQuery(&quot;FROM UserInfoImpl&quot;)</span>
        .list();
<span class="fc" id="L3803">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The organization id.
   * @return a List of the users in the given organization.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserInfoImpl&gt; retrieveUsers(Session session, String orgId) {
<span class="fc" id="L3813">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3814">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session</span>
        .createQuery(&quot;FROM UserInfoImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3816">    return result;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#stop()
   */
  @Override
  public void stop() {
<span class="fc" id="L3826">    Manager.closeSession();</span>
<span class="fc" id="L3827">  }</span>

  /**
   * Use this method after beginning a transaction.
   * 
   * @param session The Session, a transaction must be in progress.
   * @param cpd The CollectorProcessDefinitionImpl to save.
   */
  private void storeCollectorProcessDefinition(Session session, CollectorProcessDefinitionImpl cpd) {
<span class="pc bpc" id="L3836" title="1 of 2 branches missed.">    for (PropertyImpl p : cpd.getProperties()) {</span>
<span class="nc" id="L3837">      session.saveOrUpdate(p);</span>
<span class="nc" id="L3838">    }</span>
<span class="fc" id="L3839">    session.saveOrUpdate(cpd);</span>

<span class="fc" id="L3841">  }</span>

  /**
   * Use this method after beginning a transaction.
   * 
   * @param session The Session, a transaction must be in progress.
   * @param sensor The SensorImpl to save.
   */
  private void storeSensor(Session session, SensorImpl sensor) {
<span class="pc bpc" id="L3850" title="1 of 2 branches missed.">    for (PropertyImpl p : sensor.getProperties()) {</span>
<span class="nc" id="L3851">      session.saveOrUpdate(p);</span>
<span class="nc" id="L3852">    }</span>
<span class="fc" id="L3853">    session.saveOrUpdate(sensor);</span>
<span class="fc" id="L3854">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateCollectorProcessDefinition(org.wattdepot
   * . datamodel .CollectorProcessDefinition)
   */
  @Override
  public CollectorProcessDefinition updateCollectorProcessDefinition(
      CollectorProcessDefinition process) throws IdNotFoundException {
<span class="fc" id="L3866">    getCollectorProcessDefinition(process.getId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3867">    getDepository(process.getDepositoryId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3868">    getSensor(process.getSensorId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3869">    CollectorProcessDefinition ret = null;</span>
<span class="fc" id="L3870">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3871">    sessionOpen++;</span>
<span class="fc" id="L3872">    session.beginTransaction();</span>
<span class="fc" id="L3873">    CollectorProcessDefinitionImpl impl = retrieveCollectorProcessDefinition(session,</span>
        process.getId(), process.getOrganizationId());
<span class="fc" id="L3875">    impl.setId(process.getId());</span>
<span class="fc" id="L3876">    impl.setName(process.getName());</span>
<span class="fc" id="L3877">    impl.setPollingInterval(process.getPollingInterval());</span>
<span class="fc" id="L3878">    impl.setDepository(retrieveDepository(session, process.getDepositoryId(),</span>
        process.getOrganizationId()));
<span class="fc" id="L3880">    impl.setSensor(retrieveSensor(session, process.getSensorId(), process.getOrganizationId()));</span>
<span class="fc" id="L3881">    impl.setOrg(retrieveOrganization(session, process.getOrganizationId()));</span>
<span class="fc" id="L3882">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L3883" title="1 of 2 branches missed.">    for (Property p : process.getProperties()) {</span>
<span class="nc" id="L3884">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L3885">    }</span>
<span class="fc" id="L3886">    impl.setProperties(props);</span>
<span class="fc" id="L3887">    storeCollectorProcessDefinition(session, impl);</span>
<span class="fc" id="L3888">    ret = impl.toCPD();</span>
<span class="fc" id="L3889">    session.getTransaction().commit();</span>
<span class="fc" id="L3890">    session.close();</span>
<span class="fc" id="L3891">    sessionClose++;</span>
<span class="fc" id="L3892">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#updateMeasurementPruningDefinition
   * (org.wattdepot.common.domainmodel.MeasurementPruningDefinition)
   */
  @Override
  public MeasurementPruningDefinition updateMeasurementPruningDefinition(
      MeasurementPruningDefinition gcd) throws IdNotFoundException {
<span class="fc" id="L3905">    getMeasurementPruningDefinition(gcd.getId(), gcd.getOrganizationId(), true);</span>
<span class="fc" id="L3906">    getDepository(gcd.getDepositoryId(), gcd.getOrganizationId(), true);</span>
<span class="fc" id="L3907">    MeasurementPruningDefinition ret = null;</span>
<span class="fc" id="L3908">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3909">    sessionOpen++;</span>
<span class="fc" id="L3910">    session.beginTransaction();</span>
<span class="fc" id="L3911">    MeasurementPruningDefinitionImpl impl = retrieveMeasurementPruningDefinition(session,</span>
        gcd.getId(), gcd.getOrganizationId());
<span class="fc" id="L3913">    impl.setName(gcd.getName());</span>
<span class="fc" id="L3914">    impl.setDepository(retrieveDepository(session, gcd.getDepositoryId(), gcd.getOrganizationId()));</span>
<span class="fc" id="L3915">    impl.setSensor(gcd.getSensorId());</span>
<span class="fc" id="L3916">    impl.setIgnoreWindowDays(gcd.getIgnoreWindowDays());</span>
<span class="fc" id="L3917">    impl.setCollectWindowDays(gcd.getCollectWindowDays());</span>
<span class="fc" id="L3918">    impl.setMinGapSeconds(gcd.getMinGapSeconds());</span>
<span class="fc" id="L3919">    impl.setLastStarted(gcd.getLastStarted());</span>
<span class="fc" id="L3920">    impl.setLastCompleted(gcd.getLastCompleted());</span>
<span class="fc" id="L3921">    impl.setNumMeasurementsCollected(gcd.getNumMeasurementsCollected());</span>
<span class="fc" id="L3922">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3923">    ret = impl.toMPD();</span>
<span class="fc" id="L3924">    session.getTransaction().commit();</span>
<span class="fc" id="L3925">    session.close();</span>
<span class="fc" id="L3926">    sessionClose++;</span>
<span class="fc" id="L3927">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateMeasurementType(org.wattdepot.datamodel
   * .MeasurementType)
   */
  @Override
  public MeasurementType updateMeasurementType(MeasurementType type) {
<span class="fc" id="L3939">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3940">    sessionOpen++;</span>
<span class="fc" id="L3941">    session.beginTransaction();</span>
<span class="fc" id="L3942">    MeasurementTypeImpl impl = retrieveMeasurementType(session, type.getId());</span>
<span class="fc" id="L3943">    impl.setName(type.getName());</span>
<span class="fc" id="L3944">    impl.setUnits(type.getUnits());</span>
<span class="fc" id="L3945">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3946">    session.getTransaction().commit();</span>
<span class="fc" id="L3947">    session.close();</span>
<span class="fc" id="L3948">    sessionClose++;</span>

<span class="fc" id="L3950">    return type;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateOrganization(org.wattdepot.datamodel
   * .Organization)
   */
  @Override
  public Organization updateOrganization(Organization org) throws IdNotFoundException {
<span class="fc" id="L3962">    getOrganization(org.getId(), true);</span>
<span class="fc bfc" id="L3963" title="All 2 branches covered.">    for (String s : org.getUsers()) {</span>
<span class="fc" id="L3964">      getUser(s, org.getId(), true);</span>
<span class="fc" id="L3965">    }</span>
<span class="fc" id="L3966">    Organization ret = null;</span>
<span class="fc" id="L3967">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3968">    sessionOpen++;</span>
<span class="fc" id="L3969">    session.beginTransaction();</span>
<span class="fc" id="L3970">    OrganizationImpl impl = retrieveOrganization(session, org.getId());</span>
<span class="fc" id="L3971">    impl.setId(org.getId());</span>
<span class="fc" id="L3972">    impl.setName(org.getName());</span>
<span class="fc bfc" id="L3973" title="All 2 branches covered.">    for (String s : org.getUsers()) {</span>
<span class="fc" id="L3974">      UserInfoImpl u = retrieveUser(session, s, org.getId());</span>
<span class="pc bpc" id="L3975" title="1 of 2 branches missed.">      if (u != null) {</span>
<span class="fc" id="L3976">        impl.getUsers().add(u);</span>
      }
<span class="fc" id="L3978">    }</span>
<span class="fc" id="L3979">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3980">    ret = impl.toOrganization();</span>
<span class="fc" id="L3981">    session.getTransaction().commit();</span>
<span class="fc" id="L3982">    session.close();</span>
<span class="fc" id="L3983">    sessionClose++;</span>
<span class="fc" id="L3984">    cache.putOrganization(ret);</span>
<span class="fc" id="L3985">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensor(org.wattdepot.datamodel.Sensor
   * )
   */
  @Override
  public Sensor updateSensor(Sensor sensor) throws IdNotFoundException {
<span class="fc" id="L3997">    getOrganization(sensor.getOrganizationId(), true);</span>
<span class="fc" id="L3998">    getSensorModel(sensor.getModelId(), true);</span>
<span class="fc" id="L3999">    Sensor ret = null;</span>
<span class="fc" id="L4000">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L4001">    sessionOpen++;</span>
<span class="fc" id="L4002">    session.beginTransaction();</span>
<span class="fc" id="L4003">    SensorImpl impl = retrieveSensor(session, sensor.getId(), sensor.getOrganizationId());</span>
<span class="fc" id="L4004">    impl.setId(sensor.getId());</span>
<span class="fc" id="L4005">    impl.setName(sensor.getName());</span>
<span class="fc" id="L4006">    impl.setOrg(retrieveOrganization(session, sensor.getOrganizationId()));</span>
<span class="fc" id="L4007">    impl.setModel(retrieveSensorModel(session, sensor.getModelId()));</span>
<span class="fc" id="L4008">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L4009" title="1 of 2 branches missed.">    for (Property p : sensor.getProperties()) {</span>
<span class="nc" id="L4010">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L4011">    }</span>
<span class="fc" id="L4012">    impl.setProperties(props);</span>
<span class="fc" id="L4013">    storeSensor(session, impl);</span>
<span class="fc" id="L4014">    ret = impl.toSensor();</span>
<span class="fc" id="L4015">    session.getTransaction().commit();</span>
<span class="fc" id="L4016">    session.close();</span>
<span class="fc" id="L4017">    sessionClose++;</span>
<span class="fc" id="L4018">    cache.putSensor(ret);</span>
<span class="fc" id="L4019">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensorGroup(org.wattdepot.datamodel
   * .SensorGroup)
   */
  @Override
  public SensorGroup updateSensorGroup(SensorGroup group) throws IdNotFoundException {
<span class="fc" id="L4031">    getOrganization(group.getOrganizationId(), true);</span>
<span class="fc" id="L4032">    getSensorGroup(group.getId(), group.getOrganizationId(), true);</span>
    // validate the list of sensor ids.
<span class="fc bfc" id="L4034" title="All 2 branches covered.">    for (String id : group.getSensors()) {</span>
<span class="fc" id="L4035">      getSensor(id, group.getOrganizationId(), true);</span>
<span class="fc" id="L4036">    }</span>
<span class="fc" id="L4037">    SensorGroup ret = null;</span>
<span class="fc" id="L4038">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L4039">    sessionOpen++;</span>
<span class="fc" id="L4040">    session.beginTransaction();</span>
<span class="fc" id="L4041">    OrganizationImpl org = retrieveOrganization(session, group.getOrganizationId());</span>
<span class="fc" id="L4042">    SensorGroupImpl impl = retrieveSensorGroup(session, group.getId(), group.getOrganizationId());</span>
<span class="fc" id="L4043">    impl.setId(group.getId());</span>
<span class="fc" id="L4044">    impl.setName(group.getName());</span>
<span class="fc" id="L4045">    impl.setOrg(org);</span>
<span class="fc" id="L4046">    Set&lt;SensorImpl&gt; sensors = new HashSet&lt;SensorImpl&gt;();</span>
<span class="fc bfc" id="L4047" title="All 2 branches covered.">    for (String s : group.getSensors()) {</span>
<span class="fc" id="L4048">      sensors.add(retrieveSensor(session, s, group.getOrganizationId()));</span>
<span class="fc" id="L4049">    }</span>
<span class="fc" id="L4050">    impl.setSensors(sensors);</span>
<span class="fc" id="L4051">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L4052">    ret = impl.toSensorGroup();</span>
<span class="fc" id="L4053">    session.getTransaction().commit();</span>
<span class="fc" id="L4054">    session.close();</span>
<span class="fc" id="L4055">    sessionClose++;</span>
<span class="fc" id="L4056">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensorModel(org.wattdepot.datamodel
   * .SensorModel)
   */
  @Override
  public SensorModel updateSensorModel(SensorModel model) throws IdNotFoundException {
<span class="fc" id="L4068">    getSensorModel(model.getId(), true);</span>
<span class="fc" id="L4069">    SensorModel ret = null;</span>
<span class="fc" id="L4070">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L4071">    sessionOpen++;</span>
<span class="fc" id="L4072">    session.beginTransaction();</span>
<span class="fc" id="L4073">    SensorModelImpl impl = retrieveSensorModel(session, model.getId());</span>
<span class="fc" id="L4074">    impl.setName(model.getName());</span>
<span class="fc" id="L4075">    impl.setProtocol(model.getProtocol());</span>
<span class="fc" id="L4076">    impl.setId(model.getId());</span>
<span class="fc" id="L4077">    impl.setType(model.getType());</span>
<span class="fc" id="L4078">    impl.setVersion(model.getVersion());</span>
<span class="fc" id="L4079">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L4080">    ret = impl.toSensorModel();</span>
<span class="fc" id="L4081">    session.getTransaction().commit();</span>
<span class="fc" id="L4082">    session.close();</span>
<span class="fc" id="L4083">    sessionClose++;</span>
<span class="fc" id="L4084">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#updateUserInfo(org.wattdepot.datamodel
   * .UserInfo)
   */
  @Override
  public UserInfo updateUserInfo(UserInfo user) throws IdNotFoundException {
<span class="fc" id="L4095">    getUser(user.getUid(), user.getOrganizationId(), true);</span>
<span class="fc" id="L4096">    UserInfo ret = null;</span>
<span class="fc" id="L4097">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L4098">    sessionOpen++;</span>
<span class="fc" id="L4099">    session.beginTransaction();</span>
<span class="fc" id="L4100">    OrganizationImpl orgImpl = retrieveOrganization(session, user.getOrganizationId());</span>
<span class="fc" id="L4101">    UserInfoImpl impl = retrieveUser(session, user.getUid(), user.getOrganizationId());</span>
<span class="fc" id="L4102">    impl.setUid(user.getUid());</span>
<span class="fc" id="L4103">    impl.setFirstName(user.getFirstName());</span>
<span class="fc" id="L4104">    impl.setLastName(user.getLastName());</span>
<span class="fc" id="L4105">    impl.setEmail(user.getEmail());</span>
<span class="fc" id="L4106">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="fc bfc" id="L4107" title="All 2 branches covered.">    for (Property p : user.getProperties()) {</span>
<span class="fc" id="L4108">      PropertyImpl pi = new PropertyImpl(p);</span>
<span class="fc" id="L4109">      props.add(pi);</span>
<span class="fc" id="L4110">      session.saveOrUpdate(pi);</span>
<span class="fc" id="L4111">    }</span>
<span class="fc" id="L4112">    impl.setProperties(props);</span>
<span class="fc" id="L4113">    impl.setOrg(orgImpl);</span>
<span class="fc" id="L4114">    session.saveOrUpdate(orgImpl);</span>
<span class="fc" id="L4115">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L4116">    ret = impl.toUserInfo();</span>
<span class="fc" id="L4117">    session.getTransaction().commit();</span>
<span class="fc" id="L4118">    session.close();</span>
<span class="fc" id="L4119">    sessionClose++;</span>
<span class="fc" id="L4120">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateUserPassword(org.wattdepot.datamodel
   * .UserPassword)
   */
  @Override
  public UserPassword updateUserPassword(UserPassword password) throws IdNotFoundException {
<span class="fc" id="L4132">    UserPassword ret = null;</span>
<span class="fc" id="L4133">    getUserPassword(password.getUid(), password.getOrganizationId(), true);</span>
<span class="fc" id="L4134">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L4135">    sessionOpen++;</span>
<span class="fc" id="L4136">    session.beginTransaction();</span>
<span class="fc" id="L4137">    UserPasswordImpl impl = retrieveUserPassword(session, password.getUid(),</span>
        password.getOrganizationId());
<span class="fc" id="L4139">    impl.setEncryptedPassword(password.getEncryptedPassword());</span>
<span class="fc" id="L4140">    impl.setOrg(retrieveOrganization(session, password.getOrganizationId()));</span>
<span class="fc" id="L4141">    impl.setUser(retrieveUser(session, password.getUid(), password.getOrganizationId()));</span>
<span class="fc" id="L4142">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L4143">    ret = impl.toUserPassword();</span>
<span class="fc" id="L4144">    session.getTransaction().commit();</span>
<span class="fc" id="L4145">    session.close();</span>
<span class="fc" id="L4146">    sessionClose++;</span>
<span class="fc" id="L4147">    return ret;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>