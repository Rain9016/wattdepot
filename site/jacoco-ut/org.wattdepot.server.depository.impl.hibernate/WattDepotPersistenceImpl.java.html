<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WattDepotPersistenceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.html" class="el_package">org.wattdepot.server.depository.impl.hibernate</a> &gt; <span class="el_source">WattDepotPersistenceImpl.java</span></div><h1>WattDepotPersistenceImpl.java</h1><pre class="source lang-java linenums">/**
 * WattDepotImpl.java This file is part of WattDepot.
 *
 * Copyright (C) 2013  Cam Moore
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.wattdepot.server.depository.impl.hibernate;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.xml.datatype.XMLGregorianCalendar;

import org.hibernate.Session;
import org.wattdepot.common.domainmodel.CollectorProcessDefinition;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.MeasurementPruningDefinition;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.Measurement;
import org.wattdepot.common.domainmodel.MeasurementRateSummary;
import org.wattdepot.common.domainmodel.MeasurementType;
import org.wattdepot.common.domainmodel.Organization;
import org.wattdepot.common.domainmodel.Property;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorGroup;
import org.wattdepot.common.domainmodel.SensorMeasurementSummary;
import org.wattdepot.common.domainmodel.SensorModel;
import org.wattdepot.common.domainmodel.UserInfo;
import org.wattdepot.common.domainmodel.UserPassword;
import org.wattdepot.common.exception.BadSlugException;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.MeasurementGapException;
import org.wattdepot.common.exception.MeasurementTypeException;
import org.wattdepot.common.exception.MisMatchedOwnerException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.exception.UniqueIdException;
import org.wattdepot.common.util.DateConvert;
import org.wattdepot.common.util.SensorModelHelper;
import org.wattdepot.common.util.Slug;
import org.wattdepot.common.util.tstamp.Tstamp;
import org.wattdepot.server.ServerProperties;
import org.wattdepot.server.StrongAES;
import org.wattdepot.server.WattDepotPersistence;

/**
 * WattDepotImpl - Hibernate implementation of the WattDepot abstract class.
 * 
 * @author Cam Moore
 * 
 */
public class WattDepotPersistenceImpl extends WattDepotPersistence {

  private boolean checkSession;
<span class="fc" id="L71">  private int sessionOpen = 0;</span>
<span class="fc" id="L72">  private int sessionClose = 0;</span>

  private boolean timingp;
  private Logger timingLogger;
<span class="fc" id="L76">  private String padding = &quot;&quot;;</span>
  private PersistenceCache cache;

  /**
   * Creates a new WattDepotImpl instance with the given ServerProperties.
   * 
   * @param properties The ServerProperties.
   */
  public WattDepotPersistenceImpl(ServerProperties properties) {
<span class="fc" id="L85">    super();</span>
<span class="fc" id="L86">    this.cache = new PersistenceCache();</span>
    // try {
    // Session validate = Manager.getValidateFactory(properties).openSession();
    // validate.close();
    // }
    // catch (HibernateException e) { // NOPMD
    // // e.printStackTrace();
    // // might be able to just use the 'update' sessionFactory.
    // // Session create = Manager.getCreateFactory(properties).openSession();
    // // create.close();
    // }
<span class="fc" id="L97">    setServerProperties(properties);</span>
<span class="fc" id="L98">    this.checkSession = properties.get(ServerProperties.CHECK_SESSIONS).equals(&quot;true&quot;);</span>
<span class="fc" id="L99">    timingp = properties.get(ServerProperties.SERVER_TIMING_KEY).equals(ServerProperties.TRUE);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L101">      this.timingLogger = Logger.getLogger(getClass().getName());</span>
    }
    // Start with the Organizations
<span class="fc" id="L104">    Organization pub = null;</span>
    try {
<span class="fc" id="L106">      pub = getOrganization(Organization.PUBLIC_GROUP.getId(), false);</span>
    }
<span class="nc" id="L108">    catch (IdNotFoundException e1) { // NOPMD</span>
      // this is ok. We may need to create the Organization.
<span class="fc" id="L110">    }</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">    if (pub == null) {</span>
      try {
<span class="nc" id="L113">        defineOrganization(Organization.PUBLIC_GROUP.getId(), Organization.PUBLIC_GROUP.getName(),</span>
            new HashSet&lt;String&gt;());
<span class="nc bnc" id="L115" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L116">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L119">      catch (UniqueIdException e) {</span>
        // what do we do here?
<span class="nc" id="L121">        e.printStackTrace();</span>
      }
<span class="nc" id="L123">      catch (BadSlugException e) {</span>
        // what do we do here?
<span class="nc" id="L125">        e.printStackTrace();</span>
      }
<span class="nc" id="L127">      catch (IdNotFoundException e) {</span>
        // What do we do here?
<span class="nc" id="L129">        e.printStackTrace();</span>
<span class="nc" id="L130">      }</span>
    }
    else {
      try {
<span class="fc" id="L134">        updateOrganization(pub);</span>
      }
<span class="nc" id="L136">      catch (IdNotFoundException e) {</span>
        // Should not happen.
<span class="nc" id="L138">        e.printStackTrace();</span>
<span class="fc" id="L139">      }</span>
<span class="pc bpc" id="L140" title="3 of 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L141">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="pc bpc" id="L144" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L145">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="fc" id="L147">    Organization admin = null;</span>
    try {
<span class="fc" id="L149">      admin = getOrganization(Organization.ADMIN_GROUP.getId(), false);</span>
    }
<span class="nc" id="L151">    catch (IdNotFoundException e1) { // NOPMD</span>
      // this is ok, we might need to create the organization.
<span class="fc" id="L153">    }</span>
<span class="pc bpc" id="L154" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L155">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">    if (admin == null) {</span>
      try {
<span class="nc" id="L159">        defineOrganization(Organization.ADMIN_GROUP.getId(), Organization.ADMIN_GROUP.getName(),</span>
            new HashSet&lt;String&gt;());
<span class="nc bnc" id="L161" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L162">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L165">      catch (UniqueIdException e) {</span>
        // what do we do here?
<span class="nc" id="L167">        e.printStackTrace();</span>
      }
<span class="nc" id="L169">      catch (BadSlugException e) {</span>
        // what do we do here?
<span class="nc" id="L171">        e.printStackTrace();</span>
      }
<span class="nc" id="L173">      catch (IdNotFoundException e) {</span>
        // what do we do here?
<span class="nc" id="L175">        e.printStackTrace();</span>
<span class="nc" id="L176">      }</span>
    }
    else {
      try {
<span class="fc" id="L180">        updateOrganization(admin);</span>
      }
<span class="nc" id="L182">      catch (IdNotFoundException e) {</span>
        // Should not happen.
<span class="nc" id="L184">        e.printStackTrace();</span>
<span class="fc" id="L185">      }</span>
<span class="pc bpc" id="L186" title="3 of 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L187">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="fc" id="L190">    UserInfo adminUser = null;</span>
    try {
<span class="fc" id="L192">      adminUser = getUser(UserInfo.ROOT.getUid(), Organization.ADMIN_GROUP.getId(), false);</span>
    }
<span class="nc" id="L194">    catch (IdNotFoundException e) {</span>
      try {
<span class="nc" id="L196">        defineUserInfo(UserInfo.ROOT.getUid(), UserInfo.ROOT.getFirstName(),</span>
            UserInfo.ROOT.getLastName(), UserInfo.ROOT.getEmail(),
            Organization.ADMIN_GROUP.getId(), UserInfo.ROOT.getProperties(), StrongAES
                .getInstance().decrypt(UserPassword.ROOT.getEncryptedPassword()));
<span class="nc bnc" id="L200" title="All 4 branches missed.">        if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L201">          throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
        }
      }
<span class="nc" id="L204">      catch (UniqueIdException e1) {</span>
        // what do we do here?
<span class="nc" id="L206">        e1.printStackTrace();</span>
      }
<span class="nc" id="L208">      catch (IdNotFoundException e1) {</span>
        // this shouldn't happen
<span class="nc" id="L210">        e1.printStackTrace();</span>
<span class="nc" id="L211">      }</span>
<span class="fc" id="L212">    }</span>
<span class="pc bpc" id="L213" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L214">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">    if (adminUser != null) {</span>
      try {
<span class="nc" id="L218">        updateUserInfo(UserInfo.ROOT);</span>
      }
<span class="nc" id="L220">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L221">        e.printStackTrace();</span>
<span class="nc" id="L222">      }</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L224">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    if (!Organization.ADMIN_GROUP.getUsers().contains(UserInfo.ROOT.getUid())) {</span>
<span class="nc" id="L228">      Organization.ADMIN_GROUP.add(UserInfo.ROOT.getUid());</span>
      try {
<span class="nc" id="L230">        updateOrganization(Organization.ADMIN_GROUP);</span>
      }
<span class="nc" id="L232">      catch (IdNotFoundException e) { // NOPMD</span>
        // There is a problem
<span class="nc" id="L234">      }</span>
    }

    UserPassword adminPassword;
    try {
<span class="nc" id="L239">      adminPassword = getUserPassword(UserInfo.ROOT.getUid(), UserInfo.ROOT.getOrganizationId(),</span>
          false);
<span class="nc" id="L241">      updateUserPassword(adminPassword);</span>
<span class="nc bnc" id="L242" title="All 4 branches missed.">      if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L243">        throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
      }
    }
<span class="fc" id="L246">    catch (IdNotFoundException e2) { // NOPMD</span>
      // adminPassword no defined.
      // we are in trouble.
<span class="nc" id="L249">    }</span>
<span class="pc bpc" id="L250" title="3 of 4 branches missed.">    if (checkSession &amp;&amp; getSessionClose() != getSessionOpen()) {</span>
<span class="nc" id="L251">      throw new RuntimeException(&quot;opens and closed mismatched.&quot;);</span>
    }

<span class="fc" id="L254">  }</span>


  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#defineCollectorProcessDefinition(java.lang
   * .String, java.lang.String, java.lang.Long, java.lang.String,
   * java.lang.String)
   */
  @Override
  public CollectorProcessDefinition defineCollectorProcessDefinition(String id, String name,
      String sensorId, Long pollingInterval, String depositoryId, Set&lt;Property&gt; properties,
      String orgId) throws UniqueIdException, MisMatchedOwnerException, IdNotFoundException,
      BadSlugException {
<span class="fc" id="L270">    getOrganization(orgId, true);</span>
<span class="fc" id="L271">    getSensor(sensorId, orgId, true);</span>
<span class="fc" id="L272">    getDepository(depositoryId, orgId, true);</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L274">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
    try {
<span class="fc" id="L277">      CollectorProcessDefinition cpd = getCollectorProcessDefinition(id, orgId, true);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">      if (cpd != null) {</span>
<span class="fc" id="L279">        throw new UniqueIdException(id + &quot; is already a CollectorProcessDefinition id.&quot;);</span>
      }
    }
<span class="fc" id="L282">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is expected.
<span class="nc" id="L284">    }</span>
<span class="fc" id="L285">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L286">    sessionOpen++;</span>
<span class="fc" id="L287">    session.beginTransaction();</span>
<span class="fc" id="L288">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L289">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="fc" id="L290">    DepositoryImpl depot = retrieveDepository(session, depositoryId, orgId);</span>
<span class="fc" id="L291">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">    for (Property p : properties) {</span>
<span class="nc" id="L293">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L294">    }</span>
<span class="fc" id="L295">    CollectorProcessDefinitionImpl impl = new CollectorProcessDefinitionImpl(id, name, sensor,</span>
        pollingInterval, depot, props, org);
<span class="fc" id="L297">    storeCollectorProcessDefinition(session, impl);</span>
<span class="fc" id="L298">    session.getTransaction().commit();</span>
<span class="fc" id="L299">    session.close();</span>
<span class="fc" id="L300">    sessionClose++;</span>
<span class="fc" id="L301">    return impl.toCPD();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineWattDepository(java.lang.String,
   * java.lang.String, java.lang.String, org.wattdepot.datamodel.Organization)
   */
  @Override
  public Depository defineDepository(String id, String name, MeasurementType measurementType,
      String orgId) throws UniqueIdException, IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L314">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L316">    getOrganization(orgId, true);</span>
<span class="fc" id="L317">    getMeasurementType(measurementType.getId(), true);</span>
<span class="fc" id="L318">    Depository d = null;</span>
    try {
<span class="fc" id="L320">      d = getDepository(id, orgId, true);</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">      if (d != null) {</span>
<span class="fc" id="L322">        throw new UniqueIdException(name + &quot; is already a Depository name.&quot;);</span>
      }
    }
<span class="fc" id="L325">    catch (IdNotFoundException e) { // NOPMD</span>
      // ok since we are defining it.
<span class="nc" id="L327">    }</span>
<span class="fc" id="L328">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L329">    sessionOpen++;</span>
<span class="fc" id="L330">    session.beginTransaction();</span>
<span class="fc" id="L331">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L332">    MeasurementTypeImpl type = retrieveMeasurementType(session, measurementType.getId());</span>
<span class="fc" id="L333">    DepositoryImpl impl = new DepositoryImpl(id, name, type, org);</span>
<span class="fc" id="L334">    d = impl.toDepository();</span>
<span class="fc" id="L335">    session.save(impl);</span>
<span class="fc" id="L336">    session.getTransaction().commit();</span>
<span class="fc" id="L337">    session.close();</span>
<span class="fc" id="L338">    sessionClose++;</span>
<span class="fc" id="L339">    cache.putDepository(d);</span>
<span class="fc" id="L340">    return d;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#defineMeasurementPruningDefinition
   * (java.lang.String, java.lang.String, java.lang.String, java.lang.String,
   * java.lang.String, java.lang.Integer, java.lang.Integer, java.lang.Integer)
   */
  @Override
  public MeasurementPruningDefinition defineMeasurementPruningDefinition(String id, String name,
      String depositoryId, String sensorId, String orgId, Integer ignore, Integer collect,
      Integer gap) throws UniqueIdException, BadSlugException, IdNotFoundException {
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L356">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L358">    getOrganization(orgId, true);</span>
<span class="fc" id="L359">    getDepository(depositoryId, orgId, true);</span>
    try {
<span class="fc" id="L361">      getSensor(sensorId, orgId, true);</span>
    }
<span class="nc" id="L363">    catch (IdNotFoundException e) {</span>
<span class="nc" id="L364">      getSensorGroup(sensorId, orgId, true);</span>
<span class="fc" id="L365">    }</span>
<span class="fc" id="L366">    MeasurementPruningDefinition gcd = null;</span>
    try {
<span class="fc" id="L368">      gcd = getMeasurementPruningDefinition(id, orgId, true);</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">      if (gcd != null) {</span>
<span class="fc" id="L370">        throw new UniqueIdException(name + &quot; is already a MeasurementPruningDefinition name.&quot;);</span>
      }
    }
<span class="fc" id="L373">    catch (IdNotFoundException e) { // NOPMD</span>
      // ok since we are defining it.
<span class="nc" id="L375">    }</span>
<span class="fc" id="L376">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L377">    sessionOpen++;</span>
<span class="fc" id="L378">    session.beginTransaction();</span>
<span class="fc" id="L379">    DepositoryImpl dep = retrieveDepository(session, depositoryId, orgId);</span>
<span class="fc" id="L380">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L381">    MeasurementPruningDefinitionImpl impl = new MeasurementPruningDefinitionImpl(id, name, dep,</span>
        sensorId, org, ignore, collect, gap);
<span class="fc" id="L383">    gcd = impl.toMPD();</span>
<span class="fc" id="L384">    session.save(impl);</span>
<span class="fc" id="L385">    session.getTransaction().commit();</span>
<span class="fc" id="L386">    session.close();</span>
<span class="fc" id="L387">    sessionClose++;</span>
<span class="fc" id="L388">    return gcd;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineMeasurementType(java.lang.String,
   * java.lang.String)
   */
  @Override
  public MeasurementType defineMeasurementType(String id, String name, String units)
      throws UniqueIdException, BadSlugException {
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L401">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L403">    MeasurementType mt = null;</span>
    try {
<span class="nc" id="L405">      mt = getMeasurementType(id, true);</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">      if (mt != null) {</span>
<span class="nc" id="L407">        throw new UniqueIdException(id + &quot; is already a MeasurementType id.&quot;);</span>
      }
    }
<span class="fc" id="L410">    catch (IdNotFoundException e) { // NOPMD</span>
      // expected.
<span class="nc" id="L412">    }</span>
<span class="fc" id="L413">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L414">    sessionOpen++;</span>
<span class="fc" id="L415">    session.beginTransaction();</span>
<span class="fc" id="L416">    MeasurementTypeImpl impl = new MeasurementTypeImpl(id, name, units);</span>
<span class="fc" id="L417">    session.save(impl);</span>
<span class="fc" id="L418">    session.getTransaction().commit();</span>
<span class="fc" id="L419">    session.close();</span>
<span class="fc" id="L420">    sessionClose++;</span>
<span class="fc" id="L421">    return mt;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineOrganization(java.lang.String,
   * java.util.Set&lt;String&gt;)
   */
  @Override
  public Organization defineOrganization(String id, String name, Set&lt;String&gt; users)
      throws UniqueIdException, BadSlugException, IdNotFoundException {
<span class="fc" id="L433">    Long startTime = 0l;</span>
<span class="fc" id="L434">    Long endTime = 0l;</span>
<span class="fc" id="L435">    Long diff = 0l;</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L437">      timingLogger.log(Level.SEVERE, padding + &quot;Start defineOrganizations()&quot;);</span>
<span class="nc" id="L438">      padding += &quot;  &quot;;</span>
<span class="nc" id="L439">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L441">    Organization ret = null;</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L443">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
    Organization g;
    try {
<span class="nc" id="L447">      g = getOrganization(id, true);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">      if (g != null) {</span>
<span class="nc" id="L449">        throw new UniqueIdException(id + &quot; is already a Organization id.&quot;);</span>
      }
    }
<span class="fc" id="L452">    catch (IdNotFoundException e) { // NOPMD</span>
      // is ok.
<span class="nc" id="L454">    }</span>
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">    for (String uid : users) {</span>
<span class="nc" id="L456">      getUser(uid, id, true);</span>
<span class="nc" id="L457">    }</span>
<span class="fc" id="L458">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L459">    sessionOpen++;</span>
<span class="fc" id="L460">    session.beginTransaction();</span>
<span class="fc" id="L461">    Set&lt;UserInfoImpl&gt; u = new HashSet&lt;UserInfoImpl&gt;();</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">    for (String uid : users) {</span>
<span class="nc" id="L463">      u.add(retrieveUser(session, uid, id));</span>
<span class="nc" id="L464">    }</span>
<span class="fc" id="L465">    OrganizationImpl impl = new OrganizationImpl(id, name, u);</span>
<span class="fc" id="L466">    ret = impl.toOrganization();</span>
<span class="fc" id="L467">    session.save(impl);</span>
<span class="fc" id="L468">    session.getTransaction().commit();</span>
<span class="fc" id="L469">    session.close();</span>
<span class="fc" id="L470">    sessionClose++;</span>
<span class="fc" id="L471">    cache.putOrganization(ret);</span>
<span class="pc bpc" id="L472" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L473">      endTime = System.nanoTime();</span>
<span class="nc" id="L474">      diff = endTime - startTime;</span>
<span class="nc" id="L475">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L476">      timingLogger</span>
          .log(Level.SEVERE, padding + &quot;defineOrganization() took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L479">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensor(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String, java.lang.String)
   */
  @Override
  public Sensor defineSensor(String id, String name, String uri, String modelId,
      Set&lt;Property&gt; properties, String orgId) throws UniqueIdException, MisMatchedOwnerException,
      IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L492" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L493">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L495">    getOrganization(orgId, true);</span>
<span class="fc" id="L496">    getSensorModel(modelId, true);</span>
<span class="fc" id="L497">    Sensor s = null;</span>
    try {
<span class="fc" id="L499">      s = getSensor(id, orgId, true);</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">      if (s != null) {</span>
<span class="fc" id="L501">        throw new UniqueIdException(id + &quot; is already a defined Sensor.&quot;);</span>
      }
    }
<span class="fc" id="L504">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is expected.
<span class="nc" id="L506">    }</span>
<span class="fc" id="L507">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L508">    sessionOpen++;</span>
<span class="fc" id="L509">    session.beginTransaction();</span>
<span class="fc" id="L510">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L511">    SensorModelImpl model = retrieveSensorModel(session, modelId);</span>
<span class="fc" id="L512">    Set&lt;PropertyImpl&gt; prop = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">    for (Property p : properties) {</span>
<span class="nc" id="L514">      prop.add(new PropertyImpl(p));</span>
<span class="nc" id="L515">    }</span>
<span class="fc" id="L516">    SensorImpl impl = new SensorImpl(id, name, uri, model, prop, org);</span>
<span class="fc" id="L517">    s = impl.toSensor();</span>
<span class="fc" id="L518">    storeSensor(session, impl);</span>
<span class="fc" id="L519">    session.getTransaction().commit();</span>
<span class="fc" id="L520">    session.close();</span>
<span class="fc" id="L521">    sessionClose++;</span>
<span class="fc" id="L522">    cache.putSensor(s);</span>
<span class="fc" id="L523">    return s;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensorGroup(java.lang.String,
   * java.util.List, org.wattdepot.datamodel.Organization)
   */
  @Override
  public SensorGroup defineSensorGroup(String id, String name, Set&lt;String&gt; sensorIds, String orgId)
      throws UniqueIdException, MisMatchedOwnerException, IdNotFoundException, BadSlugException {
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L536">      throw new BadSlugException(id + &quot; is not a valid slug.&quot;);</span>
    }
<span class="fc" id="L538">    Organization owner = getOrganization(orgId, true);</span>
<span class="fc bfc" id="L539" title="All 2 branches covered.">    for (String sensorId : sensorIds) {</span>
<span class="fc" id="L540">      Sensor sensor = getSensor(sensorId, orgId, true);</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">      if (!orgId.equals(sensor.getOrganizationId())) {</span>
<span class="nc" id="L542">        throw new MisMatchedOwnerException(orgId + &quot; is not the owner of all the sensors.&quot;);</span>
      }
<span class="fc" id="L544">    }</span>
<span class="fc" id="L545">    SensorGroup sg = null;</span>
    try {
<span class="nc" id="L547">      sg = getSensorGroup(id, owner.getId(), true);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">      if (sg != null) {</span>
<span class="nc" id="L549">        throw new UniqueIdException(id + &quot; is already a SensorGroup id.&quot;);</span>
      }
    }
<span class="fc" id="L552">    catch (IdNotFoundException e) { // NOPMD</span>
      // this is ok since we are defining it.
<span class="nc" id="L554">    }</span>
<span class="fc" id="L555">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L556">    sessionOpen++;</span>
<span class="fc" id="L557">    session.beginTransaction();</span>
<span class="fc" id="L558">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L559">    Set&lt;SensorImpl&gt; sensors = new HashSet&lt;SensorImpl&gt;();</span>
<span class="fc bfc" id="L560" title="All 2 branches covered.">    for (String sensorId : sensorIds) {</span>
<span class="fc" id="L561">      sensors.add(retrieveSensor(session, sensorId, orgId));</span>
<span class="fc" id="L562">    }</span>
<span class="fc" id="L563">    SensorGroupImpl impl = new SensorGroupImpl(id, name, sensors, org);</span>
<span class="fc" id="L564">    session.save(impl);</span>
<span class="fc" id="L565">    session.getTransaction().commit();</span>
<span class="fc" id="L566">    session.close();</span>
<span class="fc" id="L567">    sessionClose++;</span>
<span class="fc" id="L568">    return sg;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineSensorModel(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String,
   * org.wattdepot.datamodel.Organization)
   */
  @Override
  public SensorModel defineSensorModel(String id, String name, String protocol, String type,
      String version) throws UniqueIdException, BadSlugException {
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">    if (!Slug.validateSlug(id)) {</span>
<span class="nc" id="L582">      throw new BadSlugException(id + &quot; is not a valid id.&quot;);</span>
    }
<span class="fc" id="L584">    SensorModel sm = null;</span>
    try {
<span class="nc" id="L586">      sm = getSensorModel(id, true);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">      if (sm != null) {</span>
<span class="nc" id="L588">        throw new UniqueIdException(id + &quot; is already a SensorModel id.&quot;);</span>
      }
    }
<span class="fc" id="L591">    catch (IdNotFoundException e) { // NOPMD</span>
      // expected.
<span class="nc" id="L593">    }</span>
<span class="fc" id="L594">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L595">    sessionOpen++;</span>
<span class="fc" id="L596">    session.beginTransaction();</span>
<span class="fc" id="L597">    SensorModelImpl impl = new SensorModelImpl(id, name, protocol, type, version);</span>
<span class="fc" id="L598">    session.save(impl);</span>
<span class="fc" id="L599">    session.getTransaction().commit();</span>
<span class="fc" id="L600">    session.close();</span>
<span class="fc" id="L601">    sessionClose++;</span>
<span class="fc" id="L602">    return sm;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#defineUserInfo(java.lang.String,
   * java.lang.String, java.lang.String, java.lang.String, java.lang.String,
   * java.lang.Boolean, java.util.Set)
   */
  @Override
  public UserInfo defineUserInfo(String id, String firstName, String lastName, String email,
      String orgId, Set&lt;Property&gt; properties, String password) throws UniqueIdException,
      IdNotFoundException {
<span class="fc" id="L616">    getOrganization(orgId, true);</span>
<span class="fc" id="L617">    UserInfo u = null;</span>
    try {
<span class="nc" id="L619">      u = getUser(id, orgId, true);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">      if (u != null) {</span>
<span class="nc" id="L621">        throw new UniqueIdException(id + &quot; is already a UserInfo id.&quot;);</span>
      }
    }
<span class="fc" id="L624">    catch (IdNotFoundException e) { // NOPMD</span>
      // excpected since we are defining a new user.
<span class="nc" id="L626">    }</span>
<span class="fc" id="L627">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L628">    sessionOpen++;</span>
<span class="fc" id="L629">    session.beginTransaction();</span>
<span class="fc" id="L630">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L631">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">    for (Property p : properties) {</span>
<span class="fc" id="L633">      PropertyImpl pi = new PropertyImpl(p);</span>
<span class="fc" id="L634">      props.add(pi);</span>
<span class="fc" id="L635">      session.saveOrUpdate(pi);</span>
<span class="fc" id="L636">    }</span>
<span class="fc" id="L637">    UserInfoImpl impl = new UserInfoImpl(id, firstName, lastName, email, props, org);</span>
<span class="fc" id="L638">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L639">    u = impl.toUserInfo();</span>
<span class="fc" id="L640">    UserPasswordImpl up = new UserPasswordImpl(impl, password, org);</span>
<span class="fc" id="L641">    session.saveOrUpdate(up);</span>
<span class="fc" id="L642">    session.getTransaction().commit();</span>
<span class="fc" id="L643">    session.close();</span>
<span class="fc" id="L644">    sessionClose++;</span>
<span class="fc" id="L645">    return u;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#deleteCollectorProcessDefinition(java.lang
   * .String, java.lang.String)
   */
  @Override
  public void deleteCollectorProcessDefinition(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L658">    getCollectorProcessDefinition(id, orgId, true);</span>
<span class="fc" id="L659">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L660">    sessionOpen++;</span>
<span class="fc" id="L661">    session.beginTransaction();</span>
<span class="fc" id="L662">    CollectorProcessDefinitionImpl impl = retrieveCollectorProcessDefinition(session, id, orgId);</span>
<span class="fc" id="L663">    session.delete(impl);</span>
<span class="fc" id="L664">    session.getTransaction().commit();</span>
<span class="fc" id="L665">    session.close();</span>
<span class="fc" id="L666">    sessionClose++;</span>
<span class="fc" id="L667">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteWattDepository(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteDepository(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L678">    Depository d = getDepository(id, orgId, true);</span>
<span class="fc" id="L679">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L680">    sessionOpen++;</span>
<span class="fc" id="L681">    session.beginTransaction();</span>
<span class="fc" id="L682">    DepositoryImpl impl = retrieveDepository(session, id, orgId);</span>
<span class="fc bfc" id="L683" title="All 2 branches covered.">    for (DepositorySensorContribution dsc : retrieveContributions(session, impl)) {</span>
<span class="fc" id="L684">      session.delete(dsc);</span>
<span class="fc" id="L685">    }</span>
<span class="fc" id="L686">    session.delete(impl);</span>
<span class="fc" id="L687">    session.getTransaction().commit();</span>
<span class="fc" id="L688">    session.close();</span>
<span class="fc" id="L689">    sessionClose++;</span>
<span class="pc bpc" id="L690" title="1 of 2 branches missed.">    if (d != null) {</span>
<span class="fc" id="L691">      cache.deleteDepository(d);</span>
    }
<span class="fc" id="L693">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#deleteMeasurementPruningDefinition
   * (java.lang.String)
   */
  @Override
  public void deleteMeasurementPruningDefinition(String id, String orgId) throws IdNotFoundException {
<span class="fc" id="L704">    getMeasurementPruningDefinition(id, orgId, true);</span>
<span class="fc" id="L705">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L706">    sessionOpen++;</span>
<span class="fc" id="L707">    session.beginTransaction();</span>
<span class="fc" id="L708">    MeasurementPruningDefinitionImpl impl = retrieveMeasurementPruningDefinition(session, id, orgId);</span>
<span class="fc" id="L709">    session.delete(impl);</span>
<span class="fc" id="L710">    session.getTransaction().commit();</span>
<span class="fc" id="L711">    session.close();</span>
<span class="fc" id="L712">    sessionClose++;</span>
<span class="fc" id="L713">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#deleteMeasurement(java.lang.String
   * , java.lang.String)
   */
  @Override
  public void deleteMeasurement(String depotId, String orgId, String measId)
      throws IdNotFoundException {
<span class="fc" id="L725">    Long startTime = 0l;</span>
<span class="fc" id="L726">    Long endTime = 0l;</span>
<span class="fc" id="L727">    Long diff = 0l;</span>
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L729">      timingLogger.log(Level.SEVERE, padding + &quot;Start deleteMeasurement(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L731">      padding += &quot;  &quot;;</span>
<span class="nc" id="L732">      startTime = System.nanoTime();</span>
    }
//    getOrganization(orgId, true);
//    getDepository(depotId, orgId, true);
//    getMeasurement(depotId, orgId, measId, true);
<span class="fc" id="L737">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L738">    session.beginTransaction();</span>
<span class="fc" id="L739">    MeasurementImpl impl = retrieveMeasurement(session, depotId, orgId, measId);</span>
<span class="fc bfc" id="L740" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L741">      session.delete(impl);</span>
    }
    else {
<span class="fc" id="L744">      throw new IdNotFoundException(measId + &quot; is not a valid measurment id.&quot;);</span>
    }
<span class="fc" id="L746">    session.getTransaction().commit();</span>
<span class="fc" id="L747">    session.close();</span>
<span class="pc bpc" id="L748" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L749">      endTime = System.nanoTime();</span>
<span class="nc" id="L750">      diff = endTime - startTime;</span>
<span class="nc" id="L751">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L752">      timingLogger.log(Level.SEVERE, padding + &quot;deleteMeasurement(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }    
<span class="fc" id="L755">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteMeasurementType(java.lang.String)
   */
  @Override
  public void deleteMeasurementType(String id) throws IdNotFoundException {
<span class="fc" id="L764">    getMeasurementType(id, true);</span>
<span class="fc" id="L765">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L766">    sessionOpen++;</span>
<span class="fc" id="L767">    session.beginTransaction();</span>
<span class="fc" id="L768">    MeasurementTypeImpl impl = retrieveMeasurementType(session, id);</span>
<span class="fc" id="L769">    List&lt;DepositoryImpl&gt; depositories = retrieveDepositories(session, impl);</span>
<span class="fc" id="L770">    session.getTransaction().commit();</span>
<span class="fc" id="L771">    session.close();</span>
<span class="fc" id="L772">    sessionClose++;</span>
<span class="pc bpc" id="L773" title="1 of 2 branches missed.">    for (DepositoryImpl depository : depositories) {</span>
      try {
<span class="nc" id="L775">        deleteDepository(depository.getId(), depository.getOrg().getId());</span>
      }
<span class="nc" id="L777">      catch (MisMatchedOwnerException e) {</span>
        // Shouldn't happen
<span class="nc" id="L779">        e.printStackTrace();</span>
<span class="nc" id="L780">      }</span>
<span class="nc" id="L781">    }</span>
<span class="fc" id="L782">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L783">    sessionOpen++;</span>
<span class="fc" id="L784">    session.beginTransaction();</span>
<span class="fc" id="L785">    impl = retrieveMeasurementType(session, id);</span>
<span class="fc" id="L786">    session.delete(impl);</span>
<span class="fc" id="L787">    session.getTransaction().commit();</span>
<span class="fc" id="L788">    session.close();</span>
<span class="fc" id="L789">    sessionClose++;</span>
<span class="fc" id="L790">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteOrganization(java.lang.String)
   */
  @Override
  public void deleteOrganization(String id) throws IdNotFoundException {
<span class="fc" id="L799">    Organization o = getOrganization(id, true);</span>
    // Remove Organization owned CollectorProcessDefinitions
<span class="fc" id="L801">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L802">    sessionOpen++;</span>
<span class="fc" id="L803">    session.beginTransaction();</span>
<span class="pc bpc" id="L804" title="1 of 2 branches missed.">    for (CollectorProcessDefinitionImpl sp : retrieveCollectorProcessDefinitions(session, id)) {</span>
<span class="nc" id="L805">      session.delete(sp);</span>
<span class="nc" id="L806">    }</span>
<span class="fc" id="L807">    session.getTransaction().commit();</span>
<span class="fc" id="L808">    session.close();</span>
<span class="fc" id="L809">    sessionClose++;</span>
    // Remove Organization owned MeasurementPruningDefinitions
<span class="fc" id="L811">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L812">    sessionOpen++;</span>
<span class="fc" id="L813">    session.beginTransaction();</span>
<span class="pc bpc" id="L814" title="1 of 2 branches missed.">    for (MeasurementPruningDefinitionImpl sp : retrieveMeasurementPruningDefinitions(session, id)) {</span>
<span class="nc" id="L815">      session.delete(sp);</span>
<span class="nc" id="L816">    }</span>
<span class="fc" id="L817">    session.getTransaction().commit();</span>
<span class="fc" id="L818">    session.close();</span>
<span class="fc" id="L819">    sessionClose++;</span>
    // Remove Organization owned SensorGroups
<span class="fc" id="L821">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L822">    sessionOpen++;</span>
<span class="fc" id="L823">    session.beginTransaction();</span>
<span class="fc bfc" id="L824" title="All 2 branches covered.">    for (SensorGroupImpl sg : retrieveSensorGroups(session, id)) {</span>
<span class="fc" id="L825">      session.delete(sg);</span>
<span class="fc" id="L826">    }</span>
<span class="fc" id="L827">    session.getTransaction().commit();</span>
<span class="fc" id="L828">    session.close();</span>
<span class="fc" id="L829">    sessionClose++;</span>
    // Remove Organization owned Measurements
<span class="fc" id="L831">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L832">    sessionOpen++;</span>
<span class="fc" id="L833">    session.beginTransaction();</span>
<span class="fc bfc" id="L834" title="All 2 branches covered.">    for (DepositoryImpl d : retrieveDepositories(session, id)) {</span>
<span class="fc bfc" id="L835" title="All 2 branches covered.">      for (String sensorId : listSensors(d.getId(), id, true)) {</span>
<span class="fc bfc" id="L836" title="All 2 branches covered.">        for (Measurement m : getMeasurements(d.getId(), id, sensorId, true)) {</span>
<span class="fc" id="L837">          MeasurementImpl mi = retrieveMeasurement(session, d.getId(), id, m.getId());</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">          if (mi != null) {</span>
<span class="fc" id="L839">            session.delete(mi);</span>
          }
<span class="fc" id="L841">        }</span>
<span class="fc" id="L842">      }</span>
<span class="fc" id="L843">    }</span>
<span class="fc" id="L844">    session.getTransaction().commit();</span>
<span class="fc" id="L845">    session.close();</span>
<span class="fc" id="L846">    sessionClose++;</span>
    // Remove Organization owned Depositories and Sensors
<span class="fc" id="L848">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L849">    sessionOpen++;</span>
<span class="fc" id="L850">    session.beginTransaction();</span>
<span class="fc" id="L851">    List&lt;DepositoryImpl&gt; depositories = retrieveDepositories(session, id);</span>
<span class="fc bfc" id="L852" title="All 2 branches covered.">    for (DepositoryImpl d : depositories) {</span>
<span class="fc bfc" id="L853" title="All 2 branches covered.">      for (DepositorySensorContribution dsc : retrieveContributions(session, d)) {</span>
<span class="fc" id="L854">        session.delete(dsc);</span>
<span class="fc" id="L855">      }</span>
<span class="fc" id="L856">      session.delete(d);</span>
<span class="fc" id="L857">    }</span>
<span class="fc bfc" id="L858" title="All 2 branches covered.">    for (SensorImpl s : retrieveSensors(session, id)) {</span>
<span class="fc" id="L859">      session.delete(s);</span>
<span class="fc" id="L860">    }</span>
<span class="fc" id="L861">    session.getTransaction().commit();</span>
<span class="fc" id="L862">    session.close();</span>
<span class="fc" id="L863">    sessionClose++;</span>
    // Remove Organization owned SensorModels
<span class="fc" id="L865">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L866">    sessionOpen++;</span>
<span class="fc" id="L867">    session.beginTransaction();</span>
<span class="fc bfc" id="L868" title="All 2 branches covered.">    for (SensorModelImpl sm : retrieveSensorModels(session)) {</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">      if (!SensorModelHelper.models.containsKey(sm.getName())) {</span>
<span class="fc" id="L870">        session.delete(sm);</span>
      }
<span class="fc" id="L872">    }</span>
<span class="fc" id="L873">    session.getTransaction().commit();</span>
<span class="fc" id="L874">    session.close();</span>
<span class="fc" id="L875">    sessionClose++;</span>
    // Remove Users in the Organization
<span class="fc" id="L877">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L878">    sessionOpen++;</span>
<span class="fc" id="L879">    session.beginTransaction();</span>
<span class="fc" id="L880">    OrganizationImpl orgImpl = retrieveOrganization(session, id);</span>
<span class="fc bfc" id="L881" title="All 2 branches covered.">    for (UserInfoImpl u : retrieveUsers(session, id)) {</span>
<span class="fc" id="L882">      orgImpl.getUsers().remove(u);</span>
<span class="fc" id="L883">      session.delete(u);</span>
<span class="fc" id="L884">    }</span>
<span class="fc" id="L885">    session.update(orgImpl);</span>
<span class="fc bfc" id="L886" title="All 2 branches covered.">    for (UserPasswordImpl u : retrieveUserPasswords(session, id)) {</span>
<span class="fc" id="L887">      session.delete(u);</span>
<span class="fc" id="L888">    }</span>
<span class="fc" id="L889">    session.getTransaction().commit();</span>
<span class="fc" id="L890">    session.close();</span>
<span class="fc" id="L891">    sessionClose++;</span>
    // Remove the organization
<span class="fc" id="L893">    session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L894">    sessionOpen++;</span>
<span class="fc" id="L895">    session.beginTransaction();</span>
<span class="fc" id="L896">    orgImpl = retrieveOrganization(session, id);</span>
<span class="fc" id="L897">    session.delete(orgImpl);</span>
<span class="fc" id="L898">    session.getTransaction().commit();</span>
<span class="fc" id="L899">    session.close();</span>
<span class="fc" id="L900">    sessionClose++;</span>
<span class="pc bpc" id="L901" title="1 of 2 branches missed.">    if (o != null) {</span>
<span class="fc" id="L902">      cache.deleteOrganization(o);</span>
    }
<span class="fc" id="L904">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensor(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensor(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L915">    Sensor s = getSensor(id, orgId, true);</span>
<span class="fc" id="L916">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L917">    sessionOpen++;</span>
<span class="fc" id="L918">    session.beginTransaction();</span>
<span class="fc" id="L919">    SensorImpl impl = retrieveSensor(session, id, orgId);</span>
<span class="pc bpc" id="L920" title="1 of 2 branches missed.">    for (DepositorySensorContribution dsc : retrieveContributions(session, impl)) {</span>
<span class="nc" id="L921">      session.delete(dsc);</span>
<span class="nc" id="L922">    }</span>
<span class="fc" id="L923">    session.delete(impl);</span>
<span class="fc" id="L924">    session.getTransaction().commit();</span>
<span class="fc" id="L925">    session.close();</span>
<span class="fc" id="L926">    sessionClose++;</span>
<span class="pc bpc" id="L927" title="1 of 2 branches missed.">    if (s != null) {</span>
<span class="fc" id="L928">      cache.deleteSensor(s);</span>
    }
<span class="fc" id="L930">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensorGroup(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensorGroup(String id, String orgId) throws IdNotFoundException,
      MisMatchedOwnerException {
<span class="fc" id="L941">    getSensorGroup(id, orgId, true);</span>
<span class="fc" id="L942">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L943">    sessionOpen++;</span>
<span class="fc" id="L944">    session.beginTransaction();</span>
<span class="fc" id="L945">    SensorGroupImpl impl = retrieveSensorGroup(session, id, orgId);</span>
<span class="fc" id="L946">    session.delete(impl);</span>
<span class="fc" id="L947">    session.getTransaction().commit();</span>
<span class="fc" id="L948">    session.close();</span>
<span class="fc" id="L949">    sessionClose++;</span>
<span class="fc" id="L950">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteSensorModel(java.lang.String,
   * java.lang.String)
   */
  @Override
  public void deleteSensorModel(String id) throws IdNotFoundException {
<span class="fc" id="L960">    getSensorModel(id, true);</span>
<span class="fc" id="L961">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L962">    sessionOpen++;</span>
<span class="fc" id="L963">    session.beginTransaction();</span>
<span class="fc" id="L964">    SensorModelImpl impl = retrieveSensorModel(session, id);</span>
<span class="fc" id="L965">    session.delete(impl);</span>
<span class="fc" id="L966">    session.getTransaction().commit();</span>
<span class="fc" id="L967">    session.close();</span>
<span class="fc" id="L968">    sessionClose++;</span>
<span class="fc" id="L969">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteUser(java.lang.String)
   */
  @Override
  public void deleteUser(String id, String orgId) throws IdNotFoundException {
<span class="fc" id="L978">    getUser(id, orgId, true);</span>
<span class="fc" id="L979">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L980">    sessionOpen++;</span>
<span class="fc" id="L981">    session.beginTransaction();</span>
<span class="fc" id="L982">    OrganizationImpl orgImpl = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L983">    UserInfoImpl impl = retrieveUser(session, id, orgId);</span>
<span class="fc" id="L984">    UserPasswordImpl up = retrieveUserPassword(session, id, orgId);</span>
<span class="fc" id="L985">    orgImpl.removeUser(impl);</span>
<span class="fc" id="L986">    session.saveOrUpdate(orgImpl);</span>
<span class="fc" id="L987">    session.delete(up);</span>
<span class="fc" id="L988">    session.delete(impl);</span>
<span class="fc" id="L989">    session.getTransaction().commit();</span>
<span class="fc" id="L990">    session.close();</span>
<span class="fc" id="L991">    sessionClose++;</span>
<span class="fc" id="L992">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#deleteUserPassword(java.lang.String)
   */
  @Override
  public void deleteUserPassword(String userId, String orgId) throws IdNotFoundException {
<span class="fc" id="L1001">    getUserPassword(userId, orgId, true);</span>
<span class="fc" id="L1002">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1003">    sessionOpen++;</span>
<span class="fc" id="L1004">    session.beginTransaction();</span>
<span class="fc" id="L1005">    UserPasswordImpl impl = retrieveUserPassword(session, userId, orgId);</span>
<span class="fc" id="L1006">    session.delete(impl);</span>
<span class="fc" id="L1007">    session.getTransaction().commit();</span>
<span class="fc" id="L1008">    session.close();</span>
<span class="fc" id="L1009">    sessionClose++;</span>
<span class="fc" id="L1010">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#getCollectorProcessDefinition(java.lang.
   * String, java.lang.String)
   */
  @Override
  public CollectorProcessDefinition getCollectorProcessDefinition(String id, String orgId,
      boolean check) throws IdNotFoundException {
<span class="pc bpc" id="L1022" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1023">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1025">    CollectorProcessDefinition ret = getCollectorProcessDefinitionNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1026" title="1 of 4 branches missed.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L1027">      throw new IdNotFoundException(id + &quot; is not a defined CollectorProcessDefinition's id.&quot;);</span>
    }
<span class="fc" id="L1029">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getCollectorProcessDefinitionIds()
   */
  @Override
  public List&lt;String&gt; getCollectorProcessDefinitionIds(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1040">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1041" title="All 2 branches covered.">    for (CollectorProcessDefinition s : getCollectorProcessDefinitions(orgId, check)) {</span>
<span class="fc" id="L1042">      ret.add(s.getId());</span>
<span class="fc" id="L1043">    }</span>
<span class="fc" id="L1044">    return ret;</span>
  }

  /**
   * @param id The CollectorProcessDefinition's id
   * @param orgId The Organization's id.
   * @return The defined CollectorProcessDefinition or null.
   */
  private CollectorProcessDefinition getCollectorProcessDefinitionNoCheck(String id, String orgId) {
<span class="fc" id="L1053">    CollectorProcessDefinition ret = null;</span>
<span class="fc" id="L1054">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1055">    sessionOpen++;</span>
<span class="fc" id="L1056">    session.beginTransaction();</span>
<span class="fc" id="L1057">    CollectorProcessDefinitionImpl cpd = retrieveCollectorProcessDefinition(session, id, orgId);</span>
<span class="fc bfc" id="L1058" title="All 2 branches covered.">    if (cpd != null) {</span>
<span class="fc" id="L1059">      ret = cpd.toCPD();</span>
    }
<span class="fc" id="L1061">    session.getTransaction().commit();</span>
<span class="fc" id="L1062">    session.close();</span>
<span class="fc" id="L1063">    sessionClose++;</span>
<span class="fc" id="L1064">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#getCollectorProcessDefinitions(java.lang
   * .String)
   */
  @Override
  public List&lt;CollectorProcessDefinition&gt; getCollectorProcessDefinitions(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc bfc" id="L1077" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1078">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1080">    return getCollectorProcessDefinitionsNoCheck(orgId);</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of the defined CollectorProcessDefinitions.
   */
  private List&lt;CollectorProcessDefinition&gt; getCollectorProcessDefinitionsNoCheck(String orgId) {
<span class="fc" id="L1088">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1089">    sessionOpen++;</span>
<span class="fc" id="L1090">    session.beginTransaction();</span>
<span class="fc" id="L1091">    List&lt;CollectorProcessDefinitionImpl&gt; r = retrieveCollectorProcessDefinitions(session, orgId);</span>
<span class="fc" id="L1092">    List&lt;CollectorProcessDefinition&gt; ret = new ArrayList&lt;CollectorProcessDefinition&gt;();</span>
<span class="fc bfc" id="L1093" title="All 2 branches covered.">    for (CollectorProcessDefinitionImpl cpd : r) {</span>
<span class="fc" id="L1094">      ret.add(cpd.toCPD());</span>
<span class="fc" id="L1095">    }</span>
<span class="fc" id="L1096">    session.getTransaction().commit();</span>
<span class="fc" id="L1097">    session.close();</span>
<span class="fc" id="L1098">    sessionClose++;</span>
<span class="fc" id="L1099">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDepositories(java.lang.String)
   */
  @Override
  public List&lt;Depository&gt; getDepositories(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L1109">    Long startTime = 0l;</span>
<span class="fc" id="L1110">    Long endTime = 0l;</span>
<span class="fc" id="L1111">    Long diff = 0l;</span>
<span class="pc bpc" id="L1112" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1113">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositories(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1114">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1115">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L1117" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1118">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1120">    List&lt;Depository&gt; ret = getDepositoriesNoCheck(orgId);</span>
<span class="pc bpc" id="L1121" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1122">      endTime = System.nanoTime();</span>
<span class="nc" id="L1123">      diff = endTime - startTime;</span>
<span class="nc" id="L1124">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1125">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositories(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1128">    return ret;</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of the defined Depositories.
   */
  private List&lt;Depository&gt; getDepositoriesNoCheck(String orgId) {
<span class="fc" id="L1136">    Long startTime = 0l;</span>
<span class="fc" id="L1137">    Long endTime = 0l;</span>
<span class="fc" id="L1138">    Long diff = 0l;</span>
<span class="pc bpc" id="L1139" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1140">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoriesNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1141">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1142">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1144">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1145">    sessionOpen++;</span>
<span class="fc" id="L1146">    session.beginTransaction();</span>
<span class="fc" id="L1147">    List&lt;DepositoryImpl&gt; r = retrieveDepositories(session, orgId);</span>
<span class="fc" id="L1148">    List&lt;Depository&gt; ret = new ArrayList&lt;Depository&gt;();</span>
<span class="fc bfc" id="L1149" title="All 2 branches covered.">    for (DepositoryImpl d : r) {</span>
<span class="fc" id="L1150">      ret.add(d.toDepository());</span>
<span class="fc" id="L1151">    }</span>
<span class="fc" id="L1152">    session.getTransaction().commit();</span>
<span class="fc" id="L1153">    session.close();</span>
<span class="fc" id="L1154">    sessionClose++;</span>
<span class="pc bpc" id="L1155" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1156">      endTime = System.nanoTime();</span>
<span class="nc" id="L1157">      diff = endTime - startTime;</span>
<span class="nc" id="L1158">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1159">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoriesNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1162">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDeposiory(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Depository getDepository(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1174">    Long startTime = 0l;</span>
<span class="fc" id="L1175">    Long endTime = 0l;</span>
<span class="fc" id="L1176">    Long diff = 0l;</span>
<span class="pc bpc" id="L1177" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1178">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepository(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1179">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1180">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1183">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1185">    Depository ret = cache.getDepository(id, orgId);</span>
<span class="fc bfc" id="L1186" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L1187">      ret = getDepositoryNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1188" title="1 of 2 branches missed.">      if (ret != null) {</span>
<span class="nc" id="L1189">        cache.putDepository(ret);</span>
      }
    }
<span class="pc bpc" id="L1192" title="1 of 4 branches missed.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L1193">      throw new IdNotFoundException(id + &quot; is not a defined Depository's id.&quot;);</span>
    }
<span class="pc bpc" id="L1195" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1196">      endTime = System.nanoTime();</span>
<span class="nc" id="L1197">      diff = endTime - startTime;</span>
<span class="nc" id="L1198">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1199">      timingLogger.log(Level.SEVERE, padding + &quot;getDepository(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1202">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getWattDepositoryIds()
   */
  @Override
  public List&lt;String&gt; getDepositoryIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L1212">    Long startTime = 0l;</span>
<span class="fc" id="L1213">    Long endTime = 0l;</span>
<span class="fc" id="L1214">    Long diff = 0l;</span>
<span class="pc bpc" id="L1215" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1216">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoryIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1217">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1218">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1220" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1221">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1223">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1224" title="All 2 branches covered.">    for (Depository d : getDepositoriesNoCheck(orgId)) {</span>
<span class="fc" id="L1225">      ret.add(d.getId());</span>
<span class="fc" id="L1226">    }</span>
<span class="pc bpc" id="L1227" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1228">      endTime = System.nanoTime();</span>
<span class="nc" id="L1229">      diff = endTime - startTime;</span>
<span class="nc" id="L1230">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1231">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoryIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1234">    return ret;</span>
  }

  /**
   * @param id The Depository's id.
   * @param orgId The Organization's id.
   * @return The defined Depository or null.
   */
  private Depository getDepositoryNoCheck(String id, String orgId) {
<span class="fc" id="L1243">    Long startTime = 0l;</span>
<span class="fc" id="L1244">    Long endTime = 0l;</span>
<span class="fc" id="L1245">    Long diff = 0l;</span>
<span class="pc bpc" id="L1246" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1247">      timingLogger.log(Level.SEVERE, padding + &quot;Start getDepositoryNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;)&quot;);
<span class="nc" id="L1249">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1250">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1252">    Depository ret = null;</span>
<span class="fc" id="L1253">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1254">    sessionOpen++;</span>
<span class="fc" id="L1255">    session.beginTransaction();</span>
<span class="fc" id="L1256">    DepositoryImpl impl = retrieveDepository(session, id, orgId);</span>
<span class="pc bpc" id="L1257" title="1 of 2 branches missed.">    if (impl != null) {</span>
<span class="nc" id="L1258">      ret = impl.toDepository();</span>
    }
<span class="fc" id="L1260">    session.getTransaction().commit();</span>
<span class="fc" id="L1261">    session.close();</span>
<span class="fc" id="L1262">    sessionClose++;</span>
<span class="pc bpc" id="L1263" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1264">      endTime = System.nanoTime();</span>
<span class="nc" id="L1265">      diff = endTime - startTime;</span>
<span class="nc" id="L1266">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1267">      timingLogger.log(Level.SEVERE, padding + &quot;getDepositoryNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1270">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getEarliestMeasuredValue(java
   * .lang.String, java.lang.String)
   */
  @Override
  public InterpolatedValue getEarliestMeasuredValue(String depotId, String orgId, String sensorId,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L1283">    Long startTime = 0l;</span>
<span class="fc" id="L1284">    Long endTime = 0l;</span>
<span class="fc" id="L1285">    Long diff = 0l;</span>
<span class="pc bpc" id="L1286" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1287">      timingLogger.log(Level.SEVERE, padding + &quot;Start getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1289">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1290">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1292" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1293">      getOrganization(orgId, check);</span>
<span class="fc" id="L1294">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1295">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1297">    InterpolatedValue value = getEarliestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1298" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1299">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="pc bpc" id="L1301" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1302">      endTime = System.nanoTime();</span>
<span class="nc" id="L1303">      diff = endTime - startTime;</span>
<span class="nc" id="L1304">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1305">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1308">    return value;</span>
  }

  /**
   * @param depotId The Depository's id.
   * @param orgId The Organization's id.
   * @param sensorId The Sensor id.
   * @return The earliest MeasuredValue for the given depository, organization
   *         and sensor.
   */
  private InterpolatedValue getEarliestMeasuredValueNoCheck(String depotId, String orgId,
      String sensorId) {
<span class="fc" id="L1320">    Long startTime = 0l;</span>
<span class="fc" id="L1321">    Long endTime = 0l;</span>
<span class="fc" id="L1322">    Long diff = 0l;</span>
<span class="pc bpc" id="L1323" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1324">      timingLogger.log(Level.SEVERE, padding + &quot;Start getEarliestMeasuredValueNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1326">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1327">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1329">    InterpolatedValue value = null;</span>
<span class="fc" id="L1330">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1331">    session.beginTransaction();</span>
<span class="fc" id="L1332">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1333">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1335">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
    // List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session
    // .createQuery(
    // &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor &quot;
    // + &quot;AND timestamp IN (SELECT min(timestamp) FROM MeasurementImpl WHERE &quot;
    // + &quot;depository = :depot AND sensor = :sensor)&quot;).setParameter(&quot;depot&quot;,
    // depot)
    // .setParameter(&quot;sensor&quot;, sensor).list();
<span class="pc bpc" id="L1346" title="1 of 2 branches missed.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L1347">      MeasurementImpl meas = result.get(0);</span>
<span class="fc" id="L1348">      value = new InterpolatedValue(sensorId, meas.getValue(), depot.getType().toMeasurementType(),</span>
          meas.getTimestamp());
    }
<span class="fc" id="L1351">    session.getTransaction().commit();</span>
<span class="fc" id="L1352">    session.close();</span>
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1354">      endTime = System.nanoTime();</span>
<span class="nc" id="L1355">      diff = endTime - startTime;</span>
<span class="nc" id="L1356">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1357">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValueNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1360">    return value;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinition
   * (java.lang.String, java.lang.String, boolean)
   */
  @Override
  public MeasurementPruningDefinition getMeasurementPruningDefinition(String id, String orgId,
      boolean check) throws IdNotFoundException {
<span class="fc" id="L1373">    Long startTime = 0l;</span>
<span class="fc" id="L1374">    Long endTime = 0l;</span>
<span class="fc" id="L1375">    Long diff = 0l;</span>
<span class="pc bpc" id="L1376" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1377">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementPruningDefinition(&quot; + id + &quot;, &quot;</span>
          + orgId + &quot;)&quot;);
<span class="nc" id="L1379">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1380">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1382" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1383">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1385">    MeasurementPruningDefinition gcd = getMeasurementPruningDefinitionNoCheck(id, orgId);</span>
<span class="pc bpc" id="L1386" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1387">      endTime = System.nanoTime();</span>
<span class="nc" id="L1388">      diff = endTime - startTime;</span>
<span class="nc" id="L1389">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1390">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementPruningDefinition(&quot; + id + &quot;, &quot;</span>
          + orgId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc bfc" id="L1393" title="All 2 branches covered.">    if (gcd == null) {</span>
<span class="fc" id="L1394">      throw new IdNotFoundException(id + &quot; is not a defined MeasurementPruningDefinition id.&quot;);</span>
    }
<span class="fc" id="L1396">    return gcd;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinitionIds
   * (java.lang.String, boolean)
   */
  @Override
  public List&lt;String&gt; getMeasurementPruningDefinitionIds(String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1409">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L1410" title="All 2 branches covered.">    for (MeasurementPruningDefinition gcd : getMeasurementPruningDefinitions(orgId, check)) {</span>
<span class="fc" id="L1411">      ret.add(gcd.getId());</span>
<span class="fc" id="L1412">    }</span>
<span class="fc" id="L1413">    return ret;</span>
  }

  /**
   * @param id The MeasurementPruningDefinition's id.
   * @param orgId The Organization's id.
   * @return The MeasurementPruningDefinition with the given id and orgId, or
   *         null if not defined.
   */
  private MeasurementPruningDefinition getMeasurementPruningDefinitionNoCheck(String id, String orgId) {
<span class="fc" id="L1423">    MeasurementPruningDefinition ret = null;</span>
<span class="fc" id="L1424">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1425">    sessionOpen++;</span>
<span class="fc" id="L1426">    session.beginTransaction();</span>
<span class="fc" id="L1427">    MeasurementPruningDefinitionImpl gcd = retrieveMeasurementPruningDefinition(session, id, orgId);</span>
<span class="fc bfc" id="L1428" title="All 2 branches covered.">    if (gcd != null) {</span>
<span class="fc" id="L1429">      ret = gcd.toMPD();</span>
    }
<span class="fc" id="L1431">    session.getTransaction().commit();</span>
<span class="fc" id="L1432">    session.close();</span>
<span class="fc" id="L1433">    sessionClose++;</span>
<span class="fc" id="L1434">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementPruningDefinitions
   * (java.lang.String, boolean)
   */
  @Override
  public List&lt;MeasurementPruningDefinition&gt; getMeasurementPruningDefinitions(String orgId,
      boolean check) throws IdNotFoundException {
<span class="fc bfc" id="L1447" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L1448">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L1450">    return getMeasurementPruningDefinitionsNoCheck(orgId);</span>
  }

  /**
   * @param orgId The Organization's id.
   * @return A list of defined MeasurementPruningDefinitions.
   */
  private List&lt;MeasurementPruningDefinition&gt; getMeasurementPruningDefinitionsNoCheck(String orgId) {
<span class="fc" id="L1458">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1459">    sessionOpen++;</span>
<span class="fc" id="L1460">    session.beginTransaction();</span>
<span class="fc" id="L1461">    List&lt;MeasurementPruningDefinitionImpl&gt; r = retrieveMeasurementPruningDefinitions(session, orgId);</span>
<span class="fc" id="L1462">    List&lt;MeasurementPruningDefinition&gt; ret = new ArrayList&lt;MeasurementPruningDefinition&gt;();</span>
<span class="fc bfc" id="L1463" title="All 2 branches covered.">    for (MeasurementPruningDefinitionImpl gcd : r) {</span>
<span class="fc" id="L1464">      ret.add(gcd.toMPD());</span>
<span class="fc" id="L1465">    }</span>
<span class="fc" id="L1466">    session.getTransaction().commit();</span>
<span class="fc" id="L1467">    session.close();</span>
<span class="fc" id="L1468">    sessionClose++;</span>
<span class="fc" id="L1469">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getLatestMeasuredValue(java.lang
   * .String, java.lang.String)
   */
  @Override
  public InterpolatedValue getLatestMeasuredValue(String depotId, String orgId, String sensorId,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L1482">    Long startTime = 0l;</span>
<span class="fc" id="L1483">    Long endTime = 0l;</span>
<span class="fc" id="L1484">    Long diff = 0l;</span>
<span class="pc bpc" id="L1485" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1486">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLaestMeasuredValue(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1488">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1489">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1491" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1492">      getOrganization(orgId, check);</span>
<span class="fc" id="L1493">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1494">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1496">    InterpolatedValue value = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1497" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L1498">      throw new NoMeasurementException(&quot;No &quot; + depotId + &quot; measurements for &quot; + sensorId);</span>
    }
<span class="pc bpc" id="L1500" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1501">      endTime = System.nanoTime();</span>
<span class="nc" id="L1502">      diff = endTime - startTime;</span>
<span class="nc" id="L1503">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1504">      timingLogger.log(Level.SEVERE, padding + &quot;getEarliestMeasuredValue(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1507">    return value;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensors's id.
   * @return The latest measured value or null if no measurements.
   */
  private InterpolatedValue getLatestMeasuredValueNoCheck(String depotId, String orgId,
      String sensorId) {
<span class="fc" id="L1518">    Long startTime = 0l;</span>
<span class="fc" id="L1519">    Long endTime = 0l;</span>
<span class="fc" id="L1520">    Long diff = 0l;</span>
<span class="pc bpc" id="L1521" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1522">      timingLogger.log(Level.SEVERE, padding + &quot;Start getLatestMeasuredValueNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1524">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1525">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1527">    InterpolatedValue value = null;</span>
<span class="fc" id="L1528">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1529">    session.beginTransaction();</span>
<span class="fc" id="L1530">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1531">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1533">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();

    // List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session
    // .createQuery(
    // &quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor &quot;
    // + &quot;AND timestamp IN (SELECT max(timestamp) FROM MeasurementImpl WHERE &quot;
    // + &quot;depository = :depot AND sensor = :sensor)&quot;).setParameter(&quot;depot&quot;,
    // depot)
    // .setParameter(&quot;sensor&quot;, sensor).list();
<span class="pc bpc" id="L1545" title="1 of 2 branches missed.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L1546">      MeasurementImpl meas = result.get(0);</span>
<span class="fc" id="L1547">      value = new InterpolatedValue(sensorId, meas.getValue(), depot.getType().toMeasurementType(),</span>
          meas.getTimestamp());
    }
<span class="fc" id="L1550">    session.getTransaction().commit();</span>
<span class="fc" id="L1551">    session.close();</span>
<span class="pc bpc" id="L1552" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1553">      endTime = System.nanoTime();</span>
<span class="nc" id="L1554">      diff = endTime - startTime;</span>
<span class="nc" id="L1555">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1556">      timingLogger.log(Level.SEVERE, padding + &quot;getLatestMeasuredValueNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1559">    return value;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurement(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Measurement getMeasurement(String depotId, String orgId, String measId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L1572">    Long startTime = 0l;</span>
<span class="fc" id="L1573">    Long endTime = 0l;</span>
<span class="fc" id="L1574">    Long diff = 0l;</span>
<span class="pc bpc" id="L1575" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1576">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurement(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L1578">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1579">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1581" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1582">      getOrganization(orgId, check);</span>
<span class="fc" id="L1583">      getDepository(depotId, orgId, check);</span>
    }
<span class="fc" id="L1585">    Measurement ret = getMeasurementNoCheck(depotId, orgId, measId);</span>
<span class="pc bpc" id="L1586" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1587">      endTime = System.nanoTime();</span>
<span class="nc" id="L1588">      diff = endTime - startTime;</span>
<span class="nc" id="L1589">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1590">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurement(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1593">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param measId The measurement's id.
   * @return The Measurement with the given ids or null.
   */
  private Measurement getMeasurementNoCheck(String depotId, String orgId, String measId) {
<span class="fc" id="L1603">    Long startTime = 0l;</span>
<span class="fc" id="L1604">    Long endTime = 0l;</span>
<span class="fc" id="L1605">    Long diff = 0l;</span>
<span class="pc bpc" id="L1606" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1607">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + measId + &quot;)&quot;);
<span class="nc" id="L1609">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1610">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1612">    Measurement ret = null;</span>
<span class="fc" id="L1613">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1614">    session.beginTransaction();</span>
<span class="fc" id="L1615">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1617">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depot AND id = :id&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;id&quot;, measId).list();
<span class="pc bpc" id="L1620" title="1 of 2 branches missed.">    if (result.size() == 1) {</span>
<span class="fc" id="L1621">      ret = result.get(0).toMeasurement();</span>
    }
<span class="fc" id="L1623">    session.getTransaction().commit();</span>
<span class="fc" id="L1624">    session.close();</span>
<span class="pc bpc" id="L1625" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1626">      endTime = System.nanoTime();</span>
<span class="nc" id="L1627">      diff = endTime - startTime;</span>
<span class="nc" id="L1628">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1629">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + measId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1632">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurements(java.lang.String,
   * java.lang.String)
   */
  @Override
  public List&lt;Measurement&gt; getMeasurements(String depotId, String orgId, String sensorId,
      boolean check) throws IdNotFoundException {
<span class="fc" id="L1645">    Long startTime = 0l;</span>
<span class="fc" id="L1646">    Long endTime = 0l;</span>
<span class="fc" id="L1647">    Long diff = 0l;</span>
<span class="pc bpc" id="L1648" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1649">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurements(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1651">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1652">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1654" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1655">      getOrganization(orgId, check);</span>
<span class="fc" id="L1656">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1657">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1659">    List&lt;Measurement&gt; ret = getMeasurementsNoCheck(depotId, orgId, sensorId);</span>
<span class="pc bpc" id="L1660" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1661">      endTime = System.nanoTime();</span>
<span class="nc" id="L1662">      diff = endTime - startTime;</span>
<span class="nc" id="L1663">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1664">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurements(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1667">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurements(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public List&lt;Measurement&gt; getMeasurements(String depotId, String orgId, String sensorId,
      Date start, Date end, boolean check) throws IdNotFoundException {
<span class="fc" id="L1680">    Long startTime = 0l;</span>
<span class="fc" id="L1681">    Long endTime = 0l;</span>
<span class="fc" id="L1682">    Long diff = 0l;</span>
<span class="pc bpc" id="L1683" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1684">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1686">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1687">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L1689" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L1690">      getOrganization(orgId, check);</span>
<span class="fc" id="L1691">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L1692">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L1694">    List&lt;Measurement&gt; ret = getMeasurementsNoCheck(depotId, orgId, sensorId, start, end);</span>
<span class="pc bpc" id="L1695" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1696">      endTime = System.nanoTime();</span>
<span class="nc" id="L1697">      diff = endTime - startTime;</span>
<span class="nc" id="L1698">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1699">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1702">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, boolean)
   */
  @Override
  public Long getMeasurementsCount(String orgId, boolean check) throws IdNotFoundException {
<span class="nc" id="L1714">    Long startTime = 0l;</span>
<span class="nc" id="L1715">    Long endTime = 0l;</span>
<span class="nc" id="L1716">    Long diff = 0l;</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1718">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCount(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L1719">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1720">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1722" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1723">      getOrganization(orgId, check);</span>
    }
<span class="nc" id="L1725">    Long ret = 0l;</span>
<span class="nc" id="L1726">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1727">    session.beginTransaction();</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">    for (DepositoryImpl depot : retrieveDepositories(session, orgId)) {</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1730">      List&lt;Long&gt; result = (List&lt;Long&gt;) session</span>
          .createQuery(&quot;SELECT count(*) FROM MeasurementImpl WHERE depository = :depot&quot;)
          .setParameter(&quot;depot&quot;, depot).list();
<span class="nc" id="L1733">      ret += result.get(0);</span>
<span class="nc" id="L1734">    }</span>
<span class="nc" id="L1735">    session.getTransaction().commit();</span>
<span class="nc" id="L1736">    session.close();</span>

<span class="nc bnc" id="L1738" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1739">      endTime = System.nanoTime();</span>
<span class="nc" id="L1740">      diff = endTime - startTime;</span>
<span class="nc" id="L1741">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1742">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1745">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, java.lang.String, java.lang.String)
   */
  @Override
  public Long getMeasurementsCount(String depotId, String orgId, String sensorId, boolean check)
      throws IdNotFoundException {
<span class="nc" id="L1758">    Long startTime = 0l;</span>
<span class="nc" id="L1759">    Long endTime = 0l;</span>
<span class="nc" id="L1760">    Long diff = 0l;</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1762">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCount(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1764">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1765">      startTime = System.nanoTime();</span>
    }
<span class="nc bnc" id="L1767" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1768">      getOrganization(orgId, check);</span>
<span class="nc" id="L1769">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1770">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1772">    Long ret = getMeasurementsCountNoCheck(depotId, orgId, sensorId);</span>
<span class="nc bnc" id="L1773" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1774">      endTime = System.nanoTime();</span>
<span class="nc" id="L1775">      diff = endTime - startTime;</span>
<span class="nc" id="L1776">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1777">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1780">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getMeasurementsCount(java.lang
   * .String, java.lang.String, java.lang.String, java.util.Date,
   * java.util.Date)
   */
  @Override
  public Long getMeasurementsCount(String depotId, String orgId, String sensorId, Date start,
      Date end, boolean check) throws IdNotFoundException {
<span class="nc" id="L1794">    Long startTime = 0l;</span>
<span class="nc" id="L1795">    Long endTime = 0l;</span>
<span class="nc" id="L1796">    Long diff = 0l;</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1798">      startTime = System.nanoTime();</span>
<span class="nc" id="L1799">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getMeasurementsCount(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1801">      padding += &quot;  &quot;;</span>
    }
<span class="nc bnc" id="L1803" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L1804">      getOrganization(orgId, check);</span>
<span class="nc" id="L1805">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L1806">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L1808">    Long ret = getMeasurementsCountNoCheck(depotId, orgId, sensorId, start, end);</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1810">      endTime = System.nanoTime();</span>
<span class="nc" id="L1811">      diff = endTime - startTime;</span>
<span class="nc" id="L1812">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1813">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCount(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1816">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @return the number of measurements made by the given sensor stored in the
   *         given depository.
   */
  private Long getMeasurementsCountNoCheck(String depotId, String orgId, String sensorId) {
<span class="nc" id="L1827">    Long startTime = 0l;</span>
<span class="nc" id="L1828">    Long endTime = 0l;</span>
<span class="nc" id="L1829">    Long diff = 0l;</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1831">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsCountNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1833">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1834">      startTime = System.nanoTime();</span>
    }
<span class="nc" id="L1836">    Long ret = null;</span>
<span class="nc" id="L1837">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1838">    session.beginTransaction();</span>
<span class="nc" id="L1839">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="nc" id="L1840">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1842">    List&lt;Long&gt; result = (List&lt;Long&gt;) session</span>
        .createQuery(
            &quot;SELECT count(*) FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).list();
<span class="nc" id="L1846">    ret = result.get(0);</span>
<span class="nc" id="L1847">    session.getTransaction().commit();</span>
<span class="nc" id="L1848">    session.close();</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1850">      endTime = System.nanoTime();</span>
<span class="nc" id="L1851">      diff = endTime - startTime;</span>
<span class="nc" id="L1852">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1853">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCountNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1856">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @param start The start of the interval.
   * @param end The end of the interval.
   * @return a list of the measurements made by the given sensor stored in the
   *         given depository during the interval.
   */
  private Long getMeasurementsCountNoCheck(String depotId, String orgId, String sensorId,
      Date start, Date end) {
<span class="nc" id="L1870">    Long startTime = 0l;</span>
<span class="nc" id="L1871">    Long endTime = 0l;</span>
<span class="nc" id="L1872">    Long diff = 0l;</span>
<span class="nc bnc" id="L1873" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1874">      startTime = System.nanoTime();</span>
<span class="nc" id="L1875">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getMeasurementsCountNoCheck(&quot; + depotId</span>
          + &quot;, &quot; + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1877">      padding += &quot;  &quot;;</span>
    }
<span class="nc" id="L1879">    Long ret = null;</span>
<span class="nc" id="L1880">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="nc" id="L1881">    session.beginTransaction();</span>
<span class="nc" id="L1882">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="nc" id="L1883">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
<span class="nc" id="L1884">    Long result = (Long) session</span>
        .createQuery(
            &quot;SELECT count(*) FROM MeasurementImpl WHERE timestamp &gt;= :start AND timestamp &lt;= :end AND depository = :depository AND sensor = :sensor&quot;)
        .setParameter(&quot;start&quot;, start).setParameter(&quot;end&quot;, end).setParameter(&quot;depository&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).iterate().next();
<span class="nc" id="L1889">    ret = result;</span>
<span class="nc" id="L1890">    session.getTransaction().commit();</span>
<span class="nc" id="L1891">    session.close();</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1893">      endTime = System.nanoTime();</span>
<span class="nc" id="L1894">      diff = endTime - startTime;</span>
<span class="nc" id="L1895">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1896">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsCountNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L1899">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The Organization's id.
   * @param sensorId The sensor's id.
   * @return a List of all the Measurements.
   */
  private List&lt;Measurement&gt; getMeasurementsNoCheck(String depotId, String orgId, String sensorId) {
<span class="fc" id="L1909">    List&lt;Measurement&gt; ret = new ArrayList&lt;Measurement&gt;();</span>
<span class="fc" id="L1910">    Long startTime = 0l;</span>
<span class="fc" id="L1911">    Long endTime = 0l;</span>
<span class="fc" id="L1912">    Long diff = 0l;</span>
<span class="pc bpc" id="L1913" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1914">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1916">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1917">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1919">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1920">    session.beginTransaction();</span>
<span class="fc" id="L1921">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1922">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1924">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;depot&quot;, depot).setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L1927" title="All 2 branches covered.">    for (MeasurementImpl mi : result) {</span>
<span class="fc" id="L1928">      ret.add(mi.toMeasurement());</span>
<span class="fc" id="L1929">    }</span>
<span class="fc" id="L1930">    session.getTransaction().commit();</span>
<span class="fc" id="L1931">    session.close();</span>
<span class="pc bpc" id="L1932" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1933">      endTime = System.nanoTime();</span>
<span class="nc" id="L1934">      diff = endTime - startTime;</span>
<span class="nc" id="L1935">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1936">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1939">    return ret;</span>
  }

  /**
   * @param depotId The depository's id.
   * @param orgId The organization's id.
   * @param sensorId The sensor's id.
   * @param start The start of the interval.
   * @param end The end of the interval.
   * @return All the measurements during the interval for the given depository,
   *         organization and sensor.
   */
  private List&lt;Measurement&gt; getMeasurementsNoCheck(String depotId, String orgId, String sensorId,
      Date start, Date end) {
<span class="fc" id="L1953">    Long startTime = 0l;</span>
<span class="fc" id="L1954">    Long endTime = 0l;</span>
<span class="fc" id="L1955">    Long diff = 0l;</span>
<span class="pc bpc" id="L1956" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1957">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot;</span>
          + orgId + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L1959">      padding += &quot;  &quot;;</span>
<span class="nc" id="L1960">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L1962">    List&lt;Measurement&gt; ret = new ArrayList&lt;Measurement&gt;();</span>
<span class="fc" id="L1963">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L1964">    session.beginTransaction();</span>
<span class="fc" id="L1965">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L1966">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1968">    List&lt;MeasurementImpl&gt; measurements = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp &gt;= :start AND timestamp &lt;= :end AND depository = :depository AND sensor = :sensor&quot;)
        .setParameter(&quot;start&quot;, start).setParameter(&quot;end&quot;, end).setParameter(&quot;depository&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L1973" title="All 2 branches covered.">    for (MeasurementImpl mi : measurements) {</span>
<span class="fc" id="L1974">      ret.add(mi.toMeasurement());</span>
<span class="fc" id="L1975">    }</span>
<span class="fc" id="L1976">    session.getTransaction().commit();</span>
<span class="fc" id="L1977">    session.close();</span>
<span class="pc bpc" id="L1978" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1979">      endTime = System.nanoTime();</span>
<span class="nc" id="L1980">      diff = endTime - startTime;</span>
<span class="nc" id="L1981">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L1982">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementsNoCheck(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L1985">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getMeasurementType(java.lang.String)
   */
  @Override
  public MeasurementType getMeasurementType(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L1995">    Long startTime = 0l;</span>
<span class="fc" id="L1996">    Long endTime = 0l;</span>
<span class="fc" id="L1997">    Long diff = 0l;</span>
<span class="pc bpc" id="L1998" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L1999">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementType(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2000">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2001">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2003">    MeasurementType ret = null;</span>
<span class="fc" id="L2004">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2005">    sessionOpen++;</span>
<span class="fc" id="L2006">    session.beginTransaction();</span>
<span class="fc" id="L2007">    MeasurementTypeImpl impl = retrieveMeasurementType(session, id);</span>
<span class="fc bfc" id="L2008" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2009">      ret = impl.toMeasurementType();</span>
    }
<span class="fc" id="L2011">    session.getTransaction().commit();</span>
<span class="fc" id="L2012">    session.close();</span>
<span class="fc" id="L2013">    sessionClose++;</span>
<span class="fc bfc" id="L2014" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2015">      throw new IdNotFoundException(id + &quot; is not a defined MeasurementType.&quot;);</span>
    }
<span class="pc bpc" id="L2017" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2018">      endTime = System.nanoTime();</span>
<span class="nc" id="L2019">      diff = endTime - startTime;</span>
<span class="nc" id="L2020">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2021">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementType(&quot; + id + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2024">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getMeasurementTypes()
   */
  @Override
  public List&lt;MeasurementType&gt; getMeasurementTypes() {
<span class="fc" id="L2034">    Long startTime = 0l;</span>
<span class="fc" id="L2035">    Long endTime = 0l;</span>
<span class="fc" id="L2036">    Long diff = 0l;</span>
<span class="pc bpc" id="L2037" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2038">      timingLogger.log(Level.SEVERE, padding + &quot;Start getMeasurementTypes()&quot;);</span>
<span class="nc" id="L2039">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2040">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2042">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2043">    sessionOpen++;</span>
<span class="fc" id="L2044">    session.beginTransaction();</span>
<span class="fc" id="L2045">    List&lt;MeasurementTypeImpl&gt; ret = retrieveMeasurementTypes(session);</span>
<span class="fc" id="L2046">    List&lt;MeasurementType&gt; types = new ArrayList&lt;MeasurementType&gt;();</span>
<span class="fc bfc" id="L2047" title="All 2 branches covered.">    for (MeasurementTypeImpl i : ret) {</span>
<span class="fc" id="L2048">      types.add(i.toMeasurementType());</span>
<span class="fc" id="L2049">    }</span>
<span class="fc" id="L2050">    session.getTransaction().commit();</span>
<span class="fc" id="L2051">    session.close();</span>
<span class="fc" id="L2052">    sessionClose++;</span>
<span class="pc bpc" id="L2053" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2054">      endTime = System.nanoTime();</span>
<span class="nc" id="L2055">      diff = endTime - startTime;</span>
<span class="nc" id="L2056">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2057">      timingLogger.log(Level.SEVERE, padding + &quot;getMeasurementTypes() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2060">    return types;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getOrganization(java.lang.String)
   */
  @Override
  public Organization getOrganization(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2070">    Long startTime = 0l;</span>
<span class="fc" id="L2071">    Long endTime = 0l;</span>
<span class="fc" id="L2072">    Long diff = 0l;</span>
<span class="pc bpc" id="L2073" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2074">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganization(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2075">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2077">    Organization ret = cache.getOrganization(id);</span>
<span class="fc bfc" id="L2078" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2079">      Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2080">      sessionOpen++;</span>
<span class="fc" id="L2081">      session.beginTransaction();</span>
<span class="fc" id="L2082">      OrganizationImpl org = retrieveOrganization(session, id);</span>
<span class="fc bfc" id="L2083" title="All 2 branches covered.">      if (org != null) {</span>
<span class="fc" id="L2084">        ret = org.toOrganization();</span>
      }
<span class="fc" id="L2086">      session.getTransaction().commit();</span>
<span class="fc" id="L2087">      session.close();</span>
<span class="fc" id="L2088">      sessionClose++;</span>
<span class="fc bfc" id="L2089" title="All 2 branches covered.">      if (ret == null) {</span>
<span class="fc" id="L2090">        throw new IdNotFoundException(id + &quot; isn't a defined Organization's id.&quot;);</span>
      }
<span class="fc" id="L2092">      cache.putOrganization(ret);</span>
    }
<span class="pc bpc" id="L2094" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2095">      endTime = System.nanoTime();</span>
<span class="nc" id="L2096">      diff = endTime - startTime;</span>
<span class="nc" id="L2097">      timingLogger.log(Level.SEVERE, padding + &quot;getOrganization(&quot; + id + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2100">    return ret;</span>
  }

  /*
   * (non-Javadoc)m
   * 
   * @see org.wattdepot.server.WattDepot#getOrganizationIds()
   */
  @Override
  public List&lt;String&gt; getOrganizationIds() {
<span class="fc" id="L2110">    Long startTime = 0l;</span>
<span class="fc" id="L2111">    Long endTime = 0l;</span>
<span class="fc" id="L2112">    Long diff = 0l;</span>
<span class="pc bpc" id="L2113" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2114">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganizationIds()&quot;);</span>
<span class="nc" id="L2115">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2116">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2118">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2119" title="All 2 branches covered.">    for (Organization u : getOrganizations()) {</span>
<span class="fc" id="L2120">      ret.add(u.getId());</span>
<span class="fc" id="L2121">    }</span>
<span class="pc bpc" id="L2122" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2123">      endTime = System.nanoTime();</span>
<span class="nc" id="L2124">      diff = endTime - startTime;</span>
<span class="nc" id="L2125">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2126">      timingLogger.log(Level.SEVERE, padding + &quot;getOrganizationIds() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2129">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getOrganizations()
   */
  @Override
  public List&lt;Organization&gt; getOrganizations() {
<span class="fc" id="L2139">    Long startTime = 0l;</span>
<span class="fc" id="L2140">    Long endTime = 0l;</span>
<span class="fc" id="L2141">    Long diff = 0l;</span>
<span class="pc bpc" id="L2142" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2143">      timingLogger.log(Level.SEVERE, padding + &quot;Start getOrganizations()&quot;);</span>
<span class="nc" id="L2144">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2145">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2147">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2148">    sessionOpen++;</span>
<span class="fc" id="L2149">    session.beginTransaction();</span>
<span class="fc" id="L2150">    List&lt;OrganizationImpl&gt; r = retrieveOrganizations(session);</span>
<span class="fc" id="L2151">    List&lt;Organization&gt; ret = new ArrayList&lt;Organization&gt;();</span>
<span class="fc bfc" id="L2152" title="All 2 branches covered.">    for (OrganizationImpl o : r) {</span>
<span class="fc" id="L2153">      ret.add(o.toOrganization());</span>
<span class="fc" id="L2154">    }</span>
<span class="fc" id="L2155">    session.getTransaction().commit();</span>
<span class="fc" id="L2156">    session.close();</span>
<span class="fc" id="L2157">    sessionClose++;</span>
<span class="pc bpc" id="L2158" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2159">      endTime = System.nanoTime();</span>
<span class="nc" id="L2160">      diff = endTime - startTime;</span>
<span class="nc" id="L2161">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2162">      timingLogger</span>
          .log(Level.SEVERE, padding + &quot;getOrganizations() took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2165">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#getRateSummary(java.lang.String,
   * java.lang.String, java.lang.String)
   */
  @Override
  public MeasurementRateSummary getRateSummary(String depotId, String orgId, String sensorId,
      boolean check) throws IdNotFoundException, NoMeasurementException {
<span class="nc" id="L2178">    Long startTime = 0l;</span>
<span class="nc" id="L2179">    Long endTime = 0l;</span>
<span class="nc" id="L2180">    Long diff = 0l;</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2182">      startTime = System.nanoTime();</span>
<span class="nc" id="L2183">      timingLogger.log(Level.SEVERE, padding + &quot;Starting getRateSummary(&quot; + depotId + &quot;, &quot; + orgId</span>
          + &quot;, &quot; + sensorId + &quot;)&quot;);
<span class="nc" id="L2185">      padding += &quot;  &quot;;</span>
    }
<span class="nc bnc" id="L2187" title="All 2 branches missed.">    if (check) {</span>
<span class="nc" id="L2188">      getOrganization(orgId, check);</span>
<span class="nc" id="L2189">      getDepository(depotId, orgId, check);</span>
<span class="nc" id="L2190">      getSensor(sensorId, orgId, check);</span>
    }
<span class="nc" id="L2192">    XMLGregorianCalendar now = Tstamp.makeTimestamp();</span>
<span class="nc" id="L2193">    XMLGregorianCalendar minAgo = Tstamp.incrementMinutes(now, -1);</span>
<span class="nc" id="L2194">    MeasurementRateSummary ret = new MeasurementRateSummary();</span>
<span class="nc" id="L2195">    ret.setDepositoryId(depotId);</span>
<span class="nc" id="L2196">    ret.setSensorId(sensorId);</span>
<span class="nc" id="L2197">    ret.setTimestamp(DateConvert.convertXMLCal(now));</span>
<span class="nc" id="L2198">    Long count = getMeasurementsCountNoCheck(depotId, orgId, sensorId,</span>
        DateConvert.convertXMLCal(minAgo), DateConvert.convertXMLCal(now));
<span class="nc" id="L2200">    ret.setOneMinuteCount(count);</span>
<span class="nc" id="L2201">    ret.setOneMinuteRate(count / 60.0);</span>
<span class="nc" id="L2202">    InterpolatedValue val = getLatestMeasuredValueNoCheck(depotId, orgId, sensorId);</span>
<span class="nc" id="L2203">    ret.setLatestValue(val.getValue());</span>
<span class="nc" id="L2204">    ret.setType(val.getMeasurementType());</span>
<span class="nc" id="L2205">    count = getMeasurementsCountNoCheck(depotId, orgId, sensorId);</span>
<span class="nc" id="L2206">    ret.setTotalCount(count);</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2208">      endTime = System.nanoTime();</span>
<span class="nc" id="L2209">      diff = endTime - startTime;</span>
<span class="nc" id="L2210">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2211">      timingLogger.log(Level.SEVERE, padding + &quot;getRateSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L2214">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensor(java.lang.String,
   * java.lang.String)
   */
  @Override
  public Sensor getSensor(String id, String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2225">    Long startTime = 0l;</span>
<span class="fc" id="L2226">    Long endTime = 0l;</span>
<span class="fc" id="L2227">    Long diff = 0l;</span>
<span class="pc bpc" id="L2228" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2229">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensor(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2230">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2231">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2233" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2234">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2236">    Sensor ret = cache.getSensor(id, orgId);</span>
<span class="fc bfc" id="L2237" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2238">      ret = getSensorNoCheck(id, orgId);</span>
<span class="pc bpc" id="L2239" title="1 of 2 branches missed.">      if (ret != null) {</span>
<span class="nc" id="L2240">        cache.putSensor(ret);</span>
      }
    }
<span class="fc bfc" id="L2243" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2244">      throw new IdNotFoundException(id + &quot; is not a defined Sensor id.&quot;);</span>
    }
<span class="pc bpc" id="L2246" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2247">      endTime = System.nanoTime();</span>
<span class="nc" id="L2248">      diff = endTime - startTime;</span>
<span class="nc" id="L2249">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2250">      timingLogger.log(Level.SEVERE, padding + &quot;getSensor(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2253">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroup(java.lang.String,
   * java.lang.String)
   */
  @Override
  public SensorGroup getSensorGroup(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L2265">    Long startTime = 0l;</span>
<span class="fc" id="L2266">    Long endTime = 0l;</span>
<span class="fc" id="L2267">    Long diff = 0l;</span>
<span class="pc bpc" id="L2268" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2269">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroup(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2270">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2271">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L2273" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2274">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2276">    SensorGroup ret = getSensorGroupNoCheck(id, orgId);</span>
<span class="pc bpc" id="L2277" title="1 of 4 branches missed.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2278">      throw new IdNotFoundException(id + &quot; is not a defined SensorGroup id.&quot;);</span>
    }
<span class="pc bpc" id="L2280" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2281">      endTime = System.nanoTime();</span>
<span class="nc" id="L2282">      diff = endTime - startTime;</span>
<span class="nc" id="L2283">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2284">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroup(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2287">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroupIds()
   */
  @Override
  public List&lt;String&gt; getSensorGroupIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2297">    Long startTime = 0l;</span>
<span class="fc" id="L2298">    Long endTime = 0l;</span>
<span class="fc" id="L2299">    Long diff = 0l;</span>
<span class="pc bpc" id="L2300" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2301">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2302">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2303">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L2305" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2306">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2308">    List&lt;String&gt; ret = getSensorGroupIdsNoCheck(orgId);</span>
<span class="pc bpc" id="L2309" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2310">      endTime = System.nanoTime();</span>
<span class="nc" id="L2311">      diff = endTime - startTime;</span>
<span class="nc" id="L2312">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2313">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2316">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return A List of the SensorGroups' ids.
   */
  private List&lt;String&gt; getSensorGroupIdsNoCheck(String orgId) {
<span class="fc" id="L2324">    Long startTime = 0l;</span>
<span class="fc" id="L2325">    Long endTime = 0l;</span>
<span class="fc" id="L2326">    Long diff = 0l;</span>
<span class="pc bpc" id="L2327" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2328">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2329">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2330">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2332">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2333" title="All 2 branches covered.">    for (SensorGroup s : getSensorGroupsNoCheck(orgId)) {</span>
<span class="fc" id="L2334">      ret.add(s.getId());</span>
<span class="fc" id="L2335">    }</span>
<span class="pc bpc" id="L2336" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2337">      endTime = System.nanoTime();</span>
<span class="nc" id="L2338">      diff = endTime - startTime;</span>
<span class="nc" id="L2339">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2340">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupIds(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2343">    return ret;</span>
  }

  /**
   * @param id The sensor group's id.
   * @param orgId The organization's id.
   * @return The defined SensorGroup or null.
   */
  private SensorGroup getSensorGroupNoCheck(String id, String orgId) {
<span class="fc" id="L2352">    Long startTime = 0l;</span>
<span class="fc" id="L2353">    Long endTime = 0l;</span>
<span class="fc" id="L2354">    Long diff = 0l;</span>
<span class="pc bpc" id="L2355" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2356">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;)&quot;);
<span class="nc" id="L2358">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2359">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2361">    SensorGroup ret = null;</span>
<span class="fc" id="L2362">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2363">    sessionOpen++;</span>
<span class="fc" id="L2364">    session.beginTransaction();</span>
<span class="fc" id="L2365">    SensorGroupImpl impl = retrieveSensorGroup(session, id, orgId);</span>
<span class="fc bfc" id="L2366" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2367">      ret = impl.toSensorGroup();</span>
    }
<span class="fc" id="L2369">    session.getTransaction().commit();</span>
<span class="fc" id="L2370">    session.close();</span>
<span class="fc" id="L2371">    sessionClose++;</span>
<span class="pc bpc" id="L2372" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2373">      endTime = System.nanoTime();</span>
<span class="nc" id="L2374">      diff = endTime - startTime;</span>
<span class="nc" id="L2375">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2376">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupNoCheck(&quot; + id + &quot;, &quot; + orgId</span>
          + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2379">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorGroups(java.lang.String)
   */
  @Override
  public List&lt;SensorGroup&gt; getSensorGroups(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2389">    Long startTime = 0l;</span>
<span class="fc" id="L2390">    Long endTime = 0l;</span>
<span class="fc" id="L2391">    Long diff = 0l;</span>
<span class="pc bpc" id="L2392" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2393">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroups(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2394">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2395">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2397" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2398">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2400">    List&lt;SensorGroup&gt; ret = getSensorGroupsNoCheck(orgId);</span>
<span class="pc bpc" id="L2401" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2402">      endTime = System.nanoTime();</span>
<span class="nc" id="L2403">      diff = endTime - startTime;</span>
<span class="nc" id="L2404">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2405">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroups(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2408">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return All the defined SensorGroups.
   */
  private List&lt;SensorGroup&gt; getSensorGroupsNoCheck(String orgId) {
<span class="fc" id="L2416">    Long startTime = 0l;</span>
<span class="fc" id="L2417">    Long endTime = 0l;</span>
<span class="fc" id="L2418">    Long diff = 0l;</span>
<span class="pc bpc" id="L2419" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2420">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorGroupsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2421">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2422">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2424">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2425">    sessionOpen++;</span>
<span class="fc" id="L2426">    session.beginTransaction();</span>
<span class="fc" id="L2427">    List&lt;SensorGroupImpl&gt; r = retrieveSensorGroups(session, orgId);</span>
<span class="fc" id="L2428">    List&lt;SensorGroup&gt; ret = new ArrayList&lt;SensorGroup&gt;();</span>
<span class="fc bfc" id="L2429" title="All 2 branches covered.">    for (SensorGroupImpl s : r) {</span>
<span class="fc" id="L2430">      ret.add(s.toSensorGroup());</span>
<span class="fc" id="L2431">    }</span>
<span class="fc" id="L2432">    session.getTransaction().commit();</span>
<span class="fc" id="L2433">    session.close();</span>
<span class="fc" id="L2434">    sessionClose++;</span>
<span class="pc bpc" id="L2435" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2436">      endTime = System.nanoTime();</span>
<span class="nc" id="L2437">      diff = endTime - startTime;</span>
<span class="nc" id="L2438">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2439">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorGroupsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2442">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorIds()
   */
  @Override
  public List&lt;String&gt; getSensorIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2452">    Long startTime = 0l;</span>
<span class="fc" id="L2453">    Long endTime = 0l;</span>
<span class="fc" id="L2454">    Long diff = 0l;</span>
<span class="pc bpc" id="L2455" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2456">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2457">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2458">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2460">    List&lt;String&gt; ret = getSensorIdsNoCheck(orgId);</span>
<span class="pc bpc" id="L2461" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2462">      endTime = System.nanoTime();</span>
<span class="nc" id="L2463">      diff = endTime - startTime;</span>
<span class="nc" id="L2464">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2465">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorIds(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2468">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return The defined Sensors' ids.
   */
  private List&lt;String&gt; getSensorIdsNoCheck(String orgId) {
<span class="fc" id="L2476">    Long startTime = 0l;</span>
<span class="fc" id="L2477">    Long endTime = 0l;</span>
<span class="fc" id="L2478">    Long diff = 0l;</span>
<span class="pc bpc" id="L2479" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2480">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorIdsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2481">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2482">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2484">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2485" title="All 2 branches covered.">    for (Sensor s : getSensorsNoCheck(orgId)) {</span>
<span class="fc" id="L2486">      ret.add(s.getId());</span>
<span class="fc" id="L2487">    }</span>
<span class="pc bpc" id="L2488" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2489">      endTime = System.nanoTime();</span>
<span class="nc" id="L2490">      diff = endTime - startTime;</span>
<span class="nc" id="L2491">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2492">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorIdsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2495">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModel(java.lang.String,
   * java.lang.String)
   */
  @Override
  public SensorModel getSensorModel(String id, boolean check) throws IdNotFoundException {
<span class="fc" id="L2506">    Long startTime = 0l;</span>
<span class="fc" id="L2507">    Long endTime = 0l;</span>
<span class="fc" id="L2508">    Long diff = 0l;</span>
<span class="pc bpc" id="L2509" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2510">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModel(&quot; + id + &quot;)&quot;);</span>
<span class="nc" id="L2511">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2512">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2514">    SensorModel ret = null;</span>
<span class="fc" id="L2515">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2516">    sessionOpen++;</span>
<span class="fc" id="L2517">    session.beginTransaction();</span>
<span class="fc" id="L2518">    SensorModelImpl impl = retrieveSensorModel(session, id);</span>
<span class="fc bfc" id="L2519" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2520">      ret = impl.toSensorModel();</span>
    }
<span class="fc" id="L2522">    session.getTransaction().commit();</span>
<span class="fc" id="L2523">    session.close();</span>
<span class="fc" id="L2524">    sessionClose++;</span>
<span class="fc bfc" id="L2525" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2526">      throw new IdNotFoundException(id + &quot; is not a valid SensorModel id.&quot;);</span>
    }
<span class="pc bpc" id="L2528" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2529">      endTime = System.nanoTime();</span>
<span class="nc" id="L2530">      diff = endTime - startTime;</span>
<span class="nc" id="L2531">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2532">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModel(&quot; + id + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2535">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModelIds()
   */
  @Override
  public List&lt;String&gt; getSensorModelIds() {
<span class="fc" id="L2545">    Long startTime = 0l;</span>
<span class="fc" id="L2546">    Long endTime = 0l;</span>
<span class="fc" id="L2547">    Long diff = 0l;</span>
<span class="pc bpc" id="L2548" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2549">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModelIds()&quot;);</span>
<span class="nc" id="L2550">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2551">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2553">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2554" title="All 2 branches covered.">    for (SensorModel s : getSensorModels()) {</span>
<span class="fc" id="L2555">      ret.add(s.getId());</span>
<span class="fc" id="L2556">    }</span>
<span class="pc bpc" id="L2557" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2558">      endTime = System.nanoTime();</span>
<span class="nc" id="L2559">      diff = endTime - startTime;</span>
<span class="nc" id="L2560">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2561">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModelIds() took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2564">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensorModels(java.lang.String)
   */
  @Override
  public List&lt;SensorModel&gt; getSensorModels() {
<span class="fc" id="L2574">    Long startTime = 0l;</span>
<span class="fc" id="L2575">    Long endTime = 0l;</span>
<span class="fc" id="L2576">    Long diff = 0l;</span>
<span class="pc bpc" id="L2577" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2578">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorModels()&quot;);</span>
<span class="nc" id="L2579">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2580">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2582">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2583">    sessionOpen++;</span>
<span class="fc" id="L2584">    session.beginTransaction();</span>
<span class="fc" id="L2585">    List&lt;SensorModelImpl&gt; r = retrieveSensorModels(session);</span>
<span class="fc" id="L2586">    List&lt;SensorModel&gt; ret = new ArrayList&lt;SensorModel&gt;();</span>
<span class="fc bfc" id="L2587" title="All 2 branches covered.">    for (SensorModelImpl s : r) {</span>
<span class="fc" id="L2588">      ret.add(s.toSensorModel());</span>
<span class="fc" id="L2589">    }</span>
<span class="fc" id="L2590">    session.getTransaction().commit();</span>
<span class="fc" id="L2591">    session.close();</span>
<span class="fc" id="L2592">    sessionClose++;</span>
<span class="pc bpc" id="L2593" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2594">      endTime = System.nanoTime();</span>
<span class="nc" id="L2595">      diff = endTime - startTime;</span>
<span class="nc" id="L2596">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2597">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorModels() took &quot; + (diff / 1E9) + &quot; secs.&quot;);</span>
    }
<span class="fc" id="L2599">    return ret;</span>
  }

  /**
   * @param id The sensor's id.
   * @param orgId The organization's id.
   * @return The defined Sensor or null.
   */
  private Sensor getSensorNoCheck(String id, String orgId) {
<span class="fc" id="L2608">    Long startTime = 0l;</span>
<span class="fc" id="L2609">    Long endTime = 0l;</span>
<span class="fc" id="L2610">    Long diff = 0l;</span>
<span class="pc bpc" id="L2611" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2612">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorNoCheck(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2613">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2615">    Sensor ret = null;</span>
<span class="fc" id="L2616">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2617">    sessionOpen++;</span>
<span class="fc" id="L2618">    session.beginTransaction();</span>
<span class="fc" id="L2619">    SensorImpl impl = retrieveSensor(session, id, orgId);</span>
<span class="pc bpc" id="L2620" title="1 of 2 branches missed.">    if (impl != null) {</span>
<span class="nc" id="L2621">      ret = impl.toSensor();</span>
    }
<span class="fc" id="L2623">    session.getTransaction().commit();</span>
<span class="fc" id="L2624">    session.close();</span>
<span class="fc" id="L2625">    sessionClose++;</span>
<span class="pc bpc" id="L2626" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2627">      endTime = System.nanoTime();</span>
<span class="nc" id="L2628">      diff = endTime - startTime;</span>
<span class="nc" id="L2629">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorNoCheck(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2632">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getSensors(java.lang.String)
   */
  @Override
  public List&lt;Sensor&gt; getSensors(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2642">    Long startTime = 0l;</span>
<span class="fc" id="L2643">    Long endTime = 0l;</span>
<span class="fc" id="L2644">    Long diff = 0l;</span>
<span class="pc bpc" id="L2645" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2646">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensors(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2647">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2648">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2650" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2651">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2653">    List&lt;Sensor&gt; ret = getSensorsNoCheck(orgId);</span>
<span class="pc bpc" id="L2654" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2655">      endTime = System.nanoTime();</span>
<span class="nc" id="L2656">      diff = endTime - startTime;</span>
<span class="nc" id="L2657">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2658">      timingLogger.log(Level.SEVERE, padding + &quot;getSensors(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2661">    return ret;</span>
  }

  /**
   * @param orgId The organization's id.
   * @return A list of the defined Sensors.
   */
  private List&lt;Sensor&gt; getSensorsNoCheck(String orgId) {
<span class="fc" id="L2669">    Long startTime = 0l;</span>
<span class="fc" id="L2670">    Long endTime = 0l;</span>
<span class="fc" id="L2671">    Long diff = 0l;</span>
<span class="pc bpc" id="L2672" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2673">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSensorsNoCheck(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2674">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2675">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2677">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2678">    sessionOpen++;</span>
<span class="fc" id="L2679">    session.beginTransaction();</span>
<span class="fc" id="L2680">    List&lt;SensorImpl&gt; r = retrieveSensors(session, orgId);</span>
<span class="fc" id="L2681">    List&lt;Sensor&gt; ret = new ArrayList&lt;Sensor&gt;();</span>
<span class="fc bfc" id="L2682" title="All 2 branches covered.">    for (SensorImpl s : r) {</span>
<span class="fc" id="L2683">      ret.add(s.toSensor());</span>
<span class="fc" id="L2684">    }</span>
<span class="fc" id="L2685">    session.getTransaction().commit();</span>
<span class="fc" id="L2686">    session.close();</span>
<span class="fc" id="L2687">    sessionClose++;</span>
<span class="pc bpc" id="L2688" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2689">      endTime = System.nanoTime();</span>
<span class="nc" id="L2690">      diff = endTime - startTime;</span>
<span class="nc" id="L2691">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2692">      timingLogger.log(Level.SEVERE, padding + &quot;getSensorsNoCheck(&quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2695">    return ret;</span>
  }

  /**
   * @return the sessionClose
   */
  public int getSessionClose() {
<span class="fc" id="L2702">    return sessionClose;</span>
  }

  /**
   * @return the sessionOpen
   */
  public int getSessionOpen() {
<span class="fc" id="L2709">    return sessionOpen;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getSummary(java.lang.String,
   * java.lang.String, java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public SensorMeasurementSummary getSummary(String depotId, String orgId, String sensorId,
      Date start, Date end, boolean check) throws IdNotFoundException {
<span class="nc" id="L2721">    Long startTime = 0l;</span>
<span class="nc" id="L2722">    Long endTime = 0l;</span>
<span class="nc" id="L2723">    Long diff = 0l;</span>
<span class="nc bnc" id="L2724" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2725">      timingLogger.log(Level.SEVERE, padding + &quot;Start getSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;)&quot;);
<span class="nc" id="L2727">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2728">      startTime = System.nanoTime();</span>
    }
<span class="nc" id="L2730">    List&lt;Measurement&gt; list = getMeasurements(depotId, orgId, sensorId, start, end, check);</span>
<span class="nc" id="L2731">    SensorMeasurementSummary ret = new SensorMeasurementSummary(sensorId, depotId, start, end,</span>
        list.size());
<span class="nc bnc" id="L2733" title="All 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2734">      endTime = System.nanoTime();</span>
<span class="nc" id="L2735">      diff = endTime - startTime;</span>
<span class="nc" id="L2736">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2737">      timingLogger.log(Level.SEVERE, padding + &quot;getSummary(&quot; + depotId + &quot;, &quot; + orgId + &quot;, &quot;</span>
          + sensorId + &quot;) took &quot; + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="nc" id="L2740">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUser(java.lang.String)
   */
  @Override
  public UserInfo getUser(String id, String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2750">    Long startTime = 0l;</span>
<span class="fc" id="L2751">    Long endTime = 0l;</span>
<span class="fc" id="L2752">    Long diff = 0l;</span>
<span class="pc bpc" id="L2753" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2754">      timingLogger.log(Level.SEVERE, padding + &quot;Start getUser(&quot; + id + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2755">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2756">      startTime = System.nanoTime();</span>
    }
<span class="fc bfc" id="L2758" title="All 2 branches covered.">    if (check) {</span>
<span class="fc" id="L2759">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2761">    UserInfo ret = null;</span>
<span class="fc" id="L2762">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2763">    sessionOpen++;</span>
<span class="fc" id="L2764">    session.beginTransaction();</span>
<span class="fc" id="L2765">    UserInfoImpl impl = retrieveUser(session, id, orgId);</span>
<span class="fc bfc" id="L2766" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2767">      ret = impl.toUserInfo();</span>
    }
<span class="fc" id="L2769">    session.getTransaction().commit();</span>
<span class="fc" id="L2770">    session.close();</span>
<span class="fc" id="L2771">    sessionClose++;</span>
<span class="fc bfc" id="L2772" title="All 4 branches covered.">    if (check &amp;&amp; ret == null) {</span>
<span class="fc" id="L2773">      throw new IdNotFoundException(id + &quot; is not a defined user id.&quot;);</span>
    }
<span class="pc bpc" id="L2775" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2776">      endTime = System.nanoTime();</span>
<span class="nc" id="L2777">      diff = endTime - startTime;</span>
<span class="nc" id="L2778">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2779">      timingLogger.log(Level.SEVERE, padding + &quot;getUser(&quot; + id + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L2782">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUserIds()
   */
  @Override
  public List&lt;String&gt; getUserIds(String orgId, boolean check) throws IdNotFoundException {
<span class="fc" id="L2792">    Long startTime = 0l;</span>
<span class="fc" id="L2793">    Long endTime = 0l;</span>
<span class="fc" id="L2794">    Long diff = 0l;</span>
<span class="pc bpc" id="L2795" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2796">      timingLogger.log(Level.SEVERE, padding + &quot;Start getUserIds(&quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L2797">      padding += &quot;  &quot;;</span>
<span class="nc" id="L2798">      startTime = System.nanoTime();</span>
    }
<span class="fc" id="L2800">    ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L2801" title="All 2 branches covered.">    for (UserInfo u : getUsers(orgId, check)) {</span>
<span class="fc" id="L2802">      ret.add(u.getUid());</span>
<span class="fc" id="L2803">    }</span>
<span class="pc bpc" id="L2804" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L2805">      endTime = System.nanoTime();</span>
<span class="nc" id="L2806">      diff = endTime - startTime;</span>
<span class="nc" id="L2807">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L2808">      timingLogger.log(Level.SEVERE, padding + &quot;getUserIds(&quot; + orgId + &quot;) took &quot; + (diff / 1E9)</span>
          + &quot; secs.&quot;);
    }
<span class="fc" id="L2811">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUserPassword(java.lang.String)
   */
  @Override
  public UserPassword getUserPassword(String id, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L2822">    UserPassword ret = null;</span>
<span class="fc" id="L2823">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2824">    sessionOpen++;</span>
<span class="fc" id="L2825">    session.beginTransaction();</span>
<span class="fc" id="L2826">    UserPasswordImpl impl = retrieveUserPassword(session, id, orgId);</span>
<span class="fc bfc" id="L2827" title="All 2 branches covered.">    if (impl != null) {</span>
<span class="fc" id="L2828">      ret = impl.toUserPassword();</span>
    }
<span class="fc" id="L2830">    session.getTransaction().commit();</span>
<span class="fc" id="L2831">    session.close();</span>
<span class="fc" id="L2832">    sessionClose++;</span>
<span class="fc bfc" id="L2833" title="All 2 branches covered.">    if (ret == null) {</span>
<span class="fc" id="L2834">      throw new IdNotFoundException(id + &quot; is not a valid UserPassword id.&quot;);</span>
    }
<span class="fc" id="L2836">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUsers()
   */
  @Override
  public List&lt;UserInfo&gt; getUsers() {
<span class="fc" id="L2846">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2847">    sessionOpen++;</span>
<span class="fc" id="L2848">    session.beginTransaction();</span>
<span class="fc" id="L2849">    List&lt;UserInfoImpl&gt; result = retrieveUsers(session);</span>
<span class="fc" id="L2850">    ArrayList&lt;UserInfo&gt; ret = new ArrayList&lt;UserInfo&gt;();</span>
<span class="pc bpc" id="L2851" title="1 of 2 branches missed.">    for (UserInfoImpl u : result) {</span>
<span class="nc" id="L2852">      ret.add(u.toUserInfo());</span>
<span class="nc" id="L2853">    }</span>
<span class="fc" id="L2854">    session.getTransaction().commit();</span>
<span class="fc" id="L2855">    session.close();</span>
<span class="fc" id="L2856">    sessionClose++;</span>
<span class="fc" id="L2857">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#getUsers()
   */
  @Override
  public List&lt;UserInfo&gt; getUsers(String orgId, boolean check) throws IdNotFoundException {
<span class="pc bpc" id="L2867" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2868">      getOrganization(orgId, check);</span>
    }
<span class="fc" id="L2870">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2871">    sessionOpen++;</span>
<span class="fc" id="L2872">    session.beginTransaction();</span>
<span class="fc" id="L2873">    List&lt;UserInfoImpl&gt; result = retrieveUsers(session, orgId);</span>
<span class="fc" id="L2874">    ArrayList&lt;UserInfo&gt; ret = new ArrayList&lt;UserInfo&gt;();</span>
<span class="fc bfc" id="L2875" title="All 2 branches covered.">    for (UserInfoImpl u : result) {</span>
<span class="fc" id="L2876">      ret.add(u.toUserInfo());</span>
<span class="fc" id="L2877">    }</span>
<span class="fc" id="L2878">    session.getTransaction().commit();</span>
<span class="fc" id="L2879">    session.close();</span>
<span class="fc" id="L2880">    sessionClose++;</span>
<span class="fc" id="L2881">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date timestamp,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="pc bpc" id="L2893" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L2894">      getOrganization(orgId, check);</span>
<span class="fc" id="L2895">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L2896">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L2898">    Double ret = null;</span>
<span class="fc" id="L2899">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L2900">    session.beginTransaction();</span>
<span class="fc" id="L2901">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L2902">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2904">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp = :time AND depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
<span class="fc bfc" id="L2909" title="All 2 branches covered.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L2910">      ret = result.get(0).getValue();</span>
    }
    else {
      // need to get the stradle
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2915">      List&lt;MeasurementImpl&gt; before = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &lt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L2921">      List&lt;MeasurementImpl&gt; after = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &gt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setMaxResults(1).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L2926">      MeasurementImpl justBefore = null;</span>
<span class="fc bfc" id="L2927" title="All 2 branches covered.">      for (MeasurementImpl b : before) {</span>
<span class="pc bpc" id="L2928" title="1 of 2 branches missed.">        if (b.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L2929" title="1 of 2 branches missed.">          if (justBefore == null) {</span>
<span class="fc" id="L2930">            justBefore = b;</span>
          }
<span class="nc bnc" id="L2932" title="All 2 branches missed.">          else if (b.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L2933">            justBefore = b;</span>
          }
        }
<span class="fc" id="L2936">      }</span>
<span class="fc bfc" id="L2937" title="All 2 branches covered.">      if (justBefore == null) {</span>
<span class="fc" id="L2938">        session.getTransaction().commit();</span>
<span class="fc" id="L2939">        session.close();</span>
<span class="fc" id="L2940">        throw new NoMeasurementException(&quot;Cannot find measurement before &quot; + timestamp);</span>
      }
<span class="fc" id="L2942">      MeasurementImpl justAfter = null;</span>
<span class="fc bfc" id="L2943" title="All 2 branches covered.">      for (MeasurementImpl a : after) {</span>
<span class="pc bpc" id="L2944" title="1 of 2 branches missed.">        if (a.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L2945" title="1 of 2 branches missed.">          if (justAfter == null) {</span>
<span class="fc" id="L2946">            justAfter = a;</span>
          }
<span class="nc bnc" id="L2948" title="All 2 branches missed.">          else if (a.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L2949">            justAfter = a;</span>
          }
        }
<span class="fc" id="L2952">      }</span>
<span class="fc bfc" id="L2953" title="All 2 branches covered.">      if (justAfter == null) {</span>
<span class="fc" id="L2954">        session.getTransaction().commit();</span>
<span class="fc" id="L2955">        session.close();</span>
<span class="fc" id="L2956">        throw new NoMeasurementException(&quot;Cannot find measurement after &quot; + timestamp);</span>
      }
<span class="fc" id="L2958">      Double val1 = justBefore.getValue();</span>
<span class="fc" id="L2959">      Double val2 = justAfter.getValue();</span>
<span class="fc" id="L2960">      Double deltaV = val2 - val1;</span>
<span class="fc" id="L2961">      Long t1 = justBefore.getTimestamp().getTime();</span>
<span class="fc" id="L2962">      Long t2 = justAfter.getTimestamp().getTime();</span>
<span class="fc" id="L2963">      Long deltaT = t2 - t1;</span>
<span class="fc" id="L2964">      Long t3 = timestamp.getTime();</span>
<span class="fc" id="L2965">      Long toDate = t3 - t1;</span>
<span class="fc" id="L2966">      Double slope = deltaV / deltaT;</span>
<span class="fc" id="L2967">      ret = val1 + slope * toDate;</span>
    }
<span class="fc" id="L2969">    session.getTransaction().commit();</span>
<span class="fc" id="L2970">    session.close();</span>
<span class="fc" id="L2971">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date start, Date end,
      boolean check) throws NoMeasurementException, IdNotFoundException {
<span class="fc" id="L2983">    Double endVal = getValue(depotId, orgId, sensorId, end, check);</span>
<span class="fc" id="L2984">    Double startVal = getValue(depotId, orgId, sensorId, start, check);</span>
<span class="pc bpc" id="L2985" title="2 of 4 branches missed.">    if (endVal != null &amp;&amp; startVal != null) {</span>
<span class="fc" id="L2986">      return endVal - startVal;</span>
    }
<span class="nc" id="L2988">    return null;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.util.Date, java.lang.Long)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date start, Date end,
      Long gapSeconds, boolean check) throws NoMeasurementException, MeasurementGapException,
      IdNotFoundException {
<span class="fc" id="L3001">    Double endVal = getValue(depotId, orgId, sensorId, end, gapSeconds, check);</span>
<span class="fc" id="L3002">    Double startVal = getValue(depotId, orgId, sensorId, start, gapSeconds, check);</span>
<span class="pc bpc" id="L3003" title="2 of 4 branches missed.">    if (endVal != null &amp;&amp; startVal != null) {</span>
<span class="fc" id="L3004">      return endVal - startVal;</span>
    }
<span class="nc" id="L3006">    return null;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#getValue(java.lang.String,
   * java.lang.String, java.util.Date, java.lang.Long)
   */
  @Override
  public Double getValue(String depotId, String orgId, String sensorId, Date timestamp,
      Long gapSeconds, boolean check) throws NoMeasurementException, MeasurementGapException,
      IdNotFoundException {
<span class="pc bpc" id="L3019" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L3020">      getOrganization(orgId, check);</span>
<span class="fc" id="L3021">      getDepository(depotId, orgId, check);</span>
<span class="fc" id="L3022">      getSensor(sensorId, orgId, check);</span>
    }
<span class="fc" id="L3024">    Double ret = null;</span>
<span class="fc" id="L3025">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3026">    session.beginTransaction();</span>
<span class="fc" id="L3027">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L3028">    SensorImpl sensor = retrieveSensor(session, sensorId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3030">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(
            &quot;FROM MeasurementImpl WHERE timestamp = :time AND depository = :depot AND sensor = :sensor&quot;)
        .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc bfc" id="L3035" title="All 2 branches covered.">    if (result.size() &gt; 0) {</span>
<span class="fc" id="L3036">      ret = result.get(0).getValue();</span>
    }
    else {
      // need to get the stradle
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3041">      List&lt;MeasurementImpl&gt; before = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &lt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp desc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).setMaxResults(1).list();
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3047">      List&lt;MeasurementImpl&gt; after = (List&lt;MeasurementImpl&gt;) session</span>
          .createQuery(
              &quot;FROM MeasurementImpl WHERE timestamp &gt;= :time AND depository = :depot AND sensor = :sensor ORDER BY timestamp asc&quot;)
          .setParameter(&quot;time&quot;, timestamp).setMaxResults(1).setParameter(&quot;depot&quot;, depot)
          .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L3052">      MeasurementImpl justBefore = null;</span>
<span class="fc bfc" id="L3053" title="All 2 branches covered.">      for (MeasurementImpl b : before) {</span>
<span class="pc bpc" id="L3054" title="1 of 2 branches missed.">        if (b.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3055" title="1 of 2 branches missed.">          if (justBefore == null) {</span>
<span class="fc" id="L3056">            justBefore = b;</span>
          }
<span class="nc bnc" id="L3058" title="All 2 branches missed.">          else if (b.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3059">            justBefore = b;</span>
          }
        }
<span class="fc" id="L3062">      }</span>
<span class="fc bfc" id="L3063" title="All 2 branches covered.">      if (justBefore == null) {</span>
<span class="fc" id="L3064">        session.getTransaction().commit();</span>
<span class="fc" id="L3065">        session.close();</span>
<span class="fc" id="L3066">        throw new NoMeasurementException(&quot;Cannot find measurement before &quot; + timestamp + &quot; in &quot; + depot.getName() + &quot; for &quot; + sensor.getName());</span>
      }
<span class="fc" id="L3068">      MeasurementImpl justAfter = null;</span>
<span class="fc bfc" id="L3069" title="All 2 branches covered.">      for (MeasurementImpl a : after) {</span>
<span class="pc bpc" id="L3070" title="1 of 2 branches missed.">        if (a.getSensor().getId().equals(sensorId)) {</span>
<span class="pc bpc" id="L3071" title="1 of 2 branches missed.">          if (justAfter == null) {</span>
<span class="fc" id="L3072">            justAfter = a;</span>
          }
<span class="nc bnc" id="L3074" title="All 2 branches missed.">          else if (a.getTimestamp().compareTo(justBefore.getTimestamp()) &gt; 0) {</span>
<span class="nc" id="L3075">            justAfter = a;</span>
          }
        }
<span class="fc" id="L3078">      }</span>
<span class="fc bfc" id="L3079" title="All 2 branches covered.">      if (justAfter == null) {</span>
<span class="fc" id="L3080">        session.getTransaction().commit();</span>
<span class="fc" id="L3081">        session.close();</span>
<span class="fc" id="L3082">        throw new NoMeasurementException(&quot;Cannot find measurement after &quot; + timestamp + &quot; in &quot; + depot.getName() + &quot; for &quot; + sensor.getName());</span>
      }
<span class="fc" id="L3084">      Double val1 = justBefore.getValue();</span>
<span class="fc" id="L3085">      Double val2 = justAfter.getValue();</span>
<span class="fc" id="L3086">      Double deltaV = val2 - val1;</span>
<span class="fc" id="L3087">      Long t1 = justBefore.getTimestamp().getTime();</span>
<span class="fc" id="L3088">      Long t2 = justAfter.getTimestamp().getTime();</span>
<span class="fc" id="L3089">      Long deltaT = t2 - t1;</span>
<span class="fc bfc" id="L3090" title="All 2 branches covered.">      if ((deltaT / 1000) &gt; gapSeconds) {</span>
<span class="fc" id="L3091">        session.getTransaction().commit();</span>
<span class="fc" id="L3092">        session.close();</span>
<span class="fc" id="L3093">        throw new MeasurementGapException(&quot;Gap of &quot; + (deltaT / 1000) + &quot;s is longer than &quot;</span>
            + gapSeconds + &quot; for &quot; + sensor.getName() + &quot; in &quot; + depot.getName());
      }
<span class="fc" id="L3096">      Long t3 = timestamp.getTime();</span>
<span class="fc" id="L3097">      Long toDate = t3 - t1;</span>
<span class="fc" id="L3098">      Double slope = deltaV / deltaT;</span>
<span class="fc" id="L3099">      ret = val1 + slope * toDate;</span>
    }
<span class="fc" id="L3101">    session.getTransaction().commit();</span>
<span class="fc" id="L3102">    session.close();</span>
<span class="fc" id="L3103">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#listSensors(java.lang.String)
   */
  @Override
  public List&lt;String&gt; listSensors(String depotId, String orgId, boolean check)
      throws IdNotFoundException {
<span class="fc" id="L3115">    Long startTime = 0l;</span>
<span class="fc" id="L3116">    Long endTime = 0l;</span>
<span class="fc" id="L3117">    Long diff = 0l;</span>
<span class="pc bpc" id="L3118" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L3119">      timingLogger.log(Level.SEVERE, padding + &quot;Start listSensors(&quot; + depotId + &quot;, &quot; + orgId + &quot;)&quot;);</span>
<span class="nc" id="L3120">      padding += &quot;  &quot;;</span>
<span class="nc" id="L3121">      startTime = System.nanoTime();</span>
    }
<span class="pc bpc" id="L3123" title="1 of 2 branches missed.">    if (check) {</span>
<span class="fc" id="L3124">      getOrganization(orgId, check);</span>
<span class="fc" id="L3125">      getDepository(depotId, orgId, check);</span>
    }
<span class="fc" id="L3127">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3128">    session.beginTransaction();</span>
<span class="fc" id="L3129">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
    // List&lt;SensorImpl&gt; result = (List&lt;SensorImpl&gt;) session
    // .createQuery(
    // &quot;select distinct meas.sensor FROM MeasurementImpl meas WHERE meas.depository = :depot&quot;)
    // .setParameter(&quot;depot&quot;, depot).list();
<span class="fc" id="L3135">    List&lt;DepositorySensorContribution&gt; result = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where depository = :depository&quot;)
        .setParameter(&quot;depository&quot;, depot).list();
<span class="fc" id="L3138">    ArrayList&lt;String&gt; sensorIds = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L3139" title="All 2 branches covered.">    for (DepositorySensorContribution contrib : result) {</span>
<span class="fc" id="L3140">      sensorIds.add(contrib.getSensor().getId());</span>
<span class="fc" id="L3141">    }</span>
    // for (SensorImpl sensor : result) {
    // if (!sensorIds.contains(sensor.getId())) {
    // sensorIds.add(sensor.getId());
    // }
    // }
<span class="fc" id="L3147">    session.getTransaction().commit();</span>
<span class="fc" id="L3148">    session.close();</span>
<span class="pc bpc" id="L3149" title="1 of 2 branches missed.">    if (timingp) {</span>
<span class="nc" id="L3150">      endTime = System.nanoTime();</span>
<span class="nc" id="L3151">      diff = endTime - startTime;</span>
<span class="nc" id="L3152">      padding = padding.substring(0, padding.length() - 2);</span>
<span class="nc" id="L3153">      timingLogger.log(Level.SEVERE, padding + &quot;listSensors(&quot; + depotId + &quot;, &quot; + orgId + &quot;) took &quot;</span>
          + (diff / 1E9) + &quot; secs.&quot;);
    }
<span class="fc" id="L3156">    return sensorIds;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#putMeasurement(java.lang.String,
   * org.wattdepot.common.domainmodel.Measurement)
   */
  @Override
  public void putMeasurement(String depotId, String orgId, Measurement meas)
      throws MeasurementTypeException, IdNotFoundException {
<span class="fc" id="L3169">    getOrganization(orgId, true);</span>
<span class="fc" id="L3170">    Depository d = getDepository(depotId, orgId, true);</span>
<span class="pc bpc" id="L3171" title="1 of 2 branches missed.">    if (!meas.getMeasurementType().equals(d.getMeasurementType().getUnits())) {</span>
<span class="nc" id="L3172">      throw new MeasurementTypeException(&quot;Measurement's type &quot; + meas.getMeasurementType()</span>
          + &quot; does not match &quot; + d.getMeasurementType());
    }
<span class="fc" id="L3175">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3176">    session.beginTransaction();</span>
<span class="fc" id="L3177">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
<span class="fc" id="L3178">    SensorImpl sensor = retrieveSensor(session, meas.getSensorId(), orgId);</span>
<span class="fc" id="L3179">    DepositorySensorContribution contrib = retrieveContribution(session, depot, sensor);</span>
<span class="fc bfc" id="L3180" title="All 2 branches covered.">    if (contrib == null) {</span>
<span class="fc" id="L3181">      contrib = new DepositorySensorContribution();</span>
<span class="fc" id="L3182">      contrib.setDepository(depot);</span>
<span class="fc" id="L3183">      contrib.setSensor(sensor);</span>
<span class="fc" id="L3184">      session.saveOrUpdate(contrib);</span>
    }
<span class="fc" id="L3186">    MeasurementImpl impl = new MeasurementImpl();</span>
<span class="fc" id="L3187">    impl.setDepository(depot);</span>
<span class="fc" id="L3188">    impl.setSensor(sensor);</span>
<span class="fc" id="L3189">    impl.setId(meas.getId());</span>
<span class="fc" id="L3190">    impl.setTimestamp(meas.getDate());</span>
<span class="fc" id="L3191">    impl.setValue(meas.getValue());</span>
<span class="fc" id="L3192">    impl.setUnits(meas.getMeasurementType().toString());</span>
//    InterpolatedValue iv = new InterpolatedValue(sensor.getId(), meas.getValue(), d.getMeasurementType(), meas.getDate());
//    depotSensorInfo.update(orgId, depotId, meas.getSensorId(), iv);
<span class="fc" id="L3195">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3196">    session.getTransaction().commit();</span>
<span class="fc" id="L3197">    session.close();</span>
<span class="fc" id="L3198">  }</span>

  /**
   * @param session The session with an open transaction.
   * @param id The CollectorProcessDefinition's id.
   * @param orgId The owner Organization's id.
   * @return the CollectorProcessDefinition if defined.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private CollectorProcessDefinitionImpl retrieveCollectorProcessDefinition(Session session,
      String id, String orgId) {
<span class="fc" id="L3209">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3210">    List&lt;CollectorProcessDefinitionImpl&gt; cpds = (List&lt;CollectorProcessDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM CollectorProcessDefinitionImpl WHERE id = :id AND org = :org&quot;)
        .setParameter(&quot;id&quot;, id).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3213" title="All 2 branches covered.">    if (cpds.size() == 1) {</span>
<span class="fc" id="L3214">      return cpds.get(0);</span>
    }
    else {
<span class="fc" id="L3217">      return null;</span>
    }
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return a List of CollectorProcessDefinitions owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;CollectorProcessDefinitionImpl&gt; retrieveCollectorProcessDefinitions(Session session,
      String orgId) {
<span class="fc" id="L3229">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3230">    List&lt;CollectorProcessDefinitionImpl&gt; ret = (List&lt;CollectorProcessDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM CollectorProcessDefinitionImpl WHERE org = :org&quot;)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3233">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param depo The Depository.
   * @param sensor The Sensor.
   * @return The DepositorySensorContribution if the sensor has contributed
   *         measurements to the depository, or null.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositorySensorContribution retrieveContribution(Session session, DepositoryImpl depo,
      SensorImpl sensor) {
<span class="fc" id="L3246">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(
            &quot;from DepositorySensorContribution where sensor = :sensor and depository = :depository&quot;)
        .setParameter(&quot;sensor&quot;, sensor).setParameter(&quot;depository&quot;, depo).list();
<span class="fc bfc" id="L3250" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3251">      return ret.get(0);</span>
    }
<span class="fc" id="L3253">    return null;</span>
  }

  /**
   * @param session A session with an open transaction.
   * @param depository The depository to search for.
   * @return A List of DepositorySensorContributions for the given depository.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositorySensorContribution&gt; retrieveContributions(Session session,
      DepositoryImpl depository) {
<span class="fc" id="L3264">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where depository = :depository&quot;)
        .setParameter(&quot;depository&quot;, depository).list();
<span class="fc" id="L3267">    return ret;</span>
  }

  /**
   * @param session A session with an open transaction.
   * @param sensor The sensor to search for.
   * @return A List of DepositorySensorContributions for the given sensor.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositorySensorContribution&gt; retrieveContributions(Session session,
      SensorImpl sensor) {
<span class="fc" id="L3278">    List&lt;DepositorySensorContribution&gt; ret = (List&lt;DepositorySensorContribution&gt;) session</span>
        .createQuery(&quot;from DepositorySensorContribution where sensor = :sensor&quot;)
        .setParameter(&quot;sensor&quot;, sensor).list();
<span class="fc" id="L3281">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param type The measurement type of the depository.
   * @return A List of all the depositories with the given measurment type.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositoryImpl&gt; retrieveDepositories(Session session, MeasurementTypeImpl type) {
<span class="fc" id="L3291">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE type = :type&quot;).setParameter(&quot;type&quot;, type).list();
<span class="fc" id="L3293">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;DepositoryImpl&gt; retrieveDepositories(Session session, String orgId) {
<span class="fc" id="L3303">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3304">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3306">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the Depository's id.
   * @param orgId The owner's Organization id.
   * @return A List of the Depositories owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private DepositoryImpl retrieveDepository(Session session, String id, String orgId) {
<span class="fc" id="L3317">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3318">    List&lt;DepositoryImpl&gt; ret = (List&lt;DepositoryImpl&gt;) session</span>
        .createQuery(&quot;from DepositoryImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3321" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3322">      return ret.get(0);</span>
    }
<span class="fc" id="L3324">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the MeasurementPruningDefinition's id.
   * @param orgId The Organization's id.
   * @return The MeasurementPruningDefinitionImpl or null if not defined.
   */
  private MeasurementPruningDefinitionImpl retrieveMeasurementPruningDefinition(Session session,
      String id, String orgId) {
<span class="fc" id="L3335">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3337">    List&lt;MeasurementPruningDefinitionImpl&gt; result = (List&lt;MeasurementPruningDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementPruningDefinitionImpl WHERE id = :id AND org = :org&quot;)
        .setParameter(&quot;id&quot;, id).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3340" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3341">      return result.get(0);</span>
    }
<span class="fc" id="L3343">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The Organization's id.
   * @return A list of the defined MeasurementPruningDefinitionImpls.
   */
  private List&lt;MeasurementPruningDefinitionImpl&gt; retrieveMeasurementPruningDefinitions(
      Session session, String orgId) {
<span class="fc" id="L3353">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3355">    List&lt;MeasurementPruningDefinitionImpl&gt; result = (List&lt;MeasurementPruningDefinitionImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementPruningDefinitionImpl WHERE org = :org&quot;)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3358">    return result;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param depotId the id of the Depository.
   * @param orgId the organization's id.
   * @param measId the measurement's id.
   * @return the MeasurementImpl.
   */
  private MeasurementImpl retrieveMeasurement(Session session, String depotId, String orgId,
      String measId) {
<span class="fc" id="L3370">    DepositoryImpl depot = retrieveDepository(session, depotId, orgId);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L3372">    List&lt;MeasurementImpl&gt; result = (List&lt;MeasurementImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementImpl WHERE depository = :depository AND id = :id&quot;)
        .setParameter(&quot;depository&quot;, depot).setParameter(&quot;id&quot;, measId).list();
<span class="fc bfc" id="L3375" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3376">      return result.get(0);</span>
    }
<span class="fc" id="L3378">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @param id The id of the MeasurementType.
   * @return The MeasurementType with the given id.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private MeasurementTypeImpl retrieveMeasurementType(Session session, String id) {
<span class="fc" id="L3388">    List&lt;MeasurementTypeImpl&gt; ret = (List&lt;MeasurementTypeImpl&gt;) session</span>
        .createQuery(&quot;FROM MeasurementTypeImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3390" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3391">      return ret.get(0);</span>
    }
<span class="fc" id="L3393">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @return The list of defined MeasurementTypes.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;MeasurementTypeImpl&gt; retrieveMeasurementTypes(Session session) {
<span class="fc" id="L3402">    List&lt;MeasurementTypeImpl&gt; ret = (List&lt;MeasurementTypeImpl&gt;) session.createQuery(</span>
        &quot;FROM MeasurementTypeImpl&quot;).list();
<span class="fc" id="L3404">    return ret;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @param id The id of the Organization.
   * @return The Organization with the given id.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private OrganizationImpl retrieveOrganization(Session session, String id) {
<span class="fc" id="L3414">    List&lt;OrganizationImpl&gt; ret = (List&lt;OrganizationImpl&gt;) session</span>
        .createQuery(&quot;from OrganizationImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3416" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3417">      return ret.get(0);</span>
    }
<span class="fc" id="L3419">    return null;</span>
  }

  /**
   * @param session A Session with an open transaction.
   * @return The List of defined Organizations.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;OrganizationImpl&gt; retrieveOrganizations(Session session) {
<span class="fc" id="L3428">    List&lt;OrganizationImpl&gt; ret = (List&lt;OrganizationImpl&gt;) session.createQuery(</span>
        &quot;from OrganizationImpl&quot;).list();
<span class="fc" id="L3430">    return ret;</span>

  }

  /**
   * @param session The session with an open transaction.
   * @param id the Sensor's id.
   * @param orgId The owner's Organization id.
   * @return The Sensor with the given id and owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorImpl retrieveSensor(Session session, String id, String orgId) {
<span class="fc" id="L3442">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3443">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3446" title="All 2 branches covered.">    if (ret.size() == 1) {</span>
<span class="fc" id="L3447">      return ret.get(0);</span>
    }
<span class="fc" id="L3449">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param id the SensorGroup's id.
   * @param orgId The owner's Organization id.
   * @return The SensorGroup with the given id, owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorGroupImpl retrieveSensorGroup(Session session, String id, String orgId) {
<span class="fc" id="L3460">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3461">    List&lt;SensorGroupImpl&gt; result = (List&lt;SensorGroupImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorGroupImpl WHERE id = :id AND org = :org&quot;).setParameter(&quot;id&quot;, id)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3464" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3465">      return result.get(0);</span>
    }
<span class="fc" id="L3467">    return null;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return a List of the SensorGroups owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorGroupImpl&gt; retrieveSensorGroups(Session session, String orgId) {
<span class="fc" id="L3477">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3478">    List&lt;SensorGroupImpl&gt; result = (List&lt;SensorGroupImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorGroupImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3480">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param id the id of the SensorModel to retrieve.
   * @return A List of the SensorModels owned by the orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private SensorModelImpl retrieveSensorModel(Session session, String id) {
<span class="fc" id="L3490">    List&lt;SensorModelImpl&gt; result = (List&lt;SensorModelImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorModelImpl WHERE id = :id&quot;).setParameter(&quot;id&quot;, id).list();
<span class="fc bfc" id="L3492" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3493">      return result.get(0);</span>
    }
<span class="fc" id="L3495">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @return A List of the SensorModels owned by the orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorModelImpl&gt; retrieveSensorModels(Session session) {
<span class="fc" id="L3504">    List&lt;SensorModelImpl&gt; ret = (List&lt;SensorModelImpl&gt;) session.createQuery(&quot;FROM SensorModelImpl&quot;)</span>
        .list();
<span class="fc" id="L3506">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param orgId The owner's Organization id.
   * @return A List of the Sensors owned by orgId.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;SensorImpl&gt; retrieveSensors(Session session, String orgId) {
<span class="fc" id="L3516">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3517">    List&lt;SensorImpl&gt; ret = (List&lt;SensorImpl&gt;) session</span>
        .createQuery(&quot;FROM SensorImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3519">    return ret;</span>
  }

  /**
   * @param session The session with an open transaction.
   * @param uid the User's id.
   * @param orgId the Organziation's id.
   * @return the UserInfoImpl.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private UserInfoImpl retrieveUser(Session session, String uid, String orgId) {
<span class="fc" id="L3530">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3531">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session</span>
        .createQuery(&quot;FROM UserInfoImpl WHERE uid = :uid AND org = :org&quot;).setParameter(&quot;uid&quot;, uid)
        .setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3534" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3535">      return result.get(0);</span>
    }
<span class="fc" id="L3537">    return null;</span>

  }

  /**
   * @param session The Session with an open transaction.
   * @param id the user's id.
   * @param orgId the organization's id.
   * @return the UserPasswordImpl.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private UserPasswordImpl retrieveUserPassword(Session session, String id, String orgId) {
<span class="fc" id="L3549">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3550">    UserInfoImpl user = retrieveUser(session, id, orgId);</span>
<span class="fc" id="L3551">    List&lt;UserPasswordImpl&gt; result = (List&lt;UserPasswordImpl&gt;) session</span>
        .createQuery(&quot;FROM UserPasswordImpl WHERE user = :user AND org = :org&quot;)
        .setParameter(&quot;user&quot;, user).setParameter(&quot;org&quot;, org).list();
<span class="fc bfc" id="L3554" title="All 2 branches covered.">    if (result.size() == 1) {</span>
<span class="fc" id="L3555">      return result.get(0);</span>
    }
<span class="fc" id="L3557">    return null;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The organization id.
   * @return a List of the user passwords in the given organization.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserPasswordImpl&gt; retrieveUserPasswords(Session session, String orgId) {
<span class="fc" id="L3567">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3568">    List&lt;UserPasswordImpl&gt; result = (List&lt;UserPasswordImpl&gt;) session</span>
        .createQuery(&quot;FROM UserPasswordImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3570">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @return A List of all the defined users.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserInfoImpl&gt; retrieveUsers(Session session) {
<span class="fc" id="L3579">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session.createQuery(&quot;FROM UserInfoImpl&quot;)</span>
        .list();
<span class="fc" id="L3581">    return result;</span>
  }

  /**
   * @param session The Session with an open transaction.
   * @param orgId The organization id.
   * @return a List of the users in the given organization.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private List&lt;UserInfoImpl&gt; retrieveUsers(Session session, String orgId) {
<span class="fc" id="L3591">    OrganizationImpl org = retrieveOrganization(session, orgId);</span>
<span class="fc" id="L3592">    List&lt;UserInfoImpl&gt; result = (List&lt;UserInfoImpl&gt;) session</span>
        .createQuery(&quot;FROM UserInfoImpl WHERE org = :org&quot;).setParameter(&quot;org&quot;, org).list();
<span class="fc" id="L3594">    return result;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepotPersistence#stop()
   */
  @Override
  public void stop() {
<span class="fc" id="L3604">    Manager.closeSession();</span>
<span class="fc" id="L3605">  }</span>

  /**
   * Use this method after beginning a transaction.
   * 
   * @param session The Session, a transaction must be in progress.
   * @param cpd The CollectorProcessDefinitionImpl to save.
   */
  private void storeCollectorProcessDefinition(Session session, CollectorProcessDefinitionImpl cpd) {
<span class="pc bpc" id="L3614" title="1 of 2 branches missed.">    for (PropertyImpl p : cpd.getProperties()) {</span>
<span class="nc" id="L3615">      session.saveOrUpdate(p);</span>
<span class="nc" id="L3616">    }</span>
<span class="fc" id="L3617">    session.saveOrUpdate(cpd);</span>

<span class="fc" id="L3619">  }</span>

  /**
   * Use this method after beginning a transaction.
   * 
   * @param session The Session, a transaction must be in progress.
   * @param sensor The SensorImpl to save.
   */
  private void storeSensor(Session session, SensorImpl sensor) {
<span class="pc bpc" id="L3628" title="1 of 2 branches missed.">    for (PropertyImpl p : sensor.getProperties()) {</span>
<span class="nc" id="L3629">      session.saveOrUpdate(p);</span>
<span class="nc" id="L3630">    }</span>
<span class="fc" id="L3631">    session.saveOrUpdate(sensor);</span>
<span class="fc" id="L3632">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateCollectorProcessDefinition(org.wattdepot
   * . datamodel .CollectorProcessDefinition)
   */
  @Override
  public CollectorProcessDefinition updateCollectorProcessDefinition(
      CollectorProcessDefinition process) throws IdNotFoundException {
<span class="fc" id="L3644">    getCollectorProcessDefinition(process.getId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3645">    getDepository(process.getDepositoryId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3646">    getSensor(process.getSensorId(), process.getOrganizationId(), true);</span>
<span class="fc" id="L3647">    CollectorProcessDefinition ret = null;</span>
<span class="fc" id="L3648">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3649">    sessionOpen++;</span>
<span class="fc" id="L3650">    session.beginTransaction();</span>
<span class="fc" id="L3651">    CollectorProcessDefinitionImpl impl = retrieveCollectorProcessDefinition(session,</span>
        process.getId(), process.getOrganizationId());
<span class="fc" id="L3653">    impl.setId(process.getId());</span>
<span class="fc" id="L3654">    impl.setName(process.getName());</span>
<span class="fc" id="L3655">    impl.setPollingInterval(process.getPollingInterval());</span>
<span class="fc" id="L3656">    impl.setDepository(retrieveDepository(session, process.getDepositoryId(),</span>
        process.getOrganizationId()));
<span class="fc" id="L3658">    impl.setSensor(retrieveSensor(session, process.getSensorId(), process.getOrganizationId()));</span>
<span class="fc" id="L3659">    impl.setOrg(retrieveOrganization(session, process.getOrganizationId()));</span>
<span class="fc" id="L3660">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L3661" title="1 of 2 branches missed.">    for (Property p : process.getProperties()) {</span>
<span class="nc" id="L3662">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L3663">    }</span>
<span class="fc" id="L3664">    impl.setProperties(props);</span>
<span class="fc" id="L3665">    storeCollectorProcessDefinition(session, impl);</span>
<span class="fc" id="L3666">    ret = impl.toCPD();</span>
<span class="fc" id="L3667">    session.getTransaction().commit();</span>
<span class="fc" id="L3668">    session.close();</span>
<span class="fc" id="L3669">    sessionClose++;</span>
<span class="fc" id="L3670">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepotPersistence#updateMeasurementPruningDefinition
   * (org.wattdepot.common.domainmodel.MeasurementPruningDefinition)
   */
  @Override
  public MeasurementPruningDefinition updateMeasurementPruningDefinition(
      MeasurementPruningDefinition gcd) throws IdNotFoundException {
<span class="fc" id="L3683">    getMeasurementPruningDefinition(gcd.getId(), gcd.getOrganizationId(), true);</span>
<span class="fc" id="L3684">    getDepository(gcd.getDepositoryId(), gcd.getOrganizationId(), true);</span>
<span class="fc" id="L3685">    MeasurementPruningDefinition ret = null;</span>
<span class="fc" id="L3686">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3687">    sessionOpen++;</span>
<span class="fc" id="L3688">    session.beginTransaction();</span>
<span class="fc" id="L3689">    MeasurementPruningDefinitionImpl impl = retrieveMeasurementPruningDefinition(session,</span>
        gcd.getId(), gcd.getOrganizationId());
<span class="fc" id="L3691">    impl.setName(gcd.getName());</span>
<span class="fc" id="L3692">    impl.setDepository(retrieveDepository(session, gcd.getDepositoryId(), gcd.getOrganizationId()));</span>
<span class="fc" id="L3693">    impl.setSensor(gcd.getSensorId());</span>
<span class="fc" id="L3694">    impl.setIgnoreWindowDays(gcd.getIgnoreWindowDays());</span>
<span class="fc" id="L3695">    impl.setCollectWindowDays(gcd.getCollectWindowDays());</span>
<span class="fc" id="L3696">    impl.setMinGapSeconds(gcd.getMinGapSeconds());</span>
<span class="fc" id="L3697">    impl.setLastStarted(gcd.getLastStarted());</span>
<span class="fc" id="L3698">    impl.setLastCompleted(gcd.getLastCompleted());</span>
<span class="fc" id="L3699">    impl.setNumMeasurementsCollected(gcd.getNumMeasurementsCollected());</span>
<span class="fc" id="L3700">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3701">    ret = impl.toMPD();</span>
<span class="fc" id="L3702">    session.getTransaction().commit();</span>
<span class="fc" id="L3703">    session.close();</span>
<span class="fc" id="L3704">    sessionClose++;</span>
<span class="fc" id="L3705">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateMeasurementType(org.wattdepot.datamodel
   * .MeasurementType)
   */
  @Override
  public MeasurementType updateMeasurementType(MeasurementType type) {
<span class="fc" id="L3717">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3718">    sessionOpen++;</span>
<span class="fc" id="L3719">    session.beginTransaction();</span>
<span class="fc" id="L3720">    MeasurementTypeImpl impl = retrieveMeasurementType(session, type.getId());</span>
<span class="fc" id="L3721">    impl.setName(type.getName());</span>
<span class="fc" id="L3722">    impl.setUnits(type.getUnits());</span>
<span class="fc" id="L3723">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3724">    session.getTransaction().commit();</span>
<span class="fc" id="L3725">    session.close();</span>
<span class="fc" id="L3726">    sessionClose++;</span>

<span class="fc" id="L3728">    return type;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateOrganization(org.wattdepot.datamodel
   * .Organization)
   */
  @Override
  public Organization updateOrganization(Organization org) throws IdNotFoundException {
<span class="fc" id="L3740">    getOrganization(org.getId(), true);</span>
<span class="fc bfc" id="L3741" title="All 2 branches covered.">    for (String s : org.getUsers()) {</span>
<span class="fc" id="L3742">      getUser(s, org.getId(), true);</span>
<span class="fc" id="L3743">    }</span>
<span class="fc" id="L3744">    Organization ret = null;</span>
<span class="fc" id="L3745">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3746">    sessionOpen++;</span>
<span class="fc" id="L3747">    session.beginTransaction();</span>
<span class="fc" id="L3748">    OrganizationImpl impl = retrieveOrganization(session, org.getId());</span>
<span class="fc" id="L3749">    impl.setId(org.getId());</span>
<span class="fc" id="L3750">    impl.setName(org.getName());</span>
<span class="fc bfc" id="L3751" title="All 2 branches covered.">    for (String s : org.getUsers()) {</span>
<span class="fc" id="L3752">      UserInfoImpl u = retrieveUser(session, s, org.getId());</span>
<span class="pc bpc" id="L3753" title="1 of 2 branches missed.">      if (u != null) {</span>
<span class="fc" id="L3754">        impl.getUsers().add(u);</span>
      }
<span class="fc" id="L3756">    }</span>
<span class="fc" id="L3757">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3758">    ret = impl.toOrganization();</span>
<span class="fc" id="L3759">    session.getTransaction().commit();</span>
<span class="fc" id="L3760">    session.close();</span>
<span class="fc" id="L3761">    sessionClose++;</span>
<span class="fc" id="L3762">    cache.putOrganization(ret);</span>
<span class="fc" id="L3763">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensor(org.wattdepot.datamodel.Sensor
   * )
   */
  @Override
  public Sensor updateSensor(Sensor sensor) throws IdNotFoundException {
<span class="fc" id="L3775">    getOrganization(sensor.getOrganizationId(), true);</span>
<span class="fc" id="L3776">    getSensorModel(sensor.getModelId(), true);</span>
<span class="fc" id="L3777">    Sensor ret = null;</span>
<span class="fc" id="L3778">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3779">    sessionOpen++;</span>
<span class="fc" id="L3780">    session.beginTransaction();</span>
<span class="fc" id="L3781">    SensorImpl impl = retrieveSensor(session, sensor.getId(), sensor.getOrganizationId());</span>
<span class="fc" id="L3782">    impl.setId(sensor.getId());</span>
<span class="fc" id="L3783">    impl.setName(sensor.getName());</span>
<span class="fc" id="L3784">    impl.setOrg(retrieveOrganization(session, sensor.getOrganizationId()));</span>
<span class="fc" id="L3785">    impl.setModel(retrieveSensorModel(session, sensor.getModelId()));</span>
<span class="fc" id="L3786">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="pc bpc" id="L3787" title="1 of 2 branches missed.">    for (Property p : sensor.getProperties()) {</span>
<span class="nc" id="L3788">      props.add(new PropertyImpl(p));</span>
<span class="nc" id="L3789">    }</span>
<span class="fc" id="L3790">    impl.setProperties(props);</span>
<span class="fc" id="L3791">    storeSensor(session, impl);</span>
<span class="fc" id="L3792">    ret = impl.toSensor();</span>
<span class="fc" id="L3793">    session.getTransaction().commit();</span>
<span class="fc" id="L3794">    session.close();</span>
<span class="fc" id="L3795">    sessionClose++;</span>
<span class="fc" id="L3796">    cache.putSensor(ret);</span>
<span class="fc" id="L3797">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensorGroup(org.wattdepot.datamodel
   * .SensorGroup)
   */
  @Override
  public SensorGroup updateSensorGroup(SensorGroup group) throws IdNotFoundException {
<span class="fc" id="L3809">    getOrganization(group.getOrganizationId(), true);</span>
<span class="fc" id="L3810">    getSensorGroup(group.getId(), group.getOrganizationId(), true);</span>
    // validate the list of sensor ids.
<span class="fc bfc" id="L3812" title="All 2 branches covered.">    for (String id : group.getSensors()) {</span>
<span class="fc" id="L3813">      getSensor(id, group.getOrganizationId(), true);</span>
<span class="fc" id="L3814">    }</span>
<span class="fc" id="L3815">    SensorGroup ret = null;</span>
<span class="fc" id="L3816">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3817">    sessionOpen++;</span>
<span class="fc" id="L3818">    session.beginTransaction();</span>
<span class="fc" id="L3819">    OrganizationImpl org = retrieveOrganization(session, group.getOrganizationId());</span>
<span class="fc" id="L3820">    SensorGroupImpl impl = retrieveSensorGroup(session, group.getId(), group.getOrganizationId());</span>
<span class="fc" id="L3821">    impl.setId(group.getId());</span>
<span class="fc" id="L3822">    impl.setName(group.getName());</span>
<span class="fc" id="L3823">    impl.setOrg(org);</span>
<span class="fc" id="L3824">    Set&lt;SensorImpl&gt; sensors = new HashSet&lt;SensorImpl&gt;();</span>
<span class="fc bfc" id="L3825" title="All 2 branches covered.">    for (String s : group.getSensors()) {</span>
<span class="fc" id="L3826">      sensors.add(retrieveSensor(session, s, group.getOrganizationId()));</span>
<span class="fc" id="L3827">    }</span>
<span class="fc" id="L3828">    impl.setSensors(sensors);</span>
<span class="fc" id="L3829">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3830">    ret = impl.toSensorGroup();</span>
<span class="fc" id="L3831">    session.getTransaction().commit();</span>
<span class="fc" id="L3832">    session.close();</span>
<span class="fc" id="L3833">    sessionClose++;</span>
<span class="fc" id="L3834">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateSensorModel(org.wattdepot.datamodel
   * .SensorModel)
   */
  @Override
  public SensorModel updateSensorModel(SensorModel model) throws IdNotFoundException {
<span class="fc" id="L3846">    getSensorModel(model.getId(), true);</span>
<span class="fc" id="L3847">    SensorModel ret = null;</span>
<span class="fc" id="L3848">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3849">    sessionOpen++;</span>
<span class="fc" id="L3850">    session.beginTransaction();</span>
<span class="fc" id="L3851">    SensorModelImpl impl = retrieveSensorModel(session, model.getId());</span>
<span class="fc" id="L3852">    impl.setName(model.getName());</span>
<span class="fc" id="L3853">    impl.setProtocol(model.getProtocol());</span>
<span class="fc" id="L3854">    impl.setId(model.getId());</span>
<span class="fc" id="L3855">    impl.setType(model.getType());</span>
<span class="fc" id="L3856">    impl.setVersion(model.getVersion());</span>
<span class="fc" id="L3857">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3858">    ret = impl.toSensorModel();</span>
<span class="fc" id="L3859">    session.getTransaction().commit();</span>
<span class="fc" id="L3860">    session.close();</span>
<span class="fc" id="L3861">    sessionClose++;</span>
<span class="fc" id="L3862">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see org.wattdepot.server.WattDepot#updateUserInfo(org.wattdepot.datamodel
   * .UserInfo)
   */
  @Override
  public UserInfo updateUserInfo(UserInfo user) throws IdNotFoundException {
<span class="fc" id="L3873">    getUser(user.getUid(), user.getOrganizationId(), true);</span>
<span class="fc" id="L3874">    UserInfo ret = null;</span>
<span class="fc" id="L3875">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3876">    sessionOpen++;</span>
<span class="fc" id="L3877">    session.beginTransaction();</span>
<span class="fc" id="L3878">    OrganizationImpl orgImpl = retrieveOrganization(session, user.getOrganizationId());</span>
<span class="fc" id="L3879">    UserInfoImpl impl = retrieveUser(session, user.getUid(), user.getOrganizationId());</span>
<span class="fc" id="L3880">    impl.setUid(user.getUid());</span>
<span class="fc" id="L3881">    impl.setFirstName(user.getFirstName());</span>
<span class="fc" id="L3882">    impl.setLastName(user.getLastName());</span>
<span class="fc" id="L3883">    impl.setEmail(user.getEmail());</span>
<span class="fc" id="L3884">    Set&lt;PropertyImpl&gt; props = new HashSet&lt;PropertyImpl&gt;();</span>
<span class="fc bfc" id="L3885" title="All 2 branches covered.">    for (Property p : user.getProperties()) {</span>
<span class="fc" id="L3886">      PropertyImpl pi = new PropertyImpl(p);</span>
<span class="fc" id="L3887">      props.add(pi);</span>
<span class="fc" id="L3888">      session.saveOrUpdate(pi);</span>
<span class="fc" id="L3889">    }</span>
<span class="fc" id="L3890">    impl.setProperties(props);</span>
<span class="fc" id="L3891">    impl.setOrg(orgImpl);</span>
<span class="fc" id="L3892">    session.saveOrUpdate(orgImpl);</span>
<span class="fc" id="L3893">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3894">    ret = impl.toUserInfo();</span>
<span class="fc" id="L3895">    session.getTransaction().commit();</span>
<span class="fc" id="L3896">    session.close();</span>
<span class="fc" id="L3897">    sessionClose++;</span>
<span class="fc" id="L3898">    return ret;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.wattdepot.server.WattDepot#updateUserPassword(org.wattdepot.datamodel
   * .UserPassword)
   */
  @Override
  public UserPassword updateUserPassword(UserPassword password) throws IdNotFoundException {
<span class="fc" id="L3910">    UserPassword ret = null;</span>
<span class="fc" id="L3911">    getUserPassword(password.getUid(), password.getOrganizationId(), true);</span>
<span class="fc" id="L3912">    Session session = Manager.getFactory(getServerProperties()).openSession();</span>
<span class="fc" id="L3913">    sessionOpen++;</span>
<span class="fc" id="L3914">    session.beginTransaction();</span>
<span class="fc" id="L3915">    UserPasswordImpl impl = retrieveUserPassword(session, password.getUid(),</span>
        password.getOrganizationId());
<span class="fc" id="L3917">    impl.setEncryptedPassword(password.getEncryptedPassword());</span>
<span class="fc" id="L3918">    impl.setOrg(retrieveOrganization(session, password.getOrganizationId()));</span>
<span class="fc" id="L3919">    impl.setUser(retrieveUser(session, password.getUid(), password.getOrganizationId()));</span>
<span class="fc" id="L3920">    session.saveOrUpdate(impl);</span>
<span class="fc" id="L3921">    ret = impl.toUserPassword();</span>
<span class="fc" id="L3922">    session.getTransaction().commit();</span>
<span class="fc" id="L3923">    session.close();</span>
<span class="fc" id="L3924">    sessionClose++;</span>
<span class="fc" id="L3925">    return ret;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>