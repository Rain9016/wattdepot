<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OpenEISServer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.source.html" class="el_package">org.wattdepot.extension.openeis.server</a> &gt; <span class="el_source">OpenEISServer.java</span></div><h1>OpenEISServer.java</h1><pre class="source lang-java linenums">package org.wattdepot.extension.openeis.server;

import org.restlet.data.Status;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.InterpolatedValueList;
import org.wattdepot.common.domainmodel.Measurement;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.util.tstamp.Tstamp;
import org.wattdepot.extension.openeis.domainmodel.TimeInterval;
import org.wattdepot.server.http.api.WattDepotServerResource;

import javax.xml.datatype.XMLGregorianCalendar;
import java.util.Date;
import java.util.List;

/**
 * OpenEISServer - Base class that provides functionality for getting Hourly average values for point data and
 * Hourly difference values.
 *
 * @author Cam Moore
 */
<span class="nc" id="L24">public class OpenEISServer extends WattDepotServerResource {</span>

  /**
   * Returns the hourly point data for the given depositoryId, sensorId, and for the time interval.
   *
   * @param depositoryId The Depository.
   * @param sensorId     The Sensor collecting the data.
   * @param howLong      The length of time.
   * @param keepNulls    if true returns InterpolatedValues with a value of null for missing data.
   * @return An InterpolatedValueList of the hourly data.
   */
  public InterpolatedValueList getHourlyPointData(String depositoryId, String sensorId, TimeInterval howLong, boolean keepNulls) {
<span class="nc" id="L36">    XMLGregorianCalendar now = Tstamp.makeTimestamp();</span>
<span class="nc" id="L37">    now.setTime(0, 0, 0, 0); // set now to midnight</span>
<span class="nc" id="L38">    Date nowDate = now.toGregorianCalendar().getTime();</span>
<span class="nc" id="L39">    XMLGregorianCalendar past = Tstamp.incrementDays(now, howLong.getNumDays() * -1);</span>
<span class="nc" id="L40">    Date pastDate = past.toGregorianCalendar().getTime();</span>
<span class="nc" id="L41">    return getHourlyPointData(depositoryId, sensorId, pastDate, nowDate, keepNulls);</span>
  }

  /**
   * Returns the average point data for the last year.
   *
   * @param depositoryId The Depository.
   * @param sensorId     The Sensor
   * @param keepNulls    if true returns InterpolatedValues with a value of null for missing data.
   * @return An InterpolatedValueList of the hourly data.
   */
  public InterpolatedValueList getHourlyPointDataYear(String depositoryId, String sensorId, boolean keepNulls) {
<span class="nc" id="L53">    return getHourlyPointData(depositoryId, sensorId, TimeInterval.ONE_YEAR, keepNulls);</span>
  }

  /**
   * Returns the hourly difference data for the given depositoryId, sensorId, and for the time interval.
   *
   * @param depositoryId The Depository.
   * @param sensorId     The Sensor collecting the data.
   * @param howLong      The length of time.
   * @param keepNulls    if true returns InterpolatedValues with a value of null for missing data.
   * @return An InterpolatedValueList of the hourly data.
   */
  public InterpolatedValueList getHourlyDifferenceData(String depositoryId, String sensorId, TimeInterval howLong, boolean keepNulls) {
<span class="nc" id="L66">    XMLGregorianCalendar now = Tstamp.makeTimestamp();</span>
<span class="nc" id="L67">    now.setTime(0, 0, 0, 0); // set now to midnight</span>
<span class="nc" id="L68">    Date nowDate = now.toGregorianCalendar().getTime();</span>
<span class="nc" id="L69">    XMLGregorianCalendar past = Tstamp.incrementDays(now, howLong.getNumDays() * -1);</span>
<span class="nc" id="L70">    Date pastDate = past.toGregorianCalendar().getTime();</span>
<span class="nc" id="L71">    return getHourlyDifferenceData(depositoryId, sensorId, pastDate, nowDate, keepNulls);</span>
  }

  /**
   * Returns an InterpolatedValueList of the values starting at start with an interval of howLong.
   *
   * @param depositoryId The Depository.
   * @param sensorId     The Sensor.
   * @param start        The start date.
   * @param howLong      The period to calculate the difference.
   * @param numIntervals How many values to calculate.
   * @param keepNulls    if true returns InterpolatedValues with a value of null for missing data.
   * @return an InterpolatedValueList of the values.
   */
  public InterpolatedValueList getDifferenceValues(String depositoryId, String sensorId, Date start, TimeInterval howLong, int numIntervals, boolean keepNulls) {
<span class="nc bnc" id="L86" title="All 2 branches missed.">    if (isInRole(orgId)) {</span>
<span class="nc" id="L87">      InterpolatedValueList ret = new InterpolatedValueList();</span>
      try {
<span class="nc" id="L89">        Depository depository = depot.getDepository(depositoryId, orgId, true);</span>
<span class="nc" id="L90">        XMLGregorianCalendar startCal = Tstamp.makeTimestamp(start.getTime());</span>
<span class="nc" id="L91">        startCal.setTime(0, 0, 0, 0); // start at the beginning of the day.</span>
<span class="nc" id="L92">        XMLGregorianCalendar endCal = Tstamp.incrementDays(startCal, howLong.getNumDays());</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for (int i = 0; i &lt; numIntervals; i++) {</span>
<span class="nc" id="L94">          Date begin = startCal.toGregorianCalendar().getTime();</span>
<span class="nc" id="L95">          Date end = endCal.toGregorianCalendar().getTime();</span>
<span class="nc" id="L96">          Double val = null;</span>
          try {
<span class="nc" id="L98">            val = depot.getValue(depositoryId, orgId, sensorId, begin, end, false);</span>
          }
<span class="nc" id="L100">          catch (NoMeasurementException e) {</span>
<span class="nc" id="L101">            val = null;</span>
<span class="nc" id="L102">          }</span>
<span class="nc" id="L103">          InterpolatedValue v = new InterpolatedValue(sensorId, val, depository.getMeasurementType(), begin, end);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">          if (val == null) {</span>
<span class="nc" id="L105">            ret.getMissingData().add(v);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (keepNulls) {</span>
<span class="nc" id="L107">              ret.getInterpolatedValues().add(v);</span>
            }
          }
          else {
<span class="nc" id="L111">            ret.getInterpolatedValues().add(v);</span>
          }
<span class="nc" id="L113">          startCal = Tstamp.incrementDays(startCal, howLong.getNumDays());</span>
<span class="nc" id="L114">          endCal = Tstamp.incrementDays(endCal, howLong.getNumDays());</span>
        }
<span class="nc" id="L116">        return ret;</span>
      }
<span class="nc" id="L118">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L119">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L120">        return null;</span>
      }
    }
    else {
<span class="nc" id="L124">      setStatus(Status.CLIENT_ERROR_BAD_REQUEST, &quot;Bad credentials.&quot;);</span>
<span class="nc" id="L125">      return null;</span>
    }
  }

  /**
   * Returns the hourly difference data as an InterpolatedValueList.
   *
   * @param depositoryId The Depository.
   * @param sensorId     The Sensor.
   * @param start        The start of the period.
   * @param end          The end of the period.
   * @param keepNulls    if true inserts InterpolatedValues with a value of null in the return list.
   * @return An InterpolatedValueList of the hourly differences.
   */
  public InterpolatedValueList getHourlyDifferenceData(String depositoryId, String sensorId, Date start, Date end, boolean keepNulls) {
<span class="nc bnc" id="L140" title="All 2 branches missed.">    if (isInRole(orgId)) {</span>
      try {
<span class="nc" id="L142">        Depository depository = depot.getDepository(depositoryId, orgId, true);</span>
<span class="nc" id="L143">        XMLGregorianCalendar startCal = Tstamp.makeTimestamp(start.getTime());</span>
<span class="nc" id="L144">        startCal.setTime(0, 0, 0, 0);</span>
<span class="nc" id="L145">        XMLGregorianCalendar endCal = Tstamp.makeTimestamp(end.getTime());</span>
<span class="nc" id="L146">        endCal.setTime(0, 0, 0, 0);</span>
<span class="nc" id="L147">        endCal = Tstamp.incrementDays(endCal, 1);</span>
<span class="nc" id="L148">        List&lt;XMLGregorianCalendar&gt; times = Tstamp.getTimestampList(startCal, endCal, 60);</span>
<span class="nc" id="L149">        InterpolatedValueList ret = new InterpolatedValueList();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        for (int i = 1; i &lt; times.size(); i++) {</span>
<span class="nc" id="L151">          XMLGregorianCalendar begin = times.get(i - 1);</span>
<span class="nc" id="L152">          Date beginDate = begin.toGregorianCalendar().getTime();</span>
<span class="nc" id="L153">          XMLGregorianCalendar stop = times.get(i);</span>
<span class="nc" id="L154">          Date endDate = stop.toGregorianCalendar().getTime();</span>
<span class="nc" id="L155">          Double val = null;</span>
          try {
<span class="nc" id="L157">            val = depot.getValue(depositoryId, orgId, sensorId, beginDate, endDate, false);</span>
          }
<span class="nc" id="L159">          catch (NoMeasurementException e) { // if there are no measurements just add null</span>
<span class="nc" id="L160">            val = null;</span>
<span class="nc" id="L161">          }</span>
<span class="nc" id="L162">          InterpolatedValue iv = new InterpolatedValue(sensorId, val, depository.getMeasurementType(), beginDate, endDate);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">          if (!keepNulls) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (val != null) {</span>
<span class="nc" id="L165">              ret.getInterpolatedValues().add(iv);</span>
            }
            else {
<span class="nc" id="L168">              ret.getMissingData().add(iv);</span>
            }
          }
          else {
<span class="nc" id="L172">            ret.getInterpolatedValues().add(iv);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (val == null) {</span>
<span class="nc" id="L174">              ret.getMissingData().add(iv);</span>
            }
          }
        }
<span class="nc" id="L178">        return ret;</span>
      }
<span class="nc" id="L180">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L181">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L182">        return null;</span>
      }
    }
    else {
<span class="nc" id="L186">      setStatus(Status.CLIENT_ERROR_BAD_REQUEST, &quot;Bad credentials.&quot;);</span>
<span class="nc" id="L187">      return null;</span>
    }
  }

  /**
   * Returns the hourly average data as an InterpolatedValueList.
   *
   * @param depositoryId The Depository.
   * @param sensorId     The Sensor.
   * @param start        The start of the period.
   * @param end          The end of the period.
   * @param keepNulls    if true insert InterpolatedValues with a null value.
   * @return An InterpolatedValueList of the hourly averages.
   */
  public InterpolatedValueList getHourlyPointData(String depositoryId, String sensorId, Date start, Date end, boolean keepNulls) {
<span class="nc bnc" id="L202" title="All 2 branches missed.">    if (isInRole(orgId)) {</span>
<span class="nc" id="L203">      InterpolatedValueList ret = new InterpolatedValueList();</span>
      try {
<span class="nc" id="L205">        Depository depository = depot.getDepository(depositoryId, orgId, true);</span>
<span class="nc" id="L206">        XMLGregorianCalendar startCal = Tstamp.makeTimestamp(start.getTime());</span>
<span class="nc" id="L207">        startCal.setTime(0, 0, 0, 0);</span>
<span class="nc" id="L208">        XMLGregorianCalendar endCal = Tstamp.makeTimestamp(end.getTime());</span>
<span class="nc" id="L209">        endCal.setTime(0, 0, 0, 0);</span>
<span class="nc" id="L210">        endCal = Tstamp.incrementDays(endCal, 1);</span>
<span class="nc" id="L211">        List&lt;XMLGregorianCalendar&gt; times = Tstamp.getTimestampList(startCal, endCal, 60);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        for (int i = 1; i &lt; times.size(); i++) {</span>
<span class="nc" id="L213">          XMLGregorianCalendar begin = times.get(i - 1);</span>
<span class="nc" id="L214">          Date beginDate = begin.toGregorianCalendar().getTime();</span>
<span class="nc" id="L215">          XMLGregorianCalendar stop = times.get(i);</span>
<span class="nc" id="L216">          Date endDate = stop.toGregorianCalendar().getTime();</span>
<span class="nc" id="L217">          Double val = 0.0;</span>
<span class="nc" id="L218">          List&lt;Measurement&gt; measurements = depot.getMeasurements(depositoryId, orgId, sensorId, beginDate, endDate, false);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">          if (measurements.size() &gt; 0) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            for (Measurement m : measurements) {</span>
<span class="nc" id="L221">              val += m.getValue();</span>
<span class="nc" id="L222">            }</span>
<span class="nc" id="L223">            val = val / measurements.size();</span>
          }
          else {
<span class="nc" id="L226">            val = null;</span>
          }
<span class="nc" id="L228">          InterpolatedValue iv = new InterpolatedValue(sensorId, val, depository.getMeasurementType(), beginDate, endDate);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">          if (!keepNulls) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (val != null) {</span>
<span class="nc" id="L231">              ret.getInterpolatedValues().add(iv);</span>
            }
            else {
<span class="nc" id="L234">              ret.getMissingData().add(iv);</span>
            }
          }
          else {
<span class="nc" id="L238">            ret.getInterpolatedValues().add(iv);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (val == null) {</span>
<span class="nc" id="L240">              ret.getMissingData().add(iv);</span>
            }
          }
        }
<span class="nc" id="L244">        return ret;</span>
      }
<span class="nc" id="L246">      catch (IdNotFoundException e) {</span>
<span class="nc" id="L247">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L248">        return null;</span>
      }
    }
    else {
<span class="nc" id="L252">      setStatus(Status.CLIENT_ERROR_BAD_REQUEST, &quot;Bad credentials.&quot;);</span>
<span class="nc" id="L253">      return null;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>