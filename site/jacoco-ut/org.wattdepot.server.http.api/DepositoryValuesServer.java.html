<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DepositoryValuesServer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WattDepot</a> &gt; <a href="index.source.html" class="el_package">org.wattdepot.server.http.api</a> &gt; <span class="el_source">DepositoryValuesServer.java</span></div><h1>DepositoryValuesServer.java</h1><pre class="source lang-java linenums">/**
 * DepositoryValuesServer.java This file is part of WattDepot.
 *
 * Copyright (C) 2013  Yongwen Xu
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.wattdepot.server.http.api;

import java.text.ParseException;
import java.util.Date;
import java.util.List;
import java.util.logging.Level;

import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.XMLGregorianCalendar;

import org.restlet.data.Status;
import org.restlet.resource.ResourceException;
import org.wattdepot.common.domainmodel.Depository;
import org.wattdepot.common.domainmodel.Labels;
import org.wattdepot.common.domainmodel.InterpolatedValue;
import org.wattdepot.common.domainmodel.InterpolatedValueList;
import org.wattdepot.common.domainmodel.Sensor;
import org.wattdepot.common.domainmodel.SensorGroup;
import org.wattdepot.common.exception.IdNotFoundException;
import org.wattdepot.common.exception.MisMatchedOwnerException;
import org.wattdepot.common.exception.NoMeasurementException;
import org.wattdepot.common.util.DateConvert;
import org.wattdepot.common.util.tstamp.Tstamp;

/**
 * DepositoryValuesServer - Base class for handling the Depository values HTTP
 * API (&quot;/wattdepot/{org-id}/depository/{depository-id}/values/&quot;).
 * 
 * @author Yongwen Xu
 * 
 */
<span class="fc" id="L50">public class DepositoryValuesServer extends WattDepotServerResource {</span>
  protected String depositoryId;
  protected String sensorId;
  protected String start;
  protected String end;
  protected String interval;
  protected String dataType;

  /*
   * (non-Javadoc)
   * 
   * @see org.restlet.resource.Resource#doInit()
   */
  @Override
  protected void doInit() throws ResourceException {
<span class="fc" id="L65">    super.doInit();</span>
<span class="fc" id="L66">    this.sensorId = getQuery().getValues(Labels.SENSOR);</span>
<span class="fc" id="L67">    this.start = getQuery().getValues(Labels.START);</span>
<span class="fc" id="L68">    this.end = getQuery().getValues(Labels.END);</span>
<span class="fc" id="L69">    this.depositoryId = getAttribute(Labels.DEPOSITORY_ID);</span>
<span class="fc" id="L70">    this.interval = getQuery().getValues(Labels.INTERVAL);</span>
<span class="fc" id="L71">    this.dataType = getQuery().getValues(Labels.VALUE_TYPE);</span>
<span class="fc" id="L72">  }</span>

  /**
   * retrieve the depository measurement list for a sensor.
   * 
   * @return measurement list.
   */
  public InterpolatedValueList doRetrieve() {
<span class="fc" id="L80">    getLogger().log(</span>
        Level.INFO,
        &quot;GET /wattdepot/{&quot; + orgId + &quot;}/&quot; + Labels.DEPOSITORY + &quot;/{&quot; + depositoryId + &quot;}/&quot;
            + Labels.VALUES + &quot;/?&quot; + Labels.SENSOR + &quot;={&quot; + sensorId + &quot;}&amp;&quot; + Labels.START + &quot;={&quot;
            + start + &quot;}&amp;&quot; + Labels.END + &quot;={&quot; + end + &quot;}&amp;&quot; + Labels.INTERVAL + &quot;={&quot; + interval
            + &quot;}&amp;&quot; + Labels.VALUE_TYPE + &quot;={&quot; + dataType + &quot;}&quot;);
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">    if (isInRole(orgId)) {</span>
<span class="pc bpc" id="L87" title="3 of 6 branches missed.">      if (start != null &amp;&amp; end != null &amp;&amp; interval != null) {</span>
<span class="fc" id="L88">        InterpolatedValueList ret = new InterpolatedValueList();</span>
        try {
<span class="fc" id="L90">          Depository depository = depot.getDepository(depositoryId, orgId, true);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">          if (depository != null) {</span>
<span class="fc" id="L92">            XMLGregorianCalendar startTime = DateConvert.parseCalString(start);</span>
<span class="fc" id="L93">            XMLGregorianCalendar endTime = DateConvert.parseCalString(end);</span>

            // interval is in minute
<span class="fc" id="L96">            int intervalMinutes = Integer.parseInt(interval);</span>

            // Build list of timestamps, starting with startTime, separated by
            // intervalMinutes
<span class="fc" id="L100">            List&lt;XMLGregorianCalendar&gt; timestampList = Tstamp.getTimestampList(startTime, endTime,</span>
                intervalMinutes);
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">            if (timestampList != null) {</span>
<span class="fc" id="L103">              Sensor sensor = depot.getSensor(sensorId, orgId, false);</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">              if (sensor != null) {</span>
<span class="fc" id="L105">                Date previous = null;</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">                for (int i = 0; i &lt; timestampList.size(); i++) {</span>
                  InterpolatedValue mValue;
<span class="fc" id="L108">                  Date timestamp = DateConvert.convertXMLCal(timestampList.get(i));</span>
<span class="fc" id="L109">                  Double value = new Double(0);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">                  if (&quot;point&quot;.equals(dataType)) {</span>
                    try {
<span class="fc" id="L112">                      value = depot.getValue(depositoryId, orgId, sensor.getId(), timestamp, true);</span>
                    }
<span class="nc" id="L114">                    catch (NoMeasurementException e) { // NOPMD</span>
                      // no measurements around the time so return 0?
<span class="fc" id="L116">                    }</span>
<span class="fc" id="L117">                    mValue = new InterpolatedValue(sensor.getId(), value,</span>
                        depository.getMeasurementType(), timestamp);
<span class="fc" id="L119">                    ret.getInterpolatedValues().add(mValue);</span>
                  }
                  else {
<span class="fc bfc" id="L122" title="All 2 branches covered.">                    if (previous != null) {</span>
                      try {
<span class="fc" id="L124">                        value = depot.getValue(depositoryId, orgId, sensor.getId(), previous, timestamp, true);</span>
                      }
<span class="nc" id="L126">                      catch (NoMeasurementException e) { // NOPMD</span>
                        // No measurements so return 0,
<span class="fc" id="L128">                      }</span>
<span class="fc" id="L129">                      mValue = new InterpolatedValue(sensor.getId(), value, depository.getMeasurementType(), previous, timestamp);</span>
<span class="fc" id="L130">                      ret.getInterpolatedValues().add(mValue);</span>
                    }
<span class="fc" id="L132">                    previous = timestamp;</span>
                  }
                }
<span class="fc" id="L135">              }</span>
              else {
<span class="fc" id="L137">                SensorGroup group = depot.getSensorGroup(sensorId, orgId, false);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">                if (group != null) {</span>
<span class="fc" id="L139">                  Date previous = null;</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">                  for (int i = 0; i &lt; timestampList.size(); i++) {</span>
<span class="fc" id="L141">                    Date timestamp = DateConvert.convertXMLCal(timestampList.get(i));</span>
<span class="fc" id="L142">                    Double value = new Double(0);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">                    for (String s : group.getSensors()) {</span>
<span class="fc" id="L144">                      Sensor sens = depot.getSensor(s, orgId, true);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">                      if (sens != null) {</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                        if (&quot;point&quot;.equals(dataType)) {</span>
                          try {
<span class="nc" id="L148">                            value += depot.getValue(depositoryId, orgId, sens.getId(), timestamp,</span>
                                true);
                          }
<span class="nc" id="L151">                          catch (NoMeasurementException e) { // NOPMD</span>
                            // No measurements so return 0;
<span class="nc" id="L153">                          }</span>
                        }
                        else {
<span class="fc bfc" id="L156" title="All 2 branches covered.">                          if (previous != null) {</span>
                            try {
<span class="fc" id="L158">                              value += depot.getValue(depositoryId, orgId, sens.getId(),</span>
                                  previous, timestamp, true);
                            }
<span class="nc" id="L161">                            catch (NoMeasurementException e) { // NOPMD</span>
                              // No measurements so return 0,
<span class="fc" id="L163">                            }</span>
                          }
                        }
                      }
<span class="fc" id="L167">                    }</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">                    if (&quot;point&quot;.equals(dataType)) {</span>
<span class="nc" id="L169">                      InterpolatedValue mValue = new InterpolatedValue(group.getId(), value,</span>
                          depository.getMeasurementType(), timestamp);
<span class="nc" id="L171">                      ret.getInterpolatedValues().add(mValue);</span>
<span class="nc" id="L172">                    }</span>
                    else {
<span class="fc bfc" id="L174" title="All 2 branches covered.">                      if (previous != null) {</span>
<span class="fc" id="L175">                        InterpolatedValue mValue = new InterpolatedValue(group.getId(), value,</span>
                            depository.getMeasurementType(), previous, timestamp);
<span class="fc" id="L177">                        ret.getInterpolatedValues().add(mValue);</span>
                      }
                    }
<span class="fc" id="L180">                    previous = timestamp;</span>
                  }
                }
              }
<span class="fc" id="L184">            }</span>
            else {
<span class="nc" id="L186">              setStatus(Status.CLIENT_ERROR_BAD_REQUEST, &quot;Bad start, end, or interval.&quot;);</span>
<span class="nc" id="L187">              return null;</span>
            }
<span class="fc" id="L189">          }</span>
          else {
<span class="nc" id="L191">            setStatus(Status.CLIENT_ERROR_BAD_REQUEST, depositoryId + &quot; is not defined.&quot;);</span>
<span class="nc" id="L192">            return null;</span>
          }
        }
<span class="nc" id="L195">        catch (MisMatchedOwnerException e) {</span>
<span class="nc" id="L196">          setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L197">          return null;</span>
        }
<span class="nc" id="L199">        catch (ParseException e) {</span>
<span class="nc" id="L200">          setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L201">          return null;</span>
        }
<span class="nc" id="L203">        catch (DatatypeConfigurationException e) {</span>
<span class="nc" id="L204">          setStatus(Status.SERVER_ERROR_INTERNAL, e.getMessage());</span>
<span class="nc" id="L205">          return null;</span>
        }
<span class="nc" id="L207">        catch (IdNotFoundException e) {</span>
<span class="nc" id="L208">          setStatus(Status.CLIENT_ERROR_BAD_REQUEST, e.getMessage());</span>
<span class="nc" id="L209">          return null;</span>
<span class="fc" id="L210">        }</span>
<span class="fc" id="L211">        getLogger().info(ret.toString());</span>
<span class="fc" id="L212">        return ret;</span>
      }
      else {
<span class="nc" id="L215">        setStatus(Status.CLIENT_ERROR_BAD_REQUEST, &quot;Missing start and/or end times or interval.&quot;);</span>
<span class="nc" id="L216">        return null;</span>
      }
    }
    else {
<span class="nc" id="L220">      setStatus(Status.CLIENT_ERROR_BAD_REQUEST, &quot;Bad credentials.&quot;);</span>
<span class="nc" id="L221">      return null;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>